<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>Field Buddy - Real Tech Edition</title>
  <style>
    /* ==================== BASE STYLES ==================== */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    body { 
      font: 16px -apple-system, BlinkMacSystemUI, sans-serif;
      background: #f5f5f5;
      padding: 8px;
      padding-bottom: 80px;
      color: #1a1a1a;
    }
    
    /* ==================== INPUTS ==================== */
    input, select, textarea, button {
      font-size: 16px; /* Prevents iOS zoom */
      padding: 14px;
      border: 2px solid #ddd;
      border-radius: 8px;
      width: 100%;
      margin: 8px 0;
      font-family: inherit;
      -webkit-appearance: none;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #007AFF;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }
    
    /* Read-only fields (auto-calculated) */
    input[readonly] {
      background: #f8f8f8;
      color: #666;
      cursor: not-allowed;
    }
    
    /* Checkboxes - make them HUGE for field use */
    input[type="checkbox"] {
      width: 28px;
      height: 28px;
      margin-right: 12px;
      cursor: pointer;
    }
    
    label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    /* Checkbox labels are inline */
    label.check {
      display: flex;
      align-items: center;
      font-size: 15px;
      color: #1a1a1a;
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
    }
    
    label.check:hover {
      background: #f8f8f8;
    }
    
    label.check input:checked {
      accent-color: #34C759;
      border-color: #34C759;
    }
    
    /* ==================== BUTTONS ==================== */
    button {
      background: #007AFF;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: opacity 0.2s;
    }
    
    button:active {
      opacity: 0.7;
    }
    
    button.secondary { background: #8E8E93; }
    button.success { background: #34C759; }
    button.danger { background: #FF3B30; }
    button.warning { background: #FF9500; }
    
    /* ==================== CARDS ==================== */
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .card-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .card-header .icon {
      font-size: 24px;
    }
    
    /* ==================== GRID LAYOUTS ==================== */
    .grid-2 { 
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .grid-3 { 
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    
    .grid-4 { 
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    
    /* Mobile: stack grids */
    @media (max-width: 640px) {
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
    }
    
    /* ==================== MODE TOGGLE ==================== */
    .mode-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin: 12px 0;
    }
    
    .mode-toggle button {
      background: white;
      color: #666;
      border: 2px solid #ddd;
      font-size: 15px;
      padding: 12px;
      min-height: 44px;
    }
    
    .mode-toggle button.active {
      background: #007AFF;
      color: white;
      border-color: #007AFF;
    }
    
    /* ==================== STATUS INDICATORS ==================== */
    .status {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1.4;
    }
    
    .status.good { 
      background: #D1F4E0; 
      color: #0F5132; 
      border-left: 4px solid #34C759;
    }
    
    .status.warn { 
      background: #FFF3CD; 
      color: #664D03; 
      border-left: 4px solid #FF9500;
    }
    
    .status.bad { 
      background: #F8D7DA; 
      color: #842029; 
      border-left: 4px solid #FF3B30;
    }
    
    .status.info {
      background: #D1ECF1;
      color: #0C5460;
      border-left: 4px solid #007AFF;
    }
    
    /* ==================== VOICE INPUT ==================== */
    .voice-wrapper {
      position: relative;
    }
    
    .voice-btn {
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
      width: 40px;
      height: 40px;
      padding: 0;
      background: #007AFF;
      border-radius: 50%;
      font-size: 20px;
      z-index: 2;
      min-height: unset;
    }
    
    .voice-btn.listening { 
      background: #FF3B30;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: translateY(-50%) scale(1); opacity: 1; }
      50% { transform: translateY(-50%) scale(1.1); opacity: 0.8; }
    }
    
    .voice-wrapper input,
    .voice-wrapper textarea {
      padding-right: 50px;
    }
    
    /* ==================== STICKY ACTION BAR ==================== */
    .actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 8px;
      z-index: 100;
    }
    
    .actions button {
      flex: 1;
      font-size: 14px;
      padding: 12px 8px;
    }
    
    /* ==================== COLLAPSIBLE SECTIONS (NEW) ==================== */
    .section {
      margin: 16px 0;
    }
    
    .section-toggle {
      background: white;
      border: 2px solid #ddd;
      color: #1a1a1a;
      font-weight: 600;
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-radius: 8px;
      margin: 8px 0;
    }
    
    .section-toggle:active {
      background: #f8f8f8;
    }
    
    .section-toggle .arrow {
      font-size: 18px;
      transition: transform 0.2s;
    }
    
    .section.open .arrow {
      transform: rotate(180deg);
    }
    
    .section-content {
      display: none;
      background: white;
      padding: 16px;
      border-radius: 0 0 8px 8px;
      border: 2px solid #ddd;
      border-top: none;
      margin-top: -8px;
    }
    
    .section.open .section-content {
      display: block;
    }
    
    /* ==================== MODE-SPECIFIC VISIBILITY ==================== */
    .service-only,
    .install-only,
    .ductwork-only { 
      display: none; 
    }
    
    body.mode-service .service-only { display: block; }
    body.mode-install .install-only { display: block; }
    body.mode-ductwork .ductwork-only { display: block; }
    
    /* ==================== PHOTOS ==================== */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    
    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: #f0f0f0;
    }
    
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-label {
      position: absolute;
      bottom: 4px;
      left: 4px;
      right: 4px;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
    }
    
    .photo-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #FF3B30;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.9;
      min-height: unset;
      padding: 0;
    }
    
    /* ==================== REPORT PREVIEW ==================== */
    .report-preview {
      background: #f8f8f8;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-x: auto;
      margin: 12px 0;
      border: 1px solid #ddd;
    }
    
    /* ==================== UTILITY CLASSES ==================== */
    .mb-8 { margin-bottom: 8px; }
    .mb-16 { margin-bottom: 16px; }
    .mt-8 { margin-top: 8px; }
    .mt-16 { margin-top: 16px; }
    
    .text-center { text-align: center; }
    .text-muted { color: #666; }
    .text-small { font-size: 13px; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body class="mode-service">

  <div class="card">
    <div class="card-header">
      <div>
        <div style="font-size: 20px;">‚ö° Field Buddy</div>
        <div style="font-size: 12px; color: #666; font-weight: 400; margin-top: 4px;">Install & Service Documentation</div>
      </div>
    </div>
    
    <div class="mode-toggle">
      <button onclick="setMode('service')" id="btn-service" class="active">üîß Service</button>
      <button onclick="setMode('install')" id="btn-install">üì¶ Install</button>
      <button onclick="setMode('ductwork')" id="btn-ductwork">üå¨Ô∏è Ductwork</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span>üìã Job Information</span>
    </div>
    
    <label>Customer Name</label>
    <input type="text" id="customer" placeholder="Full name">
    
    <label>Address</label>
    <input type="text" id="address" placeholder="Street, City, State">
    
    <label>Job Type</label>
    <select id="job-type">
      <option value="">Select job type...</option>
      <option value="maintenance">Maintenance</option>
      <option value="repair">Repair</option>
      <option value="diagnostic">Diagnostic</option>
      <option value="new-install">New System Install</option>
      <option value="replacement">Equipment Replacement</option>
      <option value="ductwork">Ductwork Install/Repair</option>
    </select>
    
    <div class="service-only">
      <label>Customer Complaint</label>
      <div class="voice-wrapper">
        <textarea id="complaint" placeholder="What's the issue? (in customer's words)" rows="3"></textarea>
        <button class="voice-btn" data-voice="complaint">üé§</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span>üìç Equipment Location</span>
    </div>
    
    <label>System Location</label>
    <div class="voice-wrapper">
      <input type="text" id="location" placeholder="e.g., Attic above master bedroom">
      <button class="voice-btn" data-voice="location">üé§</button>
    </div>
    
    <label>Access Notes</label>
    <div class="voice-wrapper">
      <input type="text" id="access-notes" placeholder="Ladder height, tight spaces, etc.">
      <button class="voice-btn" data-voice="access-notes">üé§</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <span>‚öôÔ∏è Equipment Details</span>
    </div>

    <div class="mode-toggle" style="grid-template-columns: 1fr 1fr; margin-bottom: 12px;">
      <button onclick="setHeatCoolMode('cooling')" id="btn-hc-cooling" class="active secondary">‚ùÑÔ∏è Cooling</button>
      <button onclick="setHeatCoolMode('heating')" id="btn-hc-heating" class="secondary">üî• Heating</button>
    </div>
    
    <div class="install-only service-only">
        <label>Unit Type</label>
        <select id="unit-type" onchange="toggleUnitData()">
            <option value="">Select unit type...</option>
            <option value="split">Split System</option>
            <option value="package">Package Unit</option>
            <option value="minisplit">Mini-Split</option>
        </select>
    </div>

    <div id="indoor-unit-fields" class="mt-8">
        <label>Indoor Unit Data (Nameplate)</label>
        <div class="voice-wrapper mb-8">
            <input type="text" id="indoor-data" placeholder="Brand/Model/Serial/Size">
            <button class="voice-btn" data-voice="indoor-data">üé§</button>
        </div>
    </div>

    <div id="outdoor-unit-fields">
        <label>Outdoor Unit Data (Nameplate)</label>
        <div class="voice-wrapper mb-8">
            <input type="text" id="outdoor-data" placeholder="Brand/Model/Serial/SEER">
            <button class="voice-btn" data-voice="outdoor-data">üé§</button>
        </div>
    </div>
    
    <div class="grid-2">
      <div>
        <label>Refrigerant Type</label>
        <select id="refrigerant" onchange="clearCalculations()">
          <option value="">Select...</option>
          <option value="R-410A">R-410A</option>
          <option value="R-22">R-22</option>
          <option value="R-32">R-32</option>
        </select>
      </div>
      <div>
        <label>Manufacture Date</label>
        <input type="date" id="mfg-date">
      </div>
    </div>
    
    <div class="install-only">
        <label>Pre-Install Inspection/Condition</label>
        <select id="install-pre-condition">
            <option value="new">New in Box, Undamaged</option>
            <option value="minor">New in Box, Minor Cosmetic Damage</option>
            <option value="used">Used/Refurbished, Condition Checked</option>
        </select>
    </div>

  </div>

  <div class="section service-only" id="section-service-diagnostics">
    <div class="section-toggle" onclick="toggleSection('section-service-diagnostics')">
      <span>üìä Full Diagnostic Measurements</span>
      <span class="arrow">‚ñº</span>
    </div>
    <div class="section-content">
      
      <div class="card-header">General Readings</div>
      <div class="grid-2">
        <div><label>Outdoor Temp (¬∞F)</label><input type="number" id="outdoor-temp" step="0.1"></div>
        <div><label>Return Static (in w.c.)</label><input type="number" id="return-static" step="0.01" oninput="calcStatic()"></div>
      </div>
      <div class="grid-2">
        <div><label>Return Air (¬∞F)</label><input type="number" id="return-temp" step="0.1" oninput="calcDelta()"></div>
        <div><label>Supply Static (in w.c.)</label><input type="number" id="supply-static" step="0.01" oninput="calcStatic()"></div>
      </div>
      <div class="grid-2 mb-8">
        <div><label>Supply Air (¬∞F)</label><input type="number" id="supply-temp" step="0.1" oninput="calcDelta()"></div>
        <div><label>Total Static (auto)</label><input type="text" id="total-static" readonly></div>
      </div>
      <div id="delta-status"></div>
      <div id="static-status"></div>

      <div class="card-header mt-16">Electrical Measurements</div>
      <div class="grid-2">
        <div><label>Voltage L1-L2</label><input type="number" id="voltage-line"></div>
        <div><label>Blower Amps</label><input type="text" id="blower-amps" placeholder="Actual/Rated"></div>
      </div>
      
      <div class="cooling-only">
        <div class="card-header mt-16">Refrigerant Circuit Readings</div>
        <div class="grid-2">
          <div><label>Suction P (psig)</label><input type="number" id="suction-pressure" step="0.1" oninput="calcRefrigerant()"></div>
          <div><label>Liquid P (psig)</label><input type="number" id="liquid-pressure" step="0.1" oninput="calcRefrigerant()"></div>
        </div>
        <div class="grid-2">
          <div><label>Suction T (¬∞F)</label><input type="number" id="suction-temp" step="0.1" oninput="calcRefrigerant()"></div>
          <div><label>Liquid T (¬∞F)</label><input type="number" id="liquid-temp" step="0.1" oninput="calcRefrigerant()"></div>
        </div>
        
        <div class="grid-2 mt-8">
            <div><label>Superheat (auto)</label><input type="text" id="superheat" readonly></div>
            <div><label>Subcool (auto)</label><input type="text" id="subcool" readonly></div>
        </div>
        <div id="superheat-status"></div>
        <div id="subcool-status"></div>

        <div class="grid-2 mt-16">
            <div><label>Compressor Amps</label><input type="text" id="comp-amps" placeholder="Actual/Rated"></div>
            <div><label>Condenser Fan Amps</label><input type="number" id="cond-fan-amps" step="0.1"></div>
        </div>
      </div>
      
      <div class="heating-only">
        <div class="card-header mt-16">Heating Circuit Readings</div>
        <div class="grid-2">
          <div><label>Gas Input (BTU/hr)</label><input type="number" id="gas-input"></div>
          <div><label>Manifold Pressure (in w.c.)</label><input type="number" id="manifold" step="0.1"></div>
        </div>
        <div class="grid-2">
            <div><label>Inducer Amps</label><input type="number" id="inducer-amps" step="0.1"></div>
            <div><label>Heat Exchanger Inspection</label><select id="heat-exchanger"><option>OK</option><option>Cracked</option><option>Soote</option></select></div>
        </div>
      </div>

    </div>
  </div>

  <div class="section service-only" id="section-service-component">
    <div class="section-toggle" onclick="toggleSection('section-service-component')">
      <span>üîç Component Inspection & Safety</span>
      <span class="arrow">‚ñº</span>
    </div>
    <div class="section-content">
      
      <div class="card-header">Safety Checklist</div>
      <div class="grid-2">
        <label class="check"><input type="checkbox" id="safety-disconnect"> Disconnect present & functional</label>
        <label class="check"><input type="checkbox" id="safety-clearances"> Clearances adequate</label>
        <label class="check"><input type="checkbox" id="safety-drain"> Drain trapped & flowing</label>
        <label class="check"><input type="checkbox" id="safety-floats"> Float switches tested</label>
        
        <div class="heating-only">
          <label class="check"><input type="checkbox" id="safety-gas"> Gas piping OK</label>
          <label class="check"><input type="checkbox" id="safety-vent"> Vent termination secure</label>
          <label class="check"><input type="checkbox" id="safety-co"> No CO detected</label>
        </div>
      </div>
      
      <div class="card-header mt-16">Component Health</div>
      <label>Filter Condition</label>
      <div class="voice-wrapper">
        <input type="text" id="filter" placeholder="Size and condition (e.g., 16x25x1 - Light Dust)">
        <button class="voice-btn" data-voice="filter">üé§</button>
      </div>
      
      <div class="grid-2">
        <div>
          <label>Evaporator Coil</label>
          <select id="evap-coil">
            <option>Evap coil condition...</option>
            <option>Clean</option>
            <option>Light dust</option>
            <option>Restricted - needs cleaning</option>
            <option>Corroded</option>
            <option>Leaking</option>
          </select>
        </div>
        <div>
          <label>Condenser Coil</label>
          <select id="cond-coil">
            <option>Cond coil condition...</option>
            <option>Clean</option>
            <option>Light debris</option>
            <option>Restricted - needs cleaning</option>
            <option>Bent fins</option>
            <option>Corroded</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label>Capacitor (¬µF)</label>
          <div class="voice-wrapper">
            <input type="text" id="capacitor" placeholder="Actual/Rated ¬µF">
            <button class="voice-btn" data-voice="capacitor">üé§</button>
          </div>
        </div>
        <div>
          <label>Contactor</label>
          <select id="contactor">
            <option>Contactor condition...</option>
            <option>Good - clean contacts</option>
            <option>Light pitting</option>
            <option>Heavy pitting - recommend replacement</option>
            <option>Burned/welded</option>
          </select>
        </div>
      </div>

    </div>
  </div>

  <div class="card install-only" id="card-install-checklist">
    <div class="card-header">
        <span>‚úÖ Installation Checklist</span>
    </div>
    
    <div class="grid-2">
      <label class="check"><input type="checkbox" id="install-pads"> Pads/Stands Level & Secure</label>
      <label class="check"><input type="checkbox" id="install-flushing"> Line-set Flushed/Pulled Vacuum</label>
      <label class="check"><input type="checkbox" id="install-brazing"> Brazing Performed w/ Nitrogen</label>
      <label class="check"><input type="checkbox" id="install-drain"> Primary/Auxiliary Drains Installed</label>
      <label class="check"><input type="checkbox" id="install-elec"> Final Electrical Connections Torqued</label>
      <label class="check"><input type="checkbox" id="install-sealing"> Plenum Sealed & Secured</label>
      <label class="check"><input type="checkbox" id="install-final"> Unit Wired to Thermostat</label>
      <label class="check"><input type="checkbox" id="install-txv"> TXV Tested/Calibrated (if applicable)</label>
    </div>
    
    <label class="mt-8">Refrigerant Added (lbs/oz)</label>
    <input type="text" id="install-charge-added" placeholder="e.g., 4 lbs 6 oz">
  </div>

  <div class="card ductwork-only" id="card-ductwork-audit">
    <div class="card-header">
      <span>üìê Ductwork & Air Audit</span>
    </div>
    
    <label>Duct Material</label>
    <select id="duct-material">
      <option>Select material...</option>
      <option>Flex Duct (R-4.2)</option>
      <option>Flex Duct (R-6/R-8)</option>
      <option>Fiberglass Board</option>
      <option>Sheet Metal</option>
    </select>
    
    <label>Sealing Condition</label>
    <select id="duct-sealing">
      <option>Select condition...</option>
      <option value="excellent">Excellent - fully mastic sealed</option>
      <option value="good">Good - metallic tape used</option>
      <option value="poor">Poor - visible leakage/gap</option>
    </select>
    
    <label>Number of Supply Vents</label>
    <input type="number" id="num-supply-vents">
    
    <label>Number of Return Grilles</label>
    <input type="number" id="num-return-grilles">
    
    <label>Airflow Notes (Static, VFD/Taps)</label>
    <div class="voice-wrapper">
      <textarea id="airflow-audit-notes" rows="2" placeholder="Note motor speeds, static issues, room temps."></textarea>
      <button class="voice-btn" data-voice="airflow-audit-notes">üé§</button>
    </div>
  </div>

  <div class="card" id="card-final-review">
    <div class="card-header">
      <span>üìù Final Review & Sign-Off</span>
    </div>
    
    <div class="service-only">
        <label>Primary Findings Summary</label>
        <div class="voice-wrapper">
            <textarea id="findings" placeholder="What's wrong and why" rows="3"></textarea>
            <button class="voice-btn" data-voice="findings">üé§</button>
        </div>
        
        <label>Repair Recommendations</label>
        <div class="voice-wrapper">
            <textarea id="recommendations" placeholder="Repair options and next steps" rows="3"></textarea>
            <button class="voice-btn" data-voice="recommendations">üé§</button>
        </div>
    </div>

    <div class="install-only">
        <label>Startup & Commissioning Notes</label>
        <div class="voice-wrapper">
            <textarea id="startup-notes" placeholder="Final pressures, AHRI Match confirmation, etc." rows="3"></textarea>
            <button class="voice-btn" data-voice="startup-notes">üé§</button>
        </div>
    </div>
    
    <div class="ductwork-only">
        <label>Ductwork Repair Summary</label>
        <div class="voice-wrapper">
            <textarea id="duct-repair-summary" placeholder="Work performed and final status." rows="3"></textarea>
            <button class="voice-btn" data-voice="duct-repair-summary">üé§</button>
        </div>
    </div>

    <div class="mt-16">
        <label>Technician Name (for report)</label>
        <input type="text" id="tech-name" placeholder="M. Perez">
    </div>

  </div>

  <div class="card">
    <div class="card-header">
      <span>üì∏ Photo Documentation</span>
    </div>
    <div class="grid-4">
      <button onclick="takePhoto('Nameplate')" class="secondary">üì∑ Nameplate</button>
      <button onclick="takePhoto('Problem')" class="secondary">üì∑ Problem/Damage</button>
      <button onclick="takePhoto('Before')" class="secondary">üì∑ Before</button>
      <button onclick="takePhoto('After')" class="secondary">üì∑ After</button>
      <button onclick="takePhoto('Electrical')" class="secondary">üì∑ Electrical</button>
      <button onclick="takePhoto('Drain')" class="secondary">üì∑ Drain</button>
      <button onclick="takePhoto('Duct-Leak')" class="secondary ductwork-only">üì∑ Duct Leak</button>
      <button onclick="takePhoto('Final-Install')" class="secondary install-only">üì∑ Final Install</button>
    </div>
    <div class="photo-grid" id="photo-preview"></div>
  </div>

  <div class="actions">
    <button onclick="generateReport()" class="success">Generate Report</button>
    <button onclick="exportPDF()" class="secondary">üìÑ Export PDF</button>
  </div>

  <script>
    // ==================== UTILITIES ====================
    const $ = id => document.getElementById(id);
    const num = val => { const n = parseFloat(val); return isNaN(n) ? null : n; };
    const photos = [];
    let heatCoolMode = 'cooling'; // Default for cooling/heating toggle inside service/install
    
    // ==================== MODE SWITCHING (TOP LEVEL) ====================
    function setMode(mode) {
      document.body.className = `mode-${mode}`;
      
      // Update top-level buttons
      document.querySelectorAll('.mode-toggle button').forEach(btn => {
        btn.classList.remove('active');
      });
      $(`btn-${mode}`).classList.add('active');
      
      // Update the secondary toggle based on the new mode
      if (mode === 'service' || mode === 'install') {
          // If switching back to service/install, ensure the secondary mode is visible
          setHeatCoolMode(heatCoolMode);
      }
    }

    // ==================== MODE SWITCHING (COOLING/HEATING SUB-TOGGLE) ====================
    function setHeatCoolMode(mode) {
        heatCoolMode = mode;
        const bodyClassList = document.body.classList;
        
        // Remove existing cooling/heating classes
        bodyClassList.remove('mode-cooling', 'mode-heating');
        
        // Add the new one
        if (bodyClassList.contains('mode-service') || bodyClassList.contains('mode-install')) {
            bodyClassList.add(`mode-${mode}`);
        }
        
        // Update secondary buttons
        $('btn-hc-cooling').className = mode === 'cooling' ? 'active' : 'secondary';
        $('btn-hc-heating').className = mode === 'heating' ? 'active' : 'secondary';
        
        // Recalculate if service mode
        if (bodyClassList.contains('mode-service')) {
            calcDelta();
            clearCalculations();
        }
    }
    
    function toggleUnitData() {
        const type = $('unit-type').value;
        if (type === 'minisplit' || type === 'package') {
            $('indoor-data').placeholder = "Unit Data (All-in-one)";
            $('outdoor-unit-fields').classList.add('hidden');
        } else {
            $('indoor-data').placeholder = "Brand/Model/Serial/Size";
            $('outdoor-unit-fields').classList.remove('hidden');
        }
    }
    
    // ==================== SECTION COLLAPSING (NEW) ====================
    function toggleSection(sectionId) {
      const section = $(sectionId);
      section.classList.toggle('open');
      
      // Only open one service section at a time (UX improvement)
      if (section.classList.contains('open') && sectionId.startsWith('section-service-')) {
          document.querySelectorAll('.section.service-only.open').forEach(openSection => {
              if (openSection.id !== sectionId) {
                  openSection.classList.remove('open');
              }
          });
      }
    }
    
    // ==================== CALCULATIONS ====================
    function clearCalculations() {
        $('superheat').value = '';
        $('subcool').value = '';
        $('superheat-status').innerHTML = '';
        $('subcool-status').innerHTML = '';
    }

    function calcDelta() {
      const ret = num($('return-temp').value);
      const sup = num($('supply-temp').value);
      const mode = heatCoolMode; // Use the internal sub-toggle mode
      
      if (ret === null || sup === null) return;
      
      const delta = mode === 'cooling' ? ret - sup : sup - ret;
      $('delta-t').value = delta.toFixed(1) + ' ¬∞F';
      
      // Status check (logic from original draft)
      const statusDiv = $('delta-status');
      if (mode === 'cooling') {
        if (delta < 14) {
          statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low delta - check airflow or low charge</div>';
        } else if (delta >= 16 && delta <= 22) {
          statusDiv.innerHTML = '<div class="status good">‚úì Delta T in optimal range</div>';
        } else {
          statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Delta T marginal - verify charge</div>';
        }
      } else { // Heating mode logic
        if (delta < 25) {
          statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low rise - check gas input or airflow</div>';
        } else if (delta >= 30 && delta <= 80) {
          statusDiv.innerHTML = '<div class="status good">‚úì Temperature rise in range</div>';
        } else {
          statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Temperature rise marginal</div>';
        }
      }
    }
    
    function calcStatic() {
      const ret = num($('return-static').value);
      const sup = num($('supply-static').value);
      
      if (ret === null || sup === null) return;
      
      const total = Math.abs(ret) + Math.abs(sup);
      $('total-static').value = total.toFixed(2) + ' in w.c.';
      
      // Status check (logic from original draft)
      const statusDiv = $('static-status');
      if (total <= 0.50) {
        statusDiv.innerHTML = '<div class="status good">‚úì Static pressure acceptable</div>';
      } else if (total <= 0.70) {
        statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Static pressure elevated - check ductwork</div>';
      } else {
        statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Static pressure excessive - duct issues likely</div>';
      }
    }
    
    // Simplified R-410A PT chart for demo
    const R410A_PT = {
      100: 50, 110: 55, 118: 60, 128: 65, 139: 70, 151: 75, 164: 80
    };
    
    function lookupSatTemp(psig, refrigerant) {
      if (refrigerant !== 'R-410A') return null;
      
      let closest = null;
      let minDiff = Infinity;
      for (let pressure in R410A_PT) {
        const diff = Math.abs(pressure - psig);
        if (diff < minDiff) {
          minDiff = diff;
          closest = R410A_PT[pressure];
        }
      }
      return closest;
    }
    
    function calcRefrigerant() {
        // Run both Superheat and Subcool when any refrigerant field changes
        calcSuperheat();
        calcSubcool();
    }
    
    function calcSuperheat() {
      const pressure = num($('suction-pressure').value);
      const lineTemp = num($('suction-temp').value);
      const refrigerant = $('refrigerant').value;
      
      if (!pressure || !lineTemp || !refrigerant || heatCoolMode !== 'cooling') return;
      
      const satTemp = lookupSatTemp(pressure, refrigerant);
      if (!satTemp) return;
      
      const superheat = lineTemp - satTemp;
      $('superheat').value = superheat.toFixed(1) + ' ¬∞F';
      
      const statusDiv = $('superheat-status');
      if (superheat < 5) {
        statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low SH - possible overcharge or TXV flooding</div>';
      } else if (superheat >= 8 && superheat <= 18) {
        statusDiv.innerHTML = '<div class="status good">‚úì Superheat in target range</div>';
      } else {
        statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Superheat marginal - verify charge</div>';
      }
    }
    
    function calcSubcool() {
      const pressure = num($('liquid-pressure').value);
      const lineTemp = num($('liquid-temp').value);
      const refrigerant = $('refrigerant').value;
      
      if (!pressure || !lineTemp || !refrigerant || heatCoolMode !== 'cooling') return;
      
      const satTemp = lookupSatTemp(pressure, refrigerant);
      if (!satTemp) return;
      
      const subcool = satTemp - lineTemp;
      $('subcool').value = subcool.toFixed(1) + ' ¬∞F';
      
      const statusDiv = $('subcool-status');
      if (subcool < 5) {
        statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low SC - possible undercharge</div>';
      } else if (subcool >= 8 && subcool <= 15) {
        statusDiv.innerHTML = '<div class="status good">‚úì Subcool in target range</div>';
      } else {
        statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Subcool marginal - verify charge</div>';
      }
    }
    
    // ==================== VOICE INPUT ====================
    let recognition = null;
    let currentTarget = null;
    
    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = (e) => {
        if (currentTarget && e.results[0]) {
          const transcript = e.results[0][0].transcript;
          currentTarget.value = transcript;
          currentTarget.dispatchEvent(new Event('input'));
        }
      };
      
      recognition.onend = () => {
        document.querySelectorAll('.voice-btn.listening').forEach(btn => {
          btn.classList.remove('listening');
        });
      };
    }
    
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('voice-btn')) {
        const targetId = e.target.dataset.voice;
        currentTarget = $(targetId);
        
        if (recognition && currentTarget) {
            try { recognition.stop(); } catch (e) {} // Stop previous instance
            document.querySelectorAll('.voice-btn').forEach(btn => btn.classList.remove('listening'));

            e.target.classList.add('listening');
            recognition.start();
        } else if (!recognition) {
          alert('Voice input not supported on this device');
        }
      }
    });
    
    // ==================== PHOTOS ====================
    
    function takePhoto(purpose) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        
        reader.onload = (event) => {
          photos.push({
            purpose: purpose,
            data: event.target.result,
            timestamp: new Date().toISOString(),
            id: Date.now()
          });
          
          updatePhotoPreview();
        };
        
        reader.readAsDataURL(file);
      };
      
      input.click();
    }
    
    function deletePhoto(photoId) {
        const index = photos.findIndex(p => p.id === photoId);
        if (index > -1 && confirm('Are you sure you want to delete this photo?')) {
            photos.splice(index, 1);
            updatePhotoPreview();
        }
    }

    function updatePhotoPreview() {
      const preview = $('photo-preview');
      preview.innerHTML = photos.map((p, i) => 
        `<div class="photo-item">
            <img src="${p.data}" alt="${p.purpose}">
            <div class="photo-label">${p.purpose}</div>
            <button class="photo-delete" onclick="deletePhoto(${p.id})">x</button>
        </div>`
      ).join('');
    }

    // ==================== REPORT GENERATION ====================
    function generateReport() {
      const mode = document.body.classList.contains('mode-service') ? 'Service' : document.body.classList.contains('mode-install') ? 'Install' : 'Ductwork';
      const techName = $('tech-name').value || '[Technician]';

      const report = {
        meta: {
            date: new Date().toLocaleDateString(),
            tech: techName,
            mode: mode,
            heatCoolMode: heatCoolMode
        },
        job: {
            customer: $('customer').value,
            address: $('address').value,
            jobType: $('job-type').value,
            complaint: $('complaint').value,
            location: $('location').value,
            accessNotes: $('access-notes').value
        },
        equipment: {
            indoor: $('indoor-data').value,
            outdoor: $('outdoor-data').value,
            refrigerant: $('refrigerant').value,
            mfgDate: $('mfg-date').value,
            unitType: $('unit-type')?.value,
        },
        // Service-Specific Data
        service: mode === 'Service' ? {
            safety: {
                disconnect: $('safety-disconnect').checked,
                drain: $('safety-drain').checked,
                floats: $('safety-floats').checked,
                gas: $('safety-gas')?.checked,
                co: $('safety-co')?.checked,
            },
            operating: {
                outdoorTemp: $('outdoor-temp').value,
                returnTemp: $('return-temp').value,
                supplyTemp: $('supply-temp').value,
                deltaT: $('delta-t').value,
                totalStatic: $('total-static').value,
                voltageLine: $('voltage-line').value,
                blowerAmps: $('blower-amps').value,
                superheat: $('superheat').value,
                subcool: $('subcool').value,
            },
            components: {
                filter: $('filter').value,
                evapCoil: $('evap-coil').value,
                contactor: $('contactor').value,
                capacitor: $('capacitor').value,
            },
            findings: $('findings').value,
            recommendations: $('recommendations').value
        } : null,
        // Install-Specific Data
        install: mode === 'Install' ? {
            checklist: Array.from(document.querySelectorAll('#card-install-checklist input[type="checkbox"]:checked')).map(cb => cb.id),
            chargeAdded: $('install-charge-added').value,
            startupNotes: $('startup-notes').value
        } : null,
        // Ductwork-Specific Data
        ductwork: mode === 'Ductwork' ? {
            material: $('duct-material').value,
            sealing: $('duct-sealing').value,
            numSupply: $('num-supply-vents').value,
            numReturn: $('num-return-grilles').value,
            notes: $('airflow-audit-notes').value,
            summary: $('duct-repair-summary').value
        } : null,
        photos: photos
      };
      
      // Store in sessionStorage
      sessionStorage.setItem('currentReport', JSON.stringify(report));
      
      displayReport(report);
    }
    
    function displayReport(report) {
      const summary = generateTextSummary(report);

      // Display in a card
      const reportCard = document.createElement('div');
      reportCard.className = 'card';
      reportCard.innerHTML = `
        <div class="card-header">Generated Report - ${report.meta.mode}</div>
        <pre class="report-preview">${summary}</pre>
        <button onclick="copyReport()" class="success mt-8">üìã Copy to Clipboard</button>
      `;
      
      // Remove old report and insert new one
      const existingReport = document.querySelector('.report-preview').closest('.card');
      if (existingReport) existingReport.remove();
      document.querySelector('.actions').before(reportCard);
      
      reportCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function generateTextSummary(report) {
        let summary = `
HVAC FIELD REPORT - ${report.meta.mode.toUpperCase()}
======================================================
Technician: ${report.meta.tech}
Date: ${report.meta.date}
Mode: ${report.meta.mode} - ${report.meta.heatCoolMode.toUpperCase()}
------------------------------------------------------
Customer: ${report.job.customer}
Address: ${report.job.address}
Job Type: ${report.job.jobType}
Location: ${report.job.location}

${report.job.complaint ? `CUSTOMER COMPLAINT:
  ${report.job.complaint}
` : ''}
EQUIPMENT IDENTITY
------------------
Indoor: ${report.equipment.indoor}
Outdoor: ${report.equipment.outdoor}
Refrigerant: ${report.equipment.refrigerant} | Mfg Date: ${report.equipment.mfgDate}
Unit Type: ${report.equipment.unitType}

`;

        if (report.meta.mode === 'Service') {
            summary += `
OPERATING CONDITIONS
--------------------
Airflow:
  Delta T: ${report.service.operating.deltaT} (${report.service.operating.returnTemp}¬∞F -> ${report.service.operating.supplyTemp}¬∞F)
  Total Static: ${report.service.operating.totalStatic}
Electrical:
  Voltage (L1-L2): ${report.service.operating.voltageLine}V
  Blower Amps: ${report.service.operating.blowerAmps}
Refrigerant (COOLING):
  Superheat/Subcool: ${report.service.operating.superheat} / ${report.service.operating.subcool}

COMPONENT CHECKLIST
-------------------
Filter: ${report.service.components.filter}
Evap Coil: ${report.service.components.evapCoil} | Contactor: ${report.service.components.contactor}
Capacitor: ${report.service.components.capacitor}

SAFETY CHECK
------------
Disconnect: ${report.service.safety.disconnect ? 'OK' : 'FAIL'} | Drain/Float: ${report.service.safety.drain ? 'OK' : 'FAIL'}
CO Test: ${report.service.safety.co === undefined ? 'N/A' : report.service.safety.co ? 'PASS' : 'FAIL'}

FINDINGS & RECOMMENDATIONS
--------------------------
Findings: ${report.service.findings}

Recommendations: ${report.service.recommendations}
`;
        } else if (report.meta.mode === 'Install') {
            summary += `
INSTALLATION CHECKLIST
----------------------
${report.install.checklist.map(item => `‚úì ${item.replace('install-', '').toUpperCase()}`).join('\n')}

Startup Notes: ${report.install.startupNotes}
Refrigerant Added: ${report.install.chargeAdded}
`;
        } else if (report.meta.mode === 'Ductwork') {
            summary += `
AIR DISTRIBUTION AUDIT
----------------------
Material/Sealing: ${report.ductwork.material} / ${report.ductwork.sealing.toUpperCase()}
Vents/Grilles: ${report.ductwork.numSupply} Supply / ${report.ductwork.numReturn} Return
Airflow Notes: ${report.ductwork.notes}

Work Summary:
${report.ductwork.summary}
`;
        }

        summary += `
PHOTO DOCUMENTATION
-------------------
${report.photos.length} Photo(s) Attached.

${report.meta.tech} CERTIFIES ACCURACY.
`;
        return summary;
    }

    function copyReport() {
      const text = document.querySelector('.report-preview').textContent;
      navigator.clipboard.writeText(text)
        .then(() => alert('‚úì Report copied to clipboard!'))
        .catch(() => alert('Copy failed.'));
    }

    function exportPDF() {
      // Logic for saving as text/pdf (same as previous draft)
      const report = sessionStorage.getItem('currentReport');
      if (!report) {
        alert('Generate report first');
        return;
      }
      
      const text = document.querySelector('.report-preview').textContent;
      const data = JSON.parse(report);
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `FieldBuddy_Report_${data.job.customer.replace(/\s/g, '_')}_${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // ==================== LOAD/SAVE DRAFT ====================
    function autoSave() {
      const draft = {
        customer: $('customer').value,
        address: $('address').value,
        jobType: $('job-type').value,
        complaint: $('complaint').value,
        location: $('location').value,
        // Add all fields here for robust saving...
      };
      sessionStorage.setItem('draft', JSON.stringify(draft));
    }
    
    window.addEventListener('load', () => {
      // Auto-save logic simplified for brevity but functional
      document.addEventListener('input', autoSave);
      
      const draft = sessionStorage.getItem('draft');
      if (draft && confirm('Resume previous session?')) {
        const data = JSON.parse(draft);
        $('customer').value = data.customer || '';
        $('address').value = data.address || '';
        $('job-type').value = data.jobType || '';
        if ($('complaint')) $('complaint').value = data.complaint || '';
        $('location').value = data.location || '';
        // Load other fields...
      }
    });

  </script>
</body>
</html>

