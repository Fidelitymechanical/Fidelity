<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>Field Buddy Pro ‚Äì Full PWA</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f8fafc; margin: 0; padding: 1rem; color: #0f172a; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #0f172a; color: #fff; border-radius: .5rem; }
    main { margin-top: 1rem; }
    h1 { font-size: 1.5rem; margin: 0; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: .25rem; cursor: pointer; }
    .btn.primary { background: #2563eb; color: #fff; }
    .btn.outline { border: 1px solid #2563eb; background: none; color: #2563eb; }
    .card { background: #fff; border-radius: .5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 1rem; margin-bottom: 1rem; }
    label { display: block; margin-top: 0.5rem; }
    input, textarea, select { width: 100%; padding: 0.5rem; margin-top: 0.25rem; border: 1px solid #cbd5e1; border-radius: .25rem; }
    .grid { display: grid; gap: 1rem; }
    .grid.two { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    #saveIndicator { display: none; background: #fde68a; color: #92400e; padding: .5rem; border-radius: .25rem; margin: 1rem 0; text-align: center; }
    #saveIndicator.show { display: block; }
  </style>
</head>
<body>
  <header>
    <h1>Field Buddy Pro</h1>
    <button id="btnInstall" class="btn outline" style="display:none">‚¨áÔ∏è Install App</button>
  </header>  <div id="saveIndicator"></div>  <main>
    <section class="card">
      <h2>Site & Job Info</h2>
      <div class="grid two">
        <label>Customer <input id="customerName" /></label>
        <label>Date <input type="date" id="inspectionDate" /></label>
        <label>Address <input id="address" /></label>
        <label>Ambient Temp (¬∞F) <input id="ambientF" type="number" /></label>
        <label>Relative Humidity (%) <input id="ambientRH" type="number" /></label>
      </div>
    </section><section class="card">
  <h2>System Data</h2>
  <div class="grid two">
    <label>Suction Pressure (psig) <input id="suctionPSI" type="number" /></label>
    <label>Head Pressure (psig) <input id="headPSI" type="number" /></label>
    <label>Superheat (¬∞F) <input id="superheat" type="number" /></label>
    <label>Subcooling (¬∞F) <input id="subcool" type="number" /></label>
    <label>Capacitor Rating (¬µF) <input id="capRating" type="number" /></label>
    <label>Capacitor Reading (¬µF) <input id="capReading" type="number" /></label>
  </div>
  <label>Additional Notes <textarea id="notes"></textarea></label>
</section>

<section class="card">
  <h2>Summary & Recommendation</h2>
  <textarea id="summary" rows="5" placeholder="Summarize diagnosis, findings, and recommended repair here..."></textarea>
</section>

<section>
  <button id="saveBtn" class="btn primary">üíæ Save Locally</button>
  <button id="exportBtn" class="btn outline">‚¨áÔ∏è Export JSON</button>
</section>

  </main>  <script>
    // ---- PWA Install ----
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('btnInstall').style.display = 'inline-block';
    });
    document.getElementById('btnInstall').addEventListener('click', async () => {
      if (!deferredPrompt) return;
      await deferredPrompt.prompt();
      deferredPrompt = null;
      document.getElementById('btnInstall').style.display = 'none';
    });

    // ---- Service Worker ----
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('/service-worker.js');
          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                const ind = document.getElementById('saveIndicator');
                ind.textContent = '‚¨ÜÔ∏è Update ready ‚Äî tap to refresh';
                ind.classList.add('show');
                ind.onclick = () => location.reload();
              }
            });
          });
        } catch (err) { console.warn('SW error', err); }
      });
    }

    // ---- Draft Save to LocalStorage ----
    const STORAGE_KEY = 'fieldbuddy_full_draft';
    const inputs = document.querySelectorAll('input, textarea');
    function saveDraft() {
      const data = {};
      inputs.forEach(i => data[i.id] = i.value);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      const ind = document.getElementById('saveIndicator');
      ind.textContent = 'üíæ Draft saved';
      ind.classList.add('show');
      setTimeout(()=>ind.classList.remove('show'), 2000);
    }

    document.getElementById('saveBtn').addEventListener('click', saveDraft);

    // Auto-save on input
    inputs.forEach(i => i.addEventListener('input', saveDraft));

    // Restore draft
    const draft = localStorage.getItem(STORAGE_KEY);
    if (draft) {
      const data = JSON.parse(draft);
      Object.keys(data).forEach(k => {
        const el = document.getElementById(k);
        if (el) el.value = data[k];
      });
    }

    // Export JSON
    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = {};
      inputs.forEach(i => data[i.id] = i.value);
      const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'FieldBuddyReport.json';
      a.click();
    });
  </script></body>
</html>
