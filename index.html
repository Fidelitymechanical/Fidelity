<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Field Buddy Pro ‚Äî HVAC Inspection & Reporting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">

  <!--
    Security hardening notes (set as server headers when possible):
      Content-Security-Policy:
        default-src 'self';
        script-src 'self' https://cdnjs.cloudflare.com 'strict-dynamic';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self';
        object-src 'none';
        base-uri 'none';
        frame-ancestors 'none';

      Referrer-Policy: no-referrer
      Permissions-Policy: camera=(), microphone=(), geolocation=(), clipboard-read=()
      X-Content-Type-Options: nosniff
      Cross-Origin-Opener-Policy: same-origin
  -->

  <!-- html2pdf for PDF export (correct SRI) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
          integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--ink:#1f2937;--muted:#6b7280;--primary:#2563eb;--border:#e5e7eb;
      --good:#16a34a;--warn:#d97706;--bad:#dc2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,sans-serif;color:var(--ink);background:var(--bg);-webkit-text-size-adjust:100%}
    .wrap{max-width:1080px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#0f172a 0%,#111827 100%);color:#fff;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    header h1{margin:0 0 6px;font-size:18px}
    header .sub{font-size:12px;color:#cbd5e1}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;align-items:center}
    .btn{background:var(--primary);color:#fff;border:0;border-radius:8px;padding:14px 18px;font-size:15px;font-weight:600;cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-height:48px;display:inline-flex;align-items:center;justify-content:center;gap:6px}
    .btn.secondary{background:#334155}
    .btn.outline{background:transparent;color:#e5e7eb;border:1px solid #475569}
    .btn.warn{background:var(--warn)}
    .btn.good{background:var(--good)}
    .btn.gray{background:#6b7280}
    .btn.small{padding:10px 14px;font-size:13px;min-height:40px}
    .right{margin-left:auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(17,24,39,.05)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px;font-weight:500}
    input[type="text"],input[type="number"],input[type="date"],textarea{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:8px;font-size:16px;background:#fff;touch-action:manipulation;-webkit-appearance:none
    }
    input[type="number"]{font-size:17px}
    textarea{min-height:100px;resize:vertical;line-height:1.5}
    .section-title{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:10px;font-weight:700;font-size:16px}
    details{border:1px dashed var(--border);border-radius:8px;padding:10px 12px;margin:10px 0}
    details[open]{border-style:solid}
    details summary{cursor:pointer;font-weight:700;margin:6px 0;font-size:15px;padding:6px 0;touch-action:manipulation}
    .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:999px;font-size:14px;margin:4px 6px 4px 0;touch-action:manipulation;min-height:44px}
    .chip input[type="checkbox"]{width:20px;height:20px;margin:0}
    .score-box{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:12px}
    .score{font-weight:800;font-size:20px}
    .score.good{color:var(--good)} .score.warn{color:var(--warn)} .score.bad{color:var(--bad)}
    .muted{color:var(--muted)} .notice{font-size:13px;color:var(--muted)}
    .summary-box{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:14px;white-space:pre-wrap;font-size:14px;line-height:1.6}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .sticky-actions{position:sticky;bottom:10px;z-index:4;display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
    .toggle{display:inline-flex;align-items:center;gap:8px;color:#cbd5e1;font-size:13px}
    .voice-input-wrapper{position:relative}
    .voice-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--primary);color:#fff;border:0;border-radius:6px;padding:8px 12px;font-size:20px;cursor:pointer;z-index:2;min-height:36px;display:flex;align-items:center;justify-content:center}
    .voice-btn.listening{background:var(--bad);animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .save-indicator{position:fixed;bottom:20px;right:20px;background:var(--good);color:#fff;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;z-index:999;box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;transition:opacity .3s}
    .save-indicator.show{opacity:1}
    .input-group{position:relative}
    .input-group input[type="text"]{padding-right:50px}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <h1>Field Buddy Pro ‚Äî HVAC Inspection & Reporting</h1>
      <div class="sub">Mobile-optimized field inspection with voice input</div>
      <div class="toolbar">
        <button class="btn" id="btnAddSystem">‚ûï Add System</button>
        <button class="btn secondary" id="btnExpandAll">Expand All</button>
        <button class="btn secondary" id="btnCollapseAll">Collapse All</button>
        <button class="btn good" id="btnGenerate">üìä Generate Reports</button>
        <button class="btn outline small" id="btnToday">Today</button>
        <button class="btn warn small" id="btnClear">üóëÔ∏è Clear All</button>
      </div>
    </header>

    <!-- Job Header -->
    <section class="card" id="jobHeader">
      <div class="section-title"><div>Job Context</div></div>
      <div class="grid-3">
        <div class="input-group voice-input-wrapper">
          <label>Customer Name</label>
          <input type="text" id="customerName" placeholder="Full name">
          <button class="voice-btn" data-voice-for="customerName">üé§</button>
        </div>
        <div><label>Inspection Date</label><input type="date" id="inspectionDate"></div>
        <div><label>Technician</label><input type="text" id="technicianName" placeholder="Your name" readonly></div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div class="input-group voice-input-wrapper">
          <label>Address</label>
          <input type="text" id="address" placeholder="Street, City, State">
          <button class="voice-btn" data-voice-for="address">üé§</button>
        </div>
        <div><label>Ambient Temperature (F)</label><input type="number" inputmode="decimal" step="0.1" id="ambientF"></div>
        <div><label>Ambient Humidity (%)</label><input type="number" inputmode="decimal" step="1" id="ambientRH"></div>
      </div>
    </section>

    <!-- Systems container -->
    <div id="systems"></div>

    <!-- Reports -->
    <section class="card" id="reportsCard" style="display:none;">
      <div class="section-title"><div>Reports</div></div>
      <div style="margin-bottom:10px">
        <button class="btn good small" id="btnCopyCustomer">üìã Copy Customer Summary</button>
        <button class="btn good small" id="btnCopyOffice">üìã Copy Office Summary</button>
      </div>
      <div class="summary-box" id="customerSummary"></div>
      <div class="divider"></div>
      <div class="summary-box" id="officeSummary"></div>
      <div class="sticky-actions">
        <button class="btn good" id="btnPDF2">üìÑ Export PDF</button>
        <button class="btn outline" id="btnHTML2">üìù Export HTML</button>
        <button class="btn outline" id="btnJSON2">üíæ Export JSON</button>
      </div>
    </section>
  </div>

  <!-- Save indicator -->
  <div class="save-indicator" id="saveIndicator">‚úì Draft saved</div>

  <!-- System Template -->
  <template id="systemTemplate">
    <section class="card" data-system>
      <div class="section-title">
        <div>System <span data-sysname>#</span></div>
        <div>
          <button class="btn gray small btnToggle">Toggle</button>
          <button class="btn warn small btnRemove">Remove</button>
        </div>
      </div>

      <!-- Identity -->
      <div class="grid-3">
        <div class="input-group voice-input-wrapper">
          <label>Area Served (e.g., Upstairs)</label>
          <input type="text" data-field="meta.zone" placeholder="Zone / Floor">
          <button class="voice-btn" data-voice-for="meta.zone">üé§</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Brand / Model</label>
          <input type="text" data-field="meta.brandModel" placeholder="Brand and model">
          <button class="voice-btn" data-voice-for="meta.brandModel">üé§</button>
        </div>
        <div>
          <label>Refrigerant Type</label>
          <input type="text" list="refrig-list" data-field="meta.refrigerant" placeholder="R-410A / R-22 / R-32">
        </div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div class="input-group voice-input-wrapper">
          <label>Indoor Model / Serial</label>
          <input type="text" data-field="meta.indoorMS" placeholder="Model / Serial">
          <button class="voice-btn" data-voice-for="meta.indoorMS">üé§</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Outdoor Model / Serial</label>
          <input type="text" data-field="meta.outdoorMS" placeholder="Model / Serial">
          <button class="voice-btn" data-voice-for="meta.outdoorMS">üé§</button>
        </div>
        <div><label>Equipment Age (yrs)</label><input type="number" inputmode="decimal" step="0.1" data-field="meta.age" placeholder="e.g., 6.0"></div>
      </div>

      <!-- Safety -->
      <details open>
        <summary>Safety</summary>
        <div>
          <label class="chip"><input type="checkbox" data-field="safety.coDetector"> CO detector present</label>
          <label class="chip"><input type="checkbox" data-field="safety.floatPrimary"> Float switch (primary)</label>
          <label class="chip"><input type="checkbox" data-field="safety.floatPan"> Float switch (pan)</label>
          <label class="chip"><input type="checkbox" data-field="safety.clearances"> Clearances OK</label>
          <label class="chip"><input type="checkbox" data-field="safety.disconnect"> Outdoor disconnect OK</label>
        </div>
        <div class="input-group voice-input-wrapper" style="margin-top:8px">
          <label>Notes</label>
          <textarea data-field="safety.notes" placeholder="Safety observations, venting, gas line, electrical, etc."></textarea>
          <button class="voice-btn" data-voice-for="safety.notes" style="top:40px">üé§</button>
        </div>
      </details>

      <!-- Mechanical -->
      <details open>
        <summary>Mechanical</summary>
        <div class="grid-4">
          <div><label>Return Air (F)</label><input type="number" inputmode="decimal" step="0.1" data-field="mech.returnF" class="calc-delta"></div>
          <div><label>Supply Air (F)</label><input type="number" inputmode="decimal" step="0.1" data-field="mech.supplyF" class="calc-delta"></div>
          <div><label>Temp Split (auto)</label><input type="text" data-field="mech.deltaT" disabled></div>
          <div>
            <label>Filter Condition</label>
            <input type="text" list="filter-list" data-field="mech.filter" placeholder="Clean / Dirty">
          </div>
        </div>

        <div class="grid-4" style="margin-top:8px">
          <div><label>Return Static (in w.c.)</label><input type="number" inputmode="decimal" step="0.01" data-field="mech.returnStatic" class="calc-static"></div>
          <div><label>Supply Static (in w.c.)</label><input type="number" inputmode="decimal" step="0.01" data-field="mech.supplyStatic" class="calc-static"></div>
          <div><label>Total Static (auto)</label><input type="text" data-field="mech.totalStatic" disabled></div>
          <div class="input-group voice-input-wrapper">
            <label>Airflow Notes</label>
            <input type="text" data-field="mech.airflowNotes" placeholder="Balance, restriction">
            <button class="voice-btn" data-voice-for="mech.airflowNotes">üé§</button>
          </div>
        </div>

        <div class="grid-4" style="margin-top:8px">
          <div><label>Suction Pressure (psig)</label><input type="number" inputmode="decimal" step="0.1" data-field="mech.suction"></div>
          <div><label>Head Pressure (psig)</label><input type="number" inputmode="decimal" step="0.1" data-field="mech.head"></div>
          <div><label>Superheat (F)</label><input type="number" inputmode="decimal" step="0.1" data-field="mech.sh"></div>
          <div><label>Subcool (F)</label><input type="number" inputmode="decimal" step="0.1" data-field="mech.sc"></div>
        </div>

        <div class="grid-4" style="margin-top:8px">
          <div class="input-group voice-input-wrapper">
            <label>Blower Amps (actual/rated)</label>
            <input type="text" data-field="mech.blowerAmps" placeholder="e.g., 5.8/5.0">
            <button class="voice-btn" data-voice-for="mech.blowerAmps">üé§</button>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Compressor Amps (actual/rated)</label>
            <input type="text" data-field="mech.compAmps" placeholder="e.g., 15.0/14.0">
            <button class="voice-btn" data-voice-for="mech.compAmps">üé§</button>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Electrical Notes</label>
            <input type="text" data-field="mech.electrical" placeholder="Capacitor, contactor">
            <button class="voice-btn" data-voice-for="mech.electrical">üé§</button>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Mechanical Notes</label>
            <input type="text" data-field="mech.notes" placeholder="Noise, vibration">
            <button class="voice-btn" data-voice-for="mech.notes">üé§</button>
          </div>
        </div>
      </details>

      <!-- Health -->
      <details open>
        <summary>Health</summary>
        <div>
          <label class="chip"><input type="checkbox" data-field="health.microbialLight"> Microbial (light)</label>
          <label class="chip"><input type="checkbox" data-field="health.microbialHeavy"> Microbial (heavy)</label>
          <label class="chip"><input type="checkbox" data-field="health.ductLeaks"> Duct/plenum leaks</label>
          <label class="chip"><input type="checkbox" data-field="health.filterOverdue"> Filter overdue</label>
          <label class="chip"><input type="checkbox" data-field="health.drainIssues"> Drain algae / slow flow</label>
        </div>
        <div class="input-group voice-input-wrapper" style="margin-top:8px">
          <label>Notes</label>
          <textarea data-field="health.notes" placeholder="Odors, contamination, plenum condition, insulation"></textarea>
          <button class="voice-btn" data-voice-for="health.notes" style="top:40px">üé§</button>
        </div>
      </details>

      <!-- Scores -->
      <div class="score-box" style="margin-top:10px">
        <div class="grid-4">
          <div><span class="muted">Safety</span><div class="score" data-score="safety">‚Äì</div></div>
          <div><span class="muted">Mechanical</span><div class="score" data-score="mechanical">‚Äì</div></div>
          <div><span class="muted">Health</span><div class="score" data-score="health">‚Äì</div></div>
          <div><span class="muted">Overall / Confidence</span><div class="score" data-score="overall">‚Äì</div><div class="notice">Conf: <span data-score="confidence">‚Äì</span>%</div></div>
        </div>
      </div>
    </section>
  </template>

  <!-- Datalists -->
  <datalist id="refrig-list">
    <option value="R-410A">
    <option value="R-22">
    <option value="R-32">
    <option value="R-454B">
  </datalist>
  <datalist id="filter-list">
    <option value="Clean">
    <option value="Dirty">
    <option value="Overdue">
    <option value="Replaced">
  </datalist>

  <script>
    // ---------- Utilities ----------
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
    const toNum = v => { const n = parseFloat(v); return isNaN(n) ? null : n; };
    const isTrue = v => v===true || v==='on' || v===1 || v==='1';

    // ---------- Init ----------
    $('#inspectionDate').valueAsDate = new Date();
    $('#technicianName').value = 'M. Perez';
    let sysCount = 0;
    addSystem();

    // ---------- Storage (sessionStorage only - fresh start on reload) ----------
    const STORAGE_KEY = 'fieldbuddy_draft_v1';
    const storage = {
      load(){ try { const raw = sessionStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } },
      save(obj){ try { sessionStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch(e){} },
      clear(){ try { sessionStorage.removeItem(STORAGE_KEY); } catch(e){} }
    };

    // ---------- Voice Input ----------
    let recognition = null;
    let currentVoiceTarget = null;

    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (e) => {
        if(e.results.length > 0 && currentVoiceTarget){
          const transcript = e.results[0][0].transcript;
          if(currentVoiceTarget.tagName === 'TEXTAREA'){
            currentVoiceTarget.value = (currentVoiceTarget.value ? currentVoiceTarget.value + ' ' : '') + transcript;
          } else {
            currentVoiceTarget.value = transcript;
          }
          currentVoiceTarget.dispatchEvent(new Event('input', {bubbles: true}));
          markDirty();
        }
      };

      recognition.onend = () => {
        $$('.voice-btn.listening').forEach(btn => btn.classList.remove('listening'));
      };

      recognition.onerror = (e) => {
        console.error('Speech recognition error:', e.error);
        $$('.voice-btn.listening').forEach(btn => btn.classList.remove('listening'));
        if(e.error !== 'no-speech' && e.error !== 'aborted'){
          alert('Voice input error: ' + e.error);
        }
      };
    }

    function startVoiceInput(btn){
      if(!recognition){
        alert('Voice input not supported on this device/browser');
        return;
      }

      const fieldName = btn.getAttribute('data-voice-for');
      const container = btn.closest('[data-system]') || btn.closest('#jobHeader');
      let targetInput = null;

      if(fieldName.includes('.')){
        targetInput = $(`[data-field="${fieldName}"]`, container);
      } else {
        targetInput = $(`#${fieldName}`, container);
      }

      if(!targetInput) return;

      currentVoiceTarget = targetInput;
      btn.classList.add('listening');
      
      try {
        recognition.start();
      } catch(e) {
        console.error('Could not start recognition:', e);
        btn.classList.remove('listening');
      }
    }

    // Wire all voice buttons
    document.addEventListener('click', (e) => {
      if(e.target.classList.contains('voice-btn')){
        startVoiceInput(e.target);
      }
    });

    // ---------- Template wiring ----------
    function addSystem(){
      const tpl = $('#systemTemplate').content.cloneNode(true);
      sysCount += 1;
      tpl.querySelector('[data-sysname]').textContent = '#' + sysCount;
      const section = tpl.querySelector('[data-system]');
      
      tpl.querySelector('.btnRemove').addEventListener('click', () => section.remove());
      tpl.querySelector('.btnToggle').addEventListener('click', () => {
        const details = $$('details', section);
        const anyOpen = details.some(d => d.open);
        details.forEach(d => d.open = !anyOpen);
      });
      
      $$('.calc-delta', tpl).forEach(el => el.addEventListener('input', onDeltaInput));
      $$('.calc-static', tpl).forEach(el => el.addEventListener('input', onStaticInput));
      $('#systems').appendChild(tpl);
    }

    function onDeltaInput(e){
      const card = e.target.closest('[data-system]');
      const r = toNum($('[data-field="mech.returnF"]', card)?.value);
      const s = toNum($('[data-field="mech.supplyF"]', card)?.value);
      const out = $('[data-field="mech.deltaT"]', card);
      if(r!=null && s!=null){ const v = (r - s).toFixed(1); out.value = v; card.dataset.deltaT = v; }
    }

    function onStaticInput(e){
      const card = e.target.closest('[data-system]');
      const rs = toNum($('[data-field="mech.returnStatic"]', card)?.value);
      const ss = toNum($('[data-field="mech.supplyStatic"]', card)?.value);
      const out = $('[data-field="mech.totalStatic"]', card);
      if(rs!=null && ss!=null){ const v = (Math.abs(rs)+Math.abs(ss)).toFixed(2); out.value = v; card.dataset.totalStatic = v; }
    }

    // ---------- Scoring ----------
    const RULES = {
      safety: [
        { when:c=>!isTrue(c['safety.coDetector']), delta:-1, reason:'CO detector not recorded' },
        { when:c=>!isTrue(c['safety.floatPrimary'])||!isTrue(c['safety.floatPan']), delta:-1, reason:'Missing float switch' },
        { when:c=>!isTrue(c['safety.clearances']), delta:-1, reason:'Clearances not verified' },
        { when:c=>!isTrue(c['safety.disconnect']), delta:-1, reason:'Outdoor disconnect not verified' },
      ],
      mechanical: [
        { when:c=>numLT(c.deltaT,16), delta:-1, reason:'Low temperature split (<16 F)' },
        { when:c=>numGT(c.deltaT,22), delta:-1, reason:'High temperature split (>22 F)' },
        { when:c=>numGT(c.totalStatic,0.50), delta:-2, reason:'High total static (>0.50 in w.c.)' },
        { when:c=>relAmpHigh(c['mech.blowerAmps']), delta:-1, reason:'Blower amps elevated' },
        { when:c=>relAmpHigh(c['mech.compAmps']), delta:-1, reason:'Compressor amps elevated' },
        { when:c=>txtFind(c['mech.notes'],'vibration|grind|hard start|overheat'), delta:-1, reason:'Mechanical noise/start stress' }
      ],
      health: [
        { when:c=>isTrue(c['health.microbialLight']), delta:-2, reason:'Microbial presence (light)' },
        { when:c=>isTrue(c['health.microbialHeavy']), delta:-4, reason:'Microbial presence (heavy)' },
        { when:c=>isTrue(c['health.ductLeaks']), delta:-2, reason:'Duct/plenum leaks' },
        { when:c=>isTrue(c['health.filterOverdue']), delta:-1, reason:'Filter overdue' },
        { when:c=>isTrue(c['health.drainIssues']), delta:-1, reason:'Drain cleanliness issues' },
      ]
    };
    const numLT=(v,t)=>{const n=toNum(v);return n!=null&&n<t;}
    const numGT=(v,t)=>{const n=toNum(v);return n!=null&&n>t;}
    const txtFind=(s,re)=>{if(!s)return false;return new RegExp(re,'i').test(s);}
    const relAmpHigh=(s)=>{ if(!s) return false; const p=s.split('/').map(x=>parseFloat(x)); if(p.length<2||isNaN(p[0])||isNaN(p[1])) return false; return (p[0]-p[1])/p[1]>0.15; };

    function collectCardData(card){
      const data={};
      $$('[data-field]', card).forEach(el=>{
        const key = el.getAttribute('data-field');
        data[key] = (el.type === 'checkbox') ? el.checked : el.value;
      });
      data.deltaT = card.dataset.deltaT || data['mech.deltaT'];
      data.totalStatic = card.dataset.totalStatic || data['mech.totalStatic'];
      return data;
    }

    function writeScore(card,key,val){
      const el = $(`[data-score="${key}"]`, card);
      el.textContent = val;
      el.classList.remove('good','warn','bad');
      if(val>=8) el.classList.add('good');
      else if(val>=5) el.classList.add('warn');
      else el.classList.add('bad');
    }

    function scoreCard(card){
      const c = collectCardData(card);
      const out = { safety:10, mechanical:10, health:10, reasons:{safety:[],mechanical:[],health:[]} };

      for(const r of RULES.safety){ if(r.when(c)){ out.safety+=r.delta; out.reasons.safety.push(r.reason);} }
      for(const r of RULES.mechanical){ if(r.when(c)){ out.mechanical+=r.delta; out.reasons.mechanical.push(r.reason);} }
      for(const r of RULES.health){ if(r.when(c)){ out.health+=r.delta; out.reasons.health.push(r.reason);} }

      out.safety=clamp(out.safety,1,10); out.mechanical=clamp(out.mechanical,1,10); out.health=clamp(out.health,1,10);
      const req=['mech.returnF','mech.supplyF','mech.returnStatic','mech.supplyStatic','mech.blowerAmps','mech.compAmps'];
      const present=req.filter(k=>c[k] && String(c[k]).trim()!=='').length;
      out.confidence = Math.round((present/req.length)*100);
      out.overall = Math.round((out.safety+out.mechanical+out.health)/3);

      writeScore(card,'safety',out.safety);
      writeScore(card,'mechanical',out.mechanical);
      writeScore(card,'health',out.health);
      $('[data-score="overall"]', card).textContent = out.overall;
      $('[data-score="confidence"]', card).textContent = out.confidence;

      card.dataset.scoreReasons = JSON.stringify(out.reasons);
      return out;
    }

    // ---------- Recommendations ----------
    function recommendFromScores(s){
      const rec = { immediate:[], corrective:[], preventive:[] };
      if(s.scores.safety<=7){
        if(!isTrue(s.data['safety.floatPrimary'])||!isTrue(s.data['safety.floatPan'])) rec.immediate.push('Install primary and pan float switches');
        if(!isTrue(s.data['safety.coDetector'])) rec.immediate.push('Add CO detector near combustion appliance');
      }
      if(s.scores.mechanical<=7){
        if(numGT(s.meta.totalStatic,0.50)) rec.corrective.push('Seal/adjust ductwork and plenum to reduce total static pressure');
        if(relAmpHigh(s.data['mech.compAmps'])) rec.preventive.push('Add soft start to reduce compressor inrush stress');
        if(relAmpHigh(s.data['mech.blowerAmps'])) rec.corrective.push('Investigate airflow restriction or blower condition');
      }
      if(s.scores.health<=8){
        if(isTrue(s.data['health.microbialHeavy'])) rec.corrective.push('Replace contaminated plenum/components and apply remediation');
        else if(isTrue(s.data['health.microbialLight'])) rec.corrective.push('Clean and sanitize coil/plenum surfaces; install UV for prevention');
        if(isTrue(s.data['health.ductLeaks'])) rec.corrective.push('Seal plenum/collar leaks with mastic and fasteners');
        if(isTrue(s.data['health.filterOverdue'])) rec.preventive.push('Install media filter cabinet and set filter schedule');
        if(isTrue(s.data['health.drainIssues'])) rec.corrective.push('Clean and re-trap condensate line; verify slope');
      }
      return rec;
    }

    // ---------- Report synthesis ----------
    function buildReports(){
      const systems = [];
      $$('[data-system]').forEach(card=>{
        const data=collectCardData(card);
        const scores=scoreCard(card);
        const reasons=JSON.parse(card.dataset.scoreReasons||'{"safety":[],"mechanical":[],"health":[]}');
        const meta={ zone:data['meta.zone']||'Zone', brandModel:data['meta.brandModel']||'Brand/Model', refrigerant:data['meta.refrigerant']||'',
                     deltaT:data.deltaT||data['mech.deltaT']||'', totalStatic:data.totalStatic||data['mech.totalStatic']||'' };
        const recs=recommendFromScores({data,scores,reasons,meta});
        systems.push({data,scores,reasons,meta,recs});
      });

      const ctx = {
        customer: $('#customerName')?.value || '',
        date: $('#inspectionDate')?.value || '',
        tech: $('#technicianName')?.value || '',
        address: $('#address')?.value || '',
        ambientF: $('#ambientF')?.value || '',
        ambientRH: $('#ambientRH')?.value || '',
        systems
      };

      const { customerText, officeText } = synthesizeReports(ctx);
      $('#customerSummary').textContent = customerText;
      $('#officeSummary').textContent = officeText;
      $('#reportsCard').style.display = 'block';
      window.scrollTo({ top: $('#reportsCard').offsetTop - 10, behavior: 'smooth' });
    }

    function synthesizeReports(ctx){
      const c=[];
      c.push(`HVAC Inspection Summary`);
      c.push(`Customer: ${ctx.customer}`);
      if(ctx.address) c.push(`Address: ${ctx.address}`);
      c.push(`Date: ${ctx.date}    Technician: ${ctx.tech}`);
      if(ctx.ambientF||ctx.ambientRH) c.push(`Ambient: ${ctx.ambientF||'-'} F, ${ctx.ambientRH||'-'} % RH`);
      c.push('');
      ctx.systems.forEach((s,i)=>{
        c.push(`System ${i+1} ‚Äî ${s.meta.zone} (${s.meta.brandModel})`);
        if(s.meta.refrigerant) c.push(`Refrigerant: ${s.meta.refrigerant}`);
        c.push(`Performance: Temperature split ${s.meta.deltaT||'-'} F, Total static ${s.meta.totalStatic||'-'} in w.c.`);
        c.push(`Scores: Safety ${s.scores.safety}/10, Mechanical ${s.scores.mechanical}/10, Health ${s.scores.health}/10, Overall ${s.scores.overall}/10, Confidence ${s.scores.confidence}%`);
        if(s.recs.immediate.length||s.recs.corrective.length||s.recs.preventive.length){
          c.push(`Recommendations:`);
          if(s.recs.immediate.length)  c.push(`  Immediate: ${s.recs.immediate.join('; ')}`);
          if(s.recs.corrective.length) c.push(`  Corrective: ${s.recs.corrective.join('; ')}`);
          if(s.recs.preventive.length) c.push(`  Preventive: ${s.recs.preventive.join('; ')}`);
        }
        c.push('');
      });

      const o=[];
      o.push(`Back Office Technical Summary`);
      o.push(`Customer: ${ctx.customer}    Date: ${ctx.date}    Technician: ${ctx.tech}`);
      if(ctx.address) o.push(`Address: ${ctx.address}`);
      if(ctx.ambientF||ctx.ambientRH) o.push(`Ambient: ${ctx.ambientF||'-'} F, ${ctx.ambientRH||'-'} % RH`);
      o.push('');
      ctx.systems.forEach((s,i)=>{
        o.push(`System ${i+1}: ${s.meta.zone} (${s.meta.brandModel})`);
        o.push(`  Identity: Refrig ${s.meta.refrigerant||'-'}   Age ${s.data['meta.age']||'-'} yrs   Indoor ${s.data['meta.indoorMS']||'-'}   Outdoor ${s.data['meta.outdoorMS']||'-'}`);
        o.push(`  Air Temps: Return ${s.data['mech.returnF']||'-'} F   Supply ${s.data['mech.supplyF']||'-'} F   Split ${s.meta.deltaT||'-'} F`);
        o.push(`  Static: Return ${s.data['mech.returnStatic']||'-'}   Supply ${s.data['mech.supplyStatic']||'-'}   Total ${s.meta.totalStatic||'-'} in w.c.`);
        o.push(`  Refrig: Suction ${s.data['mech.suction']||'-'} psig   Head ${s.data['mech.head']||'-'} psig   SH ${s.data['mech.sh']||'-'} F   SC ${s.data['mech.sc']||'-'} F`);
        o.push(`  Amps:   Blower ${s.data['mech.blowerAmps']||'-'}   Compressor ${s.data['mech.compAmps']||'-'}`);
        if(s.data['mech.filter']) o.push(`  Filter: ${s.data['mech.filter']}`);
        if(s.data['mech.electrical']) o.push(`  Electrical: ${s.data['mech.electrical']}`);
        if(s.data['mech.airflowNotes']) o.push(`  Airflow: ${s.data['mech.airflowNotes']}`);
        if(s.data['safety.notes']) o.push(`  Safety Notes: ${s.data['safety.notes']}`);
        if(s.data['mech.notes']) o.push(`  Mechanical Notes: ${s.data['mech.notes']}`);
        if(s.data['health.notes']) o.push(`  Health Notes: ${s.data['health.notes']}`);
        o.push(`  Scores: Safety ${s.scores.safety}/10   Mechanical ${s.scores.mechanical}/10   Health ${s.scores.health}/10   Overall ${s.scores.overall}/10   Confidence ${s.scores.confidence}%`);
        const reasons = s.reasons;
        if(Object.values(reasons).some(a=>a.length)){
          o.push(`  Score drivers:`);
          if(reasons.safety.length) o.push(`    Safety: ${reasons.safety.join('; ')}`);
          if(reasons.mechanical.length) o.push(`    Mechanical: ${reasons.mechanical.join('; ')}`);
          if(reasons.health.length) o.push(`    Health: ${reasons.health.join('; ')}`);
        }
        o.push(`  Tiered Recommendations:`);
        o.push(`    Immediate: ${s.recs.immediate.join('; ') || 'None'}`);
        o.push(`    Corrective: ${s.recs.corrective.join('; ') || 'None'}`);
        o.push(`    Preventive: ${s.recs.preventive.join('; ') || 'None'}`);
        o.push('');
      });

      return { customerText:c.join('\n'), officeText:o.join('\n') };
    }

    // ---------- Exports ----------
    function exportPDF(){
      buildReports(); // Auto-generate before export
      const el = document.body.cloneNode(true);
      el.querySelectorAll('.toolbar, .sticky-actions, .voice-btn, #saveIndicator').forEach(b => b && (b.style.display='none'));
      const opt = {
        margin: 0.5,
        filename: `FieldBuddy_${($('#customerName').value || 'Report')}_${($('#inspectionDate').value || new Date().toISOString().slice(0,10))}.pdf`,
        image: { type:'jpeg', quality:0.98 },
        html2canvas: { scale:2, useCORS:true },
        jsPDF: { unit:'in', format:'letter', orientation:'portrait' }
      };
      html2pdf().set(opt).from(el).save();
    }
    function exportHTML(){
      buildReports(); // Auto-generate before export
      const doc = `<!doctype html><html><head><meta charset="utf-8"><title>Field Buddy Report</title><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:0 auto;padding:16px;white-space:pre-wrap}h2{border-bottom:1px solid #ddd;padding-bottom:6px}</style></head><body><h2>Customer Summary</h2>${escapeHtml($('#customerSummary').textContent)}<h2>Back Office Summary</h2>${escapeHtml($('#officeSummary').textContent)}</body></html>`;
      const blob = new Blob([doc], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `FieldBuddy_${($('#customerName').value || 'Report')}_${($('#inspectionDate').value || new Date().toISOString().slice(0,10))}.html`;
      a.click(); URL.revokeObjectURL(a.href);
    }
    function exportJSON(){
      buildReports(); // Auto-generate before export
      const payload = {
        customer: $('#customerName')?.value || '',
        date: $('#inspectionDate')?.value || '',
        tech: $('#technicianName')?.value || '',
        address: $('#address')?.value || '',
        ambientF: $('#ambientF')?.value || '',
        ambientRH: $('#ambientRH')?.value || '',
        systems: []
      };
      $$('[data-system]').forEach(card=>{
        const data = collectCardData(card);
        const scores = scoreCard(card);
        payload.systems.push({ data, scores });
      });
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `FieldBuddy_${($('#customerName').value || 'Report')}_${($('#inspectionDate').value || new Date().toISOString().slice(0,10))}.json`;
      a.click(); URL.revokeObjectURL(a.href);
    }
    const escapeHtml = (str) => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // ---------- Copy to clipboard ----------
    function copyToClipboard(text, label){
      navigator.clipboard.writeText(text)
        .then(()=> alert(`‚úì ${label} copied! Ready to paste.`))
        .catch(()=> alert('Copy failed. Please select and copy manually.'));
    }

    // ---------- Draft persistence ----------
    function gatherDraft(){
      const draft = {
        header: {
          customer: $('#customerName').value || '',
          date: $('#inspectionDate').value || '',
          address: $('#address').value || '',
          ambientF: $('#ambientF').value || '',
          ambientRH: $('#ambientRH').value || ''
        },
        systems: []
      };
      $$('[data-system]').forEach(card=> draft.systems.push(collectCardData(card)));
      return draft;
    }

    let dirty = false;
    function markDirty(){ dirty = true; }
    
    function saveDraft(showIndicator=false){
      if(!dirty) return;
      const draft = gatherDraft();
      storage.save(draft);
      dirty = false;
      if(showIndicator){
        const ind = $('#saveIndicator');
        ind.classList.add('show');
        setTimeout(()=> ind.classList.remove('show'), 2000);
      }
    }

    function clearDraft(){
      if(confirm('Clear all data and start fresh?')){
        storage.clear(); 
        location.reload();
      }
    }

    // ---------- Global wiring ----------
    $('#btnAddSystem').addEventListener('click', addSystem);
    $('#btnExpandAll').addEventListener('click', ()=> $$('[data-system] details').forEach(d=> d.open=true));
    $('#btnCollapseAll').addEventListener('click', ()=> $$('[data-system] details').forEach(d=> d.open=false));
    $('#btnGenerate').addEventListener('click', buildReports);
    $('#btnPDF2').addEventListener('click', exportPDF);
    $('#btnHTML2').addEventListener('click', exportHTML);
    $('#btnJSON2').addEventListener('click', exportJSON);
    $('#btnClear').addEventListener('click', clearDraft);
    $('#btnToday').addEventListener('click', ()=> $('#inspectionDate').valueAsDate = new Date());
    $('#btnCopyCustomer').addEventListener('click', ()=> copyToClipboard($('#customerSummary').textContent, 'Customer Summary'));
    $('#btnCopyOffice').addEventListener('click', ()=> copyToClipboard($('#officeSummary').textContent, 'Office Summary'));

    // Mark dirty on any input
    $('#app').addEventListener('input', markDirty);

    // Auto-save every 5 seconds after changes
    setInterval(()=> {
      if(dirty) saveDraft(true);
    }, 5000);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=> {
      if(e.ctrlKey || e.metaKey){
        if(e.key === 's'){ e.preventDefault(); saveDraft(true); }
        if(e.key === 'n'){ e.preventDefault(); addSystem(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }
        if(e.key === 'g'){ e.preventDefault(); buildReports(); }
      }
    });

    // NO auto-load on startup - always start fresh
  </script>
</body>
</html>
