<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <meta name="description" content="Professional HVAC field documentation and materials system">
  <title>Field Buddy Pro v1.5 - Intelligent Validation</title>
  <style>
    /* ==================== BASE STYLES (v1.0) ==================== */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    html {
      scroll-padding-top: 20px;
    }
    
    body { 
      font: 16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #f5f5f5;
      padding: 8px;
      padding-bottom: 90px;
      color: #1a1a1a;
    }
    
    /* ==================== INPUTS (v1.0) ==================== */
    input, select, textarea, button {
      font-size: 16px;
      padding: 14px;
      border: 2px solid #ddd;
      border-radius: 8px;
      width: 100%;
      margin: 8px 0;
      font-family: inherit;
      -webkit-appearance: none;
      background: white;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #007AFF;
      box-shadow: 0 0 0 2px rgba(0,122,255,0.2);
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }
    
    input[readonly] {
      background: #f8f8f8;
      color: #666;
      cursor: not-allowed;
    }
    
    input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: #007AFF;
      flex-shrink: 0;
    }
    
    label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    label.check {
      display: flex;
      align-items: center;
      font-size: 15px;
      color: #1a1a1a;
      margin: 10px 0;
      padding: 12px;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid #e0e0e0;
      transition: all 0.2s;
    }
    
    label.check:hover {
      background: #f8f8f8;
      border-color: #007AFF;
    }
    
    label.check input:checked {
      accent-color: #34C759;
    }
    
    label.check.checked {
      background: #e6f7ec;
      border-color: #34C759;
    }
    
    /* ==================== BUTTONS (v1.0) ==================== */
    button {
      background: #007AFF;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
    }
    
    button:active {
      opacity: 0.7;
      transform: scale(0.98);
    }
    
    button.secondary { background: #8E8E93; }
    button.success { background: #34C759; }
    button.danger { background: #FF3B30; }
    button.warning { background: #FF9500; }
    button.small { 
      padding: 10px 14px;
      font-size: 14px;
      min-height: 40px;
    }
    
    /* ==================== CARDS (v1.0) ==================== */
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .card-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .card-subheader {
      font-size: 15px;
      font-weight: 600;
      color: #007AFF;
      margin: 16px 0 8px 0;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }
    
    /* ==================== GRID LAYOUTS (v1.0) ==================== */
    .grid-2 { 
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    
    .grid-3 { 
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    
    .grid-4 { 
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    
    @media (max-width: 640px) {
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
    }
    
    /* ==================== MODE TOGGLE (v1.0) ==================== */
    .mode-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 12px 0;
    }
    
    .mode-toggle button {
      background: white;
      color: #666;
      border: 2px solid #ddd;
      font-size: 15px;
      padding: 12px;
      min-height: 44px;
    }
    
    .mode-toggle button.active {
      background: #007AFF;
      color: white;
      border-color: #007AFF;
    }
    
    /* ==================== STATUS INDICATORS (v1.0) ==================== */
    .status {
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1.4;
    }
    
    .status.good { 
      background: #D1F4E0; 
      color: #0F5132; 
      border-left: 4px solid #34C759;
    }
    
    .status.warn { 
      background: #FFF3CD; 
      color: #664D03; 
      border-left: 4px solid #FF9500;
    }
    
    .status.bad { 
      background: #F8D7DA; 
      color: #842029; 
      border-left: 4px solid #FF3B30;
    }
    
    .status.info {
      background: #D1ECF1;
      color: #0C5460;
      border-left: 4px solid #007AFF;
    }
    
    /* ==================== VOICE INPUT (v1.0) ==================== */
    .voice-wrapper {
      position: relative;
    }
    
    .voice-btn {
      position: absolute;
      right: 4px;
      top: 12px;
      transform: translateY(0);
      width: 40px;
      height: 40px;
      padding: 0;
      background: #007AFF;
      border-radius: 50%;
      font-size: 20px;
      z-index: 2;
      min-height: unset;
      margin: 0;
    }

    textarea + .voice-btn {
      top: 12px;
    }
    
    .voice-btn.listening { 
      background: #FF3B30;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .voice-wrapper input,
    .voice-wrapper textarea {
      padding-right: 50px;
    }

    /* ==================== DYNAMIC FIELDS (v1.0) ==================== */
    .dynamic-item {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      border: 1px solid #e0e0e0;
      position: relative;
    }
    
    .dynamic-item .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #FF3B30;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: unset;
      padding: 0;
      margin: 0;
    }
    
    .add-btn {
      background: #34C759;
      margin-top: 8px;
    }
    
    /* ==================== COLLAPSIBLE SECTIONS (v1.0) ==================== */
    .section {
      margin: 16px 0;
    }
    
    .section-toggle {
      background: white;
      border: 2px solid #ddd;
      color: #1a1a1a;
      font-weight: 600;
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-radius: 8px;
      margin: 8px 0;
      transition: all 0.2s;
      width: 100%;
      text-align: left;
      min-height: 48px;
    }
    
    .section-toggle:hover {
      background: #f8f8f8;
      border-color: #007AFF;
    }
    
    .section-toggle .arrow {
      font-size: 18px;
      transition: transform 0.2s;
      transform-origin: center;
    }
    
    .section.open .arrow {
      transform: rotate(180deg);
    }
    
    .section-content {
      display: none;
      background: white;
      padding: 16px;
      border-radius: 0 0 8px 8px;
      border: 2px solid #ddd;
      border-top: none;
      margin-top: -8px;
    }
    
    .section.open .section-content {
      display: block;
    }
    
    /* ==================== MODE-SPECIFIC VISIBILITY (v1.0) ==================== */
    .service-only,
    .materials-only,
    .cooling-only,
    .heating-only { 
      display: none; 
    }
    
    body.mode-service .service-only { display: block; }
    body.mode-materials .materials-only { display: block; }
    
    body.mode-service.mode-cooling .cooling-only { display: block; }
    body.mode-service.mode-heating .heating-only { display: block; }

    .grid-2 .cooling-only,
    .grid-2 .heating-only,
    .grid-3 .cooling-only,
    .grid-3 .heating-only {
      display: none;
    }
    
    body.mode-service.mode-cooling .grid-2 .cooling-only,
    body.mode-service.mode-cooling .grid-3 .cooling-only {
      display: block;
    }
    
    body.mode-service.mode-heating .grid-2 .heating-only,
    body.mode-service.mode-heating .grid-3 .heating-only {
      display: block;
    }
    
    /* ==================== PHOTOS (v1.0) ==================== */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    
    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: #f0f0f0;
    }
    
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-label {
      position: absolute;
      bottom: 4px;
      left: 4px;
      right: 4px;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .photo-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #FF3B30;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.9;
      min-height: unset;
      padding: 0;
      margin: 0;
    }
    
    /* ==================== MATERIALS LIST SPECIFIC (v1.0) ==================== */
    .material-catalog {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .material-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin: 6px 0;
      background: white;
      transition: all 0.2s;
    }
    
    .material-item:hover {
      background: #f8f8f8;
      border-color: #007AFF;
    }
    
    .material-item-info {
      flex: 1;
    }
    
    .material-item-name {
      font-weight: 600;
      font-size: 14px;
      color: #1a1a1a;
    }
    
    .material-item-spec {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    
    .material-add-btn {
      padding: 6px 12px;
      font-size: 14px;
      min-height: 32px;
      margin: 0;
      border-radius: 6px;
    }
    
    .selected-material {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
      border: 2px solid #e0e0e0;
    }
    
    .selected-material-header {
      display: flex;
      align-items: start;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .selected-material-title {
      font-weight: 600;
      font-size: 15px;
      color: #1a1a1a;
    }
    
    .selected-material-category {
      font-size: 11px;
      color: #666;
      text-transform: uppercase;
      margin-top: 2px;
    }
    
    .selected-material-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .qty-input {
      width: 60px;
      padding: 6px;
      text-align: center;
      margin: 0;
      font-weight: 600;
    }
    
    .suggestion-item {
      background: white;
      padding: 10px;
      border-radius: 6px;
      margin: 6px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #e0e0e0;
    }
    
    .suggestion-info {
      flex: 1;
    }
    
    .suggestion-name {
      font-weight: 600;
      font-size: 14px;
      color: #1a1a1a;
    }
    
    .suggestion-reason {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    
    /* ==================== REPORT PREVIEW (v1.0) ==================== */
    .report-preview {
      background: #f8f8f8;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-x: auto;
      margin: 12px 0;
      border: 1px solid #ddd;
    }
    
    /* ==================== STICKY ACTION BAR (v1.0) ==================== */
    .actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 8px;
      z-index: 100;
    }
    
    .actions button {
      flex: 1;
      font-size: 14px;
      padding: 12px 8px;
    }
    
    /* ==================== MODAL & TOAST (v1.0) ==================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: scale(0.95);
      transition: transform 0.2s;
      max-height: 80vh; /* Added for long modals */
      overflow-y: auto; /* Added for long modals */
    }
    
    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-overlay.visible .modal-content {
      transform: scale(1);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .modal-body {
      font-size: 15px;
      color: #333;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .modal-actions {
      display: flex;
      gap: 8px;
    }
    
    .modal-actions button {
      flex: 1;
    }
    
    .toast-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s, top 0.3s;
    }
    
    .toast-notification.visible {
      opacity: 1;
      visibility: visible;
      top: 30px;
    }
    
    .toast-notification.success { background: #34C759; }
    .toast-notification.danger { background: #FF3B30; }
    
    /* ==================== HIDDEN / UTILITY (v1.0) ==================== */
    .hidden { display: none !important; }
    .mt-8 { margin-top: 8px; }
    .mt-16 { margin-top: 16px; }
    .mb-8 { margin-bottom: 8px; }
    .text-muted { color: #666; font-size: 13px; }

    /* ==================== NEW v1.5 DIAGNOSTIC REVIEW ==================== */
    .review-item {
      background: #f8f9fa;
      border-left: 4px solid #FF3B30; /* v1.0 danger color */
      padding: 16px;
      margin: 12px 0;
      border-radius: 8px;
    }
    
    .review-item.warning {
      border-left-color: #FF9500; /* v1.0 warning color */
    }
    
    .review-item.info {
      border-left-color: #007AFF; /* v1.0 info color */
    }
    
    .review-item-header {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 8px;
      color: #1a1a1a;
    }
    
    .review-item-measurements {
      background: white;
      padding: 10px;
      border-radius: 6px;
      margin: 8px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.5;
      border: 1px solid #ddd;
    }
    
    .review-item-checks {
      margin-top: 12px;
    }
    
    .review-item-checks label {
      /* This inherits from label.check, but we reset it */
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 14px;
      color: #1a1a1a;
      margin: 0;
      border: none;
      background: none;
      font-weight: 500; /* Reset from bold */
    }
    
    .review-item-checks input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
      margin-right: 10px; /* Re-add margin */
      flex-shrink: 0;
    }
  </style>
</head>
<body class="mode-service mode-cooling">

  <!-- Header -->
  <div class="card">
    <div class="card-header">
      <div>
        <div style="font-size: 20px;">‚ö° Field Buddy Pro</div>
        <div style="font-size: 12px; color: #666; font-weight: 400; margin-top: 4px;">Service & Materials System</div>
      </div>
    </div>
    
    <div class="mode-toggle">
      <button onclick="setMode('service')" id="btn-service" class="active">üîß Service</button>
      <button onclick="setMode('materials')" id="btn-materials">üì¶ Materials</button>
    </div>
  </div>

  <!-- ==================== SERVICE MODE (v1.0) ==================== -->
  <div class="service-only">
    
    <!-- Job Info -->
    <div class="card">
      <div class="card-header">
        <span>üìã Job Information</span>
      </div>
      
      <label for="customer">Customer Name</label>
      <input type="text" id="customer" placeholder="Full name">
      
      <label for="address">Address</label>
      <input type="text" id="address" placeholder="Street, City, State">
      
      <div class="grid-2">
        <div>
          <label for="sales-tech">Technician</label>
          <input type="text" id="sales-tech" placeholder="Your name">
        </div>
        <div>
          <label for="date">Date</label>
          <input type="date" id="date">
        </div>
      </div>
      
      <label>Job Type</label>
      <select id="job-type">
        <option value="">Select job type...</option>
        <option value="maintenance">Maintenance</option>
        <option value="repair">Repair</option>
        <option value="diagnostic">Diagnostic</option>
        <option value="emergency">Emergency</option>
      </select>
      
      <label>Customer Complaint</label>
      <div class="voice-wrapper">
        <textarea id="complaint" placeholder="What's the issue? (in customer's words)" rows="3"></textarea>
        <button class="voice-btn" data-voice="complaint">üé§</button>
      </div>
    </div>
    
    <!-- On-Site Time Tracking -->
    <div class="card">
      <div class="card-header">
        <span>‚è±Ô∏è Time Tracking</span>
      </div>
      
      <div class="grid-2">
        <div>
          <label>Arrival Time</label>
          <input type="time" id="arrival-time">
        </div>
        <div>
          <label>Completion Time</label>
          <input type="time" id="completion-time" onchange="calculateLaborHours()">
        </div>
      </div>
      
      <div class="grid-2">
        <div>
          <label>Travel Time (minutes)</label>
          <input type="number" id="travel-time" min="0" step="5">
        </div>
        <div>
          <label>Total Labor Hours (auto)</label>
          <input type="text" id="total-hours" readonly>
        </div>
      </div>
    </div>
    
    <!-- Equipment Section -->
    <div class="card">
      <div class="card-header">
        <span>‚öôÔ∏è Equipment</span>
      </div>

      <!-- Heat/Cool Toggle -->
      <div class="mode-toggle" style="grid-template-columns: 1fr 1fr; margin-bottom: 12px;">
        <button onclick="setHeatCoolMode('cooling')" id="btn-hc-cooling" class="active secondary">‚ùÑÔ∏è Cooling</button>
        <button onclick="setHeatCoolMode('heating')" id="btn-hc-heating" class="secondary">üî• Heating</button>
      </div>
      
      <label>Unit Type</label>
      <select id="unit-type" onchange="toggleUnitData()">
          <option value="">Select unit type...</option>
          <option value="split">Split System</option>
          <option value="package">Package Unit</option>
          <option value="minisplit">Mini-Split</option>
          <option value="heatpump">Heat Pump</option>
      </select>
      
      <label for="brand">Brand</label>
      <select id="brand">
        <option value="">Select brand...</option>
        <option value="Carrier">Carrier</option>
        <option value="Trane">Trane</option>
        <option value="Lennox">Lennox</option>
        <option value="Rheem">Rheem</option>
        <option value="Goodman">Goodman</option>
        <option value="York">York</option>
        <option value="American Standard">American Standard</option>
        <option value="Bryant">Bryant</option>
        <option value="Daikin">Daikin</option>
        <option value="Mitsubishi">Mitsubishi</option>
        <option value="Other">Other</option>
      </select>
      
      <div id="indoor-unit-fields" class="mt-8">
          <label>Indoor Unit Data (Nameplate)</label>
          <div class="voice-wrapper mb-8">
              <input type="text" id="indoor-data" placeholder="Model/Serial/Tonnage">
              <button class="voice-btn" data-voice="indoor-data">üé§</button>
          </div>
      </div>

      <div id="outdoor-unit-fields">
          <label>Outdoor Unit Data (Nameplate)</label>
          <div class="voice-wrapper mb-8">
              <input type="text" id="outdoor-data" placeholder="Model/Serial/SEER-BTU">
              <button class="voice-btn" data-voice="outdoor-data">üé§</button>
          </div>
      </div>
      
      <div class="grid-2">
        <div>
          <label for="tonnage">System Tonnage</label>
          <select id="tonnage">
            <option value="">Select...</option>
            <option value="1.5">1.5 Ton</option>
            <option value="2">2 Ton</option>
            <option value="2.5">2.5 Ton</option>
            <option value="3">3 Ton</option>
            <option value="3.5">3.5 Ton</option>
            <option value="4">4 Ton</option>
            <option value="5">5 Ton</option>
          </select>
        </div>
        <div>
          <label for="refrigerant">Refrigerant Type</label>
          <select id="refrigerant" onchange="clearRefrigerantCalculations()">
            <option value="">Select...</option>
            <option value="R-410A">R-410A</option>
            <option value="R-22">R-22 (Legacy)</option>
            <option value="R-32">R-32</option>
            <option value="R-454B">R-454B (A2L)</option>
          </select>
        </div>
      </div>
      
      <label for="mfg-date">Manufacture Date</label>
      <input type="date" id="mfg-date" onchange="calculateAge()">
      <div id="equipment-age" class="text-muted"></div>
    </div>
    
    <!-- Materials & Parts Used -->
    <div class="section" id="section-materials-service">
      <button class="section-toggle" onclick="toggleSection('section-materials-service')">
        <span>üîß Parts & Materials Used</span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="section-content">
        <label>Refrigerant</label>
        <div class="grid-2">
          <select id="refrigerant-added-type">
            <option value="">Type...</option>
            <option value="R-410A">R-410A</option>
            <option value="R-22">R-22</option>
            <option value="R-32">R-32</option>
            <option value="R-454B">R-454B</option>
          </select>
          <input type="text" id="refrigerant-amount" placeholder="Amount (lbs/oz)">
        </div>
        <input type="text" id="refrigerant-recovered" placeholder="Amount Recovered (if any)">
        
        <label>Filter Replaced</label>
        <div class="grid-2">
          <select id="filter-size">
            <option value="">Size...</option>
            <option value="16x25x1">16x25x1</option>
            <option value="20x25x1">20x25x1</option>
            <option value="20x25x4">20x25x4 (Media)</option>
            <option value="other">Other Size</option>
          </select>
          <select id="filter-merv">
            <option value="">MERV...</option>
            <option value="8">MERV 8</option>
            <option value="11">MERV 11</option>
            <option value="13">MERV 13</option>
          </select>
        </div>
        
        <label>Capacitor Replaced</label>
        <div class="grid-2">
          <select id="capacitor-type">
            <option value="">Type...</option>
            <option value="dual-35/5">Dual 35/5¬µF</option>
            <option value="dual-40/5">Dual 40/5¬µF</option>
            <option value="dual-45/5">Dual 45/5¬µF</option>
            <option value="other">Other Rating</option>
          </select>
          <input type="number" id="capacitor-qty" placeholder="Qty" min="0" value="0">
        </div>
        
        <label>Contactor Replaced</label>
        <div class="grid-2">
          <select id="contactor-rating">
            <option value="">Rating...</option>
            <option value="30A-2P">30A Double Pole</option>
            <option value="40A-2P">40A Double Pole</option>
            <option value="other">Other Rating</option>
          </select>
          <input type="number" id="contactor-qty" placeholder="Qty" min="0" value="0">
        </div>
        
        <label>Other Parts Used</label>
        <textarea id="other-parts" rows="3" placeholder="List any other materials: fuses, relays, transformers, etc."></textarea>
      </div>
    </div>
    
    <!-- Full Diagnostic Measurements -->
    <div class="section" id="section-service-diagnostics">
      <button class="section-toggle" onclick="toggleSection('section-service-diagnostics')">
        <span>üìä Full Diagnostic Measurements</span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="section-content">
        <div class="status info">
          <span>‚ÑπÔ∏è</span>
          <span>Diagnostic Method: Power ‚Üí Airflow ‚Üí Electrical ‚Üí Refrigerant ‚Üí Controls</span>
        </div>
        
        <div class="card-subheader">General Readings</div>
        <div class="grid-2">
          <div><label>Outdoor Temp (¬∞F)</label><input type="number" id="outdoor-temp" step="0.1"></div>
          <div><label>Outdoor Humidity (%)</label><input type="number" id="outdoor-humidity" min="0" max="100"></div>
        </div>
        <div class="grid-2">
          <div><label>Return Air (¬∞F)</label><input type="number" id="return-temp" step="0.1" oninput="calcDelta()"></div>
          <div><label>Supply Air (¬∞F)</label><input type="number" id="supply-temp" step="0.1" oninput="calcDelta()"></div>
        </div>
        <div class="grid-2">
          <div><label>Return Static (in w.c.)</label><input type="number" id="return-static" step="0.01" oninput="calcStatic()"></div>
          <div><label>Supply Static (in w.c.)</label><input type="number" id="supply-static" step="0.01" oninput="calcStatic()"></div>
        </div>
        <div class="grid-2 mb-8">
          <div><label>Delta T (auto)</label><input type="text" id="delta-t" readonly></div>
          <div><label>Total Static (auto)</label><input type="text" id="total-static" readonly></div>
        </div>
        <div id="delta-status"></div>
        <div id="static-status"></div>
        
        <div class="card-subheader mt-16">Electrical Measurements</div>
        <div class="grid-2">
          <div><label>Voltage L1-L2</label><input type="number" id="voltage-line" step="0.1" oninput="validateVoltage()"></div>
          <div><label>Control Voltage (24V)</label><input type="number" id="control-voltage" step="0.1"></div>
        </div>
        <div id="voltage-status"></div>
        
        <div class="grid-2 mt-8">
          <div><label>Blower Amps</label><input type="text" id="blower-amps" placeholder="Actual/Rated"></div>
          <div class="cooling-only"><label>Compressor Amps</label><input type="text" id="comp-amps" placeholder="Actual/Rated"></div>
          <div class="heating-only"><label>Inducer Amps</label><input type="number" id="inducer-amps" step="0.1"></div>
        </div>
        
        <div class="cooling-only">
          <div class="card-subheader mt-16">Refrigerant Circuit</div>
          <div class="grid-2">
            <div><label>Suction P (psig)</label><input type="number" id="suction-pressure" step="0.1" oninput="calcRefrigerant()"></div>
            <div><label>Liquid P (psig)</label><input type="number" id="liquid-pressure" step="0.1" oninput="calcRefrigerant()"></div>
          </div>
          <div class="grid-2">
            <div><label>Suction T (¬∞F)</label><input type="number" id="suction-temp" step="0.1" oninput="calcRefrigerant()"></div>
            <div><label>Liquid T (¬∞F)</label><input type="number" id="liquid-temp" step="0.1" oninput="calcRefrigerant()"></div>
          </div>
          <div class="grid-2 mt-8">
              <div><label>Superheat (auto)</label><input type="text" id="superheat" readonly></div>
              <div><label>Subcool (auto)</label><input type="text" id="subcool" readonly></div>
          </div>
          <div id="superheat-status"></div>
          <div id="subcool-status"></div>
        </div>
        
        <div class="heating-only">
          <div class="card-subheader mt-16">Heating Circuit</div>
          <div class="grid-2">
            <div><label>Heat Exchanger</label>
              <select id="heat-exchanger">
                <option value="">Inspect...</option>
                <option value="clean">Clean - OK</option>
                <option value="sooted">Sooted</option>
                <option value="cracked">Cracked - DANGER</option>
              </select>
            </div>
            <div><label>Flame Appearance</label>
              <select id="flame-appearance">
                <option value="">Inspect...</option>
                <option value="blue">Blue - Normal</option>
                <option value="yellow">Yellow - Incomplete Combustion</option>
                <option value="lazy">Lazy/Rolling</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Component Inspection & Safety -->
    <div class="section" id="section-service-component">
      <button class="section-toggle" onclick="toggleSection('section-service-component')">
        <span>üîç Component Inspection & Safety</span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="section-content">
        <div class="card-subheader">Safety Checklist</div>
        <div class="grid-2">
          <label class="check"><input type="checkbox" id="safety-disconnect"> Disconnect present & functional</label>
          <label class="check"><input type="checkbox" id="safety-clearances"> Clearances adequate</label>
          <label class="check"><input type="checkbox" id="safety-drain"> Drain trapped & flowing</label>
          <label class="check"><input type="checkbox" id="safety-floats"> Float switches tested</label>
        </div>
        <div class="heating-only grid-2">
          <label class="check"><input type="checkbox" id="safety-gas"> Gas piping OK</label>
          <label class="check"><input type="checkbox" id="safety-vent"> Vent termination secure</label>
          <label class="check"><input type="checkbox" id="safety-co"> No CO detected</label>
          <label class="check"><input type="checkbox" id="safety-flame-sensor"> Flame sensor clean</label>
        </div>
        
        <div class="card-subheader mt-16">Component Health</div>
        <label>Filter Condition</label>
        <div class="voice-wrapper">
          <input type="text" id="filter" placeholder="Size and condition (e.g., 16x25x1 - Light Dust)">
          <button class="voice-btn" data-voice="filter">üé§</button>
        </div>
        
        <div class="grid-2">
          <div>
            <label>Evaporator Coil</label>
            <select id="evap-coil">
              <option value="">Evap coil condition...</option>
              <option value="clean">Clean</option>
              <option value="light-dust">Light dust</option>
              <option value="restricted">Restricted - needs cleaning</option>
              <option value="frozen">Frozen</option>
              <option value="corroded">Corroded</option>
              <option value="leaking">Leaking</option>
            </select>
          </div>
          <div>
            <label>Condenser Coil</label>
            <select id="cond-coil">
              <option value="">Cond coil condition...</option>
              <option value="clean">Clean</option>
              <option value="light-debris">Light debris</option>
              <option value="restricted">Restricted - needs cleaning</option>
              <option value="bent-fins">Bent fins</option>
              <option value="corroded">Corroded</option>
            </select>
          </div>
        </div>
        
        <div class="grid-2">
          <div>
            <label>Capacitor (¬µF)</label>
            <div class="voice-wrapper">
              <input type="text" id="capacitor-reading" placeholder="Actual/Rated ¬µF (e.g. 32/35)">
              <button class="voice-btn" data-voice="capacitor-reading">üé§</button>
            </div>
          </div>
          <div>
            <label>Contactor</label>
            <select id="contactor-condition">
              <option value="">Contactor condition...</option>
              <option value="excellent">Good - clean contacts</option>
              <option value="light-pitting">Light pitting</option>
              <option value="heavy-pitting">Heavy pitting - recommend replacement</option>
              <option value="burned">Burned/welded</option>
            </select>
          </div>
        </div>
        
        <label>Blower Motor Condition</label>
        <select id="blower-condition">
          <option value="">Blower condition...</option>
          <option value="clean-quiet">Clean, runs quietly</option>
          <option value="dusty">Dusty but functional</option>
          <option value="noisy">Noisy - bearings worn</option>
          <option value="struggling">Struggling to start</option>
          <option value="failed">Failed/not running</option>
        </select>
      </div>
    </div>
    
    <!-- Final Review -->
    <div class="card">
      <div class="card-header">
        <span>üìù Final Review & Findings</span>
      </div>
      
      <label>Primary Findings Summary</label>
      <div class="voice-wrapper">
          <textarea id="findings" placeholder="What's wrong and why - be specific" rows="3"></textarea>
          <button class="voice-btn" data-voice="findings">üé§</button>
      </div>
      
      <label>Repair Recommendations</label>
      <div class="voice-wrapper">
          <textarea id="recommendations" placeholder="Repair options and next steps" rows="3"></textarea>
          <button class="voice-btn" data-voice="recommendations">üé§</button>
      </div>

      <label>Work Performed Today</label>
      <div class="voice-wrapper">
          <textarea id="work-performed" placeholder="What was done during this service call" rows="2"></textarea>
          <button class="voice-btn" data-voice="work-performed">üé§</button>
      </div>
    </div>
    
  </div>

  <!-- ==================== MATERIALS MODE (v1.0) ==================== -->
  <div class="materials-only">
    
    <!-- Materials Job Info -->
    <div class="card">
      <div class="card-header">
        <span>üìã Materials Job Info</span>
      </div>
      
      <label for="mat-customer">Customer/Job Name</label>
      <input type="text" id="mat-customer" placeholder="Enter customer or job identifier">
      
      <label for="mat-address">Job Address</label>
      <input type="text" id="mat-address" placeholder="Installation address">
      
      <div class="grid-2">
        <div>
          <label for="mat-tech">Technician</label>
          <input type="text" id="mat-tech" placeholder="Your name">
        </div>
        <div>
          <label for="mat-date">Date</label>
          <input type="date" id="mat-date">
        </div>
      </div>
      
      <label for="mat-notes">Job Notes</label>
      <textarea id="mat-notes" rows="2" placeholder="Special requirements, access notes, etc."></textarea>
    </div>
    
    <!-- Smart Suggestions (v1.0, to be populated by v1.5 logic) -->
    <div id="suggestions-container" class="hidden">
      <div class="card">
        <div class="card-header">
          <span>üí° Smart Suggestions</span>
        </div>
        <div class="status info">
          <span>‚ÑπÔ∏è</span>
          <span>Based on your service diagnostics, you may need these:</span>
        </div>
        <div id="suggestions-list"></div>
      </div>
    </div>
    
    <!-- Materials Selection -->
    <div class="card">
      <div class="card-header">
        <span>üõ†Ô∏è Add Materials</span>
      </div>
      
      <label>Select Category</label>
      <select id="material-category" onchange="updateMaterialsList()">
        <option value="">Choose a category...</option>
        <option value="equipment">Equipment</option>
        <option value="ductwork">Ductwork & Fittings</option>
        <option value="refrigerant">Refrigerant & Line Sets</option>
        <option value="electrical">Electrical</option>
        <option value="iaq">IAQ & Filtration</option>
        <option value="venting">Venting (Gas/Oil)</option>
        <option value="drainage">Drainage</option>
        <option value="consumables">Consumables & Supplies</option>
      </select>
      
      <div id="materials-catalog-container" class="material-catalog mt-8"></div>
    </div>
    
    <!-- Selected Materials List -->
    <div class="card">
      <div class="card-header">
        <span>üìù Materials List</span>
        <span id="total-items-badge" class="text-muted">0 items</span>
      </div>
      
      <div id="selected-materials-list">
        <div class="text-muted" style="text-align: center; padding: 20px;">
          No materials selected yet. Add items from the catalog above.
        </div>
      </div>
    </div>
    
  </div>

  <!-- ==================== GLOBAL: Photo Documentation (v1.0) ==================== -->
  <div class="card">
    <div class="card-header">
      <span>üì∏ Photo Documentation</span>
    </div>
    
    <div class="status info">
      <span>üì∑</span>
      <span>Take photos: Nameplate, before/after, problem areas, materials needed</span>
    </div>

    <div class="grid-4">
      <button onclick="takePhoto('Nameplate')" class="secondary small">üì∑ Nameplate</button>
      <button onclick="takePhoto('Problem')" class="secondary small">üì∑ Problem</button>
      <button onclick="takePhoto('Before')" class="secondary small">üì∑ Before</button>
      <button onclick="takePhoto('After')" class="secondary small">üì∑ After</button>
      <button onclick="takePhoto('Electrical')" class="secondary small">üì∑ Electrical</button>
      <button onclick="takePhoto('Coils')" class="secondary small">üì∑ Coils</button>
      <button onclick="takePhoto('Materials')" class="secondary small">üì∑ Materials</button>
      <button onclick="takePhoto('Other')" class="secondary small">üì∑ Other</button>
    </div>
    <div class="photo-grid" id="photo-preview"></div>
  </div>

  <!-- ==================== GLOBAL: Signature (v1.0) ==================== -->
  <div class="card">
    <div class="card-header">
      <span>‚úçÔ∏è Signature</span>
    </div>
    
    <div class="grid-2">
      <div>
        <label for="tech-name">Technician Name</label>
        <input type="text" id="tech-name" placeholder="Your name">
      </div>
      <div>
        <label for="customer-signature">Customer Signature</label>
        <input type="text" id="customer-signature" placeholder="Customer name">
      </div>
    </div>
  </div>

  <!-- ==================== GLOBAL: Sticky Action Bar (v1.0) ==================== -->
  <div class="actions">
    <button class="success" onclick="generate()" id="generate-btn">
      <span>‚úì</span> Generate
    </button>
    <button class="warning" onclick="exportReport()">
      <span>üì§</span> Export
    </button>
    <button class="danger" onclick="clearForm()">
      <span>‚úï</span> Clear
    </button>
  </div>
  
  <!-- ==================== GLOBAL: Confirmation Modal (v1.0) ==================== -->
  <div class="modal-overlay" id="modal-container">
    <div class="modal-content">
      <div class="modal-title" id="modal-title">Confirmation</div>
      <div class="modal-body" id="modal-body">Are you sure?</div>
      <div class="modal-actions">
        <button class="secondary" id="modal-cancel">Cancel</button>
        <button class="danger" id="modal-confirm">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- ==================== NEW v1.5: Diagnostic Review Modal ==================== -->
  <div class="modal-overlay" id="diagnostic-review-modal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-title">üîç Diagnostic Review</div>
      <div class="modal-body">
        
        <!-- Critical Issues -->
        <div id="review-critical-section" class="hidden">
          <div class="status bad">
            <span>‚ö†Ô∏è</span>
            <span><strong>Critical Issues Detected</strong></span>
          </div>
          <div id="review-critical-list"></div>
        </div>
        
        <!-- Findings -->
        <div id="review-findings-section" class="hidden">
          <div class="status warn">
            <span>üîç</span>
            <span><strong>Diagnostic Findings</strong></span>
          </div>
          <div id="review-findings-list"></div>
        </div>
        
        <!-- Warnings -->
        <div id="review-warnings-section" class="hidden">
          <div class="status info">
            <span>‚ÑπÔ∏è</span>
            <span><strong>Items to Verify</strong></span>
          </div>
          <div id="review-warnings-list"></div>
        </div>
        
        <!-- All Clear -->
        <div id="review-allclear-section" class="hidden">
          <div class="status good">
            <span>‚úì</span>
            <span><strong>All Systems Check Out</strong></span>
          </div>
          <p>No diagnostic issues detected. Readings are within acceptable parameters.</p>
        </div>
        
      </div>
      <div class="modal-actions">
        <button class="secondary" onclick="closeReviewModal()">
          ‚Üê Go Back & Correct
        </button>
        <button class="success" onclick="proceedToReportGeneration()">
          Proceed to Report ‚Üí
        </button>
      </div>
    </div>
  </div>

  <div class="toast-notification" id="toast-notification">
    Message here
  </div>

<script>
    // ===================================================================
    // ==================== v1.5 LOGIC - (MERGED) ====================
    // ===================================================================

    // ==================== HVAC RULES DATABASE (v1.5) ====================
    const HVAC_RULES = {
      refrigerant: {
        'r-410a': {
          superheat: { min: 8, max: 15, unit: '¬∞F' },
          subcool: { min: 8, max: 12, unit: '¬∞F' },
          pressureTemp: {
            90: 44.7, 95: 47.1, 100: 49.6, 105: 52.2, 110: 54.9, 115: 57.7, 120: 60.6,
            125: 63.6, 130: 66.7, 135: 69.9, 140: 73.2, 145: 76.6, 150: 80.1, 155: 83.7,
            160: 87.4, 165: 91.3, 170: 95.2, 175: 99.3, 180: 103.5, 185: 107.8, 190: 112.2,
            195: 116.7, 200: 121.4, 205: 126.1, 210: 131.0
          }
        },
        'r-22': {
          superheat: { min: 10, max: 20, unit: '¬∞F' },
          subcool: { min: 10, max: 15, unit: '¬∞F' },
          // R-22 PT chart would go here if needed
        }
      },
      
      airflow: {
        deltaT: {
          cooling: { min: 16, max: 22, unit: '¬∞F' },
          heating: { min: 30, max: 80, unit: '¬∞F' }
        },
        staticPressure: {
          acceptable: { max: 0.50, unit: 'in w.c.' },
          elevated: { max: 0.70, unit: 'in w.c.' },
          // Above 0.70 = excessive
        }
      },
      
      electrical: {
        voltage: {
          nominal: { min: 208, max: 240, unit: 'V' },
          acceptable: { min: 200, max: 250, unit: 'V' }
        },
        control: {
          nominal: 24,
          acceptable: { min: 22, max: 26, unit: 'V' }
        }
      },
      
      components: {
        capacitor: {
          tolerance: 0.06, // 6% of rated value
        }
      }
    };

    const DIAGNOSTIC_PATTERNS = {
      undercharge: {
        name: 'System Undercharged',
        checks: [
          'Check for refrigerant leaks at evap coil',
          'Inspect service valve connections',
          'Look for oil residue at brazed joints',
          'Check line set for damage/leaks'
        ],
        severity: 'critical',
        category: 'refrigerant'
      },
      
      overcharge: {
        name: 'System Overcharged',
        checks: [
          'Verify charge was not added incorrectly',
          'Check for non-condensables in system',
          'Confirm outdoor unit has adequate airflow'
        ],
        severity: 'warning',
        category: 'refrigerant'
      },
      
      airflowRestriction: {
        name: 'Airflow Restriction Detected',
        checks: [
          'Verify filter is ACTUALLY clean (not just looks ok)',
          'Check evap coil for dirt/restriction',
          'Inspect blower wheel for buildup',
          'Check for crushed/kinked flex duct',
          'Verify all supply vents are open'
        ],
        severity: 'critical',
        category: 'airflow'
      },
      
      txvFailure: {
        name: 'Possible TXV Issue',
        checks: [
          'Check TXV bulb attachment and insulation',
          'Verify sensing bulb location',
          'Check for restricted liquid line filter/drier',
          'TXV may be stuck or failed'
        ],
        severity: 'warning',
        category: 'refrigerant'
      },
      
      compressorNotPumping: {
        name: 'Compressor Not Pumping',
        checks: [
          'Compressor running but pressures equalized',
          'Internal valve failure likely',
          'Check compressor amp draw vs RLA',
          'Compressor replacement may be needed'
        ],
        severity: 'critical',
        category: 'mechanical'
      },
      
      weakCapacitor: {
        name: 'Weak/Failed Capacitor',
        checks: [
          'Replace capacitor - below acceptable tolerance',
          'Check for bulging or leaking',
          'Verify correct voltage rating'
        ],
        severity: 'critical',
        category: 'electrical'
      },
      
      lowVoltage: {
        name: 'Low Voltage Detected',
        checks: [
          'Check main breaker and connections',
          'Test voltage at disconnect and at unit',
          'Look for loose wire connections',
          'May need utility company involvement'
        ],
        severity: 'critical',
        category: 'electrical'
      }
    };
    
    // ==================== DIAGNOSTIC ENGINE (v1.5) ====================
    class DiagnosticEngine {
      constructor() {
        this.findings = [];
        this.warnings = [];
        this.criticalIssues = [];
      }

      parseCapacitorReading(readingStr) {
        if (!readingStr) return null;
        // Updated regex to handle "32/35" or "32 / 35"
        const matches = readingStr.match(/(\d+\.?\d*)[^\d]*(\d+\.?\d*)/);
        if (matches && matches[1] && matches[2]) {
          // Assumes smaller number is actual, larger is rated
          const n1 = parseFloat(matches[1]);
          const n2 = parseFloat(matches[2]);
          return {
            actual: Math.min(n1, n2),
            rated: Math.max(n1, n2)
          };
        }
        return null;
      }
      
      lookupSatTemp(pressure, refrigType) {
        const ptChart = HVAC_RULES.refrigerant[refrigType.toLowerCase()]?.pressureTemp;
        if (!ptChart) return null;
        
        let closest = null;
        let minDiff = Infinity;
        
        for (let temp in ptChart) {
          const diff = Math.abs(ptChart[temp] - pressure);
          if (diff < minDiff) {
            minDiff = diff;
            closest = parseFloat(temp);
          }
        }
        return closest;
      }

      analyzeServiceData(serviceData) {
        this.findings = [];
        this.warnings = [];
        this.criticalIssues = [];

        this.checkRefrigerantCircuit(serviceData);
        this.checkAirflow(serviceData);
        this.checkElectrical(serviceData);
        this.checkComponents(serviceData);
        this.checkSafety(serviceData);

        return {
          findings: this.findings,
          warnings: this.warnings,
          critical: this.criticalIssues,
          overallStatus: this.calculateOverallStatus()
        };
      }
      
      addFinding(finding) {
        this.findings.push(finding);
        if (finding.severity === 'critical') {
          this.criticalIssues.push(finding);
        }
      }
      addWarning(warning) { this.warnings.push(warning); }
      addCritical(critical) { this.criticalIssues.push(critical); }

      checkRefrigerantCircuit(data) {
        if (!data.equipment.refrigerant || !data.service.operating || data.meta.heatCoolMode !== 'cooling') return;
        
        const refrigType = data.equipment.refrigerant.toLowerCase();
        const rules = HVAC_RULES.refrigerant[refrigType];
        if (!rules) return; // No rules for this refrigerant

        const readings = data.service.operating;
        if (readings.suctionPressure && readings.suctionTemp && readings.liquidPressure && readings.liquidTemp) {
          const satTempSuction = this.lookupSatTemp(readings.suctionPressure, refrigType);
          const satTempLiquid = this.lookupSatTemp(readings.liquidPressure, refrigType);

          if (satTempSuction === null || satTempLiquid === null) return; // Can't calculate

          const superheat = readings.suctionTemp - satTempSuction;
          const subcool = satTempLiquid - readings.liquidTemp;
          
          this.matchRefrigerantPattern({
            superheat: superheat.toFixed(1),
            subcool: subcool.toFixed(1),
            suctionPressure: readings.suctionPressure,
            dischargePressure: readings.liquidPressure
          });
        }
      }

      matchRefrigerantPattern(m) {
        // Check for undercharge
        if (m.superheat > 20 && m.subcool && m.subcool < 8) {
          this.addFinding({
            pattern: 'undercharge', severity: 'critical', measurements: m,
            checks: DIAGNOSTIC_PATTERNS.undercharge.checks
          });
        }
        // Check for overcharge
        else if (m.superheat < 5 && m.subcool && m.subcool > 15) {
          this.addFinding({
            pattern: 'overcharge', severity: 'warning', measurements: m,
            checks: DIAGNOSTIC_PATTERNS.overcharge.checks
          });
        }
        // Check for TXV issues
        else if (m.superheat > 25 && m.subcool && (m.subcool >= 8 && m.subcool <= 12)) {
          this.addFinding({
            pattern: 'txvFailure', severity: 'warning', measurements: m,
            checks: DIAGNOSTIC_PATTERNS.txvFailure.checks
          });
        }
        
        // Check for compressor not pumping
        if (m.suctionPressure > 100 && m.dischargePressure < 250) {
          this.addFinding({
            pattern: 'compressorNotPumping', severity: 'critical', measurements: m,
            checks: DIAGNOSTIC_PATTERNS.compressorNotPumping.checks
          });
        }
      }

      checkAirflow(data) {
        if (!data.service.operating) return;
        const { deltaT, totalStatic } = data.service.operating;
        const mode = data.meta.heatCoolMode;
        const dtNum = parseFloat(deltaT);
        const tsNum = parseFloat(totalStatic);
        
        if (!dtNum || !tsNum) return;

        if (mode === 'cooling' && dtNum < 14 && tsNum > 0.7) {
          this.addFinding({
            pattern: 'airflowRestriction', severity: 'critical',
            measurements: { "Delta-T": dtNum, "Total Static": tsNum },
            checks: DIAGNOSTIC_PATTERNS.airflowRestriction.checks
          });
        }
        else if (mode === 'cooling' && dtNum > 24) {
          this.addWarning({
            issue: 'High Temperature Split',
            description: `Delta-T at ${dtNum}¬∞F (above 24¬∞F) suggests possible airflow restriction.`,
            checks: ['Verify blower speed setting', 'Check for blocked return', 'Inspect evap coil']
          });
        }
      }

      checkElectrical(data) {
        if (!data.service.operating) return;
        const { voltageLine, controlVoltage } = data.service.operating;
        
        if (voltageLine && voltageLine < 200) {
          this.addCritical({
            issue: 'Low Line Voltage', 
            description: `Voltage measured at ${voltageLine}V.`,
            checks: DIAGNOSTIC_PATTERNS.lowVoltage.checks
          });
        }
        
        if (controlVoltage && controlVoltage < 22) {
          this.addWarning({
            issue: 'Low Control Voltage', 
            description: `Voltage measured at ${controlVoltage}V.`,
            checks: ['Check transformer output', 'Test for voltage drop in control circuit']
          });
        }
      }

      checkComponents(data) {
        if (!data.service.components) return;
        const { capacitorReading, contactorCondition } = data.service.components;
        
        if (capacitorReading) {
          const reading = this.parseCapacitorReading(capacitorReading);
          
          if (reading && reading.actual < (reading.rated * (1 - HVAC_RULES.components.capacitor.tolerance))) {
            this.addFinding({
              pattern: 'weakCapacitor', severity: 'critical',
              measurements: {
                Actual: reading.actual + "¬µF",
                Rated: reading.rated + "¬µF",
                Percentage: ((reading.actual / reading.rated) * 100).toFixed(0) + '%'
              },
              checks: DIAGNOSTIC_PATTERNS.weakCapacitor.checks
            });
          }
        }
        
        if (contactorCondition === 'burned' || contactorCondition === 'heavy-pitting') {
          this.addCritical({
            issue: 'Contactor Failure', 
            description: `Contactor condition reported as: ${contactorCondition}`,
            checks: ['Replace contactor immediately', 'Inspect wire connections']
          });
        }
      }

      checkSafety(data) {
        if (!data.service.safety) return;
        
        const criticalSafety = [
          { key: 'disconnect', label: 'Disconnect present & functional' },
          { key: 'clearances', label: 'Clearances adequate' },
          { key: 'drain', label: 'Drain trapped & flowing' }
        ];
        
        criticalSafety.forEach(item => {
          if (data.service.safety[item.key] === false) { // Check if it's explicitly false (unchecked)
            this.addCritical({
              issue: `Safety Check Failed`,
              description: `Item not checked: "${item.label}"`,
              checks: [`Address ${item.label} immediately`]
            });
          }
        });
      }
      
      calculateOverallStatus() {
        if (this.criticalIssues.length > 0) return 'critical';
        if (this.findings.length > 0) return 'attention'; // Merged findings and warnings
        if (this.warnings.length > 0) return 'attention';
        return 'good';
      }
    }

    // ==================== CONTEXT MANAGER (v1.5) ====================
    class ContextManager {
      constructor() {
        this.context = {
          job: { customer: '', address: '', date: '', technician: '', jobType: '' },
          equipment: { 
            brand: '', unitType: '', tonnage: '', refrigerant: '', 
            mfgDate: '', indoorData: '', outdoorData: '', age: '' 
          },
          service: {
            complaint: '',
            time: {},
            safety: {},
            operating: {},
            components: {},
            review: {}
          },
          materials: { 
            selectedMaterials: [], // This will be the v1.0 global 'selectedMaterials'
            serviceMaterials: {} 
          },
          photos: [], // This will be the v1.0 global 'photos'
          signature: { tech: '', customer: '' },
          diagnosticAnalysis: null,
          currentMode: 'service',
          heatCoolMode: 'cooling'
        };
      }

      // Helper to get value
      _val(id) { return document.getElementById(id)?.value || ''; }
      _chk(id) { return document.getElementById(id)?.checked || false; }

      saveCurrentMode(mode) {
        if (mode === 'service') {
          this.context.service = this.gatherServiceData();
          this.context.materials.serviceMaterials = this.gatherServiceMaterials();
        } else if (mode === 'materials') {
          this.context.materials.selectedMaterials = selectedMaterials; // 'selectedMaterials' is global in v1.0
        }
        
        this.context.job = this.gatherJobData(mode);
        this.context.equipment = this.gatherEquipmentData();
        this.context.photos = photos; // 'photos' is global in v1.0
        this.context.signature = this.gatherSignatureData();
      }

      loadContextToForm(mode) {
        this.loadJobData(mode);
        this.loadEquipmentData();
        this.loadPhotos();
        this.loadSignatureData();
        
        if (mode === 'service') {
          this.loadServiceData();
          this.loadServiceMaterials();
        } else if (mode === 'materials') {
          this.loadMaterialsData();
          if (this.context.diagnosticAnalysis) {
            this.generateMaterialSuggestions();
          }
        }
      }
      
      // --- GATHER FUNCTIONS ---
      gatherJobData(mode) {
        if (mode === 'service') {
          return {
            customer: this._val('customer'), address: this._val('address'),
            date: this._val('date'), technician: this._val('sales-tech'),
            jobType: this._val('job-type')
          };
        } else {
          // When in materials mode, pull from materials form
          return {
            customer: this._val('mat-customer'), address: this._val('mat-address'),
            date: this._val('mat-date'), technician: this._val('mat-tech'),
            jobType: this.context.job.jobType // Preserve from service mode
          };
        }
      }

      gatherEquipmentData() {
        return {
          brand: this._val('brand'), unitType: this._val('unit-type'),
          tonnage: this._val('tonnage'), refrigerant: this._val('refrigerant'),
          mfgDate: this._val('mfg-date'), age: document.getElementById('equipment-age').textContent,
          indoorData: this._val('indoor-data'), outdoorData: this._val('outdoor-data')
        };
      }
      
      gatherSignatureData() {
        return {
          tech: this._val('tech-name'),
          customer: this._val('customer-signature')
        };
      }

      gatherServiceMaterials() {
        return {
          refrigerant: { 
            type: this._val('refrigerant-added-type'), amount: this._val('refrigerant-amount'),
            recovered: this._val('refrigerant-recovered') 
          },
          filter: { size: this._val('filter-size'), merv: this._val('filter-merv') },
          capacitor: { type: this._val('capacitor-type'), qty: this._val('capacitor-qty') },
          contactor: { rating: this._val('contactor-rating'), qty: this._val('contactor-qty') },
          other: this._val('other-parts')
        };
      }

      gatherServiceData() {
        return {
          complaint: this._val('complaint'),
          time: {
            arrival: this._val('arrival-time'), completion: this._val('completion-time'),
            travel: this._val('travel-time'), total: this._val('total-hours')
          },
          safety: {
            disconnect: this._chk('safety-disconnect'), clearances: this._chk('safety-clearances'),
            drain: this._chk('safety-drain'), floats: this._chk('safety-floats'),
            gas: this._chk('safety-gas'), vent: this._chk('safety-vent'),
            co: this._chk('safety-co'), flameSensor: this._chk('safety-flame-sensor')
          },
          operating: {
            outdoorTemp: this._val('outdoor-temp'), outdoorHumidity: this._val('outdoor-humidity'),
            returnTemp: this._val('return-temp'), supplyTemp: this._val('supply-temp'),
            deltaT: this._val('delta-t'), returnStatic: this._val('return-static'),
            supplyStatic: this._val('supply-static'), totalStatic: this._val('total-static'),
            voltageLine: this._val('voltage-line'), controlVoltage: this._val('control-voltage'),
            blowerAmps: this._val('blower-amps'), suctionPressure: this._val('suction-pressure'),
            liquidPressure: this._val('liquid-pressure'), suctionTemp: this._val('suction-temp'),
            liquidTemp: this._val('liquid-temp'), superheat: this._val('superheat'),
            subcool: this._val('subcool'), compAmps: this._val('comp-amps'),
            inducerAmps: this._val('inducer-amps'), heatExchanger: this._val('heat-exchanger'),
            flameAppearance: this._val('flame-appearance')
          },
          components: {
            filter: this._val('filter'), evapCoil: this._val('evap-coil'),
            condCoil: this._val('cond-coil'), capacitorReading: this._val('capacitor-reading'),
            contactorCondition: this._val('contactor-condition'), blowerCondition: this._val('blower-condition')
          },
          review: {
            findings: this._val('findings'),
            recommendations: this._val('recommendations'),
            workPerformed: this._val('work-performed')
          }
        };
      }
      
      // --- LOAD FUNCTIONS ---
      loadJobData(mode) {
        if (mode === 'service') {
          $('customer').value = this.context.job.customer;
          $('address').value = this.context.job.address;
          $('date').value = this.context.job.date || new Date().toISOString().split('T')[0];
          $('sales-tech').value = this.context.job.technician;
          $('job-type').value = this.context.job.jobType;
        } else {
          $('mat-customer').value = this.context.job.customer;
          $('mat-address').value = this.context.job.address;
          $('mat-date').value = this.context.job.date || new Date().toISOString().split('T')[0];
          $('mat-tech').value = this.context.job.technician;
        }
      }

      loadEquipmentData() {
        if ($('brand')) { // Check if service form elements exist
          $('brand').value = this.context.equipment.brand;
          $('unit-type').value = this.context.equipment.unitType;
          $('tonnage').value = this.context.equipment.tonnage;
          $('refrigerant').value = this.context.equipment.refrigerant;
          $('mfg-date').value = this.context.equipment.mfgDate;
          $('equipment-age').textContent = this.context.equipment.age;
          $('indoor-data').value = this.context.equipment.indoorData;
          $('outdoor-data').value = this.context.equipment.outdoorData;
          toggleUnitData(); // Ensure UI consistency
        }
      }
      
      loadSignatureData() {
        $('tech-name').value = this.context.signature.tech || '';
        $('customer-signature').value = this.context.signature.customer || '';
      }

      loadPhotos() {
        photos = this.context.photos; // 'photos' is global
        updatePhotoPreview(); // 'updatePhotoPreview' is global
      }

      loadServiceData() {
        // This is a comprehensive load to restore the service form
        const service = this.context.service;
        $('complaint').value = service.complaint || '';
        
        if (service.time) {
          $('arrival-time').value = service.time.arrival || '';
          $('completion-time').value = service.time.completion || '';
          $('travel-time').value = service.time.travel || '';
          $('total-hours').value = service.time.total || '';
        }
        
        if (service.safety) {
          Object.keys(service.safety).forEach(key => {
            const el = document.getElementById(`safety-${key}`);
            if(el) el.checked = service.safety[key];
          });
        }
        
        if (service.operating) {
          Object.keys(service.operating).forEach(key => {
            // Convert camelCase to kebab-case for element IDs
            const elId = key.replace(/[A-Z]/g, letter => `-${letter.toLowerCase()}`);
            const el = document.getElementById(elId);
            if(el) el.value = service.operating[key];
          });
        }

        if(service.components) {
          $('filter').value = service.components.filter || '';
          $('evap-coil').value = service.components.evapCoil || '';
          $('cond-coil').value = service.components.condCoil || '';
          $('capacitor-reading').value = service.components.capacitorReading || '';
          $('contactor-condition').value = service.components.contactorCondition || '';
          $('blower-condition').value = service.components.blowerCondition || '';
        }

        if(service.review) {
          $('findings').value = service.review.findings || '';
          $('recommendations').value = service.review.recommendations || '';
          $('work-performed').value = service.review.workPerformed || '';
        }
      }
      
      loadServiceMaterials() {
        const mat = this.context.materials.serviceMaterials;
        if (mat) {
          $('refrigerant-added-type').value = mat.refrigerant?.type || '';
          $('refrigerant-amount').value = mat.refrigerant?.amount || '';
          $('refrigerant-recovered').value = mat.refrigerant?.recovered || '';
          $('filter-size').value = mat.filter?.size || '';
          $('filter-merv').value = mat.filter?.merv || '';
          $('capacitor-type').value = mat.capacitor?.type || '';
          $('capacitor-qty').value = mat.capacitor?.qty || '0';
          $('contactor-rating').value = mat.contactor?.rating || '';
          $('contactor-qty').value = mat.contactor?.qty || '0';
          $('other-parts').value = mat.other || '';
        }
      }

      loadMaterialsData() {
        selectedMaterials = this.context.materials.selectedMaterials; // 'selectedMaterials' is global
        renderSelectedMaterials(); // 'renderSelectedMaterials' is global
      }
      
      generateMaterialSuggestions() {
        const analysis = this.context.diagnosticAnalysis;
        if (!analysis || !analysis.criticalIssues) return;
        
        let suggestions = [];
        
        // Use criticalIssues and findings from analysis
        const allIssues = [...analysis.criticalIssues, ...analysis.findings];
        
        allIssues.forEach(issue => {
          if (issue.pattern === 'weakCapacitor' && issue.measurements) {
            const rated = issue.measurements.Rated.replace('¬µF','');
            suggestions.push({
              category: 'electrical',
              item: { id: 'capacitor', name: `Run Capacitor (~${rated}¬µF)` },
              reason: `Weak capacitor detected (${issue.measurements.Percentage} of rated)`
            });
          }
          if (issue.pattern === 'undercharge') {
            const refrig = this.context.equipment.refrigerant || 'R-410A';
            suggestions.push({
              category: 'refrigerant',
              item: { id: refrig.toLowerCase().replace('-', ''), name: `${refrig} Refrigerant` },
              reason: `System undercharged (SH: ${issue.measurements.superheat}¬∞F)`
            });
          }
          if (issue.pattern === 'airflowRestriction') {
             suggestions.push({
              category: 'iaq', // Use IAQ category for filters
              item: { id: 'media-cleaner', name: `Filter (Check Size)` }, // Generic filter
              reason: `Airflow restriction detected (Static: ${issue.measurements["Total Static"]})`
            });
          }
        });
        
        this.displayMaterialSuggestions(suggestions);
      }

      displayMaterialSuggestions(suggestions) {
        if (suggestions.length === 0) {
            $('suggestions-container').classList.add('hidden');
            return;
        }
        
        const container = $('suggestions-container');
        const list = $('suggestions-list');
        
        container.classList.remove('hidden');
        list.innerHTML = suggestions.map((s, idx) => `
          <div class="suggestion-item">
            <div class="suggestion-info">
              <div class="suggestion-name">${s.item.name}</div>
              <div class="suggestion-reason">${s.reason}</div>
            </div>
            <button class="material-add-btn" onclick="addSuggestedMaterial(${idx})">+ Add</button>
          </div>
        `).join('');
        
        window.currentSuggestions = suggestions;
      }
    }

    // ===================================================================
    // ==================== v1.0 APP LOGIC (MODIFIED) ====================
    // ===================================================================

    // ==================== GLOBAL STATE & INSTANTIATION (v1.5) ====================
    const $ = (id) => document.getElementById(id);
    const num = val => { const n = parseFloat(val); return isNaN(n) ? null : n; };
    
    let currentMode = 'service';
    let heatCoolMode = 'cooling';
    let photos = [];
    let selectedMaterials = [];
    window.currentSuggestions = []; // For suggestion-adding function
    
    // NEW v1.5 Instantiations
    const contextManager = new ContextManager();
    const diagnosticEngine = new DiagnosticEngine();

    // v1.0 Materials Catalog
    const materialsCatalog = {
      equipment: {
        name: 'Equipment',
        items: [
          { id: 'furnace-gas', name: 'Gas Furnace', sizes: ['60K BTU', '80K BTU', '100K BTU', '120K BTU'], category: 'furnace' },
          { id: 'ac-unit', name: 'Air Conditioner', sizes: ['1.5 Ton', '2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'], category: 'cooling', tonnage: true },
          { id: 'heat-pump', name: 'Heat Pump', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'], category: 'cooling', tonnage: true },
        ]
      },
      ductwork: {
        name: 'Ductwork & Fittings',
        items: [
          { id: 'flex-duct', name: 'Flexible Duct', sizes: ['4"', '5"', '6"', '7"', '8"', '10"', '12"'], unit: 'ft' },
          { id: 'plenum-supply', name: 'Supply Plenum', sizes: ['16x20', '18x24', '20x24', '24x24'] },
        ]
      },
      refrigerant: {
        name: 'Refrigerant & Line Sets',
        items: [
          { id: 'lineset-small', name: 'Line Set (1.5-2.5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '1/4" x 3/8"', tonnageRange: [1.5, 2.5] },
          { id: 'lineset-medium', name: 'Line Set (3-3.5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '3/8" x 3/4"', tonnageRange: [3, 3.5] },
          { id: 'r410a', name: 'R-410A Refrigerant', sizes: ['25 lb', '50 lb'], unit: 'cylinder' },
          { id: 'r22', name: 'R-22 Refrigerant', sizes: ['30 lb'], unit: 'cylinder' },
        ]
      },
      electrical: {
        name: 'Electrical',
        items: [
          { id: 'disconnect-30', name: 'Disconnect Box (30A)', sizes: ['30A'], amperage: 30 },
          { id: 'whip', name: 'Electrical Whip', sizes: ['3 ft', '6 ft', '10 ft'] },
          { id: 'capacitor', name: 'Capacitor', sizes: ['5¬µF', '7.5¬µF', '10¬µF', '15¬µF', '20¬µF', '25¬µF', '30¬µF', '35¬µF', '40¬µF', '45¬µF', '50¬µF'] },
          { id: 'contactor', name: 'Contactor', sizes: ['1-Pole', '2-Pole', '3-Pole'] }
        ]
      },
      iaq: {
        name: 'IAQ & Filtration',
        items: [
          { id: 'media-cleaner', name: 'Media Air Cleaner', sizes: ['16x25', '20x25', '20x20'] },
          { id: 'uv-light', name: 'UV Light System', sizes: ['Single Lamp', 'Dual Lamp'] },
        ]
      },
      venting: { name: 'Venting (Gas/Oil)', items: [ /* ... */ ] },
      drainage: { name: 'Drainage', items: [ /* ... */ ] },
      consumables: { name: 'Consumables & Supplies', items: [ /* ... */ ] }
    };
    
    // v1.0 R410A PT Chart
    const R410A_PT = {
      90: 44.7, 95: 47.1, 100: 49.6, 105: 52.2, 110: 54.9, 115: 57.7, 120: 60.6, 125: 63.6, 130: 66.7, 135: 69.9,
      140: 73.2, 145: 76.6, 150: 80.1, 155: 83.7, 160: 87.4, 165: 91.3, 170: 95.2, 175: 99.3, 180: 103.5, 185: 107.8,
      190: 112.2, 195: 116.7, 200: 121.4, 205: 126.1, 210: 131.0, 215: 135.9, 220: 140.9
    };
    
    // ==================== MODAL & TOAST (v1.0) ====================
    const modalContainer = $('modal-container');
    const modalTitle = $('modal-title');
    const modalBody = $('modal-body');
    
    function showModal(title, message) {
      return new Promise((resolve) => {
        modalTitle.textContent = title;
        modalBody.textContent = message;
        
        $('modal-confirm').onclick = () => {
          modalContainer.classList.remove('visible');
          resolve(true);
        };
        
        $('modal-cancel').onclick = () => {
          modalContainer.classList.remove('visible');
          resolve(false);
        };
        
        modalContainer.classList.add('visible');
      });
    }

    function showToast(message, type = 'info') {
      const toast = $('toast-notification');
      toast.textContent = message;
      toast.className = 'toast-notification';
      if (type !== 'info') {
        toast.classList.add(type);
      }
      
      toast.classList.add('visible');
      
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 2500);
    }

    // ==================== MODE SWITCHING (v1.5) ====================
    function setMode(mode) {
      // Save current mode data before switching
      contextManager.saveCurrentMode(currentMode);
      
      currentMode = mode;
      contextManager.context.currentMode = mode;
      document.body.className = `mode-${mode}`;
      
      // Update mode toggle buttons
      document.querySelectorAll('.mode-toggle button').forEach(btn => btn.classList.remove('active'));
      $(`btn-${mode}`).classList.add('active');
      
      // Load context into new mode
      contextManager.loadContextToForm(mode);
      
      // Re-apply heat/cool mode for service
      if (mode === 'service') {
        setHeatCoolMode(contextManager.context.heatCoolMode); // Load previous H/C mode
      }
      
      // Update generate button text
      const btnText = $('generate-btn');
      if (mode === 'service') {
        btnText.innerHTML = '<span>‚úì</span> Generate Service Report';
      } else if (mode === 'materials') {
        btnText.innerHTML = '<span>‚úì</span> Generate Materials List';
      }
      
      showToast(`Switched to ${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode`, 'info');
    }
    
    function setHeatCoolMode(mode) {
      heatCoolMode = mode;
      contextManager.context.heatCoolMode = mode; // Save to context
      
      // Remove previous heat/cool classes
      document.body.classList.remove('mode-cooling', 'mode-heating');
      
      // Add new heat/cool class if in service mode
      if (document.body.classList.contains('mode-service')) {
        document.body.classList.add(`mode-${mode}`);
      }
      
      // Update buttons
      $('btn-hc-cooling').className = mode === 'cooling' ? 'active secondary' : 'secondary';
      $('btn-hc-heating').className = mode === 'heating' ? 'active secondary' : 'secondary';
      
      // Clear refrigerant calculations
      calcDelta();
      clearRefrigerantCalculations();
    }
    
    function toggleUnitData() {
      const type = $('unit-type').value;
      if (type === 'minisplit' || type === 'package') {
        $('indoor-data').placeholder = "Unit Data (All-in-one system)";
        $('outdoor-unit-fields').classList.add('hidden');
      } else {
        $('indoor-data').placeholder = "Model/Serial/Tonnage";
        $('outdoor-unit-fields').classList.remove('hidden');
      }
    }
    
    function toggleSection(sectionId) {
      const section = $(sectionId);
      if (section && section.classList.contains('section')) {
        section.classList.toggle('open');
      }
    }

    // ==================== CALCULATIONS (v1.0) ====================
    function clearRefrigerantCalculations() {
      const sh = $('superheat');
      const sc = $('subcool');
      const shStatus = $('superheat-status');
      const scStatus = $('subcool-status');
      
      if (sh) sh.value = '';
      if (sc) sc.value = '';
      if (shStatus) shStatus.innerHTML = '';
      if (scStatus) scStatus.innerHTML = '';
    }
    
    function calcDelta() {
      const ret = num($('return-temp').value);
      const sup = num($('supply-temp').value);
      if (ret === null || sup === null) {
        $('delta-t').value = '';
        $('delta-status').innerHTML = '';
        return;
      }
      
      const delta = heatCoolMode === 'cooling' ? ret - sup : sup - ret;
      $('delta-t').value = delta.toFixed(1) + ' ¬∞F';
      
      const statusDiv = $('delta-status');
      if (heatCoolMode === 'cooling') {
        const rules = HVAC_RULES.airflow.deltaT.cooling;
        if (delta < rules.min - 2) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è Low delta (${delta.toFixed(1)}¬∞F) - check airflow or low charge</div>`;
        else if (delta >= rules.min && delta <= rules.max) statusDiv.innerHTML = `<div class="status good">‚úì Delta T in optimal range (${rules.min}-${rules.max}¬∞F)</div>`;
        else if (delta > rules.max + 2) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è High delta (${delta.toFixed(1)}¬∞F) - possible restriction</div>`;
        else statusDiv.innerHTML = `<div class="status warn">‚ö†Ô∏è Delta T marginal - verify charge</div>`;
      } else {
        // Heating
        const rules = HVAC_RULES.airflow.deltaT.heating;
        if (delta < rules.min) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è Low rise - check gas input or airflow</div>`;
        else if (delta >= rules.min && delta <= rules.max) statusDiv.innerHTML = `<div class="status good">‚úì Temperature rise in range (${rules.min}-${rules.max}¬∞F)</div>`;
        else if (delta > rules.max) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è Excessive rise - airflow restriction</div>`;
        else statusDiv.innerHTML = `<div class="status warn">‚ö†Ô∏è Temperature rise marginal</div>`;
      }
    }
    
    function calcStatic() {
      const ret = num($('return-static').value);
      const sup = num($('supply-static').value);
      if (ret === null || sup === null) {
        $('total-static').value = '';
        $('static-status').innerHTML = '';
        return;
      }
      
      const total = Math.abs(ret) + Math.abs(sup);
      $('total-static').value = total.toFixed(2) + ' in w.c.';
      
      const statusDiv = $('static-status');
      const rules = HVAC_RULES.airflow.staticPressure;
      if (total <= rules.acceptable.max) statusDiv.innerHTML = `<div class="status good">‚úì Static pressure acceptable (‚â§${rules.acceptable.max})</div>`;
      else if (total <= rules.elevated.max) statusDiv.innerHTML = `<div class="status warn">‚ö†Ô∏è Static elevated (${rules.acceptable.max}-${rules.elevated.max})</div>`;
      else statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è Static excessive (>${rules.elevated.max}) - duct issues likely</div>`;
    }
    
    function validateVoltage() {
      const lineVoltage = num($('voltage-line').value);
      if (!lineVoltage) {
        $('voltage-status').innerHTML = '';
        return;
      }
      
      const statusDiv = $('voltage-status');
      const rules = HVAC_RULES.electrical.voltage.acceptable;
      if (lineVoltage < rules.min) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è Low voltage (<${rules.min}V)</div>`;
      else if (lineVoltage > rules.max) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è High voltage (>${rules.max}V)</div>`;
      else statusDiv.innerHTML = `<div class="status good">‚úì Voltage in acceptable range</div>`;
    }
    
    function calcRefrigerant() {
      const suctP = num($('suction-pressure').value);
      const suctT = num($('suction-temp').value);
      const liqP = num($('liquid-pressure').value);
      const liqT = num($('liquid-temp').value);
      const refrigType = $('refrigerant').value.toLowerCase();
      
      if (heatCoolMode !== 'cooling' || !refrigType || !HVAC_RULES.refrigerant[refrigType]) {
        clearRefrigerantCalculations();
        return;
      }
      
      const rules = HVAC_RULES.refrigerant[refrigType];

      if (suctP && suctT) {
        const satTemp = diagnosticEngine.lookupSatTemp(suctP, refrigType); // Use engine's lookup
        if (satTemp) {
          const superheat = suctT - satTemp;
          $('superheat').value = superheat.toFixed(1) + ' ¬∞F';
          const statusDiv = $('superheat-status');
          if (superheat < rules.superheat.min - 3) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è Low SH (<${rules.superheat.min - 3}¬∞F) - possible overcharge</div>`;
          else if (superheat >= rules.superheat.min && superheat <= rules.superheat.max) statusDiv.innerHTML = `<div class="status good">‚úì Superheat in target range (${rules.superheat.min}-${rules.superheat.max}¬∞F)</div>`;
          else if (superheat > rules.superheat.max + 5) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è High SH (>${rules.superheat.max + 5}¬∞F) - possible undercharge</div>`;
          else statusDiv.innerHTML = `<div class="status warn">‚ö†Ô∏è Superheat marginal</div>`;
        }
      }
      
      if (liqP && liqT) {
        const satTemp = diagnosticEngine.lookupSatTemp(liqP, refrigType); // Use engine's lookup
        if (satTemp) {
          const subcool = satTemp - liqT;
          $('subcool').value = subcool.toFixed(1) + ' ¬∞F';
          const statusDiv = $('subcool-status');
          if (subcool < rules.subcool.min - 3) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è Low SC (<${rules.subcool.min - 3}¬∞F) - possible undercharge</div>`;
          else if (subcool >= rules.subcool.min && subcool <= rules.subcool.max) statusDiv.innerHTML = `<div class="status good">‚úì Subcool in target range (${rules.subcool.min}-${rules.subcool.max}¬∞F)</div>`;
          else if (subcool > rules.subcool.max + 5) statusDiv.innerHTML = `<div class="status bad">‚ö†Ô∏è High SC (>${rules.subcool.max + 5}¬∞F) - possible overcharge</div>`;
          else statusDiv.innerHTML = `<div class="status warn">‚ö†Ô∏è Subcool marginal</div>`;
        }
      }
    }
    
    function calculateAge() {
      const mfgDate = $('mfg-date').value;
      if (!mfgDate) {
        $('equipment-age').textContent = '';
        return;
      }
      const mfg = new Date(mfgDate);
      const years = (Date.now() - mfg.getTime()) / (1000 * 60 * 60 * 24 * 365.25);
      $('equipment-age').textContent = `Equipment Age: ${years.toFixed(1)} years`;
    }
    
    function calculateLaborHours() {
      const arrival = $('arrival-time').value;
      const completion = $('completion-time').value;
      if (!arrival || !completion) return;
      const arrivalDate = new Date(`2000-01-01T${arrival}`);
      const completionDate = new Date(`2000-01-01T${completion}`);
      let diffMs = completionDate - arrivalDate;
      if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;
      const hours = diffMs / (1000 * 60 * 60);
      $('total-hours').value = hours.toFixed(2) + ' hours';
    }
    
    // ==================== VOICE INPUT (v1.0) ====================
    let recognition = null;
    let currentVoiceTarget = null;
    
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = (e) => {
        if (currentVoiceTarget && e.results[0]) {
          const transcript = e.results[0][0].transcript;
          currentVoiceTarget.value = transcript;
          currentVoiceTarget.dispatchEvent(new Event('input'));
          currentVoiceTarget.dispatchEvent(new Event('change'));
        }
      };
      
      recognition.onend = () => {
        document.querySelectorAll('.voice-btn.listening').forEach(btn => {
          btn.classList.remove('listening');
        });
      };
      
      recognition.onerror = (e) => {
        console.error('Speech recognition error:', e.error);
        showToast(`Voice Error: ${e.error}`, 'danger');
        document.querySelectorAll('.voice-btn.listening').forEach(btn => {
          btn.classList.remove('listening');
        });
      };
    }
    
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('voice-btn')) {
        const targetId = e.target.dataset.voice;
        currentVoiceTarget = $(targetId);
        
        if (recognition && currentVoiceTarget) {
          try { recognition.stop(); } catch (err) {}
          document.querySelectorAll('.voice-btn').forEach(btn => btn.classList.remove('listening'));
          e.target.classList.add('listening');
          try {
            recognition.start();
          } catch (err) {
            console.error('Could not start recognition:', err);
            showToast('Voice input failed to start', 'danger');
          }
        } else if (!recognition) {
          showToast('Voice input not supported on this device', 'danger');
        }
      }
    });
    
    // ==================== PHOTOS (v1.0) ====================
    function takePhoto(purpose) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          photos.push({
            purpose: purpose,
            data: event.target.result,
            timestamp: new Date().toISOString(),
            id: Date.now()
          });
          updatePhotoPreview();
        };
        reader.readAsDataURL(file);
      };
      
      input.click();
    }
    
    async function deletePhoto(photoId) {
      const confirmed = await showModal('Delete Photo', 'Are you sure you want to delete this photo?');
      if (confirmed) {
        photos = photos.filter(p => p.id !== photoId);
        updatePhotoPreview();
      }
    }
    
    function updatePhotoPreview() {
      $('photo-preview').innerHTML = photos.map(p => 
        `<div class="photo-item">
            <img src="${p.data}" alt="${p.purpose}">
            <div class="photo-label">${p.purpose}</div>
            <button class="photo-delete" onclick="deletePhoto(${p.id})">√ó</button>
        </div>`
      ).join('');
    }
    
    // ==================== MATERIALS MANAGEMENT (v1.0) ====================
    function updateMaterialsList() {
      const category = $('material-category').value;
      const container = $('materials-catalog-container');
      
      if (!category) {
        container.innerHTML = '<div class="text-muted" style="padding: 20px; text-align: center;">Select a category to view materials</div>';
        return;
      }
      
      const catalogData = materialsCatalog[category];
      if (!catalogData) return;
      
      container.innerHTML = catalogData.items.map(item => `
        <div class="material-item">
          <div class="material-item-info">
            <div class="material-item-name">${item.name}</div>
            <div class="material-item-spec">${item.sizes ? item.sizes.slice(0, 3).join(', ') + (item.sizes.length > 3 ? ' +more' : '') : 'Standard'}</div>
          </div>
          <button class="material-add-btn" onclick="addMaterial('${category}', '${item.id}')">+ Add</button>
        </div>
      `).join('');
    }
    
    function addMaterial(category, itemId) {
      const catalogData = materialsCatalog[category];
      const item = catalogData.items.find(i => i.id === itemId);
      if (!item) return;
      
      // Check if already added
      const existing = selectedMaterials.find(m => m.itemId === itemId);
      if (existing) {
        existing.quantity++;
        renderSelectedMaterials();
        showToast('Increased quantity', 'info');
        return;
      }
      
      const materialId = `mat-${Date.now()}-${Math.random()}`;
      selectedMaterials.push({
        id: materialId,
        itemId: item.id,
        category: catalogData.name,
        name: item.name,
        size: item.sizes ? item.sizes[0] : 'Standard',
        sizes: item.sizes || ['Standard'],
        spec: item.spec || null,
        quantity: 1,
        unit: item.unit || 'ea',
        tonnage: item.tonnage || false,
        tonnageRange: item.tonnageRange || null
      });
      
      renderSelectedMaterials();
      updateSuggestions(); // v1.0 suggestions
      showToast('Material added', 'success');
    }
    
    function updateMaterialQuantity(id, qty) {
      const material = selectedMaterials.find(m => m.id === id);
      if (material) {
        material.quantity = Math.max(1, parseInt(qty) || 1);
        renderSelectedMaterials();
      }
    }
    
    function updateMaterialSize(id, size) {
      const material = selectedMaterials.find(m => m.id === id);
      if (material) {
        material.size = size;
        renderSelectedMaterials();
        updateSuggestions();
      }
    }
    
    function removeMaterial(id) {
      selectedMaterials = selectedMaterials.filter(m => m.id !== id);
      renderSelectedMaterials();
      updateSuggestions();
    }
    
    function renderSelectedMaterials() {
      const container = $('selected-materials-list');
      const totalBadge = $('total-items-badge');
      
      const totalItems = selectedMaterials.reduce((sum, m) => sum + m.quantity, 0);
      totalBadge.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
      
      if (selectedMaterials.length === 0) {
        container.innerHTML = '<div class="text-muted" style="text-align: center; padding: 20px;">No materials selected yet. Add items from the catalog above.</div>';
        return;
      }
      
      container.innerHTML = selectedMaterials.map(m => `
        <div class="selected-material">
          <div class="selected-material-header">
            <div>
              <div class="selected-material-title">${m.name}</div>
              <div class="selected-material-category">${m.category}</div>
            </div>
            <button class="remove-btn" onclick="removeMaterial('${m.id}')">√ó</button>
          </div>
          <div class="selected-material-controls">
            ${m.sizes.length > 1 ? `
              <select style="flex: 1; margin: 0;" onchange="updateMaterialSize('${m.id}', this.value)">
                ${m.sizes.map(size => `<option value="${size}" ${m.size === size ? 'selected' : ''}>${size}</option>`).join('')}
              </select>
            ` : `
              <div style="flex: 1; font-size: 14px; color: #666;">${m.spec ? `${m.size} - ${m.spec}` : m.size}</div>
            `}
            <input type="number" min="1" value="${m.quantity}" class="qty-input" onchange="updateMaterialQuantity('${m.id}', this.value)">
            <div style="min-width: 30px; font-size: 14px; color: #666;">${m.unit}</div>
          </div>
        </div>
      `).join('');
    }
    
    // v1.0 Suggestions (now co-exists with v1.5 suggestions)
    function updateSuggestions() {
      // This is the v1.0 suggestion logic, based on *selected* items
      // The v1.5 logic is based on *service diagnostics*
      const suggestions = [];
      const coolingEquipment = selectedMaterials.find(m => m.tonnage);
      
      if (coolingEquipment) {
        const tonnage = parseFloat(coolingEquipment.size);
        if (tonnage) {
          const hasLineset = selectedMaterials.some(m => m.itemId && m.itemId.includes('lineset'));
          if (!hasLineset) {
            let linesetId = tonnage <= 2.5 ? 'lineset-small' : (tonnage <= 3.5 ? 'lineset-medium' : 'lineset-large');
            suggestions.push({
              category: 'refrigerant',
              item: materialsCatalog.refrigerant.items.find(i => i.id === linesetId),
              reason: `Matches ${tonnage} ton system`
            });
          }
        }
      }
      // This logic could be expanded, but we'll keep it simple
    }

    // v1.5 Function to add suggested material
    function addSuggestedMaterial(idx) {
      if (!window.currentSuggestions || !window.currentSuggestions[idx]) return;
      
      const suggestion = window.currentSuggestions[idx];
      
      // Find the catalog item to add
      const catalogItem = materialsCatalog[suggestion.category]?.items.find(
        item => item.id === suggestion.item.id
      );
      
      if (catalogItem) {
        addMaterial(suggestion.category, suggestion.item.id);
        
        // Mark as added in UI
        const suggestionElements = document.querySelectorAll('.suggestion-item');
        if (suggestionElements[idx]) {
          const btn = suggestionElements[idx].querySelector('.material-add-btn');
          btn.textContent = '‚úì Added';
          btn.style.background = '#34C759'; // success color
          btn.disabled = true;
        }
      } else {
        showToast(`Item ${suggestion.item.name} not in catalog.`, 'danger');
      }
    }
    
    // ==================== REPORT GENERATION (v1.5) ====================
    
    // v1.5 GATHER (uses ContextManager)
    function gatherServiceData() {
      contextManager.saveCurrentMode('service'); // Save all form data to context
      
      // Build the data object from the context
      const ctx = contextManager.context;
      return {
        meta: {
          tech: ctx.signature.tech || '[Technician]',
          mode: 'Service',
          heatCoolMode: ctx.heatCoolMode
        },
        job: ctx.job,
        equipment: ctx.equipment,
        time: ctx.service.time,
        materials: ctx.materials.serviceMaterials,
        service: {
          safety: ctx.service.safety,
          operating: ctx.service.operating,
          components: ctx.service.components,
          complaint: ctx.service.complaint, // Added complaint
          findings: ctx.service.review.findings,
          recommendations: ctx.service.review.recommendations,
          workPerformed: ctx.service.review.workPerformed
        },
        photos: ctx.photos,
        signature: ctx.signature
      };
    }
    
    // v1.0 GATHER
    function gatherMaterialsData() {
      contextManager.saveCurrentMode('materials'); // Save material form data
      const ctx = contextManager.context;
      
      return {
        meta: { tech: ctx.signature.tech || '[Technician]', mode: 'Materials' },
        job: ctx.job,
        materials: ctx.materials.selectedMaterials,
        photos: ctx.photos,
        signature: ctx.signature
      };
    }
    
    // v1.5 GENERATE (Main Entry Point)
    function generate() {
      const existing = document.querySelector('.report-preview')?.closest('.card');
      if (existing) existing.remove();
      
      if (currentMode === 'service') {
        const serviceData = gatherServiceData();
        const analysisResults = diagnosticEngine.analyzeServiceData(serviceData);
        
        // Store in context and session
        contextManager.context.diagnosticAnalysis = analysisResults;
        sessionStorage.setItem('diagnosticAnalysis', JSON.stringify(analysisResults));
        sessionStorage.setItem('currentServiceData', JSON.stringify(serviceData));
        
        // Show review modal if there are findings
        if (analysisResults.critical.length > 0 || 
            analysisResults.findings.length > 0 || 
            analysisResults.warnings.length > 0) {
          showDiagnosticReviewModal(analysisResults);
        } else {
          // No issues - proceed directly
          proceedToReportGeneration();
        }
        
      } else if (currentMode === 'materials') {
        const reportData = gatherMaterialsData();
        const reportText = generateMaterialsList(reportData);
        sessionStorage.setItem('currentReport', JSON.stringify(reportData));
        sessionStorage.setItem('currentReportText', reportText);
        displayReport(reportText, 'üìã Materials List Generated');
        showToast('Materials List Generated!', 'success');
      }
    }
    
    // v1.5 New Modal/Report Functions
    function showDiagnosticReviewModal(results) {
      const modal = $('diagnostic-review-modal');
      
      const populate = (sectionId, listId, items, type) => {
        const section = $(sectionId);
        const list = $(listId);
        if (items.length > 0) {
          section.classList.remove('hidden');
          list.innerHTML = items.map((item, idx) => 
            generateReviewItemHTML(item, idx, type)
          ).join('');
        } else {
          section.classList.add('hidden');
        }
      };

      populate('review-critical-section', 'review-critical-list', results.critical, 'critical');
      // Combine findings and warnings into one "Findings" section
      const allFindings = [...results.findings, ...results.warnings];
      populate('review-findings-section', 'review-findings-list', allFindings, 'finding');
      
      $('review-warnings-section').classList.add('hidden'); // Hide the separate warnings section

      if (results.critical.length === 0 && allFindings.length === 0) {
        $('review-allclear-section').classList.remove('hidden');
      } else {
        $('review-allclear-section').classList.add('hidden');
      }
      
      modal.classList.add('visible');
    }

    function generateReviewItemHTML(item, idx, type) {
      const patternInfo = DIAGNOSTIC_PATTERNS[item.pattern];
      let title = item.issue || (patternInfo ? patternInfo.name : 'Diagnostic Finding');
      
      // Determine class: critical is 'bad', finding/warning is 'warn'
      let itemClass = 'info';
      if (type === 'critical') itemClass = 'bad';
      if (type === 'finding') itemClass = 'warn';

      let html = `<div class="review-item ${itemClass}">`;
      html += `<div class="review-item-header">${title}</div>`;

      if (item.measurements) {
        html += `<div class="review-item-measurements">`;
        for (let key in item.measurements) {
          html += `<strong>${key}:</strong> ${item.measureMENTS[key]}<br>`;
        }
        html += `</div>`;
      }
      
      if (item.description) {
        html += `<p style="margin: 8px 0; font-size: 14px; line-height: 1.5;">${item.description}</p>`;
      }
      
      const checks = item.checks || [];
      if (checks.length > 0) {
        html += `<div class="review-item-checks">`;
        html += `<strong style="display: block; margin-bottom: 8px; font-size: 13px; color: #666;">Verification Steps:</strong>`;
        checks.forEach((check, checkIdx) => {
          html += `<label><input type="checkbox" id="check-${idx}-${checkIdx}"><span>${check}</span></label>`;
        });
        html += `</div>`;
      }
      
      html += `</div>`;
      return html;
    }

    function closeReviewModal() {
      $('diagnostic-review-modal').classList.remove('visible');
    }

    function proceedToReportGeneration() {
      closeReviewModal();
      
      const serviceData = JSON.parse(sessionStorage.getItem('currentServiceData'));
      const diagnosticAnalysis = JSON.parse(sessionStorage.getItem('diagnosticAnalysis'));
      
      const reportText = generateServiceReport(serviceData, diagnosticAnalysis);
      
      sessionStorage.setItem('currentReportText', reportText);
      displayReport(reportText, 'üìã Service Report Generated');
      showToast('Service Report Generated!', 'success');
    }

    // v1.5 modified generateServiceReport
    function generateServiceReport(data, diagnosticAnalysis) {
      let report = `
HVAC SERVICE REPORT
======================================================
Date: ${new Date().toLocaleString()}
Technician: ${data.meta.tech}
Mode: ${data.meta.mode} - ${data.meta.heatCoolMode.toUpperCase()}
------------------------------------------------------
Customer: ${data.job.customer}
Address: ${data.job.address}
Job Type: ${data.job.jobType}

CUSTOMER COMPLAINT:
  ${data.service.complaint || 'N/A'}

EQUIPMENT IDENTITY
------------------
Brand: ${data.equipment.brand}
Type: ${data.equipment.unitType}
Indoor: ${data.equipment.indoorData}
Outdoor: ${data.equipment.outdoorData}
Tonnage: ${data.equipment.tonnage} | Refrigerant: ${data.equipment.refrigerant}
Mfg Date: ${data.equipment.mfgDate} ${data.equipment.age ? `${data.equipment.age}` : ''}

TIME TRACKING
-------------
Arrival: ${data.time.arrival} | Completion: ${data.time.completion}
Total: ${data.time.total}

OPERATING CONDITIONS
--------------------
Outdoor: ${data.service.operating.outdoorTemp}¬∞F, ${data.service.operating.outdoorHumidity}% RH
Airflow:
  Return: ${data.service.operating.returnTemp}¬∞F | Supply: ${data.service.operating.supplyTemp}¬∞F
  Delta T: ${data.service.operating.deltaT}
  Return Static: ${data.service.operating.returnStatic} | Supply: ${data.service.operating.supplyStatic}
  Total Static: ${data.service.operating.totalStatic}

Electrical:
  Line Voltage: ${data.service.operating.voltageLine}V
  Control: ${data.service.operating.controlVoltage}V
  Blower Amps: ${data.service.operating.blowerAmps}

${data.meta.heatCoolMode === 'cooling' ? 
`Refrigerant Circuit (COOLING):
  Suction: ${data.service.operating.suctionPressure} psig @ ${data.service.operating.suctionTemp}¬∞F
  Liquid: ${data.service.operating.liquidPressure} psig @ ${data.service.operating.liquidTemp}¬∞F
  Superheat: ${data.service.operating.superheat} | Subcool: ${data.service.operating.subcool}
  Compressor: ${data.service.operating.compAmps}` : 
`Heating Circuit:
  Heat Exchanger: ${data.service.operating.heatExchanger}
  Flame: ${data.service.operating.flameAppearance}
  Inducer: ${data.service.operating.inducerAmps}A`}

COMPONENT INSPECTION
--------------------
Filter: ${data.service.components.filter}
Evap Coil: ${data.service.components.evapCoil} | Cond Coil: ${data.service.components.condCoil}
Capacitor: ${data.service.components.capacitorReading}
Contactor: ${data.service.components.contactorCondition}
Blower: ${data.service.components.blowerCondition}
`;

      // NEW v1.5 SECTION
      if (diagnosticAnalysis) {
        report += `
DIAGNOSTIC ANALYSIS
--------------------
Status: ${diagnosticAnalysis.overallStatus.toUpperCase()}
`;
        if (diagnosticAnalysis.critical.length > 0) {
          report += `\nCRITICAL ISSUES:\n`;
          diagnosticAnalysis.critical.forEach((item, idx) => {
            let title = item.issue || DIAGNOSTIC_PATTERNS[item.pattern]?.name || 'Critical Issue';
            report += `  ${idx + 1}. ${title}\n`;
            if(item.measurements) {
                report += `     ${Object.entries(item.measurements).map(([k, v]) => `${k}: ${v}`).join(', ')}\n`;
            }
            if(item.description) {
                report += `     ${item.description}\n`;
            }
          });
        }
        
        const allFindings = [...diagnosticAnalysis.findings, ...diagnosticAnalysis.warnings];
        if (allFindings.length > 0) {
          report += `\nFINDINGS & WARNINGS:\n`;
          allFindings.forEach((item, idx) => {
            let title = item.issue || DIAGNOSTIC_PATTERNS[item.pattern]?.name || 'Finding';
            report += `  ${idx + 1}. ${title}\n`;
            if(item.description) {
                report += `     ${item.description}\n`;
            }
          });
        }
      }

      report += `
MATERIALS USED
--------------
${formatServiceMaterials(data.materials)}

FINDINGS & RECOMMENDATIONS
--------------------------
Findings:
${data.service.findings}

Recommendations:
${data.service.recommendations}

Work Performed:
${data.service.workPerformed}

PHOTO DOCUMENTATION
-------------------
${data.photos.length} Photo(s): ${data.photos.map(p => p.purpose).join(', ')}

TECHNICIAN CERTIFICATION
------------------------
${data.signature.tech}
Customer Acknowledged: ${data.signature.customer}
`;
      return report.replace(/\n\s+\n/g, '\n\n');
    }
    
    // v1.0 function
    function formatServiceMaterials(materials) {
      let text = '  ';
      if (materials.refrigerant?.type) text += `Refrigerant: ${materials.refrigerant.type} - ${materials.refrigerant.amount}\n  `;
      if (materials.filter?.size) text += `Filter: ${materials.filter.size} MERV ${materials.filter.merv}\n  `;
      if (materials.capacitor?.qty > 0) text += `Capacitor: ${materials.capacitor.type} (${materials.capacitor.qty})\n  `;
      if (materials.contactor?.qty > 0) text += `Contactor: ${materials.contactor.rating} (${materials.contactor.qty})\n  `;
      if (materials.other) text += `Other: ${materials.other}\n  `;
      return text.trim() || 'None';
    }
    
    // v1.0 function
    function generateMaterialsList(data) {
      let list = '';
      list += '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n';
      list += '‚ïë          HVAC MATERIALS LIST - PRE-INSTALL                 ‚ïë\n';
      list += '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n';
      
      list += 'JOB INFORMATION\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      list += `Customer/Job: ${data.job.customer || 'N/A'}\n`;
      list += `Address: ${data.job.address || 'N/A'}\n`;
      list += `Technician: ${data.meta.tech}\n`;
      list += `Date: ${data.job.date || new Date().toISOString().split('T')[0]}\n`;
      if (data.job.notes) list += `Notes: ${data.job.notes}\n`;
      list += '\n';
      
      if (data.materials.length === 0) {
        list += 'No materials added to list.\n\n';
      } else {
        const groupedMaterials = data.materials.reduce((acc, m) => {
          if (!acc[m.category]) acc[m.category] = [];
          acc[m.category].push(m);
          return acc;
        }, {});
        
        list += 'MATERIALS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
        
        Object.entries(groupedMaterials).forEach(([category, items]) => {
          list += `${category}:\n`;
          list += '‚îÄ'.repeat(60) + '\n';
          items.forEach(m => {
            const sizeInfo = m.spec ? `${m.size} - ${m.spec}` : m.size;
            list += `‚òê ${m.name}\n`;
            list += `  Size/Spec: ${sizeInfo}\n`;
            list += `  Quantity: ${m.quantity} ${m.unit}\n`;
            list += '\n';
          });
          list += '\n';
        });
        
        list += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
        const totalItems = data.materials.reduce((sum, m) => sum + m.quantity, 0);
        list += `TOTAL ITEMS: ${totalItems}\n`;
        list += `TOTAL LINE ITEMS: ${data.materials.length}\n`;
        list += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
      }
      
      if (data.photos.length > 0) {
        list += `\nATTACHED PHOTOS: ${data.photos.length}\n`;
        list += data.photos.map(p => `  - ${p.purpose}`).join('\n') + '\n';
      }
      
      list += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      list += `Generated: ${new Date().toLocaleString()}\n`;
      list += `Technician: ${data.meta.tech}\n`;
      list += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      
      return list;
    }
    
    // v1.0 function
    function displayReport(text, title) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-header">
          <span>${title}</span>
        </div>
        <div class="status good">
          <span>‚úì</span>
          <span>Ready to export or share</span>
        </div>
        <pre class="report-preview" id="report-pre">${text}</pre>
        <div class="grid-2 mt-8">
          <button onclick="copyToClipboard()" class="success">üìã Copy</button>
          <button onclick="printReport()" class="secondary">üñ®Ô∏è Print</button>
        </div>
      `;
      
      document.querySelector('.actions').before(card);
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // v1.0 function
    function copyToClipboard() {
      const text = document.getElementById('report-pre')?.textContent;
      if (!text) {
        showToast('Generate a report first!', 'danger');
        return;
      }
      
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-9999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showToast('‚úì Copied to clipboard!', 'success');
        } else {
          showToast('Copy failed. Please copy manually.', 'danger');
        }
      } catch (err) {
        showToast('Copy failed. Please copy manually.', 'danger');
      }
      document.body.removeChild(textArea);
    }
    
    // v1.0 function
    function printReport() {
      const text = document.getElementById('report-pre')?.textContent;
      if (!text) {
        showToast('Generate a report first!', 'danger');
        return;
      }
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html><head><title>Field Buddy Report</title><style>
            body { font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; margin: 0.5in; white-space: pre-wrap; }
            @media print { body { margin: 0.25in; } }
        </style></head><body>${text}</body></html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 250);
    }
    
    // v1.0 function
    function exportReport() {
      const text = sessionStorage.getItem('currentReportText');
      const dataStr = sessionStorage.getItem('currentReport');
      if (!text || !dataStr) {
        showToast('Generate a report first', 'danger');
        return;
      }
      
      const data = JSON.parse(dataStr);
      let customer = 'Job';
      if (currentMode === 'service') {
        customer = data.job.customer.replace(/\s/g, '_') || 'ServiceJob';
      } else {
        customer = data.job.customer.replace(/\s/g, '_') || 'MaterialsList';
      }
      const date = (data.job.date || new Date().toISOString().split('T')[0]).replace(/\//g, '-');
      const fileName = `FieldBuddy_${currentMode.toUpperCase()}_${customer}_${date}.txt`;

      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Exporting file...', 'success');
    }
    
    // v1.0 function
    async function clearForm() {
      const confirmed = await showModal(
        'Clear Form', 
        'Are you sure you want to clear all data? This cannot be undone.'
      );
      if (!confirmed) return;
      
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox') el.checked = false;
        else el.value = '';
      });
      
      selectedMaterials = [];
      photos = [];
      updatePhotoPreview();
      renderSelectedMaterials();
      updateSuggestions();
      $('suggestions-container').classList.add('hidden'); // Also hide v1.5 suggestions
      
      const existing = document.querySelector('.report-preview')?.closest('.card');
      if (existing) existing.remove();
      
      // Clear context
      contextManager.context = new ContextManager().context; // Reset context
      sessionStorage.removeItem('currentReport');
      sessionStorage.removeItem('currentReportText');
      sessionStorage.removeItem('currentServiceData');
      sessionStorage.removeItem('diagnosticAnalysis');
      
      $('date').value = new Date().toISOString().split('T')[0];
      $('mat-date').value = new Date().toISOString().split('T')[0];
      
      showToast('Form cleared', 'success');
    }
    
    // ==================== CHECKBOX STYLING (v1.0) ====================
    document.addEventListener('input', (e) => {
      if (e.target.type === 'checkbox') {
        const label = e.target.closest('label.check');
        if (label) {
          label.classList.toggle('checked', e.target.checked);
        }
      }
    });
    
    // ==================== INITIALIZATION (v1.0) ====================
    window.addEventListener('load', () => {
      $('date').value = new Date().toISOString().split('T')[0];
      $('mat-date').value = new Date().toISOString().split('T')[0];
      
      setMode('service'); // This will also load context
      
      console.log('%cüì¶ Field Buddy Pro v1.5 - Intelligent Validation Loaded', 'color:#007AFF; font-size:14px; font-weight:bold');
    });
    
</script>
</body>
</html>

