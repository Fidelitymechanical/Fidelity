```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <meta name="description" content="Professional HVAC field documentation and materials system">
  <title>Field Buddy Pro - Service & Materials</title>
  <style>
    /* ==================== BASE STYLES ==================== */
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    html {
      scroll-padding-top: 20px;
    }
    
    body { 
      font: 16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #F8F9FA;
      padding: 8px;
      padding-bottom: 90px;
      color: #1F2937;
    }
    
    /* ==================== INPUTS ==================== */
    input, select, textarea, button {
      font-size: 16px;
      padding: 12px 16px;
      border: 1px solid #D1D5DB;
      border-radius: 6px;
      width: 100%;
      margin: 8px 0;
      font-family: inherit;
      -webkit-appearance: none;
      background: white;
      transition: all 0.2s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3B82F6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }
    
    input[readonly] {
      background: #F3F4F6;
      color: #6B7280;
      cursor: not-allowed;
    }
    
    input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
      accent-color: #3B82F6;
      flex-shrink: 0;
    }
    
    label {
      display: block;
      font-size: 13px;
      color: #6B7280;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    label.check {
      display: flex;
      align-items: center;
      font-size: 15px;
      color: #1F2937;
      margin: 10px 0;
      padding: 12px 14px;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #E5E7EB;
      transition: all 0.2s;
    }
    
    label.check:hover {
      background: #F9FAFB;
      border-color: #3B82F6;
    }
    
    label.check.checked {
      background: #EFF6FF;
      border-color: #3B82F6;
    }
    
    /* ==================== BUTTONS ==================== */
    button {
      background: #3B82F6;
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
      border-radius: 6px;
    }
    
    button:hover {
      background: #2563EB;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary { 
      background: #6B7280;
    }
    
    button.secondary:hover {
      background: #4B5563;
    }
    
    button.success { 
      background: #10B981;
    }
    
    button.success:hover {
      background: #059669;
    }
    
    button.danger { 
      background: #EF4444;
    }
    
    button.danger:hover {
      background: #DC2626;
    }
    
    button.warning { 
      background: #F59E0B;
    }
    
    button.warning:hover {
      background: #D97706;
    }
    
    button.small { 
      padding: 8px 12px;
      font-size: 14px;
      min-height: 36px;
    }
    
    /* ==================== CARDS ==================== */
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 12px 0;
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
      border: 1px solid #E5E7EB;
    }
    
    .card-header {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #F3F4F6;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #1F2937;
    }
    
    .card-subheader {
      font-size: 15px;
      font-weight: 600;
      color: #3B82F6;
      margin: 16px 0 8px 0;
      padding-top: 12px;
      border-top: 1px solid #E5E7EB;
    }
    
    /* ==================== GRID LAYOUTS ==================== */
    .grid-2 { 
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .grid-3 { 
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    
    .grid-4 { 
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    
    @media (max-width: 640px) {
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
    }
    
    /* ==================== MODE TOGGLE ==================== */
    .mode-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 12px 0;
    }
    
    .mode-toggle button {
      background: white;
      color: #6B7280;
      border: 1px solid #E5E7EB;
      font-size: 15px;
      padding: 12px;
      min-height: 44px;
    }
    
    .mode-toggle button:hover {
      background: #F9FAFB;
      color: #1F2937;
      border-color: #D1D5DB;
      transform: none;
      box-shadow: none;
    }
    
    .mode-toggle button.active {
      background: #3B82F6;
      color: white;
      border-color: #3B82F6;
    }
    
    .mode-toggle button.active:hover {
      background: #2563EB;
      border-color: #2563EB;
    }
    
    /* ==================== STATUS INDICATORS ==================== */
    .status {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1.4;
    }
    
    .status.good { 
      background: #D1FAE5; 
      color: #065F46; 
      border: 1px solid #10B981;
    }
    
    .status.warn { 
      background: #FEF3C7; 
      color: #92400E; 
      border: 1px solid #F59E0B;
    }
    
    .status.bad { 
      background: #FEE2E2; 
      color: #991B1B; 
      border: 1px solid #EF4444;
    }
    
    .status.info {
      background: #DBEAFE;
      color: #1E40AF;
      border: 1px solid #3B82F6;
    }
    
    /* ==================== VOICE INPUT ==================== */
    .voice-wrapper {
      position: relative;
    }
    
    .voice-btn {
      position: absolute;
      right: 4px;
      top: 12px;
      transform: translateY(0);
      width: 38px;
      height: 38px;
      padding: 0;
      background: #3B82F6;
      border-radius: 6px;
      font-size: 18px;
      z-index: 2;
      min-height: unset;
      margin: 0;
    }

    textarea + .voice-btn {
      top: 12px;
    }
    
    .voice-btn.listening { 
      background: #EF4444;
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
    }
    
    .voice-wrapper input,
    .voice-wrapper textarea {
      padding-right: 50px;
    }

    /* ==================== DYNAMIC FIELDS ==================== */
    .dynamic-item {
      background: #F9FAFB;
      padding: 14px;
      border-radius: 6px;
      margin: 8px 0;
      border: 1px solid #E5E7EB;
      position: relative;
    }
    
    .dynamic-item .remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #EF4444;
      color: white;
      border: none;
      border-radius: 6px;
      width: 28px;
      height: 28px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: unset;
      padding: 0;
      margin: 0;
    }
    
    .add-btn {
      background: #10B981;
      margin-top: 8px;
    }
    
    .add-btn:hover {
      background: #059669;
    }
    
    /* ==================== COLLAPSIBLE SECTIONS ==================== */
    .section {
      margin: 16px 0;
    }
    
    .section-toggle {
      background: white;
      border: 1px solid #E5E7EB;
      color: #1F2937;
      font-weight: 600;
      padding: 14px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      border-radius: 6px;
      margin: 8px 0;
      transition: all 0.2s;
      width: 100%;
      text-align: left;
      min-height: 48px;
    }
    
    .section-toggle:hover {
      background: #F9FAFB;
      border-color: #3B82F6;
      transform: none;
      box-shadow: none;
    }
    
    .section-toggle .arrow {
      font-size: 16px;
      transition: transform 0.2s;
      transform-origin: center;
    }
    
    .section.open .arrow {
      transform: rotate(180deg);
    }
    
    .section-content {
      display: none;
      background: white;
      padding: 16px;
      border-radius: 0 0 6px 6px;
      border: 1px solid #E5E7EB;
      border-top: none;
      margin-top: -8px;
    }
    
    .section.open .section-content {
      display: block;
    }
    
    /* ==================== MODE-SPECIFIC VISIBILITY ==================== */
    .service-only,
    .materials-only,
    .cooling-only,
    .heating-only { 
      display: none; 
    }
    
    body.mode-service .service-only { display: block; }
    body.mode-materials .materials-only { display: block; }
    
    body.mode-service.mode-cooling .cooling-only { display: block; }
    body.mode-service.mode-heating .heating-only { display: block; }

    .grid-2 .cooling-only,
    .grid-2 .heating-only,
    .grid-3 .cooling-only,
    .grid-3 .heating-only {
      display: none;
    }
    
    body.mode-service.mode-cooling .grid-2 .cooling-only,
    body.mode-service.mode-cooling .grid-3 .cooling-only {
      display: block;
    }
    
    body.mode-service.mode-heating .grid-2 .heating-only,
    body.mode-service.mode-heating .grid-3 .heating-only {
      display: block;
    }
    
    /* ==================== PHOTOS ==================== */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    
    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      background: #F3F4F6;
      border: 1px solid #E5E7EB;
    }
    
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-label {
      position: absolute;
      bottom: 4px;
      left: 4px;
      right: 4px;
      background: rgba(0,0,0,0.75);
      color: white;
      padding: 4px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .photo-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #EF4444;
      color: white;
      border: none;
      border-radius: 4px;
      width: 24px;
      height: 24px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.95;
      min-height: unset;
      padding: 0;
      margin: 0;
    }
    
    /* ==================== MATERIALS LIST SPECIFIC ==================== */
    .material-catalog {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .material-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border: 1px solid #E5E7EB;
      border-radius: 6px;
      margin: 6px 0;
      background: white;
      transition: all 0.2s;
    }
    
    .material-item:hover {
      background: #F9FAFB;
      border-color: #3B82F6;
    }
    
    .material-item-info {
      flex: 1;
    }
    
    .material-item-name {
      font-weight: 600;
      font-size: 14px;
      color: #1F2937;
    }
    
    .material-item-spec {
      font-size: 12px;
      color: #6B7280;
      margin-top: 2px;
    }
    
    .material-add-btn {
      padding: 6px 14px;
      font-size: 13px;
      min-height: 32px;
      margin: 0;
      border-radius: 6px;
    }
    
    .selected-material {
      background: #F9FAFB;
      padding: 14px;
      border-radius: 6px;
      margin: 8px 0;
      border: 1px solid #E5E7EB;
    }
    
    .selected-material-header {
      display: flex;
      align-items: start;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .selected-material-title {
      font-weight: 600;
      font-size: 15px;
      color: #1F2937;
    }
    
    .selected-material-category {
      font-size: 11px;
      color: #6B7280;
      text-transform: uppercase;
      margin-top: 2px;
    }
    
    .selected-material-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .qty-input {
      width: 60px;
      padding: 6px;
      text-align: center;
      margin: 0;
      font-weight: 600;
    }
    
    .suggestion-item {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin: 6px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #E5E7EB;
    }
    
    .suggestion-info {
      flex: 1;
    }
    
    .suggestion-name {
      font-weight: 600;
      font-size: 14px;
      color: #1F2937;
    }
    
    .suggestion-reason {
      font-size: 12px;
      color: #6B7280;
      margin-top: 2px;
    }
    
    /* ==================== REPORT PREVIEW ==================== */
    .report-preview {
      background: white;
      padding: 20px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-x: auto;
      margin: 12px 0;
      border: 1px solid #E5E7EB;
      color: #1F2937;
    }
    
    /* ==================== DIAGNOSTIC REVIEW ==================== */
    .review-item {
      background: #F9FAFB;
      border-left: 4px solid #EF4444;
      padding: 16px;
      margin: 12px 0;
      border-radius: 6px;
    }
    
    .review-item.warning {
      border-left-color: #F59E0B;
    }
    
    .review-item.info {
      border-left-color: #3B82F6;
    }
    
    .review-item-header {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 8px;
      color: #1F2937;
    }
    
    .review-item-measurements {
      background: white;
      padding: 12px;
      border-radius: 6px;
      margin: 8px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      border: 1px solid #E5E7EB;
    }
    
    .review-item-checks {
      margin-top: 12px;
    }
    
    .review-item-checks label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 14px;
    }
    
    .review-item-checks input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
    }
    
    /* ==================== STICKY ACTION BAR ==================== */
    .actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 12px;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 8px;
      z-index: 100;
      border-top: 1px solid #E5E7EB;
    }
    
    .actions button {
      flex: 1;
      font-size: 14px;
      padding: 12px 8px;
    }
    
    /* ==================== MODAL & TOAST ==================== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 24px;
      width: 90%;
      max-width: 450px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      transform: scale(0.95);
      transition: transform 0.2s;
    }
    
    .modal-overlay.visible {
      opacity: 1;
      visibility: visible;
    }
    
    .modal-overlay.visible .modal-content {
      transform: scale(1);
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #1F2937;
    }
    
    .modal-body {
      font-size: 15px;
      color: #4B5563;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .modal-actions {
      display: flex;
      gap: 8px;
    }
    
    .modal-actions button {
      flex: 1;
    }
    
    .toast-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1F2937;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s, top 0.3s;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    .toast-notification.visible {
      opacity: 1;
      visibility: visible;
      top: 30px;
    }
    
    .toast-notification.success { background: #10B981; }
    .toast-notification.danger { background: #EF4444; }
    
    /* ==================== HIDDEN / UTILITY ==================== */
    .hidden { display: none !important; }
    .mt-8 { margin-top: 8px; }
    .mt-16 { margin-top: 16px; }
    .mb-8 { margin-bottom: 8px; }
    .text-muted { color: #6B7280; font-size: 13px; }
  </style>
</head>
<body class="mode-service mode-cooling">

  <!-- Header -->
  <div class="card">
    <div class="card-header">
      <div>
        <div style="font-size: 20px;">‚ö° Field Buddy Pro</div>
        <div style="font-size: 12px; color: #6B7280; font-weight: 400; margin-top: 4px;">Service & Materials System</div>
      </div>
    </div>
    
    <div class="mode-toggle">
      <button onclick="setMode('service')" id="btn-service" class="active">üîß Service</button>
      <button onclick="setMode('materials')" id="btn-materials">üì¶ Materials</button>
    </div>
  </div>

  <!-- ==================== SERVICE MODE ==================== -->
  <div class="service-only">
    
    <!-- Job Info -->
    <div class="card">
      <div class="card-header">
        <span>üìã Job Information</span>
      </div>
      
      <label for="customer">Customer Name</label>
      <input type="text" id="customer" placeholder="Full name">
      
      <label for="address">Address</label>
      <input type="text" id="address" placeholder="Street, City, State">
      
      <div class="grid-2">
        <div>
          <label for="sales-tech">Technician</label>
          <input type="text" id="sales-tech" placeholder="Your name">
        </div>
        <div>
          <label for="date">Date</label>
          <input type="date" id="date">
        </div>
      </div>
      
      <label>Job Type</label>
      <select id="job-type">
        <option value="">Select job type...</option>
        <option value="maintenance">Maintenance</option>
        <option value="repair">Repair</option>
        <option value="diagnostic">Diagnostic</option>
        <option value="emergency">Emergency</option>
      </select>
      
      <label>Customer Complaint</label>
      <div class="voice-wrapper">
        <textarea id="complaint" placeholder="What's the issue? (in customer's words)" rows="3"></textarea>
        <button class="voice-btn" data-voice="complaint">üé§</button>
      </div>
    </div>
    
    <!-- On-Site Time Tracking -->
    <div class="card">
      <div class="card-header">
        <span>‚è±Ô∏è Time Tracking</span>
      </div>
      
      <div class="grid-2">
        <div>
          <label>Arrival Time</label>
          <input type="time" id="arrival-time">
        </div>
        <div>
          <label>Completion Time</label>
          <input type="time" id="completion-time" onchange="calculateLaborHours()">
        </div>
      </div>
      
      <div class="grid-2">
        <div>
          <label>Travel Time (minutes)</label>
          <input type="number" id="travel-time" min="0" step="5">
        </div>
        <div>
          <label>Total Labor Hours (auto)</label>
          <input type="text" id="total-hours" readonly>
        </div>
      </div>
    </div>
    
    <!-- Equipment Section -->
    <div class="card">
      <div class="card-header">
        <span>‚öôÔ∏è Equipment</span>
      </div>

      <!-- Heat/Cool Toggle -->
      <div class="mode-toggle" style="grid-template-columns: 1fr 1fr; margin-bottom: 12px;">
        <button onclick="setHeatCoolMode('cooling')" id="btn-hc-cooling" class="active secondary">‚ùÑÔ∏è Cooling</button>
        <button onclick="setHeatCoolMode('heating')" id="btn-hc-heating" class="secondary">üî• Heating</button>
      </div>
      
      <label>Unit Type</label>
      <select id="unit-type" onchange="toggleUnitData()">
          <option value="">Select unit type...</option>
          <option value="split">Split System</option>
          <option value="package">Package Unit</option>
          <option value="minisplit">Mini-Split</option>
          <option value="heatpump">Heat Pump</option>
      </select>
      
      <label for="brand">Brand</label>
      <select id="brand">
        <option value="">Select brand...</option>
        <option value="Carrier">Carrier</option>
        <option value="Trane">Trane</option>
        <option value="Lennox">Lennox</option>
        <option value="Rheem">Rheem</option>
        <option value="Goodman">Goodman</option>
        <option value="York">York</option>
        <option value="American Standard">American Standard</option>
        <option value="Bryant">Bryant</option>
        <option value="Daikin">Daikin</option>
        <option value="Mitsubishi">Mitsubishi</option>
        <option value="Other">Other</option>
      </select>
      
      <div id="indoor-unit-fields" class="mt-8">
          <label>Indoor Unit Data (Nameplate)</label>
          <div class="voice-wrapper mb-8">
              <input type="text" id="indoor-data" placeholder="Model/Serial/Tonnage">
              <button class="voice-btn" data-voice="indoor-data">üé§</button>
          </div>
      </div>

      <div id="outdoor-unit-fields">
          <label>Outdoor Unit Data (Nameplate)</label>
          <div class="voice-wrapper mb-8">
              <input type="text" id="outdoor-data" placeholder="Model/Serial/SEER-BTU">
              <button class="voice-btn" data-voice="outdoor-data">üé§</button>
          </div>
      </div>
      
      <div class="grid-2">
        <div>
          <label for="tonnage">System Tonnage</label>
          <select id="tonnage">
            <option value="">Select...</option>
            <option value="1.5">1.5 Ton</option>
            <option value="2">2 Ton</option>
            <option value="2.5">2.5 Ton</option>
            <option value="3">3 Ton</option>
            <option value="3.5">3.5 Ton</option>
            <option value="4">4 Ton</option>
            <option value="5">5 Ton</option>
          </select>
        </div>
        <div>
          <label for="refrigerant">Refrigerant Type</label>
          <select id="refrigerant" onchange="clearRefrigerantCalculations()">
            <option value="">Select...</option>
            <option value="R-410A">R-410A</option>
            <option value="R-22">R-22 (Legacy)</option>
            <option value="R-32">R-32</option>
            <option value="R-454B">R-454B (A2L)</option>
          </select>
        </div>
      </div>
      
      <label for="mfg-date">Manufacture Date</label>
      <input type="date" id="mfg-date" onchange="calculateAge()">
      <div id="equipment-age" class="text-muted"></div>
    </div>
    
    <!-- Materials & Parts Used -->
    <div class="section" id="section-materials-service">
      <button class="section-toggle" onclick="toggleSection('section-materials-service')">
        <span>üîß Parts & Materials Used</span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="section-content">
        <label>Refrigerant</label>
        <div class="grid-2">
          <select id="refrigerant-added-type">
            <option value="">Type...</option>
            <option value="R-410A">R-410A</option>
            <option value="R-22">R-22</option>
            <option value="R-32">R-32</option>
            <option value="R-454B">R-454B</option>
          </select>
          <input type="text" id="refrigerant-amount" placeholder="Amount (lbs/oz)">
        </div>
        <input type="text" id="refrigerant-recovered" placeholder="Amount Recovered (if any)">
        
        <label>Filter Replaced</label>
        <div class="grid-2">
          <select id="filter-size">
            <option value="">Size...</option>
            <option value="16x25x1">16x25x1</option>
            <option value="20x25x1">20x25x1</option>
            <option value="20x25x4">20x25x4 (Media)</option>
            <option value="other">Other Size</option>
          </select>
          <select id="filter-merv">
            <option value="">MERV...</option>
            <option value="8">MERV 8</option>
            <option value="11">MERV 11</option>
            <option value="13">MERV 13</option>
          </select>
        </div>
        
        <label>Capacitor Replaced</label>
        <div class="grid-2">
          <select id="capacitor-type">
            <option value="">Type...</option>
            <option value="dual-35/5">Dual 35/5¬µF</option>
            <option value="dual-40/5">Dual 40/5¬µF</option>
            <option value="dual-45/5">Dual 45/5¬µF</option>
            <option value="other">Other Rating</option>
          </select>
          <input type="number" id="capacitor-qty" placeholder="Qty" min="0" value="0">
        </div>
        
        <label>Contactor Replaced</label>
        <div class="grid-2">
          <select id="contactor-rating">
            <option value="">Rating...</option>
            <option value="30A-2P">30A Double Pole</option>
            <option value="40A-2P">40A Double Pole</option>
            <option value="other">Other Rating</option>
          </select>
          <input type="number" id="contactor-qty" placeholder="Qty" min="0" value="0">
        </div>
        
        <label>Other Parts Used</label>
        <textarea id="other-parts" rows="3" placeholder="List any other materials: fuses, relays, transformers, etc."></textarea>
      </div>
    </div>
    
    <!-- Full Diagnostic Measurements -->
    <div class="section" id="section-service-diagnostics">
      <button class="section-toggle" onclick="toggleSection('section-service-diagnostics')">
        <span>üìä Full Diagnostic Measurements</span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="section-content">
        <div class="status info">
          <span>‚ÑπÔ∏è</span>
          <span>Diagnostic Method: Power ‚Üí Airflow ‚Üí Electrical ‚Üí Refrigerant ‚Üí Controls</span>
        </div>
        
        <div class="card-subheader">General Readings</div>
        <div class="grid-2">
          <div><label>Outdoor Temp (¬∞F)</label><input type="number" id="outdoor-temp" step="0.1"></div>
          <div><label>Outdoor Humidity (%)</label><input type="number" id="outdoor-humidity" min="0" max="100"></div>
        </div>
        <div class="grid-2">
          <div><label>Return Air (¬∞F)</label><input type="number" id="return-temp" step="0.1" oninput="calcDelta()"></div>
          <div><label>Supply Air (¬∞F)</label><input type="number" id="supply-temp" step="0.1" oninput="calcDelta()"></div>
        </div>
        <div class="grid-2">
          <div><label>Return Static (in w.c.)</label><input type="number" id="return-static" step="0.01" oninput="calcStatic()"></div>
          <div><label>Supply Static (in w.c.)</label><input type="number" id="supply-static" step="0.01" oninput="calcStatic()"></div>
        </div>
        <div class="grid-2 mb-8">
          <div><label>Delta T (auto)</label><input type="text" id="delta-t" readonly></div>
          <div><label>Total Static (auto)</label><input type="text" id="total-static" readonly></div>
        </div>
        <div id="delta-status"></div>
        <div id="static-status"></div>
        
        <div class="card-subheader mt-16">Electrical Measurements</div>
        <div class="grid-2">
          <div><label>Voltage L1-L2</label><input type="number" id="voltage-line" step="0.1" oninput="validateVoltage()"></div>
          <div><label>Control Voltage (24V)</label><input type="number" id="control-voltage" step="0.1"></div>
        </div>
        <div id="voltage-status"></div>
        
        <div class="grid-2 mt-8">
          <div><label>Blower Amps</label><input type="text" id="blower-amps" placeholder="Actual/Rated"></div>
          <div class="cooling-only"><label>Compressor Amps</label><input type="text" id="comp-amps" placeholder="Actual/Rated"></div>
          <div class="heating-only"><label>Inducer Amps</label><input type="number" id="inducer-amps" step="0.1"></div>
        </div>
        
        <div class="cooling-only">
          <div class="card-subheader mt-16">Refrigerant Circuit</div>
          <div class="grid-2">
            <div><label>Suction P (psig)</label><input type="number" id="suction-pressure" step="0.1" oninput="calcRefrigerant()"></div>
            <div><label>Liquid P (psig)</label><input type="number" id="liquid-pressure" step="0.1" oninput="calcRefrigerant()"></div>
          </div>
          <div class="grid-2">
            <div><label>Suction T (¬∞F)</label><input type="number" id="suction-temp" step="0.1" oninput="calcRefrigerant()"></div>
            <div><label>Liquid T (¬∞F)</label><input type="number" id="liquid-temp" step="0.1" oninput="calcRefrigerant()"></div>
          </div>
          <div class="grid-2 mt-8">
              <div><label>Superheat (auto)</label><input type="text" id="superheat" readonly></div>
              <div><label>Subcool (auto)</label><input type="text" id="subcool" readonly></div>
          </div>
          <div id="superheat-status"></div>
          <div id="subcool-status"></div>
        </div>
        
        <div class="heating-only">
          <div class="card-subheader mt-16">Heating Circuit</div>
          <div class="grid-2">
            <div><label>Heat Exchanger</label>
              <select id="heat-exchanger">
                <option value="">Inspect...</option>
                <option value="clean">Clean - OK</option>
                <option value="sooted">Sooted</option>
                <option value="cracked">Cracked - DANGER</option>
              </select>
            </div>
            <div><label>Flame Appearance</label>
              <select id="flame-appearance">
                <option value="">Inspect...</option>
                <option value="blue">Blue - Normal</option>
                <option value="yellow">Yellow - Incomplete Combustion</option>
                <option value="lazy">Lazy/Rolling</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Component Inspection & Safety -->
    <div class="section" id="section-service-component">
      <button class="section-toggle" onclick="toggleSection('section-service-component')">
        <span>üîç Component Inspection & Safety</span>
        <span class="arrow">‚ñº</span>
      </button>
      <div class="section-content">
        <div class="card-subheader">Safety Checklist</div>
        <div class="grid-2">
          <label class="check"><input type="checkbox" id="safety-disconnect"> Disconnect present & functional</label>
          <label class="check"><input type="checkbox" id="safety-clearances"> Clearances adequate</label>
          <label class="check"><input type="checkbox" id="safety-drain"> Drain trapped & flowing</label>
          <label class="check"><input type="checkbox" id="safety-floats"> Float switches tested</label>
        </div>
        <div class="heating-only grid-2">
          <label class="check"><input type="checkbox" id="safety-gas"> Gas piping OK</label>
          <label class="check"><input type="checkbox" id="safety-vent"> Vent termination secure</label>
          <label class="check"><input type="checkbox" id="safety-co"> No CO detected</label>
          <label class="check"><input type="checkbox" id="safety-flame-sensor"> Flame sensor clean</label>
        </div>
        
        <div class="card-subheader mt-16">Component Health</div>
        <label>Filter Condition</label>
        <div class="voice-wrapper">
          <input type="text" id="filter" placeholder="Size and condition (e.g., 16x25x1 - Light Dust)">
          <button class="voice-btn" data-voice="filter">üé§</button>
        </div>
        
        <div class="grid-2">
          <div>
            <label>Evaporator Coil</label>
            <select id="evap-coil">
              <option value="">Evap coil condition...</option>
              <option value="clean">Clean</option>
              <option value="light-dust">Light dust</option>
              <option value="restricted">Restricted - needs cleaning</option>
              <option value="frozen">Frozen</option>
              <option value="corroded">Corroded</option>
              <option value="leaking">Leaking</option>
            </select>
          </div>
          <div>
            <label>Condenser Coil</label>
            <select id="cond-coil">
              <option value="">Cond coil condition...</option>
              <option value="clean">Clean</option>
              <option value="light-debris">Light debris</option>
              <option value="restricted">Restricted - needs cleaning</option>
              <option value="bent-fins">Bent fins</option>
              <option value="corroded">Corroded</option>
            </select>
          </div>
        </div>
        
        <div class="grid-2">
          <div>
            <label>Capacitor (¬µF)</label>
            <div class="voice-wrapper">
              <input type="text" id="capacitor-reading" placeholder="Actual/Rated ¬µF">
              <button class="voice-btn" data-voice="capacitor-reading">üé§</button>
            </div>
          </div>
          <div>
            <label>Contactor</label>
            <select id="contactor-condition">
              <option value="">Contactor condition...</option>
              <option value="excellent">Good - clean contacts</option>
              <option value="light-pitting">Light pitting</option>
              <option value="heavy-pitting">Heavy pitting - recommend replacement</option>
              <option value="burned">Burned/welded</option>
            </select>
          </div>
        </div>
        
        <label>Blower Motor Condition</label>
        <select id="blower-condition">
          <option value="">Blower condition...</option>
          <option value="clean-quiet">Clean, runs quietly</option>
          <option value="dusty">Dusty but functional</option>
          <option value="noisy">Noisy - bearings worn</option>
          <option value="struggling">Struggling to start</option>
          <option value="failed">Failed/not running</option>
        </select>
      </div>
    </div>
    
    <!-- Final Review -->
    <div class="card">
      <div class="card-header">
        <span>üìù Final Review & Findings</span>
      </div>
      
      <label>Primary Findings Summary</label>
      <div class="voice-wrapper">
          <textarea id="findings" placeholder="What's wrong and why - be specific" rows="3"></textarea>
          <button class="voice-btn" data-voice="findings">üé§</button>
      </div>
      
      <label>Repair Recommendations</label>
      <div class="voice-wrapper">
          <textarea id="recommendations" placeholder="Repair options and next steps" rows="3"></textarea>
          <button class="voice-btn" data-voice="recommendations">üé§</button>
      </div>

      <label>Work Performed Today</label>
      <div class="voice-wrapper">
          <textarea id="work-performed" placeholder="What was done during this service call" rows="2"></textarea>
          <button class="voice-btn" data-voice="work-performed">üé§</button>
      </div>
    </div>
    
  </div>

  <!-- ==================== MATERIALS MODE ==================== -->
  <div class="materials-only">
    
    <!-- Materials Job Info -->
    <div class="card">
      <div class="card-header">
        <span>üìã Materials Job Info</span>
      </div>
      
      <label for="mat-customer">Customer/Job Name</label>
      <input type="text" id="mat-customer" placeholder="Enter customer or job identifier">
      
      <label for="mat-address">Job Address</label>
      <input type="text" id="mat-address" placeholder="Installation address">
      
      <div class="grid-2">
        <div>
          <label for="mat-tech">Technician</label>
          <input type="text" id="mat-tech" placeholder="Your name">
        </div>
        <div>
          <label for="mat-date">Date</label>
          <input type="date" id="mat-date">
        </div>
      </div>
      
      <label for="mat-notes">Job Notes</label>
      <textarea id="mat-notes" rows="2" placeholder="Special requirements, access notes, etc."></textarea>
    </div>
    
    <!-- Smart Suggestions -->
    <div id="suggestions-container" class="hidden">
      <div class="card">
        <div class="card-header">
          <span>üí° Smart Suggestions</span>
        </div>
        <div class="status info">
          <span>‚ÑπÔ∏è</span>
          <span>Based on your selections, you may need these items</span>
        </div>
        <div id="suggestions-list"></div>
      </div>
    </div>
    
    <!-- Materials Selection -->
    <div class="card">
      <div class="card-header">
        <span>üõ†Ô∏è Add Materials</span>
      </div>
      
      <label>Select Category</label>
      <select id="material-category" onchange="updateMaterialsList()">
        <option value="">Choose a category...</option>
        <option value="equipment">Equipment</option>
        <option value="ductwork">Ductwork & Fittings</option>
        <option value="refrigerant">Refrigerant & Line Sets</option>
        <option value="electrical">Electrical</option>
        <option value="iaq">IAQ & Filtration</option>
        <option value="venting">Venting (Gas/Oil)</option>
        <option value="drainage">Drainage</option>
        <option value="consumables">Consumables & Supplies</option>
      </select>
      
      <div id="materials-catalog-container" class="material-catalog mt-8"></div>
    </div>
    
    <!-- Selected Materials List -->
    <div class="card">
      <div class="card-header">
        <span>üìù Materials List</span>
        <span id="total-items-badge" class="text-muted">0 items</span>
      </div>
      
      <div id="selected-materials-list">
        <div class="text-muted" style="text-align: center; padding: 20px;">
          No materials selected yet. Add items from the catalog above.
        </div>
      </div>
    </div>
    
  </div>

  <!-- GLOBAL: Photo Documentation -->
  <div class="card">
    <div class="card-header">
      <span>üì∏ Photo Documentation</span>
    </div>
    
    <div class="status info">
      <span>üì∑</span>
      <span>Take photos: Nameplate, before/after, problem areas, materials needed</span>
    </div>

    <div class="grid-4">
      <button onclick="takePhoto('Nameplate')" class="secondary small">üì∑ Nameplate</button>
      <button onclick="takePhoto('Problem')" class="secondary small">üì∑ Problem</button>
      <button onclick="takePhoto('Before')" class="secondary small">üì∑ Before</button>
      <button onclick="takePhoto('After')" class="secondary small">üì∑ After</button>
      <button onclick="takePhoto('Electrical')" class="secondary small">üì∑ Electrical</button>
      <button onclick="takePhoto('Coils')" class="secondary small">üì∑ Coils</button>
      <button onclick="takePhoto('Materials')" class="secondary small">üì∑ Materials</button>
      <button onclick="takePhoto('Other')" class="secondary small">üì∑ Other</button>
    </div>
    <div class="photo-grid" id="photo-preview"></div>
  </div>

  <!-- GLOBAL: Signature -->
  <div class="card">
    <div class="card-header">
      <span>‚úçÔ∏è Signature</span>
    </div>
    
    <div class="grid-2">
      <div>
        <label for="tech-name">Technician Name</label>
        <input type="text" id="tech-name" placeholder="Your name">
      </div>
      <div>
        <label for="customer-signature">Customer Signature</label>
        <input type="text" id="customer-signature" placeholder="Customer name">
      </div>
    </div>
  </div>

  <!-- GLOBAL: Sticky Action Bar -->
  <div class="actions">
    <button class="success" onclick="generate()" id="generate-btn">
      <span>‚úì</span> Generate
    </button>
    <button class="warning" onclick="exportReport()">
      <span>üì§</span> Export
    </button>
    <button class="danger" onclick="clearForm()">
      <span>‚úï</span> Clear
    </button>
  </div>
  
  <!-- GLOBAL: Confirmation Modal -->
  <div class="modal-overlay" id="modal-container">
    <div class="modal-content">
      <div class="modal-title" id="modal-title">Confirmation</div>
      <div class="modal-body" id="modal-body">Are you sure?</div>
      <div class="modal-actions">
        <button class="secondary" id="modal-cancel">Cancel</button>
        <button class="danger" id="modal-confirm">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Diagnostic Review Modal -->
  <div class="modal-overlay" id="diagnostic-review-modal">
    <div class="modal-content" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
      <div class="modal-title">üîç Diagnostic Review</div>
      <div class="modal-body">
        
        <!-- Critical Issues -->
        <div id="review-critical-section" class="hidden">
          <div class="status bad">
            <span>‚ö†Ô∏è</span>
            <span><strong>Critical Issues Detected</strong></span>
          </div>
          <div id="review-critical-list"></div>
        </div>
        
        <!-- Findings -->
        <div id="review-findings-section" class="hidden">
          <div class="status warn">
            <span>üîç</span>
            <span><strong>Diagnostic Findings</strong></span>
          </div>
          <div id="review-findings-list"></div>
        </div>
        
        <!-- Warnings -->
        <div id="review-warnings-section" class="hidden">
          <div class="status info">
            <span>‚ÑπÔ∏è</span>
            <span><strong>Items to Verify</strong></span>
          </div>
          <div id="review-warnings-list"></div>
        </div>
        
        <!-- All Clear -->
        <div id="review-allclear-section" class="hidden">
          <div class="status good">
            <span>‚úì</span>
            <span><strong>All Systems Check Out</strong></span>
          </div>
          <p>No diagnostic issues detected. Readings are within acceptable parameters.</p>
        </div>
        
      </div>
      
      <div class="modal-actions">
        <button class="secondary" onclick="closeReviewModal()">
          ‚Üê Go Back & Correct
        </button>
        <button class="success" onclick="proceedToReportGeneration()">
          Proceed to Report ‚Üí
        </button>
      </div>
    </div>
  </div>
  
  <div class="toast-notification" id="toast-notification">
    Message here
  </div>

  <script>
    // ==================== HVAC RULES DATABASE ====================
    const HVAC_RULES = {
      refrigerant: {
        'r-410a': {
          superheat: { min: 8, max: 15, unit: '¬∞F' },
          subcool: { min: 8, max: 12, unit: '¬∞F' },
          pressureTemp: {
            90: 44.7, 95: 47.1, 100: 49.6, 105: 52.2, 110: 54.9,
            115: 57.7, 120: 60.6, 125: 63.6, 130: 66.7, 135: 69.9,
            140: 73.2, 145: 76.6, 150: 80.1, 155: 83.7, 160: 87.4,
            165: 91.3, 170: 95.2, 175: 99.3, 180: 103.5, 185: 107.8,
            190: 112.2, 195: 116.7, 200: 121.4, 205: 126.1, 210: 131.0
          }
        },
        'r-22': {
          superheat: { min: 10, max: 20, unit: '¬∞F' },
          subcool: { min: 10, max: 15, unit: '¬∞F' }
        }
      },
      
      airflow: {
        deltaT: {
          cooling: { min: 16, max: 22, unit: '¬∞F' },
          heating: { min: 30, max: 80, unit: '¬∞F' }
        },
        staticPressure: {
          acceptable: { max: 0.50, unit: 'in w.c.' },
          elevated: { max: 0.70, unit: 'in w.c.' }
        }
      },
      
      electrical: {
        voltage: {
          nominal: { min: 208, max: 240, unit: 'V' },
          acceptable: { min: 200, max: 250, unit: 'V' }
        },
        control: {
          nominal: 24,
          acceptable: { min: 22, max: 26, unit: 'V' }
        }
      },
      
      components: {
        capacitor: {
          tolerance: 0.06
        }
      }
    };

    const DIAGNOSTIC_PATTERNS = {
      undercharge: {
        conditions: [
          { superheat: '>20', subcool: '<8' },
          { suctionPressure: 'low', dischargePressure: 'low' }
        ],
        checks: [
          'Check for refrigerant leaks at evap coil',
          'Inspect service valve connections',
          'Look for oil residue at brazed joints',
          'Check line set for damage/leaks'
        ],
        severity: 'critical',
        category: 'refrigerant'
      },
      
      overcharge: {
        conditions: [
          { superheat: '<5', subcool: '>15' },
          { suctionPressure: 'high', dischargePressure: 'high' }
        ],
        checks: [
          'Verify charge was not added incorrectly',
          'Check for non-condensables in system',
          'Confirm outdoor unit has adequate airflow'
        ],
        severity: 'warning',
        category: 'refrigerant'
      },
      
      airflowRestriction: {
        conditions: [
          { deltaT: '<14', staticPressure: '>0.7' }
        ],
        checks: [
          'Verify filter is ACTUALLY clean (not just looks ok)',
          'Check evap coil for dirt/restriction',
          'Inspect blower wheel for buildup',
          'Check for crushed/kinked flex duct',
          'Verify all supply vents are open'
        ],
        severity: 'critical',
        category: 'airflow'
      },
      
      txvFailure: {
        conditions: [
          { superheat: '>25', subcool: 'acceptable' }
        ],
        checks: [
          'Check TXV bulb attachment and insulation',
          'Verify sensing bulb location',
          'Check for restricted liquid line filter/drier',
          'TXV may be stuck or failed'
        ],
        severity: 'warning',
        category: 'refrigerant'
      },
      
      compressorNotPumping: {
        conditions: [
          { suctionPressure: '>100', dischargePressure: '<250', running: true }
        ],
        checks: [
          'Compressor running but pressures equalized',
          'Internal valve failure likely',
          'Check compressor amp draw vs RLA',
          'Compressor replacement may be needed'
        ],
        severity: 'critical',
        category: 'mechanical'
      },
      
      weakCapacitor: {
        conditions: [
          { capacitorReading: '<85%_of_rated' }
        ],
        checks: [
          'Replace capacitor - below acceptable tolerance',
          'Check for bulging or leaking',
          'Verify correct voltage rating'
        ],
        severity: 'critical',
        category: 'electrical'
      },
      
      lowVoltage: {
        conditions: [
          { lineVoltage: '<200' }
        ],
        checks: [
          'Check main breaker and connections',
          'Test voltage at disconnect and at unit',
          'Look for loose wire connections',
          'May need utility company involvement'
        ],
        severity: 'critical',
        category: 'electrical'
      }
    };

    // ==================== DIAGNOSTIC ENGINE ====================
    class DiagnosticEngine {
      constructor() {
        this.findings = [];
        this.warnings = [];
        this.criticalIssues = [];
      }
      
      analyzeServiceData(serviceData) {
        this.findings = [];
        this.warnings = [];
        this.criticalIssues = [];
        
        this.checkRefrigerantCircuit(serviceData);
        this.checkAirflow(serviceData);
        this.checkElectrical(serviceData);
        this.checkComponents(serviceData);
        this.checkSafety(serviceData);
        
        return {
          findings: this.findings,
          warnings: this.warnings,
          critical: this.criticalIssues,
          overallStatus: this.calculateOverallStatus()
        };
      }
      
      checkRefrigerantCircuit(data) {
        if (!data.equipment || !data.equipment.refrigerant || !data.service || !data.service.operating) return;
        
        const refrigType = data.equipment.refrigerant.toLowerCase();
        const rules = HVAC_RULES.refrigerant[refrigType];
        
        if (!rules) return;
        
        const readings = data.service.operating;
        
        if (readings.suctionPressure && readings.suctionTemp) {
          const satTemp = this.lookupSatTemp(readings.suctionPressure, refrigType);
          if (satTemp) {
            const superheat = readings.suctionTemp - satTemp;
            
            let subcool = null;
            if (readings.liquidPressure && readings.liquidTemp) {
              const liqSatTemp = this.lookupSatTemp(readings.liquidPressure, refrigType);
              if (liqSatTemp) {
                subcool = liqSatTemp - readings.liquidTemp;
              }
            }
            
            this.matchRefrigerantPattern({
              superheat,
              subcool,
              suctionPressure: readings.suctionPressure,
              dischargePressure: readings.liquidPressure
            });
          }
        }
      }
      
      matchRefrigerantPattern(measurements) {
        if (measurements.superheat > 20 && measurements.subcool && measurements.subcool < 8) {
          this.addFinding({
            pattern: 'undercharge',
            severity: 'critical',
            measurements: measurements,
            checks: DIAGNOSTIC_PATTERNS.undercharge.checks
          });
        }
        
        if (measurements.superheat < 5 && measurements.subcool && measurements.subcool > 15) {
          this.addFinding({
            pattern: 'overcharge',
            severity: 'warning',
            measurements: measurements,
            checks: DIAGNOSTIC_PATTERNS.overcharge.checks
          });
        }
        
        if (measurements.superheat > 25 && measurements.subcool >= 8 && measurements.subcool <= 12) {
          this.addFinding({
            pattern: 'txvFailure',
            severity: 'warning',
            measurements: measurements,
            checks: DIAGNOSTIC_PATTERNS.txvFailure.checks
          });
        }
        
        if (measurements.suctionPressure > 100 && measurements.dischargePressure < 250) {
          this.addFinding({
            pattern: 'compressorNotPumping',
            severity: 'critical',
            measurements: measurements,
            checks: DIAGNOSTIC_PATTERNS.compressorNotPumping.checks
          });
        }
      }
      
      checkAirflow(data) {
        if (!data.service || !data.service.operating) return;
        
        const readings = data.service.operating;
        const deltaT = readings.deltaT ? parseFloat(readings.deltaT) : null;
        const staticPressure = readings.totalStatic ? parseFloat(readings.totalStatic) : null;
        
        if (!deltaT || !staticPressure) return;
        
        const mode = data.meta.heatCoolMode || 'cooling';
        
        if (mode === 'cooling' && deltaT < 14 && staticPressure > 0.7) {
          this.addFinding({
            pattern: 'airflowRestriction',
            severity: 'critical',
            measurements: { deltaT, staticPressure },
            checks: DIAGNOSTIC_PATTERNS.airflowRestriction.checks
          });
        }
        
        if (mode === 'cooling' && deltaT > 24) {
          this.addWarning({
            issue: 'High temperature split',
            description: 'Delta-T above 24¬∞F suggests possible airflow restriction',
            checks: [
              'Verify blower speed setting',
              'Check for blocked return',
              'Inspect evap coil'
            ]
          });
        }
      }
      
      checkElectrical(data) {
        if (!data.service || !data.service.operating) return;
        
        const lineVoltage = data.service.operating.voltageLine;
        const controlVoltage = data.service.operating.controlVoltage;
        
        if (lineVoltage && lineVoltage < 200) {
          this.addCritical({
            issue: 'Low line voltage',
            measurement: `${lineVoltage}V`,
            checks: DIAGNOSTIC_PATTERNS.lowVoltage.checks
          });
        }
        
        if (controlVoltage && controlVoltage < 22) {
          this.addWarning({
            issue: 'Low control voltage',
            measurement: `${controlVoltage}V`,
            checks: [
              'Check transformer output',
              'Test for voltage drop in control circuit',
              'Inspect wire connections at transformer'
            ]
          });
        }
      }
      
      checkComponents(data) {
        if (!data.service || !data.service.components) return;
        
        if (data.service.components.capacitorReading) {
          const reading = this.parseCapacitorReading(data.service.components.capacitorReading);
          
          if (reading && reading.actual < reading.rated * 0.85) {
            this.addFinding({
              pattern: 'weakCapacitor',
              severity: 'critical',
              measurements: {
                actual: reading.actual,
                rated: reading.rated,
                percentage: ((reading.actual / reading.rated) * 100).toFixed(1) + '%'
              },
              checks: DIAGNOSTIC_PATTERNS.weakCapacitor.checks
            });
          }
        }
        
        if (data.service.components.contactorCondition) {
          const condition = data.service.components.contactorCondition;
          
          if (condition === 'burned' || condition === 'heavy-pitting') {
            this.addCritical({
              issue: 'Contactor failure',
              description: `Contactor condition: ${condition}`,
              checks: ['Replace contactor immediately', 'Inspect wire connections']
            });
          }
        }
      }
      
      checkSafety(data) {
        if (!data.service || !data.service.safety) return;
        
        const criticalSafety = [
          { key: 'disconnect', label: 'Disconnect present and functional' },
          { key: 'clearances', label: 'Clearances adequate' },
          { key: 'drain', label: 'Drain trapped and flowing' }
        ];
        
        criticalSafety.forEach(item => {
          if (data.service.safety[item.key] === false) {
            this.addCritical({
              issue: `Safety: ${item.label}`,
              description: 'Critical safety item not satisfied',
              checks: [`Address ${item.label} immediately`]
            });
          }
        });
      }
      
      lookupSatTemp(pressure, refrigType) {
        const ptChart = HVAC_RULES.refrigerant[refrigType]?.pressureTemp;
        if (!ptChart) return null;
        
        let closest = null;
        let minDiff = Infinity;
        
        for (let temp in ptChart) {
          const diff = Math.abs(ptChart[temp] - pressure);
          if (diff < minDiff) {
            minDiff = diff;
            closest = parseFloat(temp);
          }
        }
        
        return closest;
      }
      
      parseCapacitorReading(readingStr) {
        const matches = readingStr.match(/(\d+\.?\d*).*?(\d+\.?\d*)/);
        if (matches) {
          return {
            actual: parseFloat(matches[1]),
            rated: parseFloat(matches[2])
          };
        }
        return null;
      }
      
      addFinding(finding) {
        this.findings.push(finding);
        if (finding.severity === 'critical') {
          this.criticalIssues.push(finding);
        }
      }
      
      addWarning(warning) {
        this.warnings.push(warning);
      }
      
      addCritical(critical) {
        this.criticalIssues.push(critical);
      }
      
      calculateOverallStatus() {
        if (this.criticalIssues.length > 0) return 'critical';
        if (this.warnings.length > 2) return 'warning';
        if (this.findings.length > 0) return 'attention';
        return 'good';
      }
    }

    // ==================== CONTEXT MANAGER ====================
    class ContextManager {
      constructor() {
        this.context = {
          job: { customer: '', address: '', date: '', technician: '', jobType: '' },
          equipment: { brand: '', unitType: '', tonnage: '', refrigerant: '', mfgDate: '', indoorData: '', outdoorData: '' },
          service: { complaint: '', timeTracking: {}, readings: {}, components: {}, safety: {}, findings: '', recommendations: '', workPerformed: '' },
          materials: { selectedMaterials: [], suggestions: [] },
          photos: [],
          diagnosticAnalysis: null,
          currentMode: 'service',
          heatCoolMode: 'cooling'
        };
      }
      
      saveCurrentMode(mode) {
        if (mode === 'service') {
          this.context.service = this.gatherServiceData();
        } else if (mode === 'materials') {
          this.context.materials.selectedMaterials = selectedMaterials;
        }
        
        this.context.job = this.gatherJobData();
        this.context.equipment = this.gatherEquipmentData();
        this.context.photos = photos;
      }
      
      loadContextToForm(mode) {
        this.loadJobData();
        this.loadEquipmentData();
        this.loadPhotos();
        
        if (mode === 'service') {
          this.loadServiceData();
        } else if (mode === 'materials') {
          this.loadMaterialsData();
          
          if (this.context.diagnosticAnalysis) {
            this.generateMaterialSuggestions();
          }
        }
      }
      
      gatherJobData() {
        return {
          customer: document.getElementById('customer')?.value || '',
          address: document.getElementById('address')?.value || '',
          date: document.getElementById('date')?.value || '',
          technician: document.getElementById('sales-tech')?.value || '',
          jobType: document.getElementById('job-type')?.value || ''
        };
      }
      
      gatherEquipmentData() {
        return {
          brand: document.getElementById('brand')?.value || '',
          unitType: document.getElementById('unit-type')?.value || '',
          tonnage: document.getElementById('tonnage')?.value || '',
          refrigerant: document.getElementById('refrigerant')?.value || '',
          mfgDate: document.getElementById('mfg-date')?.value || '',
          indoorData: document.getElementById('indoor-data')?.value || '',
          outdoorData: document.getElementById('outdoor-data')?.value || ''
        };
      }
      
      gatherServiceData() {
        return {
          complaint: document.getElementById('complaint')?.value || ''
        };
      }
      
      loadJobData() {
        if (document.getElementById('customer')) {
          document.getElementById('customer').value = this.context.job.customer;
        }
        if (document.getElementById('mat-customer')) {
          document.getElementById('mat-customer').value = this.context.job.customer;
        }
        if (document.getElementById('address')) {
          document.getElementById('address').value = this.context.job.address;
        }
        if (document.getElementById('mat-address')) {
          document.getElementById('mat-address').value = this.context.job.address;
        }
      }
      
      loadEquipmentData() {
        if (document.getElementById('brand')) {
          document.getElementById('brand').value = this.context.equipment.brand;
        }
      }
      
      loadPhotos() {
        photos = this.context.photos;
        updatePhotoPreview();
      }
      
      loadServiceData() {
      }
      
      loadMaterialsData() {
      }
      
      generateMaterialSuggestions() {
        const analysis = this.context.diagnosticAnalysis;
        if (!analysis) return;
        
        const suggestions = [];
        
        analysis.critical.forEach(issue => {
          if (issue.pattern === 'weakCapacitor' && issue.measurements) {
            const rated = issue.measurements.rated;
            suggestions.push({
              category: 'electrical',
              item: {
                id: 'capacitor',
                name: 'Run Capacitor',
                sizes: [`${rated}¬µF`]
              },
              reason: `Weak capacitor detected (${issue.measurements.percentage} of rated)`
            });
          }
          
          if (issue.pattern === 'undercharge') {
            suggestions.push({
              category: 'refrigerant',
              item: {
                id: 'r410a',
                name: 'R-410A Refrigerant',
                sizes: ['25 lb']
              },
              reason: `System undercharged - SH: ${issue.measurements.superheat}¬∞F, SC: ${issue.measurements.subcool}¬∞F`
            });
          }
        });
        
        this.displayMaterialSuggestions(suggestions);
      }
      
      displayMaterialSuggestions(suggestions) {
        if (suggestions.length === 0) return;
        
        const container = document.getElementById('suggestions-container');
        const list = document.getElementById('suggestions-list');
        
        container.classList.remove('hidden');
        list.innerHTML = suggestions.map((s, idx) => `
          <div class="suggestion-item">
            <div class="suggestion-info">
              <div class="suggestion-name">${s.item.name}</div>
              <div class="suggestion-reason">${s.reason}</div>
            </div>
            <button class="material-add-btn" onclick="addSuggestedMaterial(${idx})">+ Add</button>
          </div>
        `).join('');
        
        window.currentSuggestions = suggestions;
      }
    }

    const contextManager = new ContextManager();

    // ==================== GLOBAL STATE ====================
    const $ = (id) => document.getElementById(id);
    const num = val => { const n = parseFloat(val); return isNaN(n) ? null : n; };
    
    let currentMode = 'service';
    let heatCoolMode = 'cooling';
    let photos = [];
    let selectedMaterials = [];
    
    const materialsCatalog = {
      equipment: {
        name: 'Equipment',
        items: [
          { id: 'furnace-gas', name: 'Gas Furnace', sizes: ['60K BTU', '80K BTU', '100K BTU', '120K BTU'], category: 'furnace' },
          { id: 'furnace-electric', name: 'Electric Furnace', sizes: ['10kW', '15kW', '20kW', '25kW'], category: 'furnace' },
          { id: 'ac-unit', name: 'Air Conditioner', sizes: ['1.5 Ton', '2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'], category: 'cooling', tonnage: true },
          { id: 'heat-pump', name: 'Heat Pump', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'], category: 'cooling', tonnage: true },
          { id: 'evap-coil', name: 'Evaporator Coil', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton', '5 Ton'], category: 'cooling', tonnage: true },
          { id: 'air-handler', name: 'Air Handler', sizes: ['2 Ton', '2.5 Ton', '3 Ton', '3.5 Ton', '4 Ton'], category: 'cooling' },
          { id: 'package-unit', name: 'Package Unit', sizes: ['2 Ton', '3 Ton', '4 Ton', '5 Ton'], category: 'cooling', tonnage: true }
        ]
      },
      ductwork: {
        name: 'Ductwork & Fittings',
        items: [
          { id: 'trunk-duct', name: 'Trunk Duct (Rectangular)', sizes: ['12x8', '14x8', '16x8', '18x10', '20x10', '24x12'], unit: 'ft' },
          { id: 'flex-duct', name: 'Flexible Duct', sizes: ['4"', '5"', '6"', '7"', '8"', '10"', '12"'], unit: 'ft' },
          { id: 'plenum-supply', name: 'Supply Plenum', sizes: ['16x20', '18x24', '20x24', '24x24'] },
          { id: 'plenum-return', name: 'Return Plenum', sizes: ['16x20', '18x24', '20x24', '24x24'] },
          { id: 'collar', name: 'Starting Collar', sizes: ['4"', '5"', '6"', '7"', '8"', '10"', '12"'] },
          { id: 'register', name: 'Supply Register', sizes: ['4x10', '4x12', '6x10', '6x12', '8x10', '10x10'] },
          { id: 'grille', name: 'Return Grille', sizes: ['10x10', '12x12', '14x14', '16x16', '20x20', '24x24'] },
          { id: 'damper', name: 'Balancing Damper', sizes: ['4"', '6"', '8"', '10"', '12"'] },
          { id: 'transition', name: 'Transition', sizes: ['Various'] },
          { id: 'elbow-90', name: '90¬∞ Elbow', sizes: ['6"', '8"', '10"', '12"'] }
        ]
      },
      refrigerant: {
        name: 'Refrigerant & Line Sets',
        items: [
          { id: 'lineset-small', name: 'Line Set (1.5-2.5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '1/4" x 3/8"', tonnageRange: [1.5, 2.5] },
          { id: 'lineset-medium', name: 'Line Set (3-3.5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '3/8" x 3/4"', tonnageRange: [3, 3.5] },
          { id: 'lineset-large', name: 'Line Set (4-5 Ton)', sizes: ['15 ft', '25 ft', '35 ft', '50 ft'], spec: '3/8" x 7/8"', tonnageRange: [4, 5] },
          { id: 'r410a', name: 'R-410A Refrigerant', sizes: ['25 lb', '50 lb'], unit: 'cylinder' },
          { id: 'r32', name: 'R-32 Refrigerant', sizes: ['20 lb'], unit: 'cylinder' },
          { id: 'nitrogen', name: 'Nitrogen (Pressure Test)', sizes: ['Small', 'Large'], unit: 'tank' },
          { id: 'linecover', name: 'Line Set Cover/Insulation', sizes: ['15 ft', '25 ft', '50 ft'] }
        ]
      },
      electrical: {
        name: 'Electrical',
        items: [
          { id: 'disconnect-30', name: 'Disconnect Box (30A)', sizes: ['30A'], amperage: 30 },
          { id: 'disconnect-60', name: 'Disconnect Box (60A)', sizes: ['60A'], amperage: 60 },
          { id: 'whip', name: 'Electrical Whip', sizes: ['3 ft', '6 ft', '10 ft'] },
          { id: 'breaker', name: 'Circuit Breaker', sizes: ['15A', '20A', '30A', '40A', '50A', '60A'] },
          { id: 'wire-lv', name: 'Low Voltage Wire (18ga)', sizes: ['18/5', '18/8'], unit: 'ft' },
          { id: 'wire-hv', name: 'High Voltage Wire', sizes: ['10/2', '10/3', '8/2', '8/3', '6/2', '6/3'], unit: 'ft' },
          { id: 'condensate-switch', name: 'Condensate Safety Switch', sizes: ['Standard'] },
          { id: 'relay', name: 'Relay', sizes: ['24V', '120V', '240V'] },
          { id: 'capacitor', name: 'Capacitor', sizes: ['5¬µF', '7.5¬µF', '10¬µF', '15¬µF', '20¬µF', '25¬µF', '30¬µF', '35¬µF', '40¬µF', '45¬µF', '50¬µF'] },
          { id: 'contactor', name: 'Contactor', sizes: ['1-Pole', '2-Pole', '3-Pole'] }
        ]
      },
      iaq: {
        name: 'IAQ & Filtration',
        items: [
          { id: 'media-cleaner', name: 'Media Air Cleaner', sizes: ['16x25', '20x25', '20x20'] },
          { id: 'electronic-cleaner', name: 'Electronic Air Cleaner', sizes: ['16x25', '20x25'] },
          { id: 'hepa-filter', name: 'HEPA Filter Box', sizes: ['Standard'] },
          { id: 'humidifier', name: 'Whole-Home Humidifier', sizes: ['Bypass', 'Fan-Powered', 'Steam'] },
          { id: 'dehumidifier', name: 'Whole-Home Dehumidifier', sizes: ['90 Pint', '120 Pint', '150 Pint'] },
          { id: 'uv-light', name: 'UV Light System', sizes: ['Single Lamp', 'Dual Lamp'] },
          { id: 'erv', name: 'ERV System', sizes: ['100 CFM', '150 CFM', '200 CFM'] },
          { id: 'hrv', name: 'HRV System', sizes: ['100 CFM', '150 CFM', '200 CFM'] },
          { id: 'reme-halo', name: 'REME HALO Air Purifier', sizes: ['24V'] }
        ]
      },
      venting: {
        name: 'Venting (Gas/Oil)',
        items: [
          { id: 'bvent', name: 'B-Vent Pipe', sizes: ['3"', '4"', '5"', '6"', '7"'], unit: 'ft' },
          { id: 'pvc-vent', name: 'PVC Vent Pipe', sizes: ['2"', '3"', '4"'], unit: 'ft' },
          { id: 'vent-cap', name: 'Vent Cap/Termination', sizes: ['2"', '3"', '4"', '5"', '6"'] },
          { id: 'vent-connector', name: 'Vent Connector', sizes: ['3"', '4"', '5"', '6"'] },
          { id: 'vent-elbow', name: 'Vent Elbow (45¬∞/90¬∞)', sizes: ['2"', '3"', '4"', '5"'] },
          { id: 'inducer', name: 'Inducer Motor', sizes: ['Standard', 'High Efficiency'] }
        ]
      },
      drainage: {
        name: 'Drainage',
        items: [
          { id: 'condensate-pump', name: 'Condensate Pump', sizes: ['Standard', 'Heavy Duty'] },
          { id: 'drain-pvc', name: 'PVC Drain Pipe (3/4")', sizes: ['10 ft', '20 ft'], unit: 'length' },
          { id: 'drain-pan', name: 'Drain Pan', sizes: ['Primary', 'Secondary', 'Auxiliary'] },
          { id: 'ptrap', name: 'P-Trap', sizes: ['3/4"', '1"'] },
          { id: 'float-switch', name: 'Float Switch', sizes: ['Standard'] },
          { id: 'drain-fitting', name: 'Drain Fittings Kit', sizes: ['Standard'] }
        ]
      },
      consumables: {
        name: 'Consumables & Supplies',
        items: [
          { id: 'mastic', name: 'Duct Mastic', sizes: ['1 Gallon', '5 Gallon'] },
          { id: 'foil-tape', name: 'Foil Tape', sizes: ['2"', '3"'], unit: 'roll' },
          { id: 'duct-tape', name: 'Duct Tape', sizes: ['Standard'], unit: 'roll' },
          { id: 'screws-tap', name: 'Self-Tapping Screws', sizes: ['#8 x 1/2"', '#10 x 3/4"', '#12 x 1"'], unit: 'box' },
          { id: 'screws-sheet', name: 'Sheet Metal Screws', sizes: ['#8', '#10'], unit: 'box' },
          { id: 'hangers', name: 'Duct Hangers/Strapping', sizes: ['Standard'], unit: 'roll' },
          { id: 'insulation-duct', name: 'Duct Insulation', sizes: ['R-6', 'R-8'], unit: 'roll' },
          { id: 'insulation-pipe', name: 'Pipe Insulation', sizes: ['1/4"', '3/8"', '1/2"', '3/4"'], unit: 'ft' },
          { id: 'refrig-oil', name: 'Refrigerant Oil', sizes: ['8 oz', '16 oz'] },
          { id: 'leak-seal', name: 'Leak Sealant', sizes: ['Standard'] },
          { id: 'cleaning', name: 'Coil Cleaner', sizes: ['Aerosol', '1 Gallon'] },
          { id: 'wire-nuts', name: 'Wire Nuts Assortment', sizes: ['Standard'], unit: 'pack' },
          { id: 'zip-ties', name: 'Zip Ties', sizes: ['Assorted'], unit: 'pack' }
        ]
      }
    };
    
    const R410A_PT = {
      90: 44.7, 95: 47.1, 100: 49.6, 105: 52.2, 110: 54.9,
      115: 57.7, 120: 60.6, 125: 63.6, 130: 66.7, 135: 69.9,
      140: 73.2, 145: 76.6, 150: 80.1, 155: 83.7, 160: 87.4,
      165: 91.3, 170: 95.2, 175: 99.3, 180: 103.5, 185: 107.8,
      190: 112.2, 195: 116.7, 200: 121.4, 205: 126.1, 210: 131.0,
      215: 135.9, 220: 140.9
    };
    
    // ==================== MODAL & TOAST ====================
    const modalContainer = $('modal-container');
    const modalTitle = $('modal-title');
    const modalBody = $('modal-body');
    
    function showModal(title, message) {
      return new Promise((resolve) => {
        modalTitle.textContent = title;
        modalBody.textContent = message;
        
        $('modal-confirm').onclick = () => {
          modalContainer.classList.remove('visible');
          resolve(true);
        };
        
        $('modal-cancel').onclick = () => {
          modalContainer.classList.remove('visible');
          resolve(false);
        };
        
        modalContainer.classList.add('visible');
      });
    }

    function showToast(message, type = 'info') {
      const toast = $('toast-notification');
      toast.textContent = message;
      toast.className = 'toast-notification';
      if (type !== 'info') {
        toast.classList.add(type);
      }
      
      toast.classList.add('visible');
      
      setTimeout(() => {
        toast.classList.remove('visible');
      }, 2500);
    }

    // ==================== MODE SWITCHING ====================
    function setMode(mode) {
      contextManager.saveCurrentMode(currentMode);
      
      currentMode = mode;
      document.body.className = `mode-${mode}`;
      
      document.querySelectorAll('.mode-toggle button').forEach(btn => btn.classList.remove('active'));
      $(`btn-${mode}`).classList.add('active');
      
      contextManager.loadContextToForm(mode);
      
      if (mode === 'service') {
        setHeatCoolMode(heatCoolMode);
      }
      
      const btnText = $('generate-btn');
      if (mode === 'service') {
        btnText.innerHTML = '<span>‚úì</span> Generate Service Report';
      } else if (mode === 'materials') {
        btnText.innerHTML = '<span>‚úì</span> Generate Materials List';
      }
      
      showToast(`Switched to ${mode.charAt(0).toUpperCase() + mode.slice(1)} Mode`, 'info');
    }
    
    function setHeatCoolMode(mode) {
      heatCoolMode = mode;
      
      document.body.classList.remove('mode-cooling', 'mode-heating');
      
      if (document.body.classList.contains('mode-service')) {
        document.body.classList.add(`mode-${mode}`);
      }
      
      $('btn-hc-cooling').className = mode === 'cooling' ? 'active secondary' : 'secondary';
      $('btn-hc-heating').className = mode === 'heating' ? 'active secondary' : 'secondary';
      
      calcDelta();
      clearRefrigerantCalculations();
    }
    
    function toggleUnitData() {
      const type = $('unit-type').value;
      if (type === 'minisplit' || type === 'package') {
        $('indoor-data').placeholder = "Unit Data (All-in-one system)";
        $('outdoor-unit-fields').classList.add('hidden');
      } else {
        $('indoor-data').placeholder = "Model/Serial/Tonnage";
        $('outdoor-unit-fields').classList.remove('hidden');
      }
    }
    
    function toggleSection(sectionId) {
      const section = $(sectionId);
      if (section && section.classList.contains('section')) {
        section.classList.toggle('open');
      }
    }

    // ==================== CALCULATIONS ====================
    function clearRefrigerantCalculations() {
      const sh = $('superheat');
      const sc = $('subcool');
      const shStatus = $('superheat-status');
      const scStatus = $('subcool-status');
      
      if (sh) sh.value = '';
      if (sc) sc.value = '';
      if (shStatus) shStatus.innerHTML = '';
      if (scStatus) scStatus.innerHTML = '';
    }
    
    function calcDelta() {
      const ret = num($('return-temp').value);
      const sup = num($('supply-temp').value);
      if (ret === null || sup === null) return;
      
      const delta = heatCoolMode === 'cooling' ? ret - sup : sup - ret;
      $('delta-t').value = delta.toFixed(1) + ' ¬∞F';
      
      const statusDiv = $('delta-status');
      if (heatCoolMode === 'cooling') {
        if (delta < 14) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low delta - check airflow or low charge</div>';
        else if (delta >= 16 && delta <= 22) statusDiv.innerHTML = '<div class="status good">‚úì Delta T in optimal range (16-22¬∞F)</div>';
        else if (delta > 24) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è High delta - possible restriction</div>';
        else statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Delta T marginal - verify charge</div>';
      } else {
        if (delta < 25) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low rise - check gas input or airflow</div>';
        else if (delta >= 30 && delta <= 80) statusDiv.innerHTML = '<div class="status good">‚úì Temperature rise in range (30-80¬∞F)</div>';
        else if (delta > 90) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Excessive rise - airflow restriction</div>';
        else statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Temperature rise marginal</div>';
      }
    }
    
    function calcStatic() {
      const ret = num($('return-static').value);
      const sup = num($('supply-static').value);
      if (ret === null || sup === null) return;
      
      const total = Math.abs(ret) + Math.abs(sup);
      $('total-static').value = total.toFixed(2) + ' in w.c.';
      
      const statusDiv = $('static-status');
      if (total <= 0.50) statusDiv.innerHTML = '<div class="status good">‚úì Static pressure acceptable (‚â§0.50)</div>';
      else if (total <= 0.70) statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Static elevated (0.50-0.70)</div>';
      else statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Static excessive (>0.70) - duct issues likely</div>';
    }
    
    function validateVoltage() {
      const lineVoltage = num($('voltage-line').value);
      if (!lineVoltage) return;
      
      const statusDiv = $('voltage-status');
      if (lineVoltage < 200) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low voltage (<200V)</div>';
      else if (lineVoltage > 250) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è High voltage (>250V)</div>';
      else if (lineVoltage >= 208 && lineVoltage <= 240) statusDiv.innerHTML = '<div class="status good">‚úì Voltage in acceptable range</div>';
      else statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Voltage marginal</div>';
    }
    
    function lookupSatTemp(psig) {
      const refrigerant = $('refrigerant').value;
      if (refrigerant !== 'R-410A') return null;
      let closest = null, minDiff = Infinity;
      for (let pressure in R410A_PT) {
        const diff = Math.abs(pressure - psig);
        if (diff < minDiff) { minDiff = diff; closest = R410A_PT[pressure]; }
      }
      return closest;
    }
    
    function calcRefrigerant() {
      const suctP = num($('suction-pressure').value);
      const suctT = num($('suction-temp').value);
      const liqP = num($('liquid-pressure').value);
      const liqT = num($('liquid-temp').value);
      
      if (heatCoolMode !== 'cooling') return;

      if (suctP && suctT) {
        const satTemp = lookupSatTemp(suctP);
        if (satTemp) {
          const superheat = suctT - satTemp;
          $('superheat').value = superheat.toFixed(1) + ' ¬∞F';
          const statusDiv = $('superheat-status');
          if (superheat < 5) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low SH (<5¬∞F) - possible overcharge</div>';
          else if (superheat >= 8 && superheat <= 18) statusDiv.innerHTML = '<div class="status good">‚úì Superheat in target range (8-18¬∞F)</div>';
          else if (superheat > 25) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è High SH (>25¬∞F) - possible undercharge</div>';
          else statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Superheat marginal</div>';
        }
      }
      
      if (liqP && liqT) {
        const satTemp = lookupSatTemp(liqP);
        if (satTemp) {
          const subcool = satTemp - liqT;
          $('subcool').value = subcool.toFixed(1) + ' ¬∞F';
          const statusDiv = $('subcool-status');
          if (subcool < 5) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low SC (<5¬∞F) - possible undercharge</div>';
          else if (subcool >= 8 && subcool <= 15) statusDiv.innerHTML = '<div class="status good">‚úì Subcool in target range (8-15¬∞F)</div>';
          else if (subcool > 20) statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è High SC (>20¬∞F) - possible overcharge</div>';
          else statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Subcool marginal</div>';
        }
      }
    }
    
    function calculateAge() {
      const mfgDate = $('mfg-date').value;
      if (!mfgDate) return;
      const mfg = new Date(mfgDate);
      const years = (Date.now() - mfg.getTime()) / (1000 * 60 * 60 * 24 * 365.25);
      $('equipment-age').textContent = `Equipment Age: ${years.toFixed(1)} years`;
    }
    
    function calculateLaborHours() {
      const arrival = $('arrival-time').value;
      const completion = $('completion-time').value;
      if (!arrival || !completion) return;
      const arrivalDate = new Date(`2000-01-01T${arrival}`);
      const completionDate = new Date(`2000-01-01T${completion}`);
      let diffMs = completionDate - arrivalDate;
      if (diffMs < 0) diffMs += 24 * 60 * 60 * 1000;
      const hours = diffMs / (1000 * 60 * 60);
      $('total-hours').value = hours.toFixed(2) + ' hours';
    }
    
    // ==================== VOICE INPUT ====================
    let recognition = null;
    let currentVoiceTarget = null;
    
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = (e) => {
        if (currentVoiceTarget && e.results[0]) {
          const transcript = e.results[0][0].transcript;
          currentVoiceTarget.value = transcript;
          currentVoiceTarget.dispatchEvent(new Event('input'));
          currentVoiceTarget.dispatchEvent(new Event('change'));
        }
      };
      
      recognition.onend = () => {
        document.querySelectorAll('.voice-btn.listening').forEach(btn => {
          btn.classList.remove('listening');
        });
      };
      
      recognition.onerror = (e) => {
        console.error('Speech recognition error:', e.error);
        showToast(`Voice Error: ${e.error}`, 'danger');
        document.querySelectorAll('.voice-btn.listening').forEach(btn => {
          btn.classList.remove('listening');
        });
      };
    }
    
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('voice-btn')) {
        const targetId = e.target.dataset.voice;
        currentVoiceTarget = $(targetId);
        
        if (recognition && currentVoiceTarget) {
          try { recognition.stop(); } catch (err) {}
          document.querySelectorAll('.voice-btn').forEach(btn => btn.classList.remove('listening'));
          e.target.classList.add('listening');
          try {
            recognition.start();
          } catch (err) {
            console.error('Could not start recognition:', err);
            showToast('Voice input failed to start', 'danger');
          }
        } else if (!recognition) {
          showToast('Voice input not supported on this device', 'danger');
        }
      }
    });
    
    // ==================== PHOTOS ====================
    function takePhoto(purpose) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          photos.push({
            purpose: purpose,
            data: event.target.result,
            timestamp: new Date().toISOString(),
            id: Date.now()
          });
          updatePhotoPreview();
        };
        reader.readAsDataURL(file);
      };
      
      input.click();
    }
    
    async function deletePhoto(photoId) {
      const confirmed = await showModal('Delete Photo', 'Are you sure you want to delete this photo?');
      if (confirmed) {
        photos = photos.filter(p => p.id !== photoId);
        updatePhotoPreview();
      }
    }
    
    function updatePhotoPreview() {
      $('photo-preview').innerHTML = photos.map(p => 
        `<div class="photo-item">
            <img src="${p.data}" alt="${p.purpose}">
            <div class="photo-label">${p.purpose}</div>
            <button class="photo-delete" onclick="deletePhoto(${p.id})">√ó</button>
        </div>`
      ).join('');
    }
    
    // ==================== MATERIALS MANAGEMENT ====================
    
    function updateMaterialsList() {
      const category = $('material-category').value;
      const container = $('materials-catalog-container');
      
      if (!category) {
        container.innerHTML = '<div class="text-muted" style="padding: 20px; text-align: center;">Select a category to view materials</div>';
        return;
      }
      
      const catalogData = materialsCatalog[category];
      if (!catalogData) return;
      
      container.innerHTML = catalogData.items.map(item => `
        <div class="material-item">
          <div class="material-item-info">
            <div class="material-item-name">${item.name}</div>
            <div class="material-item-spec">${item.sizes ? item.sizes.slice(0, 3).join(', ') + (item.sizes.length > 3 ? ' +more' : '') : 'Standard'}</div>
          </div>
          <button class="material-add-btn" onclick="addMaterial('${category}', '${item.id}')">+ Add</button>
        </div>
      `).join('');
    }
    
    function addMaterial(category, itemId) {
      const catalogData = materialsCatalog[category];
      const item = catalogData.items.find(i => i.id === itemId);
      if (!item) return;
      
      const materialId = `mat-${Date.now()}-${Math.random()}`;
      selectedMaterials.push({
        id: materialId,
        itemId: item.id,
        category: catalogData.name,
        name: item.name,
        size: item.sizes ? item.sizes[0] : 'Standard',
        sizes: item.sizes || ['Standard'],
        spec: item.spec || null,
        quantity: 1,
        unit: item.unit || 'ea',
        tonnage: item.tonnage || false,
        tonnageRange: item.tonnageRange || null
      });
      
      renderSelectedMaterials();
      updateSuggestions();
      showToast('Material added', 'success');
    }
    
    function updateMaterialQuantity(id, qty) {
      const material = selectedMaterials.find(m => m.id === id);
      if (material) {
        material.quantity = Math.max(1, parseInt(qty) || 1);
        renderSelectedMaterials();
      }
    }
    
    function updateMaterialSize(id, size) {
      const material = selectedMaterials.find(m => m.id === id);
      if (material) {
        material.size = size;
        renderSelectedMaterials();
        updateSuggestions();
      }
    }
    
    function removeMaterial(id) {
      selectedMaterials = selectedMaterials.filter(m => m.id !== id);
      renderSelectedMaterials();
      updateSuggestions();
    }
    
    function renderSelectedMaterials() {
      const container = $('selected-materials-list');
      const totalBadge = $('total-items-badge');
      
      const totalItems = selectedMaterials.reduce((sum, m) => sum + m.quantity, 0);
      totalBadge.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
      
      if (selectedMaterials.length === 0) {
        container.innerHTML = '<div class="text-muted" style="text-align: center; padding: 20px;">No materials selected yet. Add items from the catalog above.</div>';
        return;
      }
      
      container.innerHTML = selectedMaterials.map(m => `
        <div class="selected-material">
          <div class="selected-material-header">
            <div>
              <div class="selected-material-title">${m.name}</div>
              <div class="selected-material-category">${m.category}</div>
            </div>
            <button class="remove-btn" onclick="removeMaterial('${m.id}')">√ó</button>
          </div>
          <div class="selected-material-controls">
            ${m.sizes.length > 1 ? `
              <select style="flex: 1; margin: 0;" onchange="updateMaterialSize('${m.id}', this.value)">
                ${m.sizes.map(size => `<option value="${size}" ${m.size === size ? 'selected' : ''}>${size}</option>`).join('')}
              </select>
            ` : `
              <div style="flex: 1; font-size: 14px; color: #6B7280;">${m.spec ? `${m.size} - ${m.spec}` : m.size}</div>
            `}
            <input type="number" min="1" value="${m.quantity}" class="qty-input" onchange="updateMaterialQuantity('${m.id}', this.value)">
            <div style="min-width: 30px; font-size: 14px; color: #6B7280;">${m.unit}</div>
          </div>
        </div>
      `).join('');
    }
    
    function getTonnageFromSize(sizeStr) {
      const match = sizeStr.match(/(\d+\.?\d*)\s*Ton/i);
      return match ? parseFloat(match[1]) : null;
    }
    
    function updateSuggestions() {
      const suggestions = [];
      
      const coolingEquipment = selectedMaterials.find(m => m.tonnage);
      
      if (coolingEquipment) {
        const tonnage = getTonnageFromSize(coolingEquipment.size);
        
        if (tonnage) {
          const hasLineset = selectedMaterials.some(m => m.itemId && m.itemId.includes('lineset'));
          if (!hasLineset) {
            let linesetId;
            if (tonnage <= 2.5) linesetId = 'lineset-small';
            else if (tonnage <= 3.5) linesetId = 'lineset-medium';
            else linesetId = 'lineset-large';
            
            const linesetItem = materialsCatalog.refrigerant.items.find(i => i.id === linesetId);
            if (linesetItem) {
              suggestions.push({
                category: 'refrigerant',
                item: linesetItem,
                reason: `Matches ${tonnage} ton system`
              });
            }
          }
          
          const hasDisconnect = selectedMaterials.some(m => m.itemId && m.itemId.includes('disconnect'));
          if (!hasDisconnect) {
            const disconnectId = tonnage >= 4 ? 'disconnect-60' : 'disconnect-30';
            const disconnectItem = materialsCatalog.electrical.items.find(i => i.id === disconnectId);
            if (disconnectItem) {
              suggestions.push({
                category: 'electrical',
                item: disconnectItem,
                reason: `Required for ${tonnage} ton unit`
              });
            }
          }
        }
      }
      
      const hasEquipment = selectedMaterials.some(m => m.category === 'Equipment');
      
      if (hasEquipment) {
        const hasPlenum = selectedMaterials.some(m => m.name && m.name.includes('Plenum'));
        if (!hasPlenum) {
          const plenumItem = materialsCatalog.ductwork.items.find(i => i.id === 'plenum-supply');
          if (plenumItem) {
            suggestions.push({
              category: 'ductwork',
              item: plenumItem,
              reason: 'Required for equipment installation'
            });
          }
        }
        
        const hasDrain = selectedMaterials.some(m => m.itemId && (m.itemId.includes('drain') || m.itemId.includes('ptrap')));
        if (!hasDrain) {
          const drainItem = materialsCatalog.drainage.items.find(i => i.id === 'ptrap');
          if (drainItem) {
            suggestions.push({
              category: 'drainage',
              item: drainItem,
              reason: 'Required for condensate drainage'
            });
          }
        }
      }
      
      const suggestionsContainer = $('suggestions-container');
      const suggestionsList = $('suggestions-list');
      
      if (suggestions.length > 0) {
        suggestionsContainer.classList.remove('hidden');
        suggestionsList.innerHTML = suggestions.map(s => `
          <div class="suggestion-item">
            <div class="suggestion-info">
              <div class="suggestion-name">${s.item.name}</div>
              <div class="suggestion-reason">${s.reason}</div>
            </div>
            <button class="material-add-btn" onclick="addMaterial('${s.category}', '${s.item.id}')">+ Add</button>
          </div>
        `).join('');
      } else {
        suggestionsContainer.classList.add('hidden');
      }
    }
    
    function addSuggestedMaterial(idx) {
      if (!window.currentSuggestions || !window.currentSuggestions[idx]) return;
      
      const suggestion = window.currentSuggestions[idx];
      
      const catalogItem = materialsCatalog[suggestion.category]?.items.find(
        item => item.id === suggestion.item.id
      );
      
      if (catalogItem) {
        addMaterial(suggestion.category, suggestion.item.id);
        
        const suggestionElements = document.querySelectorAll('.suggestion-item');
        if (suggestionElements[idx]) {
          const btn = suggestionElements[idx].querySelector('.material-add-btn');
          btn.textContent = '‚úì Added';
          btn.style.background = '#10B981';
        }
      }
    }
    
    // ==================== REPORT GENERATION ====================
    
    function gatherServiceData() {
      return {
        meta: { tech: $('tech-name').value || '[Technician]', mode: 'Service', heatCoolMode: heatCoolMode },
        job: {
          customer: $('customer').value,
          address: $('address').value,
          jobType: $('job-type').value,
          complaint: $('complaint')?.value,
        },
        equipment: {
          brand: $('brand').value,
          unitType: $('unit-type')?.value,
          indoor: $('indoor-data').value,
          outdoor: $('outdoor-data').value,
          tonnage: $('tonnage').value,
          refrigerant: $('refrigerant').value,
          mfgDate: $('mfg-date').value,
          age: $('equipment-age').textContent
        },
        time: {
          arrival: $('arrival-time').value,
          completion: $('completion-time').value,
          travel: $('travel-time').value,
          total: $('total-hours').value
        },
        materials: {
          refrigerant: { 
            type: $('refrigerant-added-type').value, 
            amount: $('refrigerant-amount').value, 
            recovered: $('refrigerant-recovered').value 
          },
          filter: { size: $('filter-size').value, merv: $('filter-merv').value },
          capacitor: { type: $('capacitor-type').value, qty: $('capacitor-qty').value },
          contactor: { rating: $('contactor-rating').value, qty: $('contactor-qty').value },
          other: $('other-parts').value
        },
        service: {
          safety: {
            disconnect: $('safety-disconnect').checked, 
            clearances: $('safety-clearances').checked,
            drain: $('safety-drain').checked, 
            floats: $('safety-floats').checked,
            gas: $('safety-gas')?.checked, 
            vent: $('safety-vent')?.checked,
            co: $('safety-co')?.checked, 
            flameSensor: $('safety-flame-sensor')?.checked
          },
          operating: {
            outdoorTemp: $('outdoor-temp').value, 
            outdoorHumidity: $('outdoor-humidity').value,
            returnTemp: $('return-temp').value, 
            supplyTemp: $('supply-temp').value,
            deltaT: $('delta-t').value, 
            returnStatic: $('return-static').value,
            supplyStatic: $('supply-static').value, 
            totalStatic: $('total-static').value,
            voltageLine: $('voltage-line').value, 
            controlVoltage: $('control-voltage').value,
            blowerAmps: $('blower-amps').value, 
            suctionPressure: parseFloat($('suction-pressure').value) || null,
            liquidPressure: parseFloat($('liquid-pressure').value) || null, 
            suctionTemp: parseFloat($('suction-temp').value) || null,
            liquidTemp: parseFloat($('liquid-temp').value) || null, 
            superheat: $('superheat')?.value,
            subcool: $('subcool')?.value, 
            compAmps: $('comp-amps')?.value,
            inducerAmps: $('inducer-amps')?.value, 
            heatExchanger: $('heat-exchanger')?.value,
            flameAppearance: $('flame-appearance')?.value
          },
          components: {
            filter: $('filter').value, 
            evapCoil: $('evap-coil').value,
            condCoil: $('cond-coil').value, 
            capacitorReading: $('capacitor-reading').value,
            contactorCondition: $('contactor-condition').value, 
            blowerCondition: $('blower-condition').value
          },
          findings: $('findings').value,
          recommendations: $('recommendations').value,
          workPerformed: $('work-performed').value
        },
        photos: photos,
        signature: { 
          tech: $('tech-name').value, 
          customer: $('customer-signature').value 
        }
      };
    }
    
    function gatherMaterialsData() {
      return {
        meta: { tech: $('mat-tech').value || '[Technician]', mode: 'Materials' },
        job: {
          customer: $('mat-customer').value,
          address: $('mat-address').value,
          date: $('mat-date').value,
          notes: $('mat-notes').value
        },
        materials: selectedMaterials,
        photos: photos,
        signature: {
          tech: $('tech-name').value,
          customer: $('customer-signature').value
        }
      };
    }
    
    function generateServiceReport(data, diagnosticAnalysis) {
      let report = `
HVAC SERVICE REPORT
======================================================
Date: ${new Date().toLocaleString()}
Technician: ${data.meta.tech}
Mode: ${data.meta.mode} - ${data.meta.heatCoolMode.toUpperCase()}
------------------------------------------------------
Customer: ${data.job.customer}
Address: ${data.job.address}
Job Type: ${data.job.jobType}

CUSTOMER COMPLAINT:
  ${data.job.complaint || 'N/A'}

EQUIPMENT IDENTITY
------------------
Brand: ${data.equipment.brand}
Type: ${data.equipment.unitType}
Indoor: ${data.equipment.indoor}
Outdoor: ${data.equipment.outdoor}
Tonnage: ${data.equipment.tonnage} | Refrigerant: ${data.equipment.refrigerant}
Mfg Date: ${data.equipment.mfgDate} ${data.equipment.age ? `(${data.equipment.age})` : ''}

TIME TRACKING
-------------
Arrival: ${data.time.arrival} | Completion: ${data.time.completion}
Total: ${data.time.total}

OPERATING CONDITIONS
--------------------
Outdoor: ${data.service.operating.outdoorTemp}¬∞F, ${data.service.operating.outdoorHumidity}% RH
Airflow:
  Return: ${data.service.operating.returnTemp}¬∞F | Supply: ${data.service.operating.supplyTemp}¬∞F
  Delta T: ${data.service.operating.deltaT}
  Return Static: ${data.service.operating.returnStatic} | Supply: ${data.service.operating.supplyStatic}
  Total Static: ${data.service.operating.totalStatic}

Electrical:
  Line Voltage: ${data.service.operating.voltageLine}V
  Control: ${data.service.operating.controlVoltage}V
  Blower Amps: ${data.service.operating.blowerAmps}

${data.meta.heatCoolMode === 'cooling' ? `Refrigerant Circuit (COOLING):
  Suction: ${data.service.operating.suctionPressure} psig @ ${data.service.operating.suctionTemp}¬∞F
  Liquid: ${data.service.operating.liquidPressure} psig @ ${data.service.operating.liquidTemp}¬∞F
  Superheat: ${data.service.operating.superheat} | Subcool: ${data.service.operating.subcool}
  Compressor: ${data.service.operating.compAmps}` : 
`Heating Circuit:
  Heat Exchanger: ${data.service.operating.heatExchanger}
  Flame: ${data.service.operating.flameAppearance}
  Inducer: ${data.service.operating.inducerAmps}A`}

COMPONENT INSPECTION
--------------------
Filter: ${data.service.components.filter}
Evap Coil: ${data.service.components.evapCoil} | Cond Coil: ${data.service.components.condCoil}
Capacitor: ${data.service.components.capacitorReading}
Contactor: ${data.service.components.contactorCondition}
Blower: ${data.service.components.blowerCondition}

`;

      if (diagnosticAnalysis) {
        report += `DIAGNOSTIC ANALYSIS
--------------------
Status: ${diagnosticAnalysis.overallStatus.toUpperCase()}

`;

        if (diagnosticAnalysis.critical.length > 0) {
          report += `CRITICAL ISSUES:\n`;
          diagnosticAnalysis.critical.forEach((issue, idx) => {
            report += `  ${idx + 1}. ${issue.issue || DIAGNOSTIC_PATTERNS[issue.pattern]?.checks[0] || 'Critical issue detected'}\n`;
            if (issue.measurements) {
              for (let key in issue.measurements) {
                report += `     ${key}: ${issue.measurements[key]}\n`;
              }
            }
          });
          report += '\n';
        }

        if (diagnosticAnalysis.findings.length > 0) {
          report += `FINDINGS:\n`;
          diagnosticAnalysis.findings.forEach((finding, idx) => {
            const pattern = DIAGNOSTIC_PATTERNS[finding.pattern];
            report += `  ${idx + 1}. ${pattern ? pattern.checks[0] : 'Finding detected'}\n`;
            if (finding.measurements) {
              for (let key in finding.measurements) {
                report += `     ${key}: ${finding.measurements[key]}\n`;
              }
            }
          });
          report += '\n';
        }

        if (diagnosticAnalysis.warnings.length > 0) {
          report += `WARNINGS:\n`;
          diagnosticAnalysis.warnings.forEach((warning, idx) => {
            report += `  ${idx + 1}. ${warning.issue}\n`;
            if (warning.description) {
              report += `     ${warning.description}\n`;
            }
          });
          report += '\n';
        }
      }

      report += `MATERIALS USED
--------------
${formatServiceMaterials(data.materials)}

FINDINGS & RECOMMENDATIONS
--------------------------
Findings:
${data.service.findings}

Recommendations:
${data.service.recommendations}

Work Performed:
${data.service.workPerformed}

PHOTO DOCUMENTATION
-------------------
${data.photos.length} Photo(s): ${data.photos.map(p => p.purpose).join(', ')}

TECHNICIAN CERTIFICATION
------------------------
${data.signature.tech}
Customer Acknowledged: ${data.signature.customer}
`;

      return report.replace(/\n\s+\n/g, '\n\n');
    }
    
    function formatServiceMaterials(materials) {
      let text = '  ';
      if (materials.refrigerant?.type) text += `Refrigerant: ${materials.refrigerant.type} - ${materials.refrigerant.amount}\n  `;
      if (materials.filter?.size) text += `Filter: ${materials.filter.size} MERV ${materials.filter.merv}\n  `;
      if (materials.capacitor?.qty > 0) text += `Capacitor: ${materials.capacitor.type} (${materials.capacitor.qty})\n  `;
      if (materials.contactor?.qty > 0) text += `Contactor: ${materials.contactor.rating} (${materials.contactor.qty})\n  `;
      if (materials.other) text += `Other: ${materials.other}\n  `;
      return text.trim() || 'None';
    }
    
    function generateMaterialsList(data) {
      let list = '';
      list += '‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n';
      list += '‚ïë          HVAC MATERIALS LIST - PRE-INSTALL                 ‚ïë\n';
      list += '‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n';
      
      list += 'JOB INFORMATION\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      list += `Customer/Job: ${data.job.customer || 'N/A'}\n`;
      list += `Address: ${data.job.address || 'N/A'}\n`;
      list += `Technician: ${data.meta.tech}\n`;
      list += `Date: ${data.job.date || new Date().toISOString().split('T')[0]}\n`;
      if (data.job.notes) list += `Notes: ${data.job.notes}\n`;
      list += '\n';
      
      if (data.materials.length === 0) {
        list += 'No materials added to list.\n\n';
      } else {
        const groupedMaterials = data.materials.reduce((acc, m) => {
          if (!acc[m.category]) acc[m.category] = [];
          acc[m.category].push(m);
          return acc;
        }, {});
        
        list += 'MATERIALS\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
        
        Object.entries(groupedMaterials).forEach(([category, items]) => {
          list += `${category}:\n`;
          list += '‚îÄ'.repeat(60) + '\n';
          items.forEach(m => {
            const sizeInfo = m.spec ? `${m.size} - ${m.spec}` : m.size;
            list += `‚òê ${m.name}\n`;
            list += `  Size/Spec: ${sizeInfo}\n`;
            list += `  Quantity: ${m.quantity} ${m.unit}\n`;
            list += '\n';
          });
          list += '\n';
        });
        
        list += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
        const totalItems = data.materials.reduce((sum, m) => sum + m.quantity, 0);
        list += `TOTAL ITEMS: ${totalItems}\n`;
        list += `TOTAL LINE ITEMS: ${data.materials.length}\n`;
        list += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
      }
      
      if (data.photos.length > 0) {
        list += `\nATTACHED PHOTOS: ${data.photos.length}\n`;
        list += data.photos.map(p => `  - ${p.purpose}`).join('\n') + '\n';
      }
      
      list += `\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      list += `Generated: ${new Date().toLocaleString()}\n`;
      list += `Technician: ${data.meta.tech}\n`;
      list += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
      
      return list;
    }
    
    function generate() {
      const existing = document.querySelector('.report-preview')?.closest('.card');
      if (existing) existing.remove();
      
      if (currentMode === 'service') {
        const serviceData = gatherServiceData();
        
        const diagnosticEngine = new DiagnosticEngine();
        const analysisResults = diagnosticEngine.analyzeServiceData(serviceData);
        
        contextManager.context.diagnosticAnalysis = analysisResults;
        sessionStorage.setItem('diagnosticAnalysis', JSON.stringify(analysisResults));
        sessionStorage.setItem('currentServiceData', JSON.stringify(serviceData));
        
        if (analysisResults.critical.length > 0 || 
            analysisResults.findings.length > 0 || 
            analysisResults.warnings.length > 0) {
          showDiagnosticReviewModal(analysisResults);
        } else {
          proceedToReportGeneration();
        }
        
      } else if (currentMode === 'materials') {
        const reportData = gatherMaterialsData();
        const reportText = generateMaterialsList(reportData);
        sessionStorage.setItem('currentReport', JSON.stringify(reportData));
        sessionStorage.setItem('currentReportText', reportText);
        displayReport(reportText, 'üìã Materials List Generated');
        showToast('Materials List Generated!', 'success');
      }
    }
    
    function showDiagnosticReviewModal(results) {
      const modal = $('diagnostic-review-modal');
      
      if (results.critical.length > 0) {
        $('review-critical-section').classList.remove('hidden');
        const criticalList = $('review-critical-list');
        criticalList.innerHTML = results.critical.map((item, idx) => 
          generateReviewItemHTML(item, idx, 'critical')
        ).join('');
      } else {
        $('review-critical-section').classList.add('hidden');
      }
      
      if (results.findings.length > 0) {
        $('review-findings-section').classList.remove('hidden');
        const findingsList = $('review-findings-list');
        findingsList.innerHTML = results.findings.map((item, idx) => 
          generateReviewItemHTML(item, idx, 'finding')
        ).join('');
      } else {
        $('review-findings-section').classList.add('hidden');
      }
      
      if (results.warnings.length > 0) {
        $('review-warnings-section').classList.remove('hidden');
        const warningsList = $('review-warnings-list');
        warningsList.innerHTML = results.warnings.map((item, idx) => 
          generateReviewItemHTML(item, idx, 'warning')
        ).join('');
      } else {
        $('review-warnings-section').classList.add('hidden');
      }
      
      if (results.critical.length === 0 && 
          results.findings.length === 0 && 
          results.warnings.length === 0) {
        $('review-allclear-section').classList.remove('hidden');
      } else {
        $('review-allclear-section').classList.add('hidden');
      }
      
      modal.classList.add('visible');
    }

    function generateReviewItemHTML(item, idx, type) {
      let title = item.issue || 'Diagnostic Finding';
      
      if (item.pattern) {
        if (item.pattern === 'undercharge') title = 'System Undercharged';
        if (item.pattern === 'overcharge') title = 'System Overcharged';
        if (item.pattern === 'airflowRestriction') title = 'Airflow Restriction Detected';
        if (item.pattern === 'txvFailure') title = 'Possible TXV Issue';
        if (item.pattern === 'compressorNotPumping') title = 'Compressor Not Pumping';
        if (item.pattern === 'weakCapacitor') title = 'Weak/Failed Capacitor';
        if (item.pattern === 'lowVoltage') title = 'Low Voltage Detected';
      }
      
      let html = `<div class="review-item ${type}">`;
      html += `<div class="review-item-header">${title}</div>`;
      
      if (item.measurements) {
        html += `<div class="review-item-measurements">`;
        for (let key in item.measurements) {
          const value = item.measurements[key];
          html += `<strong>${key}:</strong> ${value}<br>`;
        }
        html += `</div>`;
      }
      
      if (item.description) {
        html += `<p style="margin: 8px 0; font-size: 14px; line-height: 1.5;">${item.description}</p>`;
      }
      
      const checks = item.checks || (DIAGNOSTIC_PATTERNS[item.pattern] ? DIAGNOSTIC_PATTERNS[item.pattern].checks : []);
      if (checks && checks.length > 0) {
        html += `<div class="review-item-checks">`;
        html += `<strong style="display: block; margin-bottom: 8px;">Verify:</strong>`;
        checks.forEach((check, checkIdx) => {
          html += `
            <label>
              <input type="checkbox" id="check-${idx}-${checkIdx}">
              <span>${check}</span>
            </label>
          `;
        });
        html += `</div>`;
      }
      
      html += `</div>`;
      return html;
    }

    function closeReviewModal() {
      $('diagnostic-review-modal').classList.remove('visible');
    }

    function proceedToReportGeneration() {
      closeReviewModal();
      
      const serviceData = JSON.parse(sessionStorage.getItem('currentServiceData'));
      const diagnosticAnalysis = JSON.parse(sessionStorage.getItem('diagnosticAnalysis'));
      
      const reportText = generateServiceReport(serviceData, diagnosticAnalysis);
      
      sessionStorage.setItem('currentReportText', reportText);
      displayReport(reportText, 'üìã Service Report Generated');
      showToast('Service Report Generated!', 'success');
    }
    
    function displayReport(text, title) {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-header">
          <span>${title}</span>
        </div>
        <div class="status good">
          <span>‚úì</span>
          <span>Ready to export or share</span>
        </div>
        <pre class="report-preview" id="report-pre">${text}</pre>
        <div class="grid-2 mt-8">
          <button onclick="copyToClipboard()" class="success">üìã Copy</button>
          <button onclick="printReport()" class="secondary">üñ®Ô∏è Print</button>
        </div>
      `;
      
      document.querySelector('.actions').before(card);
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function copyToClipboard() {
      const text = $('report-pre')?.textContent;
      if (!text) {
        showToast('Generate a report first!', 'danger');
        return;
      }
      
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-9999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showToast('‚úì Copied to clipboard!', 'success');
        } else {
          showToast('Copy failed. Please copy manually.', 'danger');
        }
      } catch (err) {
        showToast('Copy failed. Please copy manually.', 'danger');
      }
      document.body.removeChild(textArea);
    }
    
    function printReport() {
      const text = $('report-pre')?.textContent;
      if (!text) {
        showToast('Generate a report first!', 'danger');
        return;
      }
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html><head><title>Field Buddy Report</title><style>
            body { font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4; margin: 0.5in; white-space: pre-wrap; }
            @media print { body { margin: 0.25in; } }
        </style></head><body>${text}</body></html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 250);
    }
    
    function exportReport() {
      const text = sessionStorage.getItem('currentReportText');
      const dataStr = sessionStorage.getItem('currentReport') || sessionStorage.getItem('currentServiceData');
      if (!text || !dataStr) {
        showToast('Generate a report first', 'danger');
        return;
      }
      
      const data = JSON.parse(dataStr);
      let customer = 'Job';
      if (currentMode === 'service') {
        customer = data.job.customer.replace(/\s/g, '_') || 'ServiceJob';
      } else {
        customer = data.job.customer.replace(/\s/g, '_') || 'MaterialsList';
      }
      const date = (data.job.date || new Date().toISOString().split('T')[0]).replace(/\//g, '-');
      const fileName = `FieldBuddy_${currentMode.toUpperCase()}_${customer}_${date}.txt`;

      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Exporting file...', 'success');
    }
    
    async function clearForm() {
      const confirmed = await showModal(
        'Clear Form', 
        'Are you sure you want to clear all data? This cannot be undone.'
      );
      if (!confirmed) return;
      
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'checkbox') el.checked = false;
        else el.value = '';
      });
      
      selectedMaterials = [];
      photos = [];
      updatePhotoPreview();
      renderSelectedMaterials();
      updateSuggestions();
      
      const existing = document.querySelector('.report-preview')?.closest('.card');
      if (existing) existing.remove();
      
      sessionStorage.removeItem('currentReport');
      sessionStorage.removeItem('currentReportText');
      sessionStorage.removeItem('currentServiceData');
      sessionStorage.removeItem('diagnosticAnalysis');
      
      $('date').value = new Date().toISOString().split('T')[0];
      $('mat-date').value = new Date().toISOString().split('T')[0];
      
      showToast('Form cleared', 'success');
    }
    
    // ==================== CHECKBOX STYLING ====================
    document.addEventListener('input', (e) => {
      if (e.target.type === 'checkbox') {
        const label = e.target.closest('label.check');
        if (label) {
          label.classList.toggle('checked', e.target.checked);
        }
      }
    });
    
    // ==================== INITIALIZATION ====================
    window.addEventListener('load', () => {
      $('date').value = new Date().toISOString().split('T')[0];
      $('mat-date').value = new Date().toISOString().split('T')[0];
      
      setMode('service');
      
      console.log('%c‚ö° Field Buddy Pro v1.5 - Enhanced with Diagnostic Engine', 'color:#3B82F6; font-size:14px; font-weight:bold');
    });
    
  </script>
</body>
</html>
