<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="description" content="Field Buddy Pro v3.0 - Professional HVAC Field Service Management">
  <title>Field Buddy Pro v3.0</title>
  
  <!-- CDN Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  
  <style>
    :root {
      --primary: #0066CC;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-700: #374151;
      --gray-900: #111827;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      font-size: 14px;
      line-height: 1.5;
    }
    
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      font-size: 24px;
      color: var(--primary);
      margin-bottom: 5px;
    }
    
    .header p { color: var(--gray-700); font-size: 13px; }
    
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--gray-900);
    }
    
    .form-grid { display: grid; gap: 15px; grid-template-columns: 1fr; }
    .form-grid-2 { grid-template-columns: repeat(2, 1fr); }
    .form-grid-3 { grid-template-columns: repeat(3, 1fr); }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--gray-700);
    }
    
    input, select, textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.1);
    }
    
    textarea { min-height: 80px; resize: vertical; }
    
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    
    .toggle-group {
      display: inline-flex;
      background: var(--gray-100);
      border-radius: 6px;
      padding: 2px;
      gap: 2px;
    }
    
    .toggle-btn {
      padding: 8px 16px;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      color: var(--gray-700);
      transition: all 0.2s;
    }
    
    .toggle-btn.active {
      background: white;
      color: var(--gray-900);
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    
    .photo-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    
    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid var(--gray-200);
      cursor: pointer;
    }
    
    .photo-item img { width: 100%; height: 100%; object-fit: cover; }
    
    .photo-upload {
      aspect-ratio: 1;
      border: 2px dashed var(--gray-200);
      border-radius: 6px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: var(--gray-50);
    }
    
    .photo-upload:hover { border-color: var(--primary); }
    
    .signature-pad {
      width: 100%;
      height: 200px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      cursor: crosshair;
      background: white;
    }
    
    .chart-container { height: 300px; margin: 20px 0; }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge-success { background: #D1FAE5; color: #065F46; }
    .badge-warning { background: #FEF3C7; color: #92400E; }
    .badge-danger { background: #FEE2E2; color: #991B1B; }
    
    .diagnostic-panel {
      background: linear-gradient(135deg, #0066CC, #004C99);
      border-radius: 8px;
      padding: 20px;
      color: white;
      margin: 20px 0;
    }
    
    .diagnostic-card {
      background: white;
      border-radius: 6px;
      padding: 15px;
      margin-top: 12px;
      color: var(--gray-900);
    }
    
    .quality-score {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: var(--gray-50);
      border-radius: 6px;
      margin-bottom: 20px;
    }
    
    .quality-score-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--success);
    }
    
    .progress-bar {
      height: 8px;
      background: var(--gray-200);
      border-radius: 4px;
      flex: 1;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--success);
      transition: width 0.3s;
    }
    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--gray-900);
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s;
      z-index: 1000;
    }
    
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.success { background: var(--success); }
    .toast.danger { background: var(--danger); }
    
    .hidden { display: none !important; }
    
    @media (max-width: 768px) {
      .form-grid-2, .form-grid-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    
    <div class="header">
      <h1>üîß Field Buddy Pro v3.0</h1>
      <p>Professional HVAC Service Management - Complete Edition with PDF Export, Photos, Signatures & More</p>
    </div>
    
    <!-- Quality Score -->
    <div class="quality-score">
      <strong>Report Quality:</strong>
      <span class="quality-score-value" id="quality-score">0%</span>
      <div class="progress-bar">
        <div class="progress-fill" id="quality-progress" style="width: 0%;"></div>
      </div>
    </div>
    
    <!-- System Mode -->
    <div class="card">
      <div class="card-title">System Mode</div>
      <div class="toggle-group">
        <button class="toggle-btn active" id="mode-cooling" onclick="setSystemMode('cooling')">‚ùÑÔ∏è Cooling</button>
        <button class="toggle-btn" id="mode-heating" onclick="setSystemMode('heating')">üî• Heating</button>
      </div>
    </div>
    
    <!-- Job Info -->
    <div class="card">
      <div class="card-title">Job Information</div>
      <div class="form-grid">
        <div class="toggle-group">
          <button class="toggle-btn active" id="call-trouble" onclick="setCallType('trouble')">Trouble Call</button>
          <button class="toggle-btn" id="call-maintenance" onclick="setCallType('maintenance')">Maintenance</button>
        </div>
      </div>
      <div class="form-grid form-grid-2">
        <div>
          <label>Customer Name</label>
          <input type="text" id="customer-name" placeholder="Enter customer name" oninput="calcQuality()">
        </div>
        <div>
          <label>Date</label>
          <input type="date" id="service-date" oninput="calcQuality()">
        </div>
      </div>
      <div class="form-grid">
        <div>
          <label>Service Address</label>
          <input type="text" id="service-address" placeholder="123 Main St" oninput="calcQuality()">
        </div>
      </div>
      <div class="form-grid">
        <div>
          <label>Customer Complaint</label>
          <textarea id="customer-complaint" placeholder="Describe the issue..." oninput="calcQuality()"></textarea>
        </div>
      </div>
    </div>
    
    <!-- Equipment -->
    <div class="card">
      <div class="card-title">Equipment Information</div>
      <div class="form-grid form-grid-3">
        <div>
          <label>Unit Type</label>
          <select id="unit-type" onchange="calcQuality()">
            <option value="">Select...</option>
            <option value="split">Split System</option>
            <option value="package">Package Unit</option>
            <option value="mini-split">Mini-Split</option>
            <option value="heat-pump">Heat Pump</option>
          </select>
        </div>
        <div>
          <label>Tonnage</label>
          <select id="tonnage" onchange="calcQuality()">
            <option value="">Select...</option>
            <option value="2">2 Ton</option>
            <option value="2.5">2.5 Ton</option>
            <option value="3">3 Ton</option>
            <option value="3.5">3.5 Ton</option>
            <option value="4">4 Ton</option>
            <option value="5">5 Ton</option>
          </select>
        </div>
        <div>
          <label>Refrigerant</label>
          <select id="refrigerant">
            <option value="R410A">R-410A</option>
            <option value="R22">R-22</option>
            <option value="R454B">R-454B</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Cooling Measurements -->
    <div class="card" id="cooling-section">
      <div class="card-title">Diagnostic Measurements (Cooling)</div>
      <div class="form-grid form-grid-3">
        <div>
          <label>Return Temp (¬∞F)</label>
          <input type="number" id="return-temp" oninput="calculate()">
        </div>
        <div>
          <label>Supply Temp (¬∞F)</label>
          <input type="number" id="supply-temp" oninput="calculate()">
        </div>
        <div>
          <label>Delta-T</label>
          <input type="text" id="delta-t" readonly>
        </div>
      </div>
      <div class="form-grid form-grid-2">
        <div>
          <label>Suction Pressure (PSI)</label>
          <input type="number" id="suction-pressure" oninput="calculate()">
        </div>
        <div>
          <label>Suction Temp (¬∞F)</label>
          <input type="number" id="suction-temp" oninput="calculate()">
        </div>
        <div>
          <label>Liquid Pressure (PSI)</label>
          <input type="number" id="liquid-pressure" oninput="calculate()">
        </div>
        <div>
          <label>Liquid Temp (¬∞F)</label>
          <input type="number" id="liquid-temp" oninput="calculate()">
        </div>
      </div>
      <div class="form-grid form-grid-2">
        <div>
          <label>Superheat (¬∞F)</label>
          <input type="text" id="superheat" readonly>
        </div>
        <div>
          <label>Subcool (¬∞F)</label>
          <input type="text" id="subcool" readonly>
        </div>
      </div>
      <div class="chart-container">
        <canvas id="pressure-chart"></canvas>
      </div>
    </div>
    
    <!-- Heating Measurements -->
    <div class="card hidden" id="heating-section">
      <div class="card-title">Diagnostic Measurements (Heating)</div>
      <div class="form-grid form-grid-3">
        <div>
          <label>Return Temp (¬∞F)</label>
          <input type="number" id="return-temp-heat" oninput="calculate()">
        </div>
        <div>
          <label>Supply Temp (¬∞F)</label>
          <input type="number" id="supply-temp-heat" oninput="calculate()">
        </div>
        <div>
          <label>Temp Rise</label>
          <input type="text" id="temp-rise" readonly>
        </div>
      </div>
      <div class="form-grid form-grid-2">
        <div>
          <label>Manifold Pressure (in w.c.)</label>
          <input type="number" id="manifold-pressure" oninput="calculate()">
        </div>
        <div>
          <label>Voltage (V)</label>
          <input type="number" id="voltage-heat">
        </div>
      </div>
    </div>
    
    <!-- Diagnostics -->
    <div id="diagnostic-results"></div>
    
    <!-- Photos -->
    <div class="card">
      <div class="card-title">üì∏ Job Photos</div>
      <div class="photo-gallery" id="photo-gallery">
        <label class="photo-upload">
          <input type="file" accept="image/*" capture="camera" multiple onchange="handlePhotos(event)" style="display:none">
          <span style="font-size: 32px;">üì∑</span>
          <span>Add Photo</span>
        </label>
      </div>
    </div>
    
    <!-- Findings -->
    <div class="card">
      <div class="card-title">Findings & Work</div>
      <div class="form-grid">
        <div>
          <label>Findings</label>
          <textarea id="findings" placeholder="What you found..." oninput="calcQuality()"></textarea>
        </div>
        <div>
          <label>Recommendations</label>
          <textarea id="recommendations" placeholder="What you recommend..." oninput="calcQuality()"></textarea>
        </div>
        <div>
          <label>Work Performed</label>
          <textarea id="work-performed" placeholder="Work completed..." oninput="calcQuality()"></textarea>
        </div>
      </div>
    </div>
    
    <!-- Signature -->
    <div class="card">
      <div class="card-title">‚úçÔ∏è Customer Signature</div>
      <div class="form-grid form-grid-2">
        <div>
          <label>Customer Name</label>
          <input type="text" id="sig-name" placeholder="Customer name" oninput="calcQuality()">
        </div>
        <div>
          <label>Date</label>
          <input type="date" id="sig-date" oninput="calcQuality()">
        </div>
      </div>
      <canvas id="signature-pad" class="signature-pad"></canvas>
      <div class="btn-group" style="margin-top: 12px;">
        <button class="btn btn-secondary" onclick="clearSig()">Clear</button>
        <button class="btn btn-primary" onclick="saveSig()">Save Signature</button>
      </div>
    </div>
    
    <!-- Tech Info -->
    <div class="card">
      <div class="card-title">Technician</div>
      <div class="form-grid form-grid-2">
        <div>
          <label>Name</label>
          <input type="text" id="tech-name" value="Mart√≠n Perez">
        </div>
        <div>
          <label>Phone</label>
          <input type="tel" id="tech-phone" value="(346)451-0024">
        </div>
      </div>
      <div class="form-grid">
        <div>
          <label>Email</label>
          <input type="email" id="tech-email" value="Mperez@villageplumbing.com">
        </div>
      </div>
    </div>
    
    <!-- Actions -->
    <div class="btn-group">
      <button class="btn btn-success" onclick="generateReport('pdf')">üìÑ Generate PDF</button>
      <button class="btn btn-primary" onclick="generateReport('text')">üìã Text Report</button>
      <button class="btn btn-secondary" onclick="clearAll()">üóëÔ∏è Clear Form</button>
    </div>
    
    <!-- Report Output -->
    <div id="report-output"></div>
    
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    // ==================== STATE ====================
    let systemMode = 'cooling';
    let callType = 'trouble';
    let photos = [];
    let signaturePad = null;
    let customerSignature = null;
    let diagnosticResults = [];
    let chart = null;
    
    const R410A_PT = {
      43: 0, 57: 10, 73: 20, 92: 30, 114: 40, 140: 50, 169: 60, 201: 70, 237: 80, 278: 90,
      323: 100, 373: 110, 428: 120, 493: 130, 565: 140
    };
    
    // ==================== HELPERS ====================
    function $(id) { return document.getElementById(id); }
    
    function toast(msg, type = 'success') {
      const t = $('toast');
      t.textContent = msg;
      t.className = `toast show ${type}`;
      setTimeout(() => t.classList.remove('show'), 3000);
    }
    
    // ==================== NAVIGATION ====================
    function setSystemMode(mode) {
      systemMode = mode;
      $('mode-cooling').classList.toggle('active', mode === 'cooling');
      $('mode-heating').classList.toggle('active', mode === 'heating');
      $('cooling-section').classList.toggle('hidden', mode !== 'cooling');
      $('heating-section').classList.toggle('hidden', mode !== 'heating');
      calculate();
    }
    
    function setCallType(type) {
      callType = type;
      $('call-trouble').classList.toggle('active', type === 'trouble');
      $('call-maintenance').classList.toggle('active', type === 'maintenance');
    }
    
    // ==================== QUALITY SCORE ====================
    function calcQuality() {
      let score = 0, total = 0;
      
      if ($('customer-name').value) score += 10;
      total += 10;
      if ($('service-date').value) score += 10;
      total += 10;
      if ($('service-address').value) score += 10;
      total += 10;
      if ($('customer-complaint').value) score += 10;
      total += 10;
      if ($('unit-type').value) score += 10;
      total += 10;
      if ($('findings').value) score += 10;
      total += 10;
      if ($('work-performed').value) score += 10;
      total += 10;
      if (photos.length > 0) score += 15;
      total += 15;
      if (customerSignature) score += 15;
      total += 15;
      
      const pct = Math.round((score / total) * 100);
      $('quality-score').textContent = `${pct}%`;
      $('quality-progress').style.width = `${pct}%`;
      
      if (pct >= 80) $('quality-score').style.color = 'var(--success)';
      else if (pct >= 50) $('quality-score').style.color = 'var(--warning)';
      else $('quality-score').style.color = 'var(--danger)';
    }
    
    // ==================== PHOTOS ====================
    function handlePhotos(e) {
      Array.from(e.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = (ev) => {
          photos.push({ data: ev.target.result, name: file.name });
          displayPhotos();
          calcQuality();
          toast(`Photo "${file.name}" added`);
        };
        reader.readAsDataURL(file);
      });
      e.target.value = '';
    }
    
    function displayPhotos() {
      let html = '<label class="photo-upload"><input type="file" accept="image/*" multiple onchange="handlePhotos(event)" style="display:none"><span style="font-size:32px">üì∑</span><span>Add Photo</span></label>';
      photos.forEach((p, i) => {
        html += `<div class="photo-item" onclick="viewPhoto(${i})"><img src="${p.data}"></div>`;
      });
      $('photo-gallery').innerHTML = html;
    }
    
    function viewPhoto(i) {
      window.open(photos[i].data);
    }
    
    // ==================== SIGNATURE ====================
    function initSignature() {
      const canvas = $('signature-pad');
      signaturePad = new SignaturePad(canvas, {
        backgroundColor: 'rgb(255,255,255)',
        penColor: 'rgb(0,0,0)'
      });
      
      function resize() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        if (customerSignature) {
          const img = new Image();
          img.onload = () => signaturePad.fromDataURL(customerSignature);
          img.src = customerSignature;
        }
      }
      
      window.addEventListener('resize', resize);
      resize();
    }
    
    function clearSig() {
      if (signaturePad) {
        signaturePad.clear();
        customerSignature = null;
        calcQuality();
        toast('Signature cleared');
      }
    }
    
    function saveSig() {
      if (!signaturePad || signaturePad.isEmpty()) {
        toast('Please provide a signature first', 'danger');
        return;
      }
      customerSignature = signaturePad.toDataURL();
      calcQuality();
      toast('Signature saved!');
    }
    
    // ==================== CALCULATIONS ====================
    function getSatTemp(pressure) {
      const pressures = Object.keys(R410A_PT).map(Number);
      const closest = pressures.reduce((p, c) => 
        Math.abs(c - pressure) < Math.abs(p - pressure) ? c : p
      );
      return R410A_PT[closest];
    }
    
    function calculate() {
      if (systemMode === 'cooling') {
        const ret = parseFloat($('return-temp').value);
        const sup = parseFloat($('supply-temp').value);
        if (!isNaN(ret) && !isNaN(sup)) {
          $('delta-t').value = `${(ret - sup).toFixed(1)}¬∞F`;
        }
        
        const sP = parseFloat($('suction-pressure').value);
        const sT = parseFloat($('suction-temp').value);
        if (!isNaN(sP) && !isNaN(sT)) {
          const sat = getSatTemp(sP);
          if (sat) $('superheat').value = `${(sT - sat).toFixed(1)}¬∞F`;
        }
        
        const lP = parseFloat($('liquid-pressure').value);
        const lT = parseFloat($('liquid-temp').value);
        if (!isNaN(lP) && !isNaN(lT)) {
          const sat = getSatTemp(lP);
          if (sat) $('subcool').value = `${(sat - lT).toFixed(1)}¬∞F`;
        }
        
        runDiagnostics();
        updateChart();
      } else {
        const ret = parseFloat($('return-temp-heat').value);
        const sup = parseFloat($('supply-temp-heat').value);
        if (!isNaN(ret) && !isNaN(sup)) {
          $('temp-rise').value = `${(sup - ret).toFixed(1)}¬∞F`;
        }
        runDiagnostics();
      }
    }
    
    function runDiagnostics() {
      diagnosticResults = [];
      
      if (systemMode === 'cooling') {
        const deltaT = parseFloat($('delta-t').value);
        if (!isNaN(deltaT)) {
          if (deltaT < 14) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Low Delta-T',
              message: `Delta-T is ${deltaT.toFixed(1)}¬∞F (Expected: 16-22¬∞F)`,
              recommendations: ['Check air filter', 'Inspect evaporator coil', 'Verify blower operation']
            });
          } else if (deltaT >= 16 && deltaT <= 22) {
            diagnosticResults.push({
              severity: 'success',
              title: 'Delta-T Optimal',
              message: `Delta-T is ${deltaT.toFixed(1)}¬∞F - System airflow good`
            });
          }
        }
        
        const sh = parseFloat($('superheat').value);
        const sc = parseFloat($('subcool').value);
        if (!isNaN(sh) && !isNaN(sc)) {
          if (sh > 20 && sc < 8) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'System Undercharged',
              message: `SH: ${sh.toFixed(1)}¬∞F, SC: ${sc.toFixed(1)}¬∞F`,
              recommendations: ['Check for leaks', 'Add refrigerant by weight']
            });
          } else if (sh >= 8 && sh <= 15 && sc >= 8 && sc <= 12) {
            diagnosticResults.push({
              severity: 'success',
              title: 'Refrigerant Charge OK',
              message: `SH: ${sh.toFixed(1)}¬∞F, SC: ${sc.toFixed(1)}¬∞F`
            });
          }
        }
      } else {
        const rise = parseFloat($('temp-rise').value);
        if (!isNaN(rise)) {
          if (rise < 35) {
            diagnosticResults.push({
              severity: 'danger',
              title: 'Low Temperature Rise',
              message: `Temp rise is ${rise.toFixed(1)}¬∞F (Expected: 35-65¬∞F)`,
              recommendations: ['Check gas pressure', 'Inspect burners']
            });
          } else if (rise >= 35 && rise <= 65) {
            diagnosticResults.push({
              severity: 'success',
              title: 'Temperature Rise OK',
              message: `Temp rise is ${rise.toFixed(1)}¬∞F`
            });
          }
        }
      }
      
      displayDiagnostics();
    }
    
    function displayDiagnostics() {
      const container = $('diagnostic-results');
      if (diagnosticResults.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      let html = '<div class="diagnostic-panel"><h3>üéØ Diagnostic Analysis</h3>';
      diagnosticResults.forEach(r => {
        html += `<div class="diagnostic-card">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px">
            <strong>${r.title}</strong>
            <span class="badge badge-${r.severity}">${r.severity}</span>
          </div>
          <p>${r.message}</p>`;
        if (r.recommendations) {
          html += '<ul style="margin-top:8px;padding-left:20px">';
          r.recommendations.forEach(rec => html += `<li>${rec}</li>`);
          html += '</ul>';
        }
        html += '</div>';
      });
      html += '</div>';
      container.innerHTML = html;
    }
    
    // ==================== CHART ====================
    function updateChart() {
      if (!chart) {
        const ctx = $('pressure-chart').getContext('2d');
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Suction', 'Liquid'],
            datasets: [{
              label: 'Pressure (PSI)',
              data: [0, 0],
              backgroundColor: ['rgba(0,102,204,0.2)', 'rgba(239,68,68,0.2)'],
              borderColor: ['rgb(0,102,204)', 'rgb(239,68,68)'],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
          }
        });
      }
      
      const sP = parseFloat($('suction-pressure').value) || 0;
      const lP = parseFloat($('liquid-pressure').value) || 0;
      chart.data.datasets[0].data = [sP, lP];
      chart.update();
    }
    
    // ==================== REPORT GENERATION ====================
    function generateReport(format) {
      const customer = $('customer-name').value || 'N/A';
      const date = $('service-date').value || new Date().toISOString().split('T')[0];
      const address = $('service-address').value || 'N/A';
      const complaint = $('customer-complaint').value || 'N/A';
      const tech = $('tech-name').value;
      const techPhone = $('tech-phone').value;
      const techEmail = $('tech-email').value;
      
      let report = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë      VILLAGE PLUMBING - SERVICE REPORT              ‚ïë
‚ïë      Field Buddy Pro v3.0 Complete Edition          ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

JOB INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Customer: ${customer}
Date: ${date}
Address: ${address}
Call Type: ${callType === 'trouble' ? 'Trouble Call' : 'Maintenance'}
System Mode: ${systemMode === 'cooling' ? 'Cooling' : 'Heating'}

Customer Complaint:
${complaint}

EQUIPMENT INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Unit Type: ${$('unit-type').value || 'N/A'}
Tonnage: ${$('tonnage').value || 'N/A'} Ton
Refrigerant: ${$('refrigerant').value}

`;

      if (systemMode === 'cooling') {
        report += `COOLING MEASUREMENTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Return Temp: ${$('return-temp').value || 'N/A'}¬∞F
Supply Temp: ${$('supply-temp').value || 'N/A'}¬∞F
Delta-T: ${$('delta-t').value || 'N/A'}

Suction Pressure: ${$('suction-pressure').value || 'N/A'} PSI
Suction Temp: ${$('suction-temp').value || 'N/A'}¬∞F
Superheat: ${$('superheat').value || 'N/A'}

Liquid Pressure: ${$('liquid-pressure').value || 'N/A'} PSI
Liquid Temp: ${$('liquid-temp').value || 'N/A'}¬∞F
Subcool: ${$('subcool').value || 'N/A'}

`;
      } else {
        report += `HEATING MEASUREMENTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Return Temp: ${$('return-temp-heat').value || 'N/A'}¬∞F
Supply Temp: ${$('supply-temp-heat').value || 'N/A'}¬∞F
Temperature Rise: ${$('temp-rise').value || 'N/A'}
Manifold Pressure: ${$('manifold-pressure').value || 'N/A'} in w.c.

`;
      }

      if (diagnosticResults.length > 0) {
        report += `DIAGNOSTIC ANALYSIS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

`;
        diagnosticResults.forEach(r => {
          report += `${r.title} [${r.severity.toUpperCase()}]\n${r.message}\n`;
          if (r.recommendations) {
            report += 'Recommendations:\n';
            r.recommendations.forEach(rec => report += `  ‚Ä¢ ${rec}\n`);
          }
          report += '\n';
        });
      }

      report += `FINDINGS & WORK PERFORMED
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Findings:
${$('findings').value || 'N/A'}

Recommendations:
${$('recommendations').value || 'N/A'}

Work Performed:
${$('work-performed').value || 'N/A'}

`;

      if (photos.length > 0) {
        report += `JOB PHOTOS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${photos.length} photo(s) attached

`;
      }

      if (customerSignature) {
        report += `CUSTOMER SIGNATURE
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Customer: ${$('sig-name').value || 'N/A'}
Date: ${$('sig-date').value || date}
[Digital signature on file]

`;
      }

      report += `TECHNICIAN INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Tech: ${tech}
Phone: ${techPhone}
Email: ${techEmail}

Generated: ${new Date().toLocaleString()}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Field Buddy Pro v3.0 - Professional Edition
`;

      if (format === 'pdf') {
        generatePDF(report);
      } else {
        displayTextReport(report);
      }
      
      toast('Report generated successfully!');
    }
    
    function generatePDF(textReport) {
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        
        pdf.setFontSize(14);
        pdf.text('Village Plumbing - Service Report', 105, 20, { align: 'center' });
        pdf.setFontSize(9);
        pdf.text('Field Buddy Pro v3.0', 105, 27, { align: 'center' });
        
        pdf.setFontSize(8);
        const lines = pdf.splitTextToSize(textReport, 180);
        let y = 35;
        
        lines.forEach(line => {
          if (y > 280) {
            pdf.addPage();
            y = 20;
          }
          pdf.text(line, 15, y);
          y += 4;
        });
        
        if (photos.length > 0) {
          pdf.addPage();
          pdf.setFontSize(12);
          pdf.text('Job Photos', 105, 20, { align: 'center' });
          
          let pY = 30, pX = 15;
          photos.forEach((photo, i) => {
            if (pY > 200) {
              pdf.addPage();
              pY = 20;
            }
            try {
              pdf.addImage(photo.data, 'JPEG', pX, pY, 80, 60);
              pdf.setFontSize(7);
              pdf.text(photo.name, pX, pY + 65);
            } catch (e) {
              console.error('Error adding photo:', e);
            }
            pX = (i % 2 === 0) ? 115 : 15;
            if (i % 2 === 1) pY += 75;
          });
        }
        
        if (customerSignature) {
          pdf.addPage();
          pdf.setFontSize(12);
          pdf.text('Customer Signature', 105, 20, { align: 'center' });
          pdf.addImage(customerSignature, 'PNG', 40, 30, 130, 50);
        }
        
        pdf.save(`service-report-${new Date().toISOString().split('T')[0]}.pdf`);
        toast('PDF generated successfully!');
      } catch (e) {
        console.error('PDF generation error:', e);
        toast('Error generating PDF', 'danger');
      }
    }
    
    function displayTextReport(report) {
      const output = $('report-output');
      output.innerHTML = `
        <div class="card">
          <div class="card-title">üìÑ Generated Report</div>
          <pre style="background:var(--gray-50);padding:15px;border-radius:6px;overflow-x:auto;font-size:11px;line-height:1.4">${report}</pre>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="copyReport()">üìã Copy to Clipboard</button>
            <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Print</button>
          </div>
        </div>
      `;
    }
    
    function copyReport() {
      const text = document.querySelector('pre').textContent;
      navigator.clipboard.writeText(text).then(() => {
        toast('Copied to clipboard!');
      });
    }
    
    function printReport() {
      const text = document.querySelector('pre').textContent;
      const w = window.open('', '_blank');
      w.document.write(`<html><head><title>Service Report</title><style>body{font-family:monospace;font-size:12px;line-height:1.4;margin:0.5in;white-space:pre-wrap}</style></head><body>${text}</body></html>`);
      w.document.close();
      setTimeout(() => {
        w.print();
        w.close();
      }, 250);
    }
    
    function clearAll() {
      if (!confirm('Clear all form data?')) return;
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.type === 'text' || el.type === 'number' || el.type === 'date' || el.type === 'email' || el.type === 'tel') {
          if (!el.id.includes('tech-')) el.value = '';
        } else if (el.tagName === 'TEXTAREA') {
          el.value = '';
        } else if (el.tagName === 'SELECT') {
          el.selectedIndex = 0;
        }
      });
      photos = [];
      displayPhotos();
      clearSig();
      diagnosticResults = [];
      displayDiagnostics();
      $('report-output').innerHTML = '';
      toast('Form cleared');
    }
    
    // ==================== INIT ====================
    window.addEventListener('load', () => {
      $('service-date').value = new Date().toISOString().split('T')[0];
      $('sig-date').value = new Date().toISOString().split('T')[0];
      initSignature();
      calcQuality();
      
      console.log('%cüîß Field Buddy Pro v3.0', 'color:#0066CC;font-size:16px;font-weight:bold');
      console.log('%cProfessional HVAC Service Management', 'color:#666;font-size:12px');
      toast('Field Buddy Pro v3.0 Ready!', 'success');
    });
  </script>
</body>
</html>