<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Field Buddy Pro ‚Äî HVAC Inspection & Reporting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">

  <!--
    Security hardening notes (set as server headers when possible):
      Content-Security-Policy:
        default-src 'self';
        script-src 'self' https://cdnjs.cloudflare.com 'strict-dynamic';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self';
        object-src 'none';
        base-uri 'none';
        frame-ancestors 'none';

      Referrer-Policy: no-referrer
      Permissions-Policy: camera=(), microphone=(), geolocation=(), clipboard-read=()
      X-Content-Type-Options: nosniff
      Cross-Origin-Opener-Policy: same-origin
  -->

  <!-- html2pdf for PDF export (SRI locked) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
          integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--ink:#1f2937;--muted:#6b7280;--primary:#2563eb;--border:#e5e7eb;
      --good:#16a34a;--warn:#d97706;--bad:#dc2626;--slate:#0f172a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,sans-serif;color:var(--ink);background:var(--bg);-webkit-text-size-adjust:100%}
    .wrap{max-width:1080px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,#0f172a 0%,#111827 100%);color:#fff;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    header h1{margin:0 0 6px;font-size:18px}
    header .sub{font-size:12px;color:#cbd5e1}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;align-items:center}
    .btn{background:var(--primary);color:#fff;border:0;border-radius:8px;padding:14px 18px;font-size:15px;font-weight:600;cursor:pointer;touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-height:48px;display:inline-flex;align-items:center;justify-content:center;gap:6px}
    .btn.secondary{background:#334155}
    .btn.outline{background:transparent;color:#e5e7eb;border:1px solid #475569}
    .btn.warn{background:var(--bad)}
    .btn.good{background:var(--good)}
    .btn.gray{background:#6b7280}
    .btn.small{padding:10px 14px;font-size:13px;min-height:40px}
    .right{margin-left:auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 2px 8px rgba(17,24,39,.05)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:880px){ .grid-4{grid-template-columns:1fr 1fr} }
    @media (max-width:640px){ .grid-2,.grid-3,.grid-4{grid-template-columns:1fr} }
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px;font-weight:500}
    input[type="text"],input[type="number"],input[type="date"],input[type="time"],textarea,select{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:8px;font-size:16px;background:#fff;touch-action:manipulation;-webkit-appearance:none
    }
    input[type="number"]{font-size:17px}
    textarea{min-height:100px;resize:vertical;line-height:1.5}
    .section-title{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:10px;font-weight:700;font-size:16px}
    details{border:1px dashed var(--border);border-radius:8px;padding:10px 12px;margin:10px 0}
    details[open]{border-style:solid}
    details summary{cursor:pointer;font-weight:700;margin:6px 0;font-size:15px;padding:6px 0;touch-action:manipulation}
    .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:999px;font-size:14px;margin:4px 6px 4px 0;touch-action:manipulation;min-height:44px}
    .chip input[type="checkbox"]{width:20px;height:20px;margin:0}
    .score-box{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:12px}
    .score{font-weight:800;font-size:20px}
    .score.good{color:var(--good)} .score.warn{color:var(--warn)} .score.bad{color:var(--bad)}
    .muted{color:var(--muted)} .notice{font-size:13px;color:var(--muted)}
    .summary-box{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:14px;white-space:pre-wrap;font-size:14px;line-height:1.6}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .sticky-actions{position:sticky;bottom:10px;z-index:4;display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
    .toggle{display:inline-flex;align-items:center;gap:8px;color:#cbd5e1;font-size:13px}
    .voice-input-wrapper{position:relative}
    .voice-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--primary);color:#fff;border:0;border-radius:6px;padding:8px 12px;font-size:20px;cursor:pointer;z-index:2;min-height:36px;display:flex;align-items:center;justify-content:center}
    .voice-btn.listening{background:var(--bad);animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .save-indicator{position:fixed;bottom:20px;right:20px;background:var(--good);color:#fff;padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;z-index:999;box-shadow:0 4px 12px rgba(0,0,0,.2);opacity:0;transition:opacity .3s}
    .save-indicator.show{opacity:1}
    .input-group{position:relative}
    .input-group input[type="text"], .input-group textarea{padding-right:50px}
    .hint{font-size:12px;color:#64748b;margin-top:6px}
    .mode-toggle{display:flex;gap:6px;flex-wrap:wrap}
    .mode-btn{border:1px solid var(--border);background:#fff;border-radius:999px;padding:8px 12px;font-weight:600;cursor:pointer}
    .mode-btn.active.cool{background:#e0f2fe;border-color:#93c5fd}
    .mode-btn.active.heat{background:#fee2e2;border-color:#fca5a5}
    .sop-tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .sop-tags .tag{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;background:#fff;cursor:pointer}
    .tag.active{background:#e2e8f0}
    .badge{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <h1>Field Buddy Pro ‚Äî HVAC Inspection & Reporting</h1>
      <div class="sub">Mobile-optimized field inspection with voice input</div>
      <div class="toolbar">
        <button class="btn" id="btnAddSystem">‚ûï Add System</button>
        <button class="btn secondary" id="btnExpandAll">Expand All</button>
        <button class="btn secondary" id="btnCollapseAll">Collapse All</button>
        <button class="btn good" id="btnGenerate">üìä Generate Reports</button>
        <button class="btn outline small" id="btnToday">Today</button>
        <button class="btn warn small" id="btnClear">üóëÔ∏è Clear All</button>
      </div>
    </header>

    <!-- Job Header -->
    <section class="card" id="jobHeader">
      <div class="section-title"><div>Job Context</div></div>
      <div class="grid-3">
        <div class="input-group voice-input-wrapper">
          <label>Customer Name</label>
          <input type="text" id="customerName" placeholder="Full name">
          <button class="voice-btn" data-voice-for="customerName">üé§</button>
        </div>
        <div><label>Inspection Date</label><input type="date" id="inspectionDate"></div>
        <div><label>Time Arrived</label><input type="time" id="timeArrived"></div>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div class="input-group voice-input-wrapper">
          <label>Technician</label>
          <input type="text" id="technicianName" placeholder="Your name">
          <button class="voice-btn" data-voice-for="technicianName">üé§</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Address</label>
          <input type="text" id="address" placeholder="Street, City, State">
          <button class="voice-btn" data-voice-for="address">üé§</button>
        </div>
        <div class="grid-2">
          <div><label>Ambient Temperature (¬∞F)</label><input type="number" inputmode="decimal" step="0.1" id="ambientF"></div>
          <div><label>Ambient Humidity (%)</label><input type="number" inputmode="decimal" step="1" id="ambientRH"></div>
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div class="input-group voice-input-wrapper">
          <label>Primary Complaint (customer words)</label>
          <input type="text" id="primaryComplaint" placeholder="Exact phrasing">
          <button class="voice-btn" data-voice-for="primaryComplaint">üé§</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Observable Symptoms</label>
          <input type="text" id="observableSymptoms" placeholder="e.g., weak airflow, odors">
          <button class="voice-btn" data-voice-for="observableSymptoms">üé§</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Root Cause (tech assessment)</label>
          <input type="text" id="rootCause" placeholder="Link symptoms ‚Üí measurements">
          <button class="voice-btn" data-voice-for="rootCause">üé§</button>
        </div>
      </div>
    </section>

    <!-- Systems container -->
    <div id="systems"></div>

    <!-- Reports -->
    <section class="card" id="reportsCard" style="display:none;">
      <div class="section-title"><div>Reports</div></div>
      <div style="margin-bottom:10px">
        <button class="btn good small" id="btnCopyCustomer">üìã Copy Customer Summary</button>
        <button class="btn good small" id="btnCopyOffice">üìã Copy Office Summary</button>
      </div>
      <div class="summary-box" id="customerSummary"></div>
      <div class="divider"></div>
      <div class="summary-box" id="officeSummary"></div>
      <div class="sticky-actions">
        <button class="btn good" id="btnPDF2">üìÑ Export PDF</button>
        <button class="btn outline" id="btnHTML2">üìù Export HTML</button>
        <button class="btn outline" id="btnJSON2">üíæ Export JSON</button>
      </div>
    </section>
  </div>

  <!-- Save indicator -->
  <div class="save-indicator" id="saveIndicator">‚úì Draft saved</div>

  <!-- System Template -->
  <template id="systemTemplate">
    <section class="card" data-system>
      <div class="section-title">
        <div>System <span data-sysname>#</span> <span class="badge" data-badge-type>Type: ‚Äî</span> <span class="badge" data-badge-mode>Mode: ‚Äî</span></div>
        <div>
          <button class="btn gray small btnToggle">Toggle</button>
          <button class="btn warn small btnRemove">Remove</button>
        </div>
      </div>

      <!-- Identity -->
      <div class="grid-3">
        <div>
          <label>System Type</label>
          <select data-field="meta.systemType">
            <option value="">Select...</option>
            <option>Split System</option>
            <option>Heat Pump</option>
            <option>Package Unit</option>
            <option>Mini-Split</option>
            <option>Furnace Only</option>
          </select>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Area Served (e.g., Upstairs)</label>
          <input type="text" data-field="meta.zone" placeholder="Zone / Floor">
          <button class="voice-btn" data-voice-for="meta.zone">üé§</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Brand / Model</label>
          <input type="text" data-field="meta.brandModel" placeholder="Brand and model">
          <button class="voice-btn" data-voice-for="meta.brandModel">üé§</button>
        </div>
      </div>

      <div class="grid-4" style="margin-top:8px">
        <div>
          <label>Refrigerant</label>
          <input type="text" list="refrig-list" data-field="meta.refrigerant" placeholder="R-410A / R-22 / R-32 / R-454B">
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Indoor Model / Serial</label>
          <input type="text" data-field="meta.indoorMS" placeholder="Model / Serial">
          <button class="voice-btn" data-voice-for="meta.indoorMS">üé§</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Outdoor Model / Serial</label>
          <input type="text" data-field="meta.outdoorMS" placeholder="Model / Serial">
          <button class="voice-btn" data-voice-for="meta.outdoorMS">üé§</button>
        </div>
        <div>
          <label>Manufacture Date</label>
          <input type="date" data-field="meta.mfgDate">
          <div class="hint">Age auto-calculated</div>
        </div>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <div><label>Equipment Age (yrs, auto)</label><input type="text" data-field="meta.age" disabled></div>
        <div class="input-group voice-input-wrapper">
          <label>Filter Size</label>
          <input type="text" data-field="meta.filterSize" placeholder="e.g., 16x25x1">
          <button class="voice-btn" data-voice-for="meta.filterSize">üé§</button>
        </div>
        <div>
          <label>Mode</label>
          <div class="mode-toggle">
            <button type="button" class="mode-btn active cool" data-mode="COOLING">‚ùÑÔ∏è Cooling</button>
            <button type="button" class="mode-btn heat" data-mode="HEATING">üî• Heating</button>
          </div>
        </div>
      </div>

      <!-- Voice hints -->
      <div class="hint">Voice prompts: say ‚ÄúSafety section‚Äù, ‚ÄúMechanical performance‚Äù, ‚ÄúAir quality findings‚Äù.</div>

      <!-- Safety (Expanded) -->
      <details open>
        <summary>Safety <span class="badge" data-badge-safety>SOP: ‚Äî</span></summary>
        <div class="sop-tags" data-sop="safety">
          <span class="tag" data-sopval="Pass">Pass</span>
          <span class="tag" data-sopval="Fail">Fail</span>
          <span class="tag" data-sopval="Needs Attention">Needs Attention</span>
        </div>
        <div>
          <label class="chip"><input type="checkbox" data-field="safety.coDetector"> CO detector present</label>
          <label class="chip"><input type="checkbox" data-field="safety.floatPrimary"> Float switch (primary)</label>
          <label class="chip"><input type="checkbox" data-field="safety.floatPan"> Float switch (pan)</label>
          <label class="chip"><input type="checkbox" data-field="safety.clearances"> Clearances OK</label>
          <label class="chip"><input type="checkbox" data-field="safety.disconnect"> Outdoor disconnect OK</label>
        </div>
        <div class="divider"></div>
        <div class="muted" style="margin:6px 0">Furnace safety tests</div>
        <div>
          <label class="chip"><input type="checkbox" data-field="safety.rollout"> Rollout switch tested</label>
          <label class="chip"><input type="checkbox" data-field="safety.pressureSwitch"> Pressure switch tested</label>
          <label class="chip"><input type="checkbox" data-field="safety.highLimit"> High-limit switch tested</label>
          <label class="chip"><input type="checkbox" data-field="safety.flameSensor"> Flame sensor OK</label>
          <label class="chip"><input type="checkbox" data-field="safety.ignitionVerified"> Ignition verified</label>
          <label class="chip"><input type="checkbox" data-field="safety.noGasLeaks"> No gas leaks detected</label>
          <label class="chip"><input type="checkbox" data-field="safety.ventingIntact"> Venting/flue intact</label>
          <label class="chip"><input type="checkbox" data-field="safety.grounded"> Electrical connections tight & grounded</label>
        </div>
        <div class="input-group voice-input-wrapper" style="margin-top:8px">
          <label>Safety Notes</label>
          <textarea data-field="safety.notes" placeholder="Venting, gas line, electrical, combustion, detector locations..."></textarea>
          <button class="voice-btn" data-voice-for="safety.notes" style="top:40px">üé§</button>
        </div>
      </details>

      <!-- Mechanical -->
      <details open>
        <summary>Mechanical <span class="badge" data-badge-mech>SOP: ‚Äî</span></summary>
        <div class="sop-tags" data-sop="mechanical">
          <span class="tag" data-sopval="Sound">Sound</span>
          <span class="tag" data-sopval="Stable">Stable</span>
          <span class="tag" data-sopval="Needs Service">Needs Service</span>
        </div>

        <!-- Shared / Cooling -->
        <div class="grid-4" style="margin-top:8px" data-mode-show="COOLING,HEATING">
          <div><label>Return Air (¬∞F)</label><input type="number" step="0.1" data-field="mech.returnF" class="calc-delta calc-rise"></div>
          <div><label>Supply Air (¬∞F)</label><input type="number" step="0.1" data-field="mech.supplyF" class="calc-delta calc-rise"></div>
          <div><label>Temp Split ŒîT (cooling, auto)</label><input type="text" data-field="mech.deltaT" disabled></div>
          <div><label>Temp Rise ŒîT (heating, auto)</label><input type="text" data-field="mech.tempRise" disabled></div>
        </div>

        <div class="grid-4" style="margin-top:8px" data-mode-show="COOLING,HEATING">
          <div>
            <label>Filter Condition</label>
            <input type="text" list="filter-list" data-field="mech.filter" placeholder="Clean / Dirty / Overdue / Replaced">
          </div>
          <div><label>Return Static (in. w.c.)</label><input type="number" step="0.01" data-field="mech.returnStatic" class="calc-static"></div>
          <div><label>Supply Static (in. w.c.)</label><input type="number" step="0.01" data-field="mech.supplyStatic" class="calc-static"></div>
          <div><label>Total Static (auto)</label><input type="text" data-field="mech.totalStatic" disabled></div>
        </div>

        <!-- Cooling-specific -->
        <div class="grid-4" style="margin-top:8px" data-mode-show="COOLING">
          <div><label>Suction Pressure (psig)</label><input type="number" step="0.1" data-field="mech.suction"></div>
          <div><label>Head Pressure (psig)</label><input type="number" step="0.1" data-field="mech.head"></div>
          <div><label>Superheat (¬∞F)</label><input type="number" step="0.1" data-field="mech.sh"></div>
          <div><label>Subcool (¬∞F)</label><input type="number" step="0.1" data-field="mech.sc"></div>
        </div>

        <!-- Heating-specific -->
        <div class="grid-4" style="margin-top:8px" data-mode-show="HEATING">
          <div><label>Inducer Motor Amps</label><input type="number" step="0.01" data-field="mech.inducerAmps"></div>
          <div><label>Gas Input (BTU/hr)</label><input type="number" step="1" data-field="mech.gasInput"></div>
          <div><label>Manifold Pressure (in. w.c.)</label><input type="number" step="0.01" data-field="mech.manifold"></div>
          <div><label>Flame Signal (¬µA)</label><input type="number" step="0.1" data-field="mech.flameSignal"></div>
        </div>

        <!-- Electrical -->
        <div class="grid-4" style="margin-top:8px" data-mode-show="COOLING,HEATING">
          <div><label>Voltage L1‚ÄìL2 (V)</label><input type="number" step="0.1" data-field="mech.v_l1l2"></div>
          <div><label>Voltage L1‚ÄìN (V)</label><input type="number" step="0.1" data-field="mech.v_l1n"></div>
          <div><label>Voltage L2‚ÄìN (V)</label><input type="number" step="0.1" data-field="mech.v_l2n"></div>
          <div class="input-group voice-input-wrapper">
            <label>Electrical Notes</label>
            <input type="text" data-field="mech.electrical" placeholder="Capacitor, contactor, wiring">
            <button class="voice-btn" data-voice-for="mech.electrical">üé§</button>
          </div>
        </div>

        <!-- Amps / Capacitor -->
        <div class="grid-4" style="margin-top:8px" data-mode-show="COOLING,HEATING">
          <div class="input-group voice-input-wrapper">
            <label>Blower Amps (actual/rated)</label>
            <input type="text" data-field="mech.blowerAmps" placeholder="e.g., 5.8/5.0">
            <button class="voice-btn" data-voice-for="mech.blowerAmps">üé§</button>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Compressor Amps (actual/rated)</label>
            <input type="text" data-field="mech.compAmps" placeholder="e.g., 15.0/14.0">
            <button class="voice-btn" data-voice-for="mech.compAmps">üé§</button>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Capacitor ¬µF (actual/rated)</label>
            <input type="text" data-field="mech.capacitance" placeholder="e.g., 37.5/40">
            <button class="voice-btn" data-voice-for="mech.capacitance">üé§</button>
          </div>
          <div>
            <label>Coil Condition</label>
            <select data-field="mech.coilCondition">
              <option value="">Select...</option>
              <option>Clean</option>
              <option>Lightly soiled</option>
              <option>Restricted</option>
              <option>Corroded</option>
              <option>Leaking</option>
            </select>
          </div>
        </div>

        <div class="grid-4" style="margin-top:8px">
          <div class="input-group voice-input-wrapper">
            <label>Mechanical Notes</label>
            <input type="text" data-field="mech.notes" placeholder="Noise, vibration, hard start, overheating">
            <button class="voice-btn" data-voice-for="mech.notes">üé§</button>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Airflow Notes</label>
            <input type="text" data-field="mech.airflowNotes" placeholder="Balance, restriction, duct size">
            <button class="voice-btn" data-voice-for="mech.airflowNotes">üé§</button>
          </div>
          <div class="input-group voice-input-wrapper" data-mode-show="COOLING">
            <label>Refrigerant Notes</label>
            <input type="text" data-field="mech.refNotes" placeholder="Targets, metering device observations">
            <button class="voice-btn" data-voice-for="mech.refNotes">üé§</button>
          </div>
        </div>
      </details>

      <!-- Health / IAQ -->
      <details open>
        <summary>Health / IAQ <span class="badge" data-badge-health>SOP: ‚Äî</span></summary>
        <div class="sop-tags" data-sop="health">
          <span class="tag" data-sopval="Clean">Clean</span>
          <span class="tag" data-sopval="Contaminated">Contaminated</span>
          <span class="tag" data-sopval="Needs Remediation">Needs Remediation</span>
        </div>

        <div style="margin-top:6px">
          <label class="chip"><input type="checkbox" data-field="health.plenumClean"> Supply/return plenums clean</label>
          <label class="chip"><input type="checkbox" data-field="health.insulationIntact"> Insulation intact</label>
          <label class="chip"><input type="checkbox" data-field="health.oxidationRust"> Oxidation / rust present</label>
          <label class="chip"><input type="checkbox" data-field="health.waterDamage"> Water damage visible</label>
          <label class="chip"><input type="checkbox" data-field="health.microbialLight"> Microbial (light)</label>
          <label class="chip"><input type="checkbox" data-field="health.microbialHeavy"> Microbial (heavy)</label>
          <label class="chip"><input type="checkbox" data-field="health.ductLeaks"> Duct/plenum leaks</label>
          <label class="chip"><input type="checkbox" data-field="health.filterOverdue"> Filter overdue</label>
          <label class="chip"><input type="checkbox" data-field="health.drainIssues"> Drain algae / slow flow</label>
        </div>

        <div class="grid-4" style="margin-top:8px">
          <div>
            <label>Filtration Upgrade</label>
            <select data-field="health.filtrationUpgrade">
              <option value="">None</option>
              <option>Media</option>
              <option>Electronic</option>
              <option>HEPA</option>
              <option>UV</option>
              <option>Bipolar</option>
            </select>
          </div>
          <div class="chip"><label><input type="checkbox" data-field="health.uvPresent"> UV system present</label></div>
          <div class="chip"><label><input type="checkbox" data-field="health.uvOperational"> UV system operational</label></div>
          <div class="input-group voice-input-wrapper">
            <label>Odor Findings</label>
            <input type="text" data-field="health.odor" placeholder="Musty, chemical, burning, none">
            <button class="voice-btn" data-voice-for="health.odor">üé§</button>
          </div>
        </div>

        <div class="input-group voice-input-wrapper" style="margin-top:8px">
          <label>Health Notes</label>
          <textarea data-field="health.notes" placeholder="Coil/plenum contamination, insulation, leaks, microbial detail"></textarea>
          <button class="voice-btn" data-voice-for="health.notes" style="top:40px">üé§</button>
        </div>
      </details>

      <!-- Scores -->
      <div class="score-box" style="margin-top:10px">
        <div class="grid-4">
          <div><span class="muted">Safety</span><div class="score" data-score="safety">‚Äì</div></div>
          <div><span class="muted">Mechanical</span><div class="score" data-score="mechanical">‚Äì</div></div>
          <div><span class="muted">Health</span><div class="score" data-score="health">‚Äì</div></div>
          <div><span class="muted">Overall / Confidence</span><div class="score" data-score="overall">‚Äì</div><div class="notice">Conf: <span data-score="confidence">‚Äì</span>%</div></div>
        </div>
      </div>
    </section>
  </template>

  <!-- Datalists -->
  <datalist id="refrig-list">
    <option value="R-410A">
    <option value="R-22">
    <option value="R-32">
    <option value="R-454B">
  </datalist>
  <datalist id="filter-list">
    <option value="Clean">
    <option value="Dirty">
    <option value="Overdue">
    <option value="Replaced">
  </datalist>

  <script>
    // ---------- Utilities ----------
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
    const toNum = v => { const n = parseFloat(v); return isNaN(n) ? null : n; };
    const isTrue = v => v===true || v==='on' || v===1 || v==='1';
    const nowISO = () => new Date().toISOString().slice(0,10);

    // ---------- Init ----------
    $('#inspectionDate').valueAsDate = new Date();
    $('#timeArrived').value = new Date().toTimeString().slice(0,5);
    let sysCount = 0;
    addSystem();

    // ---------- Storage (sessionStorage only - fresh start on reload) ----------
    const STORAGE_KEY = 'fieldbuddy_draft_v2';
    const storage = {
      load(){ try { const raw = sessionStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; } },
      save(obj){ try { sessionStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch(e){} },
      clear(){ try { sessionStorage.removeItem(STORAGE_KEY); } catch(e){} }
    };

    // ---------- Voice Input ----------
    let recognition = null;
    let currentVoiceTarget = null;

    if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (e) => {
        if(e.results.length > 0 && currentVoiceTarget){
          const transcript = e.results[0][0].transcript;
          if(currentVoiceTarget.tagName === 'TEXTAREA'){
            currentVoiceTarget.value = (currentVoiceTarget.value ? currentVoiceTarget.value + ' ' : '') + transcript;
          } else {
            currentVoiceTarget.value = transcript;
          }
          currentVoiceTarget.dispatchEvent(new Event('input', {bubbles: true}));
          markDirty();
        }
      };

      recognition.onend = () => { $$('.voice-btn.listening').forEach(btn => btn.classList.remove('listening')); };
      recognition.onerror = (e) => {
        $$('.voice-btn.listening').forEach(btn => btn.classList.remove('listening'));
        if(e.error !== 'no-speech' && e.error !== 'aborted'){ alert('Voice input error: ' + e.error); }
      };
    }

    function startVoiceInput(btn){
      if(!recognition){ alert('Voice input not supported on this device/browser'); return; }
      const fieldName = btn.getAttribute('data-voice-for');
      const container = btn.closest('[data-system]') || btn.closest('#jobHeader');
      let targetInput = null;

      if(fieldName.includes('.')){ targetInput = $(`[data-field="${fieldName}"]`, container); }
      else { targetInput = $(`#${fieldName}`, container); }

      if(!targetInput) return;
      currentVoiceTarget = targetInput;
      btn.classList.add('listening');
      try { recognition.start(); } catch(e) { btn.classList.remove('listening'); }
    }

    document.addEventListener('click', (e) => {
      if(e.target.classList.contains('voice-btn')){ startVoiceInput(e.target); }
      if(e.target.classList.contains('mode-btn')){ setMode(e.target.closest('[data-system]'), e.target.dataset.mode); }
      if(e.target.classList.contains('tag')){ toggleSOPTag(e.target); }
    });

    // ---------- Template wiring ----------
    function addSystem(){
      const tpl = $('#systemTemplate').content.cloneNode(true);
      sysCount += 1;
      tpl.querySelector('[data-sysname]').textContent = '#' + sysCount;
      const section = tpl.querySelector('[data-system]');

      // Remove / Toggle sections open/closed
      tpl.querySelector('.btnRemove').addEventListener('click', () => section.remove());
      tpl.querySelector('.btnToggle').addEventListener('click', () => {
        const details = $$('details', section);
        const anyOpen = details.some(d => d.open);
        details.forEach(d => d.open = !anyOpen);
      });

      // Calculations
      $$('.calc-delta', tpl).forEach(el => el.addEventListener('input', onDeltaInput));
      $$('.calc-rise', tpl).forEach(el => el.addEventListener('input', onRiseInput));
      $$('.calc-static', tpl).forEach(el => el.addEventListener('input', onStaticInput));

      // Manufacture date ‚Üí age calc
      $('[data-field="meta.mfgDate"]', tpl).addEventListener('input', onAgeCalc);

      // Mode defaults
      setMode(section, 'COOLING');

      // Score live update
      section.addEventListener('input', ()=>scoreCard(section));

      // SOP badge live update
      updateBadges(section);

      // Append
      $('#systems').appendChild(tpl);
    }

    function setMode(card, mode){
      // Toggle buttons
      $$('.mode-btn', card).forEach(b=>{
        b.classList.remove('active','cool','heat');
        if(b.dataset.mode === mode){
          b.classList.add('active', mode==='COOLING' ? 'cool':'heat');
        }
      });
      // Show/hide mode-specific blocks
      $$('[data-mode-show]', card).forEach(block=>{
        const modes = (block.getAttribute('data-mode-show')||'').split(',').map(s=>s.trim());
        block.style.display = modes.includes(mode) ? '' : 'none';
      });
      // Badge
      $('[data-badge-mode]', card).textContent = `Mode: ${mode}`;
      card.dataset.mode = mode;
      scoreCard(card);
    }

    function onDeltaInput(e){
      const card = e.target.closest('[data-system]');
      const r = toNum($('[data-field="mech.returnF"]', card)?.value);
      const s = toNum($('[data-field="mech.supplyF"]', card)?.value);
      const out = $('[data-field="mech.deltaT"]', card);
      if(r!=null && s!=null){ const v = (r - s).toFixed(1); out.value = v; card.dataset.deltaT = v; }
    }
    function onRiseInput(e){
      const card = e.target.closest('[data-system]');
      const r = toNum($('[data-field="mech.returnF"]', card)?.value);
      const s = toNum($('[data-field="mech.supplyF"]', card)?.value);
      const out = $('[data-field="mech.tempRise"]', card);
      if(r!=null && s!=null){ const v = (s - r).toFixed(1); out.value = v; card.dataset.tempRise = v; }
    }
    function onStaticInput(e){
      const card = e.target.closest('[data-system]');
      const rs = toNum($('[data-field="mech.returnStatic"]', card)?.value);
      const ss = toNum($('[data-field="mech.supplyStatic"]', card)?.value);
      const out = $('[data-field="mech.totalStatic"]', card);
      if(rs!=null && ss!=null){ const v = (Math.abs(rs)+Math.abs(ss)).toFixed(2); out.value = v; card.dataset.totalStatic = v; }
    }
    function onAgeCalc(e){
      const card = e.target.closest('[data-system]');
      const mfg = e.target.value ? new Date(e.target.value) : null;
      const ageEl = $('[data-field="meta.age"]', card);
      if(!mfg || isNaN(mfg.getTime())){ ageEl.value = ''; return; }
      const yrs = (Date.now() - mfg.getTime()) / (1000*60*60*24*365.25);
      ageEl.value = yrs.toFixed(1);
    }

    // SOP tags
    function toggleSOPTag(tag){
      const container = tag.parentElement;
      $$('.tag', container).forEach(t=>t.classList.remove('active'));
      tag.classList.add('active');

      const section = tag.closest('[data-system]');
      const group = container.getAttribute('data-sop');
      const value = tag.getAttribute('data-sopval');

      if(group==='safety'){ $('[data-badge-safety]', section).textContent = `SOP: ${value}`; }
      if(group==='mechanical'){ $('[data-badge-mech]', section).textContent = `SOP: ${value}`; }
      if(group==='health'){ $('[data-badge-health]', section).textContent = `SOP: ${value}`; }
      scoreCard(section);
    }
    function updateBadges(card){
      const t = $('[data-field="meta.systemType"]', card)?.value || '‚Äî';
      $('[data-badge-type]', card).textContent = `Type: ${t}`;
      // SOP badges default
      if(!$('[data-badge-safety]', card).textContent.includes(':')) $('[data-badge-safety]', card).textContent = 'SOP: ‚Äî';
      if(!$('[data-badge-mech]', card).textContent.includes(':')) $('[data-badge-mech]', card).textContent = 'SOP: ‚Äî';
      if(!$('[data-badge-health]', card).textContent.includes(':')) $('[data-badge-health]', card).textContent = 'SOP: ‚Äî';
    }

    // ---------- Scoring ----------
    const numLT=(v,t)=>{const n=toNum(v);return n!=null&&n<t;}
    const numGT=(v,t)=>{const n=toNum(v);return n!=null&&n>t;}
    const txtFind=(s,re)=>{if(!s)return false;return new RegExp(re,'i').test(s);}
    const relAmpHigh=(s,th=0.15)=>{ if(!s) return false; const p=s.split('/').map(x=>parseFloat(x)); if(p.length<2||isNaN(p[0])||isNaN(p[1])) return false; return (p[0]-p[1])/p[1]>th; };
    const capLow=(s,th=0.10)=>{ if(!s) return false; const p=s.split('/').map(x=>parseFloat(x)); if(p.length<2||isNaN(p[0])||isNaN(p[1])) return false; return (p[1]-p[0])/p[1]>th; };

    const RULES = {
      safety: [
        { when:c=>!isTrue(c['safety.coDetector']), delta:-1, reason:'CO detector not recorded' },
        { when:c=>!isTrue(c['safety.floatPrimary'])||!isTrue(c['safety.floatPan']), delta:-1, reason:'Missing float switch' },
        { when:c=>!isTrue(c['safety.clearances']), delta:-1, reason:'Clearances not verified' },
        { when:c=>!isTrue(c['safety.disconnect']), delta:-1, reason:'Outdoor disconnect not verified' },
        // New penalties (heating)
        { when:c=>!isTrue(c['safety.rollout']), delta:-1, reason:'Rollout switch not tested' },
        { when:c=>!isTrue(c['safety.pressureSwitch']), delta:-1, reason:'Pressure switch not tested' },
        { when:c=>!isTrue(c['safety.highLimit']), delta:-1, reason:'High-limit not tested' },
        { when:c=>!isTrue(c['safety.ignitionVerified']), delta:-1, reason:'Ignition not verified' },
        { when:c=>!isTrue(c['safety.noGasLeaks']), delta:-2, reason:'Gas leak concern' },
        { when:c=>!isTrue(c['safety.ventingIntact']), delta:-2, reason:'Venting/flue issue' },
      ],
      mechanical: [
        { when:c=>numLT(c.deltaT,16), delta:-1, reason:'Low cooling ŒîT (<16¬∞F)' },
        { when:c=>numGT(c.deltaT,22), delta:-1, reason:'High cooling ŒîT (>22¬∞F)' },
        { when:c=>numLT(c.tempRise,30) && c._mode==='HEATING', delta:-1, reason:'Low heat temperature rise (<30¬∞F)' },
        { when:c=>numGT(c.tempRise,70) && c._mode==='HEATING', delta:-1, reason:'High heat temperature rise (>70¬∞F)' },
        { when:c=>numGT(c.totalStatic,0.50), delta:-2, reason:'High total static (>0.50 in w.c.)' },
        { when:c=>relAmpHigh(c['mech.blowerAmps']), delta:-1, reason:'Blower amps elevated' },
        { when:c=>relAmpHigh(c['mech.compAmps']), delta:-1, reason:'Compressor amps elevated' },
        { when:c=>capLow(c['mech.capacitance']), delta:-1, reason:'Capacitor ¬µF low' },
        { when:c=>numGT(c['mech.inducerAmps'],1.2), delta:-1, reason:'Inducer amps elevated' },
        { when:c=>txtFind(c['mech.notes'],'vibration|grind|hard start|overheat'), delta:-1, reason:'Mechanical noise/start stress' }
      ],
      health: [
        { when:c=>isTrue(c['health.microbialLight']), delta:-2, reason:'Microbial presence (light)' },
        { when:c=>isTrue(c['health.microbialHeavy']), delta:-4, reason:'Microbial presence (heavy)' },
        { when:c=>isTrue(c['health.ductLeaks']), delta:-2, reason:'Duct/plenum leaks' },
        { when:c=>isTrue(c['health.filterOverdue']), delta:-1, reason:'Filter overdue' },
        { when:c=>isTrue(c['health.drainIssues']), delta:-1, reason:'Drain cleanliness issues' },
        { when:c=>isTrue(c['health.oxidationRust']), delta:-1, reason:'Oxidation/rust present' },
        { when:c=>isTrue(c['health.waterDamage']), delta:-2, reason:'Water damage visible' },
        { when:c=>txtFind(c['mech.coilCondition'],'Corroded|Leaking'), delta:-2, reason:'Compromised coil (corroded/leaking)' },
        { when:c=>!isTrue(c['health.plenumClean']), delta:-1, reason:'Plenum contamination' },
      ]
    };

    function collectCardData(card){
      const data={};
      $$('[data-field]', card).forEach(el=>{
        const key = el.getAttribute('data-field');
        data[key] = (el.type === 'checkbox') ? el.checked : el.value;
      });
      data.deltaT = card.dataset.deltaT || data['mech.deltaT'];
      data.tempRise = card.dataset.tempRise || data['mech.tempRise'];
      data.totalStatic = card.dataset.totalStatic || data['mech.totalStatic'];
      data._mode = card.dataset.mode || 'COOLING';
      return data;
    }

    function writeScore(card,key,val){
      const el = $(`[data-score="${key}"]`, card);
      el.textContent = val;
      el.classList.remove('good','warn','bad');
      if(val>=8) el.classList.add('good');
      else if(val>=5) el.classList.add('warn');
      else el.classList.add('bad');
    }

    function scoreCard(card){
      const c = collectCardData(card);
      const out = { safety:10, mechanical:10, health:10, reasons:{safety:[],mechanical:[],health:[]} };

      for(const r of RULES.safety){ if(r.when(c)){ out.safety+=r.delta; out.reasons.safety.push(r.reason);} }
      for(const r of RULES.mechanical){ if(r.when(c)){ out.mechanical+=r.delta; out.reasons.mechanical.push(r.reason);} }
      for(const r of RULES.health){ if(r.when(c)){ out.health+=r.delta; out.reasons.health.push(r.reason);} }

      out.safety=clamp(out.safety,1,10);
      out.mechanical=clamp(out.mechanical,1,10);
      out.health=clamp(out.health,1,10);

      const req=['mech.returnF','mech.supplyF','mech.returnStatic','mech.supplyStatic','mech.blowerAmps','mech.compAmps'];
      const present=req.filter(k=>c[k] && String(c[k]).trim()!=='').length;
      out.confidence = Math.round((present/req.length)*100);
      out.overall = Math.round((out.safety+out.mechanical+out.health)/3);

      writeScore(card,'safety',out.safety);
      writeScore(card,'mechanical',out.mechanical);
      writeScore(card,'health',out.health);
      $('[data-score="overall"]', card).textContent = out.overall;
      $('[data-score="confidence"]', card).textContent = out.confidence;

      card.dataset.scoreReasons = JSON.stringify(out.reasons);
      return out;
    }

    // ---------- Recommendations ----------
    function recommendFromScores(bundle){
      const { data, scores, meta } = bundle;
      const rec = { immediate:[], corrective:[], preventive:[] };

      // Immediate
      if(!isTrue(data['safety.noGasLeaks'])) rec.immediate.push('Investigate and resolve gas leak before operation');
      if(!isTrue(data['safety.ventingIntact'])) rec.immediate.push('Correct venting/flue issues to prevent CO hazards');
      if(txtFind(data['mech.coilCondition'],'Leaking')) rec.immediate.push('Replace/repair leaking coil and recover/charge refrigerant per EPA');

      // Corrective (performance restoration)
      if(numGT(data.totalStatic,0.50)) rec.corrective.push('Seal/resize ductwork to reduce total static; verify filter/media sizing');
      if(isTrue(data['health.ductLeaks'])) rec.corrective.push('Mastic and mechanically fasten plenum/boot seams');
      if(isTrue(data['health.waterDamage'])) rec.corrective.push('Address water damage and correct source (drain/insulation)');
      if(isTrue(data['health.drainIssues'])) rec.corrective.push('Clean, flush, and re-trap condensate line; verify slope');
      if(txtFind(data['mech.coilCondition'],'Restricted|Corroded')) rec.corrective.push('Clean or replace coil; add UV to prevent regrowth');

      // Preventive / enhancements
      if(!data['health.filtrationUpgrade'] || data['health.filtrationUpgrade']==='None')
        rec.preventive.push('Add media filtration cabinet for improved IAQ and reduced static');
      if(!isTrue(data['health.uvPresent'])) rec.preventive.push('Install UV air purification for coil/plenum hygiene');
      if(relAmpHigh(data['mech.compAmps'])) rec.preventive.push('Add soft-start to reduce compressor inrush/current');
      if(relAmpHigh(data['mech.blowerAmps'])) rec.preventive.push('Service blower wheel and verify tap/speed to target airflow');

      // Mode-specific
      if(meta.mode==='COOLING'){
        if(numLT(data.deltaT,16)) rec.corrective.push('Verify airflow (filter, coil, duct) and refrigerant charge for low ŒîT');
      } else {
        if(numLT(data.tempRise,30) || numGT(data.tempRise,70)) rec.corrective.push('Adjust gas input/airflow to target proper temperature rise');
        if(!isTrue(data['safety.rollout'])||!isTrue(data['safety.highLimit'])) rec.immediate.push('Complete furnace safety switch testing before continued operation');
      }
      return rec;
    }

    // ---------- Report synthesis ----------
    function buildReports(){
      const systems = [];
      $$('[data-system]').forEach(card=>{
        const data=collectCardData(card);
        const scores=scoreCard(card);
        const reasons=JSON.parse(card.dataset.scoreReasons||'{"safety":[],"mechanical":[],"health":[]}');
        const meta={
          zone:data['meta.zone']||'Zone',
          brandModel:data['meta.brandModel']||'Brand/Model',
          refrigerant:data['meta.refrigerant']||'',
          type:data['meta.systemType']||'',
          age:data['meta.age']||'',
          mode: card.dataset.mode || 'COOLING',
          deltaT:data.deltaT||data['mech.deltaT']||'',
          tempRise:data.tempRise||data['mech.tempRise']||'',
          totalStatic:data.totalStatic||data['mech.totalStatic']||''
        };
        const recs=recommendFromScores({data,scores,reasons,meta});
        const sop = {
          safety: ($('[data-badge-safety]', card).textContent.split(':')[1]||'').trim(),
          mechanical: ($('[data-badge-mech]', card).textContent.split(':')[1]||'').trim(),
          health: ($('[data-badge-health]', card).textContent.split(':')[1]||'').trim()
        };
        systems.push({data,scores,reasons,meta,recs,sop});
      });

      const ctx = {
        customer: $('#customerName')?.value || '',
        date: $('#inspectionDate')?.value || '',
        time: $('#timeArrived')?.value || '',
        tech: $('#technicianName')?.value || '',
        address: $('#address')?.value || '',
        ambientF: $('#ambientF')?.value || '',
        ambientRH: $('#ambientRH')?.value || '',
        complaint: $('#primaryComplaint')?.value || '',
        symptoms: $('#observableSymptoms')?.value || '',
        root: $('#rootCause')?.value || '',
        systems
      };

      const { customerText, officeText } = synthesizeReports(ctx);
      $('#customerSummary').textContent = customerText;
      $('#officeSummary').textContent = officeText;
      $('#reportsCard').style.display = 'block';
      window.scrollTo({ top: $('#reportsCard').offsetTop - 10, behavior: 'smooth' });
    }

    function synthesizeReports(ctx){
      const c=[];
      c.push(`HVAC Inspection Summary`);
      c.push(`Customer: ${ctx.customer}`);
      if(ctx.address) c.push(`Address: ${ctx.address}`);
      c.push(`Date: ${ctx.date}    Time: ${ctx.time || '-' }    Technician: ${ctx.tech}`);
      if(ctx.ambientF||ctx.ambientRH) c.push(`Ambient: ${ctx.ambientF||'-'} ¬∞F, ${ctx.ambientRH||'-'} % RH`);
      if(ctx.complaint) c.push(`Primary complaint: ${ctx.complaint}`);
      if(ctx.symptoms) c.push(`Observed: ${ctx.symptoms}`);
      if(ctx.root) c.push(`Assessment: ${ctx.root}`);
      c.push('');

      ctx.systems.forEach((s,i)=>{
        c.push(`System ${i+1} ‚Äî ${s.meta.zone} (${s.meta.brandModel})`);
        if(s.meta.type) c.push(`Type: ${s.meta.type}    Mode: ${s.meta.mode}    Age: ${s.meta.age || '-'} yrs`);
        if(s.meta.refrigerant) c.push(`Refrigerant: ${s.meta.refrigerant}`);
        if(s.meta.mode==='COOLING'){
          c.push(`Performance: Cooling ŒîT ${s.meta.deltaT||'-'} ¬∞F, Total static ${s.meta.totalStatic||'-'} in w.c.`);
        }else{
          c.push(`Performance: Heat rise ${s.meta.tempRise||'-'} ¬∞F, Total static ${s.meta.totalStatic||'-'} in w.c.`);
        }
        c.push(`Scores: Safety ${s.scores.safety}/10, Mechanical ${s.scores.mechanical}/10, Health ${s.scores.health}/10, Overall ${s.scores.overall}/10, Confidence ${s.scores.confidence}%`);
        c.push(`SOP Status ‚Äî Safety: ${s.sop.safety||'-'} | Mechanical: ${s.sop.mechanical||'-'} | Health: ${s.sop.health||'-'}`);
        if(s.recs.immediate.length||s.recs.corrective.length||s.recs.preventive.length){
          c.push(`Recommendations:`);
          if(s.recs.immediate.length)  c.push(`  Immediate: ${s.recs.immediate.join('; ')}`);
          if(s.recs.corrective.length) c.push(`  Corrective: ${s.recs.corrective.join('; ')}`);
          if(s.recs.preventive.length) c.push(`  Preventive: ${s.recs.preventive.join('; ')}`);
        }
        c.push('');
      });

      const o=[];
      o.push(`Back Office Technical Summary`);
      o.push(`Customer: ${ctx.customer}    Date: ${ctx.date} ${ctx.time?(' '+ctx.time):''}    Technician: ${ctx.tech}`);
      if(ctx.address) o.push(`Address: ${ctx.address}`);
      if(ctx.ambientF||ctx.ambientRH) o.push(`Ambient: ${ctx.ambientF||'-'} ¬∞F, ${ctx.ambientRH||'-'} % RH`);
      if(ctx.complaint) o.push(`Primary complaint: ${ctx.complaint}`);
      if(ctx.symptoms) o.push(`Observed: ${ctx.symptoms}`);
      if(ctx.root) o.push(`Assessment: ${ctx.root}`);
      o.push('');

      ctx.systems.forEach((s,i)=>{
        o.push(`System ${i+1}: ${s.meta.zone} (${s.meta.brandModel})`);
        o.push(`  Identity: Type ${s.meta.type||'-'}  Refrig ${s.meta.refrigerant||'-'}  Age ${s.meta.age||'-'} yrs  Indoor ${s.data['meta.indoorMS']||'-'}  Outdoor ${s.data['meta.outdoorMS']||'-'}`);
        o.push(`  Mode: ${s.meta.mode}`);
        o.push(`  Air Temps: Return ${s.data['mech.returnF']||'-'} ¬∞F   Supply ${s.data['mech.supplyF']||'-'} ¬∞F   Cooling ŒîT ${s.meta.deltaT||'-'} ¬∞F   Heat Rise ${s.meta.tempRise||'-'} ¬∞F`);
        o.push(`  Static: Return ${s.data['mech.returnStatic']||'-'}   Supply ${s.data['mech.supplyStatic']||'-'}   Total ${s.meta.totalStatic||'-'} in w.c.`);
        if(s.meta.mode==='COOLING'){
          o.push(`  Refrig: Suction ${s.data['mech.suction']||'-'} psig   Head ${s.data['mech.head']||'-'} psig   SH ${s.data['mech.sh']||'-'} ¬∞F   SC ${s.data['mech.sc']||'-'} ¬∞F`);
        }else{
          o.push(`  Heating: Inducer ${s.data['mech.inducerAmps']||'-'} A   Gas Input ${s.data['mech.gasInput']||'-'} BTU/hr   Manifold ${s.data['mech.manifold']||'-'} in w.c.   Flame ${s.data['mech.flameSignal']||'-'} ¬µA`);
        }
        o.push(`  Electrical: L1-L2 ${s.data['mech.v_l1l2']||'-'} V   L1-N ${s.data['mech.v_l1n']||'-'} V   L2-N ${s.data['mech.v_l2n']||'-'} V`);
        o.push(`  Amps:   Blower ${s.data['mech.blowerAmps']||'-'}   Compressor ${s.data['mech.compAmps']||'-'}`);
        o.push(`  Capacitor: ${s.data['mech.capacitance']||'-'} ¬µF    Coil: ${s.data['mech.coilCondition']||'-'}`);
        if(s.data['mech.filter']) o.push(`  Filter: ${s.data['mech.filter']}`);
        if(s.data['mech.electrical']) o.push(`  Electrical Notes: ${s.data['mech.electrical']}`);
        if(s.data['mech.airflowNotes']) o.push(`  Airflow Notes: ${s.data['mech.airflowNotes']}`);
        if(s.data['mech.refNotes']) o.push(`  Refrigerant Notes: ${s.data['mech.refNotes']}`);
        // Safety switch results
        o.push(`  Safety Switches: Rollout ${isTrue(s.data['safety.rollout'])?'OK':'‚Äî'}  Pressure ${isTrue(s.data['safety.pressureSwitch'])?'OK':'‚Äî'}  High-limit ${isTrue(s.data['safety.highLimit'])?'OK':'‚Äî'}  Flame sensor ${isTrue(s.data['safety.flameSensor'])?'OK':'‚Äî'}  Ignition ${isTrue(s.data['safety.ignitionVerified'])?'OK':'‚Äî'}`);
        o.push(`  Gas/Venting: Gas leaks ${isTrue(s.data['safety.noGasLeaks'])?'none':'CHECK'}  Venting ${isTrue(s.data['safety.ventingIntact'])?'intact':'ISSUE'}`);
        // IAQ
        const filt = s.data['health.filtrationUpgrade']||'None';
        const uv = isTrue(s.data['health.uvPresent']) ? (isTrue(s.data['health.uvOperational']) ? 'UV present/operational' : 'UV present/not operational') : 'UV not present';
        if(s.data['health.odor']) o.push(`  Odor: ${s.data['health.odor']}`);
        o.push(`  IAQ: Filtration ${filt}; ${uv}`);
        if(s.data['health.notes']) o.push(`  Health Notes: ${s.data['health.notes']}`);

        // Scores & SOP
        o.push(`  Scores: Safety ${s.scores.safety}/10   Mechanical ${s.scores.mechanical}/10   Health ${s.scores.health}/10   Overall ${s.scores.overall}/10   Confidence ${s.scores.confidence}%`);
        const reasons = s.reasons;
        if(Object.values(reasons).some(a=>a.length)){
          o.push(`  Score drivers:`);
          if(reasons.safety.length) o.push(`    Safety: ${reasons.safety.join('; ')}`);
          if(reasons.mechanical.length) o.push(`    Mechanical: ${reasons.mechanical.join('; ')}`);
          if(reasons.health.length) o.push(`    Health: ${reasons.health.join('; ')}`);
        }
        // SOP summary
        o.push(`  SOP Status: Safety=${s.sop.safety||'-'}  Mechanical=${s.sop.mechanical||'-'}  Health=${s.sop.health||'-'}`);

        // Tiered Recommendations
        o.push(`  Tiered Recommendations:`);
        o.push(`    Immediate: ${s.recs.immediate.join('; ') || 'None'}`);
        o.push(`    Corrective: ${s.recs.corrective.join('; ') || 'None'}`);
        o.push(`    Preventive: ${s.recs.preventive.join('; ') || 'None'}`);
        o.push('');
      });

      return { customerText:c.join('\n'), officeText:o.join('\n') };
    }

    // ---------- Exports ----------
    function exportPDF(){
      buildReports(); // Auto-generate before export
      const el = document.body.cloneNode(true);
      el.querySelectorAll('.toolbar, .sticky-actions, .voice-btn, #saveIndicator').forEach(b => b && (b.style.display='none'));
      const opt = {
        margin: 0.5,
        filename: `FieldBuddy_${($('#customerName').value || 'Report')}_${($('#inspectionDate').value || nowISO())}.pdf`,
        image: { type:'jpeg', quality:0.98 },
        html2canvas: { scale:2, useCORS:true },
        jsPDF: { unit:'in', format:'letter', orientation:'portrait' }
      };
      html2pdf().set(opt).from(el).save();
    }
    function exportHTML(){
      buildReports();
      const escapeHtml = (str) => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
      const doc = `<!doctype html><html><head><meta charset="utf-8"><title>Field Buddy Report</title><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font-family:Arial,Helvetica,sans-serif;max-width:900px;margin:0 auto;padding:16px;white-space:pre-wrap}h2{border-bottom:1px solid #ddd;padding-bottom:6px}</style></head><body><h2>Customer Summary</h2>${escapeHtml($('#customerSummary').textContent)}<h2>Back Office Summary</h2>${escapeHtml($('#officeSummary').textContent)}</body></html>`;
      const blob = new Blob([doc], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `FieldBuddy_${($('#customerName').value || 'Report')}_${($('#inspectionDate').value || nowISO())}.html`;
      a.click(); URL.revokeObjectURL(a.href);
    }
    function exportJSON(){
      buildReports();
      const payload = {
        customer: $('#customerName')?.value || '',
        date: $('#inspectionDate')?.value || '',
        time: $('#timeArrived')?.value || '',
        tech: $('#technicianName')?.value || '',
        address: $('#address')?.value || '',
        ambientF: $('#ambientF')?.value || '',
        ambientRH: $('#ambientRH')?.value || '',
        complaint: $('#primaryComplaint')?.value || '',
        symptoms: $('#observableSymptoms')?.value || '',
        root: $('#rootCause')?.value || '',
        systems: []
      };
      $$('[data-system]').forEach(card=>{
        const data = collectCardData(card);
        const scores = scoreCard(card);
        const sop = {
          safety: ($('[data-badge-safety]', card).textContent.split(':')[1]||'').trim(),
          mechanical: ($('[data-badge-mech]', card).textContent.split(':')[1]||'').trim(),
          health: ($('[data-badge-health]', card).textContent.split(':')[1]||'').trim()
        };
        payload.systems.push({ data, scores, sop });
      });
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `FieldBuddy_${($('#customerName').value || 'Report')}_${($('#inspectionDate').value || nowISO())}.json`;
      a.click(); URL.revokeObjectURL(a.href);
    }

    // ---------- Copy to clipboard ----------
    function copyToClipboard(text, label){
      navigator.clipboard.writeText(text)
        .then(()=> alert(`‚úì ${label} copied! Ready to paste.`))
        .catch(()=> alert('Copy failed. Please select and copy manually.'));
    }

    // ---------- Draft persistence ----------
    function gatherDraft(){
      const draft = {
        header: {
          customer: $('#customerName').value || '',
          date: $('#inspectionDate').value || '',
          time: $('#timeArrived').value || '',
          tech: $('#technicianName').value || '',
          address: $('#address').value || '',
          ambientF: $('#ambientF').value || '',
          ambientRH: $('#ambientRH').value || '',
          complaint: $('#primaryComplaint').value || '',
          symptoms: $('#observableSymptoms').value || '',
          root: $('#rootCause').value || ''
        },
        systems: []
      };
      $$('[data-system]').forEach(card=> draft.systems.push(collectCardData(card)));
      return draft;
    }

    let dirty = false;
    function markDirty(){ dirty = true; }

    function saveDraft(showIndicator=false){
      if(!dirty) return;
      const draft = gatherDraft();
      storage.save(draft);
      dirty = false;
      if(showIndicator){
        const ind = $('#saveIndicator');
        ind.classList.add('show');
        setTimeout(()=> ind.classList.remove('show'), 1500);
      }
    }

    function clearDraft(){
      if(confirm('Clear all data and start fresh?')){
        storage.clear();
        location.reload();
      }
    }

    // ---------- Global wiring ----------
    $('#btnAddSystem').addEventListener('click', addSystem);
    $('#btnExpandAll').addEventListener('click', ()=> $$('[data-system] details').forEach(d=> d.open=true));
    $('#btnCollapseAll').addEventListener('click', ()=> $$('[data-system] details').forEach(d=> d.open=false));
    $('#btnGenerate').addEventListener('click', buildReports);
    $('#btnPDF2').addEventListener('click', exportPDF);
    $('#btnHTML2').addEventListener('click', exportHTML);
    $('#btnJSON2').addEventListener('click', exportJSON);
    $('#btnClear').addEventListener('click', clearDraft);
    $('#btnToday').addEventListener('click', ()=> $('#inspectionDate').valueAsDate = new Date());
    $('#btnCopyCustomer').addEventListener('click', ()=> copyToClipboard($('#customerSummary').textContent, 'Customer Summary'));
    $('#btnCopyOffice').addEventListener('click', ()=> copyToClipboard($('#officeSummary').textContent, 'Office Summary'));

    // Mark dirty on any input / select change
    $('#app').addEventListener('input', (e)=>{
      if(e.target.matches('[data-field="meta.systemType"]')){
        const card = e.target.closest('[data-system]'); updateBadges(card);
      }
      markDirty();
    });
    $('#app').addEventListener('change', markDirty);

    // Auto-save every 5 seconds after changes
    setInterval(()=> { if(dirty) saveDraft(true); }, 5000);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e)=> {
      if(e.ctrlKey || e.metaKey){
        if(e.key === 's'){ e.preventDefault(); saveDraft(true); }
        if(e.key === 'n'){ e.preventDefault(); addSystem(); window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }
        if(e.key === 'g'){ e.preventDefault(); buildReports(); }
      }
    });

    // Start fresh on reload (intentionally not auto-loading previous session)
    // If you prefer auto-load, uncomment below:
    // const draft = storage.load(); if(draft){ /* hydrate here */ }
  </script>
</body>
</html>
