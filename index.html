<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Field Buddy Pro v2.0 — HVAC Inspection & Reporting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f172a">
  <meta name="description" content="Professional HVAC field inspection tool with photo capture, refrigerant calculations, and intelligent diagnostics">

  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
          integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --bg:#f6f7fb;--card:#fff;--ink:#1f2937;--muted:#6b7280;--primary:#2563eb;--border:#e5e7eb;
      --good:#16a34a;--warn:#d97706;--bad:#dc2626;--info:#0ea5e9;
      --shadow-sm:0 2px 8px rgba(17,24,39,.05);--shadow-md:0 4px 16px rgba(17,24,39,.1);
      --shadow-lg:0 8px 24px rgba(17,24,39,.15);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,sans-serif;color:var(--ink);background:var(--bg);-webkit-text-size-adjust:100%;line-height:1.5}
    .wrap{max-width:1080px;margin:0 auto;padding:12px}
    
    /* Header */
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#0f172a 0%,#111827 100%);color:#fff;border-radius:10px;padding:14px;margin-bottom:12px;box-shadow:var(--shadow-lg)}
    header h1{margin:0 0 4px;font-size:18px;font-weight:700}
    header .sub{font-size:12px;color:#cbd5e1;display:flex;align-items:center;gap:8px}
    header .version{background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;align-items:center}
    
    /* Buttons */
    .btn{background:var(--primary);color:#fff;border:0;border-radius:8px;padding:14px 18px;font-size:15px;font-weight:600;cursor:pointer;touch-action:manipulation;min-height:48px;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all .2s;box-shadow:var(--shadow-sm)}
    .btn:active{transform:scale(0.98)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn.secondary{background:#334155}
    .btn.outline{background:transparent;color:#e5e7eb;border:1px solid #475569;box-shadow:none}
    .btn.warn{background:var(--warn)}
    .btn.good{background:var(--good)}
    .btn.gray{background:#6b7280}
    .btn.small{padding:10px 14px;font-size:13px;min-height:40px}
    .btn.icon-only{padding:10px;min-width:40px}
    .right{margin-left:auto}
    
    /* Cards */
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:var(--shadow-sm);transition:box-shadow .2s}
    .card:hover{box-shadow:var(--shadow-md)}
    .section-title{display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--border);padding-bottom:8px;margin-bottom:10px;font-weight:700;font-size:16px}
    
    /* Grid */
    .grid-2{display:grid;grid-template-columns:1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr;gap:10px}
    .grid-4{display:grid;grid-template-columns:1fr;gap:10px}
    
    /* Form elements */
    label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px;font-weight:500}
    input[type="text"],input[type="number"],input[type="date"],textarea,select{
      width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:8px;font-size:16px;background:#fff;touch-action:manipulation;-webkit-appearance:none;transition:all .2s;font-family:inherit
    }
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,0.1)}
    
    /* Field validation states */
    .input-error{border-color:var(--bad)!important;background:#fef2f2!important}
    .input-warning{border-color:var(--warn)!important;background:#fffbeb!important}
    .input-success{border-color:var(--good)!important}
    .field-hint{font-size:11px;color:var(--muted);margin-top:4px;display:flex;align-items:center;gap:4px}
    .field-hint.error{color:var(--bad)}
    .field-hint.warning{color:var(--warn)}
    .field-hint.success{color:var(--good)}
    .help-icon{cursor:help;display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;background:#e5e7eb;font-size:10px;font-weight:bold;color:var(--muted);margin-left:4px}
    
    select{cursor:pointer}
    input[type="number"]{font-size:17px}
    textarea{min-height:100px;resize:vertical;line-height:1.5}
    
    /* Details/Accordion */
    details{border:1px dashed var(--border);border-radius:8px;padding:10px 12px;margin:10px 0;transition:all .2s}
    details[open]{border-style:solid;background:#f8fafc}
    details summary{cursor:pointer;font-weight:700;margin:6px 0;font-size:15px;padding:6px 0;touch-action:manipulation;list-style:none;display:flex;align-items:center;justify-content:space-between}
    details summary::-webkit-details-marker{display:none}
    details summary::after{content:'▼';font-size:12px;transition:transform .2s;color:var(--muted)}
    details[open] summary::after{transform:rotate(180deg)}
    
    /* Checkboxes */
    .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:999px;font-size:14px;margin:4px 6px 4px 0;touch-action:manipulation;min-height:44px;transition:all .2s;cursor:pointer}
    .chip:hover{background:#f8fafc;border-color:var(--primary)}
    .chip input[type="checkbox"]{width:20px;height:20px;margin:0;cursor:pointer}
    .chip input[type="checkbox"]:checked + span{font-weight:600}
    
    /* Scores */
    .score-box{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:12px}
    .score{font-weight:800;font-size:20px}
    .score.good{color:var(--good)} .score.warn{color:var(--warn)} .score.bad{color:var(--bad)}
    
    /* Status tags */
    .sop-status{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .status-tag{padding:6px 12px;border-radius:999px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:#fff;transition:all .2s;min-height:36px;display:inline-flex;align-items:center}
    .status-tag:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
    .status-tag.pass,.status-tag.sound,.status-tag.clean{background:var(--good);color:#fff;border-color:var(--good)}
    .status-tag.fail,.status-tag.service,.status-tag.contaminated{background:var(--bad);color:#fff;border-color:var(--bad)}
    .status-tag.attention,.status-tag.stable,.status-tag.remediation{background:var(--warn);color:#fff;border-color:var(--warn)}
    
    /* Mode toggle */
    .mode-toggle{display:flex;gap:10px;margin-bottom:12px}
    .mode-btn{flex:1;padding:12px;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer;text-align:center;font-weight:600;transition:all .2s;font-size:15px}
    .mode-btn:hover{border-color:var(--primary)}
    .mode-btn.active{background:var(--primary);color:#fff;border-color:var(--primary);box-shadow:var(--shadow-sm)}
    
    /* Voice input */
    .voice-input-wrapper{position:relative}
    .voice-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--primary);color:#fff;border:0;border-radius:6px;padding:8px 12px;font-size:20px;cursor:pointer;z-index:2;min-height:36px;display:flex;align-items:center;justify-content:center;transition:all .2s}
    .voice-btn:hover{background:#1d4ed8}
    .voice-btn.listening{background:var(--bad);animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    .voice-hint{font-size:12px;color:var(--muted);font-style:italic;margin-top:4px}
    
    /* Photo grid */
    .photo-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:8px}
    .photo-item{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;border:1px solid var(--border);background:#f8fafc;cursor:pointer;transition:all .2s}
    .photo-item:hover{transform:scale(1.05);box-shadow:var(--shadow-md)}
    .photo-item img{width:100%;height:100%;object-fit:cover}
    .photo-delete{position:absolute;top:4px;right:4px;background:var(--bad);color:#fff;border:0;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
    .photo-item:hover .photo-delete{opacity:1}
    .photo-count{font-weight:600;color:var(--primary)}
    .photo-input{display:none}
    .photo-add{border:2px dashed var(--border);background:#f8fafc;display:flex;align-items:center;justify-content:center;font-size:32px;color:var(--muted);cursor:pointer;transition:all .2s}
    .photo-add:hover{border-color:var(--primary);color:var(--primary);background:#eff6ff}
    
    /* Quick notes */
    .quick-notes{margin-top:8px}
    .note-item{background:#fffbeb;border:1px solid #fbbf24;border-radius:6px;padding:8px 12px;margin-bottom:6px;font-size:13px;display:flex;align-items:start;gap:8px}
    .note-item.flag{background:#fef2f2;border-color:#ef4444}
    .note-time{font-size:11px;color:var(--muted)}
    .note-delete{background:transparent;border:0;color:var(--muted);cursor:pointer;padding:0;font-size:16px;margin-left:auto}
    
    /* Target indicators */
    .target-indicator{background:#eff6ff;border:1px solid var(--info);border-radius:6px;padding:8px 12px;margin-top:8px;font-size:13px;color:#0369a1;display:flex;align-items:center;gap:6px}
    .target-indicator.good{background:#f0fdf4;border-color:var(--good);color:#15803d}
    .target-indicator.warn{background:#fffbeb;border-color:var(--warn);color:#92400e}
    .target-indicator.bad{background:#fef2f2;border-color:var(--bad);color:#991b1b}
    
    /* Progress bar */
    .progress-bar{height:6px;background:#e5e7eb;border-radius:3px;overflow:hidden;margin:8px 0}
    .progress-fill{height:100%;background:var(--primary);transition:width .3s;border-radius:3px}
    .progress-fill.complete{background:var(--good)}
    .completion-badge{display:inline-flex;align-items:center;gap:4px;background:#f0fdf4;color:var(--good);padding:4px 10px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid var(--good)}
    
    /* Modals */
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
    .modal-content{background:#fff;border-radius:12px;padding:24px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow-lg)}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .modal-title{font-size:18px;font-weight:700}
    .modal-close{background:transparent;border:0;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:6px}
    .modal-close:hover{background:#f3f4f6}
    
    /* Toast notifications */
    .toast{position:fixed;bottom:20px;right:20px;background:#fff;padding:12px 16px;border-radius:8px;font-size:14px;font-weight:600;z-index:999;box-shadow:var(--shadow-lg);display:flex;align-items:center;gap:8px;opacity:0;transform:translateY(10px);transition:all .3s;border:1px solid var(--border)}
    .toast.show{opacity:1;transform:translateY(0)}
    .toast.success{background:var(--good);color:#fff;border-color:var(--good)}
    .toast.error{background:var(--bad);color:#fff;border-color:var(--bad)}
    .toast.info{background:var(--info);color:#fff;border-color:var(--info)}
    
    /* Summary boxes */
    .muted{color:var(--muted)}
    .notice{font-size:13px;color:var(--muted)}
    .summary-box{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:14px;white-space:pre-wrap;font-size:14px;line-height:1.6;font-family:ui-monospace,monospace}
    .divider{height:1px;background:var(--border);margin:12px 0}
    
    /* Sticky actions */
    .sticky-actions{position:sticky;bottom:10px;z-index:4;display:flex;gap:8px;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
    
    /* Hidden sections */
    .cooling-only,.heating-only{display:none}
    .mode-cooling .cooling-only{display:block}
    .mode-heating .heating-only{display:block}
    
    /* Responsive */
    @media(min-width:640px){
      .grid-2{grid-template-columns:1fr 1fr}
      .grid-3{grid-template-columns:1fr 1fr 1fr}
      .grid-4{grid-template-columns:repeat(4,1fr)}
      header h1{font-size:20px}
    }
    @media(min-width:768px){
      .wrap{padding:20px}
    }
    
    /* Print styles */
    @media print{
      .toolbar,.btn,.voice-btn,.sticky-actions,.photo-delete,.modal{display:none!important}
      header .sub,.version{display:none}
      body{background:#fff}
      .card{break-inside:avoid;page-break-inside:avoid;box-shadow:none}
      details{border:none!important}
      details summary{display:none}
      details{display:block!important}
    }
  </style>
</head>
<body>
  <div class="wrap" id="app">
    <header>
      <h1>Field Buddy Pro — HVAC Inspection & Reporting</h1>
      <div class="sub">
        <span>Mobile-optimized field inspection with intelligent diagnostics</span>
        <span class="version">v2.0</span>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnAddSystem">➕ Add System</button>
        <button class="btn secondary" id="btnExpandAll">Expand All</button>
        <button class="btn secondary" id="btnCollapseAll">Collapse All</button>
        <button class="btn good" id="btnGenerate">📊 Generate Reports</button>
        <button class="btn outline small" id="btnToday">Today</button>
        <button class="btn outline small" id="btnHelp">❓ Help</button>
        <button class="btn warn small" id="btnClear">🗑️ Clear All</button>
      </div>
    </header>

    <!-- Job Header -->
    <section class="card" id="jobHeader">
      <div class="section-title"><div>Job Context</div></div>
      <div class="grid-3">
        <div class="input-group voice-input-wrapper">
          <label>Customer Name</label>
          <input type="text" id="customerName" placeholder="Full name" autocomplete="name">
          <button class="voice-btn" data-voice-for="customerName" title="Voice input">🎤</button>
        </div>
        <div><label>Inspection Date</label><input type="date" id="inspectionDate"></div>
        <div><label>Technician</label><input type="text" id="technicianName" placeholder="Your name" autocomplete="name"></div>
      </div>
      <div class="grid-3" style="margin-top:8px">
        <div class="input-group voice-input-wrapper">
          <label>Address</label>
          <input type="text" id="address" placeholder="Street, City, State" autocomplete="street-address">
          <button class="voice-btn" data-voice-for="address" title="Voice input">🎤</button>
        </div>
        <div>
          <label>Ambient Temperature (F)</label>
          <input type="number" inputmode="decimal" step="0.1" id="ambientF" placeholder="e.g., 75.0">
          <div class="field-hint">🌡️ Outdoor temperature</div>
        </div>
        <div>
          <label>Ambient Humidity (%)</label>
          <input type="number" inputmode="decimal" step="1" id="ambientRH" placeholder="e.g., 55">
          <div class="field-hint">💧 Outdoor humidity</div>
        </div>
      </div>
    </section>

    <!-- Systems container -->
    <div id="systems"></div>

    <!-- Reports -->
    <section class="card" id="reportsCard" style="display:none;">
      <div class="section-title"><div>Generated Reports</div></div>
      <div style="margin-bottom:10px">
        <button class="btn good small" id="btnCopyCustomer">📋 Copy Customer Summary</button>
        <button class="btn good small" id="btnCopyOffice">📋 Copy Office Summary</button>
      </div>
      <div class="summary-box" id="customerSummary"></div>
      <div class="divider"></div>
      <div class="summary-box" id="officeSummary"></div>
      <div class="sticky-actions">
        <button class="btn good" id="btnPDF2">📄 Export PDF</button>
        <button class="btn outline" id="btnHTML2">📝 Export HTML</button>
        <button class="btn outline" id="btnJSON2">💾 Export JSON</button>
      </div>
    </section>
  </div>

  <!-- Toast container -->
  <div id="toastContainer"></div>

  <!-- Help Modal -->
  <div id="helpModal" class="modal" style="display:none">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">⌨️ Keyboard Shortcuts & Tips</div>
        <button class="modal-close" id="btnCloseHelp">×</button>
      </div>
      <div>
        <h4 style="margin:12px 0 8px">Shortcuts</h4>
        <ul style="margin:0;padding-left:20px;line-height:2">
          <li><kbd style="background:#f3f4f6;padding:2px 6px;border-radius:4px">Ctrl+S</kbd> — Save draft</li>
          <li><kbd style="background:#f3f4f6;padding:2px 6px;border-radius:4px">Ctrl+N</kbd> — Add new system</li>
          <li><kbd style="background:#f3f4f6;padding:2px 6px;border-radius:4px">Ctrl+G</kbd> — Generate reports</li>
          <li><kbd style="background:#f3f4f6;padding:2px 6px;border-radius:4px">Tab</kbd> — Next field</li>
        </ul>
        <h4 style="margin:16px 0 8px">Features</h4>
        <ul style="margin:0;padding-left:20px;line-height:2">
          <li>🎤 Voice input for text fields</li>
          <li>📸 Photo capture with compression</li>
          <li>💬 Quick notes and flags</li>
          <li>🎯 Real-time refrigerant calculations</li>
          <li>✓ Automatic field validation</li>
          <li>💾 Auto-save every 2 seconds</li>
        </ul>
        <h4 style="margin:16px 0 8px">Tips</h4>
        <ul style="margin:0;padding-left:20px;line-height:2">
          <li>Field hints appear as you type</li>
          <li>Green borders = values look good</li>
          <li>Yellow borders = check values</li>
          <li>Red borders = out of range</li>
          <li>Photos auto-compress for storage</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Photo viewer modal -->
  <div id="photoModal" class="modal" style="display:none">
    <div class="modal-content" style="max-width:800px">
      <div class="modal-header">
        <div class="modal-title">Photo</div>
        <button class="modal-close" id="btnClosePhoto">×</button>
      </div>
      <img id="photoModalImg" style="width:100%;border-radius:8px">
    </div>
  </div>

  <!-- System Template -->
  <template id="systemTemplate">
    <section class="card" data-system>
      <div class="section-title">
        <div style="display:flex;align-items:center;gap:8px">
          <span>System <span data-sysname>#</span></span>
          <span class="completion-badge" style="display:none" data-completion>✓ <span data-percent>0</span>% Complete</span>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn gray small btnToggle" title="Expand/collapse all sections">Toggle</button>
          <button class="btn warn small btnRemove" title="Remove this system">Remove</button>
        </div>
      </div>
      <div class="progress-bar"><div class="progress-fill" data-progress style="width:0"></div></div>

      <!-- Mode Toggle -->
      <div class="mode-toggle">
        <button class="mode-btn active" data-mode="cooling">❄️ Cooling</button>
        <button class="mode-btn" data-mode="heating">🔥 Heating</button>
      </div>

      <!-- Identity -->
      <div class="grid-3">
        <div class="input-group voice-input-wrapper">
          <label>Area Served (e.g., Upstairs)</label>
          <input type="text" data-field="meta.zone" placeholder="Zone / Floor">
          <button class="voice-btn" data-voice-for="meta.zone" title="Voice input">🎤</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Brand / Model</label>
          <input type="text" data-field="meta.brandModel" placeholder="Brand and model">
          <button class="voice-btn" data-voice-for="meta.brandModel" title="Voice input">🎤</button>
        </div>
        <div class="input-group">
          <label>System Type</label>
          <select data-field="meta.systemType">
            <option value="">Select type...</option>
            <option value="split">Split System</option>
            <option value="heatpump">Heat Pump</option>
            <option value="package">Package Unit</option>
            <option value="minisplit">Mini-Split</option>
            <option value="furnace">Furnace Only</option>
          </select>
        </div>
      </div>
      <div class="grid-4" style="margin-top:8px">
        <div class="input-group voice-input-wrapper">
          <label>Indoor Model / Serial</label>
          <input type="text" data-field="meta.indoorMS" placeholder="Model / Serial">
          <button class="voice-btn" data-voice-for="meta.indoorMS" title="Voice input">🎤</button>
        </div>
        <div class="input-group voice-input-wrapper">
          <label>Outdoor Model / Serial</label>
          <input type="text" data-field="meta.outdoorMS" placeholder="Model / Serial">
          <button class="voice-btn" data-voice-for="meta.outdoorMS" title="Voice input">🎤</button>
        </div>
        <div>
          <label>Manufacture Date</label>
          <input type="date" data-field="meta.mfgDate" class="calc-age">
        </div>
        <div>
          <label>Equipment Age (yrs)</label>
          <input type="number" inputmode="decimal" step="0.1" data-field="meta.age" readonly>
        </div>
      </div>
      <div class="cooling-only">
        <label>Refrigerant Type</label>
        <select data-field="meta.refrigerant" class="calc-targets">
          <option value="">Select refrigerant...</option>
          <option value="R-410A">R-410A</option>
          <option value="R-22">R-22</option>
          <option value="R-32">R-32</option>
          <option value="R-454B">R-454B</option>
        </select>
      </div>

      <!-- Photos -->
      <details open>
        <summary>📸 Photos (<span class="photo-count">0</span>)</summary>
        <input type="file" accept="image/*" capture="environment" multiple class="photo-input">
        <button class="btn secondary small btn-add-photo" style="margin-top:8px">📷 Take/Upload Photos</button>
        <div class="photo-grid" style="margin-top:8px"></div>
      </details>

      <!-- Quick Notes -->
      <details open>
        <summary>💬 Quick Notes & Flags</summary>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn small secondary btn-quick-note">💬 Add Note</button>
          <button class="btn small warn btn-flag-issue">🚩 Flag Issue</button>
        </div>
        <div class="quick-notes"></div>
      </details>

      <!-- Safety -->
      <details open>
        <summary>Safety</summary>
        <div>
          <label class="chip"><input type="checkbox" data-field="safety.coDetector"><span>CO detector present</span></label>
          <label class="chip"><input type="checkbox" data-field="safety.floatPrimary"><span>Float switch (primary)</span></label>
          <label class="chip"><input type="checkbox" data-field="safety.floatPan"><span>Float switch (pan)</span></label>
          <label class="chip"><input type="checkbox" data-field="safety.clearances"><span>Clearances OK</span></label>
          <label class="chip"><input type="checkbox" data-field="safety.disconnect"><span>Outdoor disconnect OK</span></label>
          <div class="heating-only">
            <label class="chip"><input type="checkbox" data-field="safety.rollout"><span>Rollout switch tested</span></label>
            <label class="chip"><input type="checkbox" data-field="safety.pressure"><span>Pressure switch tested</span></label>
            <label class="chip"><input type="checkbox" data-field="safety.highlimit"><span>High-limit switch tested</span></label>
            <label class="chip"><input type="checkbox" data-field="safety.flame"><span>Flame sensor OK</span></label>
            <label class="chip"><input type="checkbox" data-field="safety.ignition"><span>Ignition operation verified</span></label>
            <label class="chip"><input type="checkbox" data-field="safety.gasleaks"><span>No gas leaks detected</span></label>
            <label class="chip"><input type="checkbox" data-field="safety.venting"><span>Venting/flue intact</span></label>
          </div>
          <label class="chip"><input type="checkbox" data-field="safety.electrical"><span>Electrical connections tight & grounded</span></label>
        </div>
        <div class="input-group voice-input-wrapper" style="margin-top:8px">
          <label>Safety Notes</label>
          <textarea data-field="safety.notes" placeholder="Safety observations, venting, gas line, electrical, etc."></textarea>
          <button class="voice-btn" data-voice-for="safety.notes" style="top:40px" title="Voice input">🎤</button>
        </div>
        <div class="sop-status">
          <span class="muted" style="margin-right:8px">Status:</span>
          <span class="status-tag pass" data-sop="safety" data-value="pass">Pass</span>
          <span class="status-tag fail" data-sop="safety" data-value="fail">Fail</span>
          <span class="status-tag attention" data-sop="safety" data-value="attention">Needs Attention</span>
        </div>
      </details>

      <!-- Mechanical -->
      <details open>
        <summary>Mechanical</summary>
        <div class="grid-4">
          <div>
            <label>Return Air (F) <span class="help-icon" title="Temperature of air entering system">?</span></label>
            <input type="number" inputmode="decimal" step="0.1" data-field="mech.returnF" class="calc-delta calc-targets" placeholder="e.g., 75.0" data-validate="temp">
            <div class="field-hint">🎯 Normal: 68-78°F</div>
          </div>
          <div>
            <label>Supply Air (F) <span class="help-icon" title="Temperature of air leaving system">?</span></label>
            <input type="number" inputmode="decimal" step="0.1" data-field="mech.supplyF" class="calc-delta" placeholder="e.g., 55.0" data-validate="temp">
            <div class="field-hint cooling-only">🎯 Target: 55-60°F</div>
            <div class="field-hint heating-only">🎯 Target: 110-140°F</div>
          </div>
          <div class="cooling-only">
            <label>Temp Split (auto)</label>
            <input type="text" data-field="mech.deltaT" disabled>
            <div class="field-hint">🎯 Target: 16-22°F</div>
          </div>
          <div class="heating-only">
            <label>Temp Rise (auto)</label>
            <input type="text" data-field="mech.tempRise" disabled>
            <div class="field-hint">🎯 Target: 30-80°F</div>
          </div>
          <div class="input-group">
            <label>Filter Condition</label>
            <select data-field="mech.filter">
              <option value="">Select...</option>
              <option value="Clean">Clean</option>
              <option value="Dirty">Dirty</option>
              <option value="Overdue">Overdue</option>
              <option value="Replaced">Replaced</option>
            </select>
          </div>
        </div>

        <div class="grid-4" style="margin-top:8px">
          <div>
            <label>Return Static (in w.c.)</label>
            <input type="number" inputmode="decimal" step="0.01" data-field="mech.returnStatic" class="calc-static" placeholder="e.g., -0.15" data-validate="static">
            <div class="field-hint">🎯 Typical: -0.10 to -0.25</div>
          </div>
          <div>
            <label>Supply Static (in w.c.)</label>
            <input type="number" inputmode="decimal" step="0.01" data-field="mech.supplyStatic" class="calc-static" placeholder="e.g., 0.30" data-validate="static">
            <div class="field-hint">🎯 Typical: 0.20 to 0.40</div>
          </div>
          <div>
            <label>Total Static (auto)</label>
            <input type="text" data-field="mech.totalStatic" disabled>
            <div class="field-hint">🎯 Max: 0.50 in w.c.</div>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Airflow Notes</label>
            <input type="text" data-field="mech.airflowNotes" placeholder="Balance, restriction">
            <button class="voice-btn" data-voice-for="mech.airflowNotes" title="Voice input">🎤</button>
          </div>
        </div>

        <div class="cooling-only">
          <div class="target-indicator" data-target-pressure style="display:none"></div>
          <div class="grid-4" style="margin-top:8px">
            <div>
              <label>Suction Pressure (psig)</label>
              <input type="number" inputmode="decimal" step="0.1" data-field="mech.suction" class="calc-targets" placeholder="e.g., 118" data-validate="pressure-suction">
              <div class="field-hint">📊 Depends on refrigerant</div>
            </div>
            <div>
              <label>Head Pressure (psig)</label>
              <input type="number" inputmode="decimal" step="0.1" data-field="mech.head" placeholder="e.g., 250" data-validate="pressure-head">
              <div class="field-hint">🎯 Typical: 200-300 psig</div>
            </div>
            <div>
              <label>Superheat (F)</label>
              <input type="number" inputmode="decimal" step="0.1" data-field="mech.sh" placeholder="e.g., 10" data-validate="superheat">
              <div class="field-hint">🎯 TXV: 8-12°F | Fixed: 10-20°F</div>
            </div>
            <div>
              <label>Subcool (F)</label>
              <input type="number" inputmode="decimal" step="0.1" data-field="mech.sc" placeholder="e.g., 10" data-validate="subcool">
              <div class="field-hint">🎯 Target: 8-15°F</div>
            </div>
          </div>
        </div>

        <div class="heating-only">
          <div class="grid-4" style="margin-top:8px">
            <div class="input-group voice-input-wrapper">
              <label>Inducer Motor Amps</label>
              <input type="text" data-field="mech.inducerAmps" placeholder="e.g., 2.5/2.0">
              <button class="voice-btn" data-voice-for="mech.inducerAmps" title="Voice input">🎤</button>
              <div class="field-hint">Format: actual/rated</div>
            </div>
            <div>
              <label>Gas Input (BTU/hr)</label>
              <input type="number" inputmode="decimal" data-field="mech.gasInput" placeholder="e.g., 80000">
            </div>
            <div>
              <label>Manifold Pressure (in w.c.)</label>
              <input type="number" inputmode="decimal" step="0.1" data-field="mech.manifoldPressure" placeholder="e.g., 3.5">
              <div class="field-hint">🎯 Typical: 3.2-3.7</div>
            </div>
            <div></div>
          </div>
        </div>

        <div class="grid-4" style="margin-top:8px">
          <div class="input-group voice-input-wrapper">
            <label>Blower Amps (actual/rated)</label>
            <input type="text" data-field="mech.blowerAmps" placeholder="e.g., 5.8/5.0" data-validate="amps">
            <button class="voice-btn" data-voice-for="mech.blowerAmps" title="Voice input">🎤</button>
            <div class="field-hint">Format: actual/rated</div>
          </div>
          <div class="input-group voice-input-wrapper cooling-only">
            <label>Compressor Amps (actual/rated)</label>
            <input type="text" data-field="mech.compAmps" placeholder="e.g., 15.0/14.0" data-validate="amps">
            <button class="voice-btn" data-voice-for="mech.compAmps" title="Voice input">🎤</button>
            <div class="field-hint">Format: actual/rated</div>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Voltage L1-L2</label>
            <input type="text" data-field="mech.voltageL1L2" placeholder="e.g., 240" data-validate="voltage">
            <button class="voice-btn" data-voice-for="mech.voltageL1L2" title="Voice input">🎤</button>
            <div class="field-hint">🎯 Typical: 220-250V</div>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Capacitor µF (actual/rated)</label>
            <input type="text" data-field="mech.capacitor" placeholder="e.g., 42/45" data-validate="capacitor">
            <button class="voice-btn" data-voice-for="mech.capacitor" title="Voice input">🎤</button>
            <div class="field-hint">Format: actual/rated</div>
          </div>
        </div>

        <div class="grid-4" style="margin-top:8px">
          <div class="input-group voice-input-wrapper">
            <label>Voltage L1-N</label>
            <input type="text" data-field="mech.voltageL1N" placeholder="e.g., 120">
            <button class="voice-btn" data-voice-for="mech.voltageL1N" title="Voice input">🎤</button>
            <div class="field-hint">🎯 Typical: 110-125V</div>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Voltage L2-N</label>
            <input type="text" data-field="mech.voltageL2N" placeholder="e.g., 120">
            <button class="voice-btn" data-voice-for="mech.voltageL2N" title="Voice input">🎤</button>
            <div class="field-hint">🎯 Typical: 110-125V</div>
          </div>
          <div class="input-group">
            <label>Coil Condition</label>
            <select data-field="mech.coilCondition">
              <option value="">Select...</option>
              <option value="Clean">Clean</option>
              <option value="Lightly soiled">Lightly soiled</option>
              <option value="Restricted">Restricted</option>
              <option value="Corroded">Corroded</option>
              <option value="Leaking">Leaking</option>
            </select>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Electrical Notes</label>
            <input type="text" data-field="mech.electrical" placeholder="Capacitor, contactor">
            <button class="voice-btn" data-voice-for="mech.electrical" title="Voice input">🎤</button>
          </div>
        </div>
        
        <div class="input-group voice-input-wrapper" style="margin-top:8px">
          <label>Mechanical Notes</label>
          <textarea data-field="mech.notes" placeholder="Noise, vibration, overall condition"></textarea>
          <button class="voice-btn" data-voice-for="mech.notes" style="top:40px" title="Voice input">🎤</button>
        </div>
        <div class="sop-status">
          <span class="muted" style="margin-right:8px">Status:</span>
          <span class="status-tag sound" data-sop="mechanical" data-value="sound">Sound</span>
          <span class="status-tag stable" data-sop="mechanical" data-value="stable">Stable</span>
          <span class="status-tag service" data-sop="mechanical" data-value="service">Needs Service</span>
        </div>
      </details>

      <!-- Health -->
      <details open>
        <summary>Health</summary>
        <div>
          <label class="chip"><input type="checkbox" data-field="health.microbialLight"><span>Microbial (light)</span></label>
          <label class="chip"><input type="checkbox" data-field="health.microbialHeavy"><span>Microbial (heavy)</span></label>
          <label class="chip"><input type="checkbox" data-field="health.ductLeaks"><span>Duct/plenum leaks</span></label>
          <label class="chip"><input type="checkbox" data-field="health.filterOverdue"><span>Filter overdue</span></label>
          <label class="chip"><input type="checkbox" data-field="health.drainIssues"><span>Drain algae / slow flow</span></label>
          <label class="chip"><input type="checkbox" data-field="health.plenumsClean"><span>Supply/return plenums clean</span></label>
          <label class="chip"><input type="checkbox" data-field="health.insulationIntact"><span>Insulation intact</span></label>
          <label class="chip"><input type="checkbox" data-field="health.oxidationPresent"><span>Oxidation/rust present</span></label>
          <label class="chip"><input type="checkbox" data-field="health.waterDamage"><span>Water damage visible</span></label>
          <label class="chip"><input type="checkbox" data-field="health.uvPresent"><span>UV system present</span></label>
          <label class="chip"><input type="checkbox" data-field="health.uvOperational"><span>UV operational</span></label>
        </div>
        <div class="grid-2" style="margin-top:8px">
          <div class="input-group">
            <label>Filtration Upgrades</label>
            <select data-field="health.filtrationUpgrades">
              <option value="">None present</option>
              <option value="Media">Media filter</option>
              <option value="Electronic">Electronic filter</option>
              <option value="HEPA">HEPA filter</option>
              <option value="UV">UV light</option>
              <option value="Bipolar">Bipolar ionization</option>
            </select>
          </div>
          <div class="input-group voice-input-wrapper">
            <label>Odor Findings</label>
            <input type="text" data-field="health.odorFindings" placeholder="Musty, chemical, burning, etc.">
            <button class="voice-btn" data-voice-for="health.odorFindings" title="Voice input">🎤</button>
          </div>
        </div>
        <div class="input-group voice-input-wrapper" style="margin-top:8px">
          <label>Health Notes</label>
          <textarea data-field="health.notes" placeholder="Odors, contamination, plenum condition, insulation"></textarea>
          <button class="voice-btn" data-voice-for="health.notes" style="top:40px" title="Voice input">🎤</button>
        </div>
        <div class="sop-status">
          <span class="muted" style="margin-right:8px">Status:</span>
          <span class="status-tag clean" data-sop="health" data-value="clean">Clean</span>
          <span class="status-tag contaminated" data-sop="health" data-value="contaminated">Contaminated</span>
          <span class="status-tag remediation" data-sop="health" data-value="remediation">Needs Remediation</span>
        </div>
      </details>

      <!-- Scores -->
      <div class="score-box" style="margin-top:10px">
        <div class="grid-4">
          <div><span class="muted">Safety</span><div class="score" data-score="safety">–</div></div>
          <div><span class="muted">Mechanical</span><div class="score" data-score="mechanical">–</div></div>
          <div><span class="muted">Health</span><div class="score" data-score="health">–</div></div>
          <div><span class="muted">Overall / Confidence</span><div class="score" data-score="overall">–</div><div class="notice">Conf: <span data-score="confidence">–</span>%</div></div>
        </div>
      </div>
    </section>
  </template>

  <script>
    // ========================================
    // UTILITIES & CONSTANTS
    // ========================================
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
    const toNum = v => { const n = parseFloat(v); return isNaN(n) ? null : n; };
    const isTrue = v => v===true || v==='on' || v===1 || v==='1';
    const sanitize = str => String(str).replace(/[<>]/g, '');
    
    // Refrigerant PT Charts (Pressure-Temperature)
    const PT_CHARTS = {
      'R-410A': { 50:102, 55:113, 60:125, 65:138, 70:151, 75:165, 80:180, 85:196, 90:213, 95:231 },
      'R-22': { 50:84, 55:93, 60:102, 65:112, 70:122, 75:133, 80:145, 85:157, 90:171, 95:185 },
      'R-32': { 50:119, 55:132, 60:145, 65:160, 70:175, 75:191, 80:208, 85:226, 90:246, 95:266 },
      'R-454B': { 50:99, 55:110, 60:121, 65:133, 70:146, 75:160, 80:175, 85:190, 90:207, 95:225 }
    };

    // ========================================
    // STATE MANAGEMENT
    // ========================================
    let sysCount = 0;
    let dirty = false;
    let saveTimeout;
    
    const AppState = {
      systems: new Map(),
      photos: new Map(),
      notes: new Map()
    };

    // ========================================
    // INITIALIZATION
    // ========================================
    function init() {
      $('#inspectionDate').valueAsDate = new Date();
      const savedTech = localStorage.getItem('technicianName');
      $('#technicianName').value = savedTech || 'M. Perez';
      
      // Remember technician name
      $('#technicianName').addEventListener('change', (e) => {
        localStorage.setItem('technicianName', e.target.value);
      });
      
      addSystem();
      wireGlobalEvents();
      initVoiceRecognition();
    }

    // ========================================
    // VOICE RECOGNITION
    // ========================================
    let recognition = null;
    let currentVoiceTarget = null;

    function initVoiceRecognition() {
      if(!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) return;
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (e) => {
        if(e.results.length > 0 && currentVoiceTarget){
          const transcript = e.results[0][0].transcript;
          if(currentVoiceTarget.tagName === 'TEXTAREA'){
            currentVoiceTarget.value = (currentVoiceTarget.value ? currentVoiceTarget.value + ' ' : '') + transcript;
          } else {
            currentVoiceTarget.value = transcript;
          }
          currentVoiceTarget.dispatchEvent(new Event('input', {bubbles: true}));
          markDirty();
          showToast('Voice input captured', 'success');
        }
      };

      recognition.onend = () => {
        $$('.voice-btn.listening').forEach(btn => btn.classList.remove('listening'));
      };

      recognition.onerror = (e) => {
        $$('.voice-btn.listening').forEach(btn => btn.classList.remove('listening'));
        if(e.error !== 'no-speech' && e.error !== 'aborted'){
          showToast('Voice input error: ' + e.error, 'error');
        }
      };
    }

    function startVoiceInput(btn) {
      if(!recognition) {
        showToast('Voice input not supported on this device', 'error');
        return;
      }

      const fieldName = btn.getAttribute('data-voice-for');
      const container = btn.closest('[data-system]') || btn.closest('#jobHeader');
      let targetInput = null;

      if(fieldName.includes('.')) {
        targetInput = $(`[data-field="${fieldName}"]`, container);
      } else {
        targetInput = $(`#${fieldName}`, container);
      }

      if(!targetInput) return;

      currentVoiceTarget = targetInput;
      btn.classList.add('listening');
      
      try {
        recognition.start();
      } catch(e) {
        btn.classList.remove('listening');
        showToast('Could not start voice recognition', 'error');
      }
    }

    // ========================================
    // SYSTEM MANAGEMENT
    // ========================================
    function addSystem() {
      const tpl = $('#systemTemplate').content.cloneNode(true);
      sysCount += 1;
      const sysId = 'sys_' + Date.now();
      
      tpl.querySelector('[data-sysname]').textContent = '#' + sysCount;
      const section = tpl.querySelector('[data-system]');
      section.classList.add('mode-cooling');
      section.dataset.systemId = sysId;
      section.dataset.mode = 'cooling';
      
      AppState.systems.set(sysId, {});
      AppState.photos.set(sysId, []);
      AppState.notes.set(sysId, []);
      
      // Wire buttons
      tpl.querySelector('.btnRemove').addEventListener('click', () => {
        if(confirm('Remove this system?')) {
          AppState.systems.delete(sysId);
          AppState.photos.delete(sysId);
          AppState.notes.delete(sysId);
          section.remove();
          markDirty();
        }
      });
      
      tpl.querySelector('.btnToggle').addEventListener('click', () => {
        const details = $$('details', section);
        const anyOpen = details.some(d => d.open);
        details.forEach(d => d.open = !anyOpen);
      });
      
      // Mode toggle
      const modeBtns = $$('.mode-btn', tpl);
      modeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const mode = btn.getAttribute('data-mode');
          modeBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          section.classList.remove('mode-cooling', 'mode-heating');
          section.classList.add(`mode-${mode}`);
          section.dataset.mode = mode;
          markDirty();
          updateCalculations(section);
          updateTargetPressure(section);
        });
      });
      
      // SOP status tags
      $$('.status-tag', tpl).forEach(tag => {
        tag.addEventListener('click', () => {
          const sop = tag.getAttribute('data-sop');
          const value = tag.getAttribute('data-value');
          const siblings = $$(`[data-sop="${sop}"]`, section);
          siblings.forEach(s => s.classList.remove('pass','fail','attention','sound','stable','service','clean','contaminated','remediation'));
          tag.classList.add(value);
          section.dataset[`sop${sop.charAt(0).toUpperCase() + sop.slice(1)}`] = value;
          markDirty();
        });
      });
      
      // Photo handling
      const photoInput = $('.photo-input', tpl);
      const btnAddPhoto = $('.btn-add-photo', tpl);
      btnAddPhoto.addEventListener('click', () => photoInput.click());
      photoInput.addEventListener('change', (e) => handlePhotoUpload(section, e.target.files));
      
      // Quick notes
      $('.btn-quick-note', tpl).addEventListener('click', () => addQuickNote(section, false));
      $('.btn-flag-issue', tpl).addEventListener('click', () => addQuickNote(section, true));
      
      // Wire calculations
      $$('.calc-delta', tpl).forEach(el => el.addEventListener('input', () => updateCalculations(section)));
      $$('.calc-static', tpl).forEach(el => el.addEventListener('input', () => updateCalculations(section)));
      $$('.calc-age', tpl).forEach(el => el.addEventListener('change', () => updateAge(section)));
      $$('.calc-targets', tpl).forEach(el => el.addEventListener('input', () => updateTargetPressure(section)));
      
      // Wire validation
      $$('[data-validate]', tpl).forEach(el => {
        el.addEventListener('input', () => validateField(el));
        el.addEventListener('blur', () => validateField(el));
      });
      
      $('#systems').appendChild(tpl);
      updateProgress(section);
      markDirty();
    }

    // ========================================
    // PHOTO MANAGEMENT
    // ========================================
    async function handlePhotoUpload(card, files) {
      if(!files || files.length === 0) return;
      
      const sysId = card.dataset.systemId;
      const photos = AppState.photos.get(sysId);
      
      for(let file of Array.from(files)) {
        try {
          const compressed = await compressImage(file, 1200, 0.85);
          const photo = {
            id: 'photo_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            data: compressed,
            timestamp: new Date().toISOString(),
            name: file.name
          };
          photos.push(photo);
        } catch(e) {
          showToast('Error processing photo: ' + file.name, 'error');
        }
      }
      
      AppState.photos.set(sysId, photos);
      renderPhotos(card);
      markDirty();
      showToast(`${files.length} photo(s) added`, 'success');
    }

    function compressImage(file, maxWidth, quality) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            if(w > maxWidth) {
              h = (h * maxWidth) / w;
              w = maxWidth;
            }
            canvas.width = w;
            canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function renderPhotos(card) {
      const sysId = card.dataset.systemId;
      const photos = AppState.photos.get(sysId) || [];
      const grid = $('.photo-grid', card);
      const countEl = $('.photo-count', card);
      
      countEl.textContent = photos.length;
      grid.innerHTML = '';
      
      photos.forEach(photo => {
        const item = document.createElement('div');
        item.className = 'photo-item';
        item.innerHTML = `
          <img src="${photo.data}" alt="Photo" title="${photo.name}">
          <button class="photo-delete" data-photo-id="${photo.id}">×</button>
        `;
        
        item.querySelector('img').addEventListener('click', () => showPhotoModal(photo.data));
        item.querySelector('.photo-delete').addEventListener('click', (e) => {
          e.stopPropagation();
          deletePhoto(card, photo.id);
        });
        
        grid.appendChild(item);
      });
      
      // Add upload button
      const addBtn = document.createElement('div');
      addBtn.className = 'photo-add';
      addBtn.textContent = '+';
      addBtn.addEventListener('click', () => $('.photo-input', card).click());
      grid.appendChild(addBtn);
    }

    function deletePhoto(card, photoId) {
      const sysId = card.dataset.systemId;
      const photos = AppState.photos.get(sysId).filter(p => p.id !== photoId);
      AppState.photos.set(sysId, photos);
      renderPhotos(card);
      markDirty();
    }

    function showPhotoModal(dataUrl) {
      const modal = $('#photoModal');
      $('#photoModalImg').src = dataUrl;
      modal.style.display = 'flex';
    }

    // ========================================
    // QUICK NOTES
    // ========================================
    function addQuickNote(card, isFlag) {
      const text = prompt(isFlag ? 'Describe the issue:' : 'Quick note:');
      if(!text) return;
      
      const sysId = card.dataset.systemId;
      const notes = AppState.notes.get(sysId);
      
      const note = {
        id: 'note_' + Date.now(),
        text: sanitize(text),
        timestamp: new Date().toISOString(),
        isFlag
      };
      
      notes.push(note);
      AppState.notes.set(sysId, notes);
      renderNotes(card);
      markDirty();
    }

    function renderNotes(card) {
      const sysId = card.dataset.systemId;
      const notes = AppState.notes.get(sysId) || [];
      const container = $('.quick-notes', card);
      
      container.innerHTML = '';
      notes.forEach(note => {
        const item = document.createElement('div');
        item.className = 'note-item' + (note.isFlag ? ' flag' : '');
        const time = new Date(note.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        item.innerHTML = `
          <span>${note.isFlag ? '🚩' : '💬'}</span>
          <div style="flex:1">
            <div>${note.text}</div>
            <div class="note-time">${time}</div>
          </div>
          <button class="note-delete" data-note-id="${note.id}">×</button>
        `;
        
        item.querySelector('.note-delete').addEventListener('click', () => {
          const filtered = AppState.notes.get(sysId).filter(n => n.id !== note.id);
          AppState.notes.set(sysId, filtered);
          renderNotes(card);
          markDirty();
        });
        
        container.appendChild(item);
      });
    }

    // ========================================
    // CALCULATIONS
    // ========================================
    function updateCalculations(card) {
      const r = toNum($('[data-field="mech.returnF"]', card)?.value);
      const s = toNum($('[data-field="mech.supplyF"]', card)?.value);
      const mode = card.dataset.mode || 'cooling';
      
      // Temperature delta/rise
      if(mode === 'cooling') {
        const out = $('[data-field="mech.deltaT"]', card);
        if(out && r!=null && s!=null) {
          const v = (r - s).toFixed(1);
          out.value = v;
          card.dataset.deltaT = v;
          
          // Validation
          const val = parseFloat(v);
          if(val < 16 || val > 22) {
            out.classList.add('input-warning');
          } else {
            out.classList.add('input-success');
          }
        }
      } else {
        const out = $('[data-field="mech.tempRise"]', card);
        if(out && r!=null && s!=null) {
          const v = (s - r).toFixed(1);
          out.value = v;
          card.dataset.tempRise = v;
          
          // Validation
          const val = parseFloat(v);
          if(val < 30 || val > 80) {
            out.classList.add('input-warning');
          } else {
            out.classList.add('input-success');
          }
        }
      }
      
      // Static pressure
      const rs = toNum($('[data-field="mech.returnStatic"]', card)?.value);
      const ss = toNum($('[data-field="mech.supplyStatic"]', card)?.value);
      const out = $('[data-field="mech.totalStatic"]', card);
      if(rs!=null && ss!=null) {
        const v = (Math.abs(rs) + Math.abs(ss)).toFixed(2);
        out.value = v;
        card.dataset.totalStatic = v;
        
        // Validation
        const val = parseFloat(v);
        if(val > 0.50) {
          out.classList.add('input-error');
        } else if(val > 0.45) {
          out.classList.add('input-warning');
        } else {
          out.classList.add('input-success');
        }
      }
      
      updateProgress(card);
    }

    function updateAge(card) {
      const mfgDate = $('[data-field="meta.mfgDate"]', card)?.value;
      const ageField = $('[data-field="meta.age"]', card);
      if(mfgDate && ageField) {
        const mfg = new Date(mfgDate);
        const now = new Date();
        const age = ((now - mfg) / (365.25 * 24 * 60 * 60 * 1000)).toFixed(1);
        ageField.value = age;
        markDirty();
      }
    }

    function updateTargetPressure(card) {
      const refrig = $('[data-field="meta.refrigerant"]', card)?.value;
      const returnF = toNum($('[data-field="mech.returnF"]', card)?.value);
      const indicator = $('[data-target-pressure]', card);
      
      if(!refrig || !returnF || !PT_CHARTS[refrig]) {
        indicator.style.display = 'none';
        return;
      }
      
      const target = calcTargetPressure(refrig, returnF);
      const suction = toNum($('[data-field="mech.suction"]', card)?.value);
      
      indicator.style.display = 'flex';
      indicator.className = 'target-indicator';
      
      if(!suction) {
        indicator.textContent = `🎯 Target suction pressure: ~${target} psig (based on ${returnF}°F return)`;
        indicator.classList.add('info');
      } else {
        const diff = Math.abs(suction - target);
        const pct = (diff / target) * 100;
        
        if(pct <= 5) {
          indicator.classList.add('good');
          indicator.textContent = `✓ Suction pressure looks good (${suction} psig vs target ${target} psig)`;
        } else if(pct <= 15) {
          indicator.classList.add('warn');
          indicator.textContent = `⚠️ Suction pressure slightly off (${suction} psig vs target ${target} psig)`;
        } else {
          indicator.classList.add('bad');
          indicator.textContent = `❌ Suction pressure significantly off (${suction} psig vs target ${target} psig) - check charge`;
        }
      }
    }

    function calcTargetPressure(refrigerant, returnTemp) {
      const chart = PT_CHARTS[refrigerant];
      if(!chart) return null;
      
      const temps = Object.keys(chart).map(Number).sort((a,b) => a-b);
      
      // Exact match
      if(chart[returnTemp]) return chart[returnTemp];
      
      // Find bounding temps
      let lower = null, upper = null;
      for(let t of temps) {
        if(t <= returnTemp) lower = t;
        if(t >= returnTemp && !upper) upper = t;
      }
      
      if(!lower) return chart[upper];
      if(!upper) return chart[lower];
      
      // Linear interpolation
      const ratio = (returnTemp - lower) / (upper - lower);
      return Math.round(chart[lower] + (chart[upper] - chart[lower]) * ratio);
    }

    // ========================================
    // FIELD VALIDATION
    // ========================================
    function validateField(input) {
      const type = input.getAttribute('data-validate');
      const value = input.value.trim();
      
      input.classList.remove('input-error', 'input-warning', 'input-success');
      
      if(!value) return;
      
      const val = toNum(value);
      
      switch(type) {
        case 'temp':
          if(val < 30 || val > 150) {
            input.classList.add('input-error');
          } else if(val < 40 || val > 95) {
            input.classList.add('input-warning');
          } else {
            input.classList.add('input-success');
          }
          break;
          
        case 'static':
          if(Math.abs(val) > 1.0) {
            input.classList.add('input-error');
          } else if(Math.abs(val) > 0.6) {
            input.classList.add('input-warning');
          } else {
            input.classList.add('input-success');
          }
          break;
          
        case 'pressure-suction':
          if(val < 0 || val > 200) {
            input.classList.add('input-error');
          } else {
            input.classList.add('input-success');
          }
          break;
          
        case 'pressure-head':
          if(val < 0 || val > 600) {
            input.classList.add('input-error');
          } else if(val < 150 || val > 400) {
            input.classList.add('input-warning');
          } else {
            input.classList.add('input-success');
          }
          break;
          
        case 'superheat':
          if(val < 0 || val > 50) {
            input.classList.add('input-error');
          } else if(val < 5 || val > 25) {
            input.classList.add('input-warning');
          } else {
            input.classList.add('input-success');
          }
          break;
          
        case 'subcool':
          if(val < 0 || val > 30) {
            input.classList.add('input-error');
          } else if(val < 5 || val > 20) {
            input.classList.add('input-warning');
          } else {
            input.classList.add('input-success');
          }
          break;
          
        case 'amps':
          if(value.includes('/')) {
            const [actual, rated] = value.split('/').map(v => parseFloat(v));
            if(isNaN(actual) || isNaN(rated)) {
              input.classList.add('input-error');
            } else {
              const diff = ((actual - rated) / rated) * 100;
              if(Math.abs(diff) > 20) {
                input.classList.add('input-error');
              } else if(Math.abs(diff) > 10) {
                input.classList.add('input-warning');
              } else {
                input.classList.add('input-success');
              }
            }
          }
          break;
          
        case 'capacitor':
          if(value.includes('/')) {
            const [actual, rated] = value.split('/').map(v => parseFloat(v));
            if(isNaN(actual) || isNaN(rated)) {
              input.classList.add('input-error');
            } else {
              const diff = ((actual - rated) / rated) * 100;
              if(Math.abs(diff) > 10) {
                input.classList.add('input-warning');
              } else if(Math.abs(diff) > 6) {
                input.classList.add('input-success');
              } else {
                input.classList.add('input-success');
              }
            }
          }
          break;
          
        case 'voltage':
          if(val < 100 || val > 270) {
            input.classList.add('input-error');
          } else if((val >= 200 && (val < 210 || val > 250)) || (val < 200 && (val < 105 || val > 130))) {
            input.classList.add('input-warning');
          } else {
            input.classList.add('input-success');
          }
          break;
      }
    }

    // ========================================
    // PROGRESS TRACKING
    // ========================================
    function updateProgress(card) {
      const fields = $$('[data-field]', card);
      const filled = fields.filter(f => {
        if(f.type === 'checkbox') return f.checked;
        return f.value && f.value.trim() !== '';
      }).length;
      
      const pct = Math.round((filled / fields.length) * 100);
      const progressFill = $('[data-progress]', card);
      const badge = $('[data-completion]', card);
      const percentEl = $('[data-percent]', card);
      
      progressFill.style.width = pct + '%';
      if(pct === 100) progressFill.classList.add('complete');
      
      if(pct >= 50) {
        badge.style.display = 'inline-flex';
        percentEl.textContent = pct;
      } else {
        badge.style.display = 'none';
      }
    }

    // ========================================
    // SCORING
    // ========================================
    const RULES = {
      safety: [
        { when:c=>!isTrue(c['safety.coDetector']), delta:-1, reason:'CO detector not recorded' },
        { when:c=>!isTrue(c['safety.floatPrimary'])||!isTrue(c['safety.floatPan']), delta:-1, reason:'Missing float switch' },
        { when:c=>!isTrue(c['safety.clearances']), delta:-1, reason:'Clearances not verified' },
        { when:c=>!isTrue(c['safety.disconnect']), delta:-1, reason:'Outdoor disconnect not verified' },
        { when:c=>c.mode==='heating'&&!isTrue(c['safety.rollout']), delta:-1, reason:'Rollout switch not tested' },
        { when:c=>c.mode==='heating'&&!isTrue(c['safety.pressure']), delta:-1, reason:'Pressure switch not tested' },
        { when:c=>c.mode==='heating'&&!isTrue(c['safety.highlimit']), delta:-1, reason:'High-limit switch not tested' },
        { when:c=>c.mode==='heating'&&!isTrue(c['safety.flame']), delta:-1, reason:'Flame sensor not verified' },
        { when:c=>c.mode==='heating'&&!isTrue(c['safety.ignition']), delta:-1, reason:'Ignition not verified' },
        { when:c=>c.mode==='heating'&&!isTrue(c['safety.gasleaks']), delta:-2, reason:'Gas leak check not performed' },
        { when:c=>c.mode==='heating'&&!isTrue(c['safety.venting']), delta:-2, reason:'Venting not verified' },
        { when:c=>!isTrue(c['safety.electrical']), delta:-1, reason:'Electrical connections not verified' }
      ],
      mechanical: [
        { when:c=>c.mode==='cooling'&&numLT(c.deltaT,16), delta:-1, reason:'Low temperature split (<16 F)' },
        { when:c=>c.mode==='cooling'&&numGT(c.deltaT,22), delta:-1, reason:'High temperature split (>22 F)' },
        { when:c=>c.mode==='heating'&&numLT(c.tempRise,30), delta:-1, reason:'Low temperature rise (<30 F)' },
        { when:c=>c.mode==='heating'&&numGT(c.tempRise,80), delta:-1, reason:'High temperature rise (>80 F)' },
        { when:c=>numGT(c.totalStatic,0.50), delta:-2, reason:'High total static (>0.50 in w.c.)' },
        { when:c=>relAmpHigh(c['mech.blowerAmps']), delta:-1, reason:'Blower amps elevated' },
        { when:c=>c.mode==='cooling'&&relAmpHigh(c['mech.compAmps']), delta:-1, reason:'Compressor amps elevated' },
        { when:c=>c.mode==='heating'&&relAmpHigh(c['mech.inducerAmps']), delta:-1, reason:'Inducer amps elevated' },
        { when:c=>txtFind(c['mech.coilCondition'],'corroded|leaking'), delta:-2, reason:'Coil compromised' },
        { when:c=>txtFind(c['mech.notes'],'vibration|grind|hard start|overheat'), delta:-1, reason:'Mechanical noise/start stress' }
      ],
      health: [
        { when:c=>isTrue(c['health.microbialLight']), delta:-2, reason:'Microbial presence (light)' },
        { when:c=>isTrue(c['health.microbialHeavy']), delta:-4, reason:'Microbial presence (heavy)' },
        { when:c=>isTrue(c['health.ductLeaks']), delta:-2, reason:'Duct/plenum leaks' },
        { when:c=>isTrue(c['health.filterOverdue']), delta:-1, reason:'Filter overdue' },
        { when:c=>isTrue(c['health.drainIssues']), delta:-1, reason:'Drain cleanliness issues' },
        { when:c=>!isTrue(c['health.plenumsClean']), delta:-1, reason:'Plenums contaminated' },
        { when:c=>!isTrue(c['health.insulationIntact']), delta:-1, reason:'Insulation compromised' },
        { when:c=>isTrue(c['health.oxidationPresent']), delta:-1, reason:'Rust/oxidation present' },
        { when:c=>isTrue(c['health.waterDamage']), delta:-2, reason:'Water damage visible' }
      ]
    };

    const numLT = (v,t) => { const n=toNum(v); return n!=null && n<t; };
    const numGT = (v,t) => { const n=toNum(v); return n!=null && n>t; };
    const txtFind = (s,re) => { if(!s) return false; return new RegExp(re,'i').test(s); };
    const relAmpHigh = (s) => {
      if(!s) return false;
      const p = s.split('/').map(x=>parseFloat(x));
      if(p.length<2 || isNaN(p[0]) || isNaN(p[1])) return false;
      return (p[0]-p[1])/p[1] > 0.15;
    };

    function collectCardData(card) {
      const data = {};
      $$('[data-field]', card).forEach(el => {
        const key = el.getAttribute('data-field');
        data[key] = (el.type === 'checkbox') ? el.checked : el.value;
      });
      data.deltaT = card.dataset.deltaT || data['mech.deltaT'];
      data.tempRise = card.dataset.tempRise || data['mech.tempRise'];
      data.totalStatic = card.dataset.totalStatic || data['mech.totalStatic'];
      data.mode = card.dataset.mode || 'cooling';
      data.sopSafety = card.dataset.sopSafety || '';
      data.sopMechanical = card.dataset.sopMechanical || '';
      data.sopHealth = card.dataset.sopHealth || '';
      return data;
    }

    function writeScore(card, key, val) {
      const el = $(`[data-score="${key}"]`, card);
      el.textContent = val;
      el.classList.remove('good','warn','bad');
      if(val >= 8) el.classList.add('good');
      else if(val >= 5) el.classList.add('warn');
      else el.classList.add('bad');
    }

    function scoreCard(card) {
      const c = collectCardData(card);
      const out = { safety:10, mechanical:10, health:10, reasons:{safety:[],mechanical:[],health:[]} };

      for(const r of RULES.safety) { if(r.when(c)) { out.safety+=r.delta; out.reasons.safety.push(r.reason); } }
      for(const r of RULES.mechanical) { if(r.when(c)) { out.mechanical+=r.delta; out.reasons.mechanical.push(r.reason); } }
      for(const r of RULES.health) { if(r.when(c)) { out.health+=r.delta; out.reasons.health.push(r.reason); } }

      out.safety = clamp(out.safety, 1, 10);
      out.mechanical = clamp(out.mechanical, 1, 10);
      out.health = clamp(out.health, 1, 10);
      
      const req = ['mech.returnF','mech.supplyF','mech.returnStatic','mech.supplyStatic','mech.blowerAmps'];
      if(c.mode === 'cooling') req.push('mech.compAmps');
      const present = req.filter(k => c[k] && String(c[k]).trim() !== '').length;
      out.confidence = Math.round((present/req.length)*100);
      out.overall = Math.round((out.safety + out.mechanical + out.health) / 3);

      writeScore(card, 'safety', out.safety);
      writeScore(card, 'mechanical', out.mechanical);
      writeScore(card, 'health', out.health);
      $('[data-score="overall"]', card).textContent = out.overall;
      $('[data-score="confidence"]', card).textContent = out.confidence;

      card.dataset.scoreReasons = JSON.stringify(out.reasons);
      return out;
    }

    function recommendFromScores(s) {
      const rec = { immediate:[], corrective:[], preventive:[] };
      
      if(s.scores.safety <= 7) {
        if(!isTrue(s.data['safety.floatPrimary'])||!isTrue(s.data['safety.floatPan']))
          rec.immediate.push('Install primary and pan float switches');
        if(!isTrue(s.data['safety.coDetector']))
          rec.immediate.push('Add CO detector near combustion appliance');
        if(s.data.mode==='heating'&&!isTrue(s.data['safety.gasleaks']))
          rec.immediate.push('Perform gas leak check immediately');
        if(s.data.mode==='heating'&&!isTrue(s.data['safety.venting']))
          rec.immediate.push('Verify venting integrity');
      }
      
      if(s.scores.mechanical <= 7) {
        if(numGT(s.meta.totalStatic, 0.50))
          rec.corrective.push('Seal/adjust ductwork and plenum to reduce total static pressure');
        if(relAmpHigh(s.data['mech.compAmps']))
          rec.preventive.push('Add soft start to reduce compressor inrush stress');
        if(relAmpHigh(s.data['mech.blowerAmps']))
          rec.corrective.push('Investigate airflow restriction or blower condition');
        if(txtFind(s.data['mech.coilCondition'], 'leaking'))
          rec.immediate.push('Replace leaking coil');
        if(txtFind(s.data['mech.coilCondition'], 'corroded'))
          rec.corrective.push('Replace corroded coil');
      }
      
      if(s.scores.health <= 8) {
        if(isTrue(s.data['health.microbialHeavy']))
          rec.corrective.push('Replace contaminated plenum/components and apply remediation');
        else if(isTrue(s.data['health.microbialLight']))
          rec.corrective.push('Clean and sanitize coil/plenum surfaces; install UV for prevention');
        if(isTrue(s.data['health.ductLeaks']))
          rec.corrective.push('Seal plenum/collar leaks with mastic and fasteners');
        if(isTrue(s.data['health.filterOverdue']))
          rec.preventive.push('Install media filter cabinet and set filter schedule');
        if(isTrue(s.data['health.drainIssues']))
          rec.corrective.push('Clean and re-trap condensate line; verify slope');
        if(isTrue(s.data['health.waterDamage']))
          rec.immediate.push('Address water damage source and remediate affected areas');
        if(!s.data['health.filtrationUpgrades'] || s.data['health.filtrationUpgrades']==='')
          rec.preventive.push('Consider filtration upgrades for improved air quality');
      }
      
      return rec;
    }

    // ========================================
    // REPORT GENERATION
    // ========================================
    function buildReports() {
      const systems = [];
      $$('[data-system]').forEach(card => {
        const data = collectCardData(card);
        const scores = scoreCard(card);
        const reasons = JSON.parse(card.dataset.scoreReasons || '{"safety":[],"mechanical":[],"health":[]}');
        const meta = {
          zone: data['meta.zone'] || 'Zone',
          brandModel: data['meta.brandModel'] || 'Brand/Model',
          refrigerant: data['meta.refrigerant'] || '',
          systemType: data['meta.systemType'] || '',
          mode: data.mode || 'cooling',
          deltaT: data.deltaT || data['mech.deltaT'] || '',
          tempRise: data.tempRise || data['mech.tempRise'] || '',
          totalStatic: data.totalStatic || data['mech.totalStatic'] || ''
        };
        const recs = recommendFromScores({data, scores, reasons, meta});
        
        // Include photos and notes
        const sysId = card.dataset.systemId;
        const photos = AppState.photos.get(sysId) || [];
        const notes = AppState.notes.get(sysId) || [];
        
        systems.push({data, scores, reasons, meta, recs, photos: photos.length, notes});
      });

      const ctx = {
        customer: $('#customerName')?.value || '',
        date: $('#inspectionDate')?.value || '',
        tech: $('#technicianName')?.value || '',
        address: $('#address')?.value || '',
        ambientF: $('#ambientF')?.value || '',
        ambientRH: $('#ambientRH')?.value || '',
        systems
      };

      const {customerText, officeText} = synthesizeReports(ctx);
      $('#customerSummary').textContent = customerText;
      $('#officeSummary').textContent = officeText;
      $('#reportsCard').style.display = 'block';
      
      setTimeout(() => {
        window.scrollTo({ top: $('#reportsCard').offsetTop - 80, behavior: 'smooth' });
      }, 100);
      
      showToast('Reports generated successfully', 'success');
    }

    function synthesizeReports(ctx) {
      const c = [];
      c.push(`HVAC INSPECTION SUMMARY`);
      c.push(`Customer: ${ctx.customer}`);
      if(ctx.address) c.push(`Address: ${ctx.address}`);
      c.push(`Date: ${ctx.date}    Technician: ${ctx.tech}`);
      if(ctx.ambientF||ctx.ambientRH) c.push(`Ambient: ${ctx.ambientF||'-'} F, ${ctx.ambientRH||'-'} % RH`);
      c.push('');
      
      ctx.systems.forEach((s,i) => {
        c.push(`System ${i+1} — ${s.meta.zone} (${s.meta.brandModel}) [${s.meta.mode.toUpperCase()} MODE]`);
        if(s.meta.systemType) c.push(`Type: ${s.meta.systemType}`);
        if(s.meta.mode==='cooling' && s.meta.refrigerant) c.push(`Refrigerant: ${s.meta.refrigerant}`);
        if(s.meta.mode==='cooling') c.push(`Performance: Temperature split ${s.meta.deltaT||'-'} F, Total static ${s.meta.totalStatic||'-'} in w.c.`);
        else c.push(`Performance: Temperature rise ${s.meta.tempRise||'-'} F, Total static ${s.meta.totalStatic||'-'} in w.c.`);
        c.push(`Scores: Safety ${s.scores.safety}/10, Mechanical ${s.scores.mechanical}/10, Health ${s.scores.health}/10, Overall ${s.scores.overall}/10, Confidence ${s.scores.confidence}%`);
        if(s.data.sopSafety || s.data.sopMechanical || s.data.sopHealth) {
          c.push(`SOP Status: Safety: ${s.data.sopSafety||'not set'} | Mechanical: ${s.data.sopMechanical||'not set'} | Health: ${s.data.sopHealth||'not set'}`);
        }
        if(s.photos > 0) c.push(`📸 Photos: ${s.photos} attached`);
        if(s.notes.length > 0) {
          c.push(`Notes & Flags:`);
          s.notes.forEach(n => c.push(`  ${n.isFlag ? '🚩' : '💬'} ${n.text}`));
        }
        if(s.recs.immediate.length||s.recs.corrective.length||s.recs.preventive.length) {
          c.push(`Recommendations:`);
          if(s.recs.immediate.length) c.push(`  ⚠️ IMMEDIATE: ${s.recs.immediate.join('; ')}`);
          if(s.recs.corrective.length) c.push(`  🔧 CORRECTIVE: ${s.recs.corrective.join('; ')}`);
          if(s.recs.preventive.length) c.push(`  🛡️ PREVENTIVE: ${s.recs.preventive.join('; ')}`);
        }
        c.push('');
      });

      const o = [];
      o.push(`BACK OFFICE TECHNICAL SUMMARY`);
      o.push(`Customer: ${ctx.customer}    Date: ${ctx.date}    Technician: ${ctx.tech}`);
      if(ctx.address) o.push(`Address: ${ctx.address}`);
      if(ctx.ambientF||ctx.ambientRH) o.push(`Ambient: ${ctx.ambientF||'-'} F, ${ctx.ambientRH||'-'} % RH`);
      o.push('');
      
      ctx.systems.forEach((s,i) => {
        o.push(`SYSTEM ${i+1}: ${s.meta.zone} (${s.meta.brandModel}) [${s.meta.mode.toUpperCase()} MODE]`);
        o.push(`  Identity: Type ${s.meta.systemType||'-'}   Refrig ${s.meta.refrigerant||'-'}   Age ${s.data['meta.age']||'-'} yrs`);
        o.push(`            Indoor ${s.data['meta.indoorMS']||'-'}   Outdoor ${s.data['meta.outdoorMS']||'-'}`);
        
        if(s.meta.mode === 'cooling') {
          o.push(`  Air Temps: Return ${s.data['mech.returnF']||'-'} F   Supply ${s.data['mech.supplyF']||'-'} F   Split ${s.meta.deltaT||'-'} F`);
        } else {
          o.push(`  Air Temps: Return ${s.data['mech.returnF']||'-'} F   Supply ${s.data['mech.supplyF']||'-'} F   Rise ${s.meta.tempRise||'-'} F`);
        }
        
        o.push(`  Static: Return ${s.data['mech.returnStatic']||'-'}   Supply ${s.data['mech.supplyStatic']||'-'}   Total ${s.meta.totalStatic||'-'} in w.c.`);
        
        if(s.meta.mode === 'cooling') {
          o.push(`  Refrig: Suction ${s.data['mech.suction']||'-'} psig   Head ${s.data['mech.head']||'-'} psig   SH ${s.data['mech.sh']||'-'} F   SC ${s.data['mech.sc']||'-'} F`);
          o.push(`  Amps:   Blower ${s.data['mech.blowerAmps']||'-'}   Compressor ${s.data['mech.compAmps']||'-'}`);
        } else {
          o.push(`  Heating: Inducer ${s.data['mech.inducerAmps']||'-'} A   Gas Input ${s.data['mech.gasInput']||'-'} BTU/hr   Manifold ${s.data['mech.manifoldPressure']||'-'} in w.c.`);
          o.push(`  Amps:   Blower ${s.data['mech.blowerAmps']||'-'}   Inducer ${s.data['mech.inducerAmps']||'-'}`);
        }
        
        o.push(`  Voltage: L1-L2 ${s.data['mech.voltageL1L2']||'-'} V   L1-N ${s.data['mech.voltageL1N']||'-'} V   L2-N ${s.data['mech.voltageL2N']||'-'} V`);
        o.push(`  Capacitor: ${s.data['mech.capacitor']||'-'} µF   Coil: ${s.data['mech.coilCondition']||'-'}`);
        
        if(s.data['mech.filter']) o.push(`  Filter: ${s.data['mech.filter']}`);
        if(s.data['mech.electrical']) o.push(`  Electrical: ${s.data['mech.electrical']}`);
        if(s.data['mech.airflowNotes']) o.push(`  Airflow: ${s.data['mech.airflowNotes']}`);
        
        if(s.meta.mode === 'heating') {
          const checks = [];
          if(isTrue(s.data['safety.rollout'])) checks.push('Rollout✓');
          if(isTrue(s.data['safety.pressure'])) checks.push('Pressure✓');
          if(isTrue(s.data['safety.highlimit'])) checks.push('HighLimit✓');
          if(isTrue(s.data['safety.flame'])) checks.push('Flame✓');
          if(isTrue(s.data['safety.ignition'])) checks.push('Ignition✓');
          if(isTrue(s.data['safety.gasleaks'])) checks.push('GasLeaks✓');
          if(isTrue(s.data['safety.venting'])) checks.push('Venting✓');
          if(checks.length > 0) o.push(`  Safety Checks: ${checks.join(' ')}`);
        }
        
        if(s.data['safety.notes']) o.push(`  Safety Notes: ${s.data['safety.notes']}`);
        if(s.data['mech.notes']) o.push(`  Mechanical Notes: ${s.data['mech.notes']}`);
        
        if(s.data['health.filtrationUpgrades']) o.push(`  Filtration: ${s.data['health.filtrationUpgrades']}`);
        if(isTrue(s.data['health.uvPresent'])) {
          o.push(`  UV System: Present ${isTrue(s.data['health.uvOperational'])?'(Operational)':'(Not operational)'}`);
        }
        if(s.data['health.odorFindings']) o.push(`  Odors: ${s.data['health.odorFindings']}`);
        if(s.data['health.notes']) o.push(`  Health Notes: ${s.data['health.notes']}`);
        
        if(s.photos > 0) o.push(`  📸 Photos: ${s.photos} attached to inspection`);
        
        if(s.notes.length > 0) {
          o.push(`  Quick Notes:`);
          s.notes.forEach(n => {
            const time = new Date(n.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            o.push(`    ${n.isFlag ? '🚩 FLAG' : '💬'} [${time}] ${n.text}`);
          });
        }
        
        o.push(`  Scores: Safety ${s.scores.safety}/10   Mechanical ${s.scores.mechanical}/10   Health ${s.scores.health}/10   Overall ${s.scores.overall}/10   Confidence ${s.scores.confidence}%`);
        
        if(s.data.sopSafety || s.data.sopMechanical || s.data.sopHealth) {
          o.push(`  SOP Status: Safety: ${s.data.sopSafety||'not set'} | Mechanical: ${s.data.sopMechanical||'not set'} | Health: ${s.data.sopHealth||'not set'}`);
        }
        
        const reasons = s.reasons;
        if(Object.values(reasons).some(a => a.length)) {
          o.push(`  Score Drivers:`);
          if(reasons.safety.length) o.push(`    Safety: ${reasons.safety.join('; ')}`);
          if(reasons.mechanical.length) o.push(`    Mechanical: ${reasons.mechanical.join('; ')}`);
          if(reasons.health.length) o.push(`    Health: ${reasons.health.join('; ')}`);
        }
        
        o.push(`  Tiered Recommendations:`);
        o.push(`    ⚠️ IMMEDIATE: ${s.recs.immediate.join('; ') || 'None'}`);
        o.push(`    🔧 CORRECTIVE: ${s.recs.corrective.join('; ') || 'None'}`);
        o.push(`    🛡️ PREVENTIVE: ${s.recs.preventive.join('; ') || 'None'}`);
        o.push('');
      });

      return { customerText: c.join('\n'), officeText: o.join('\n') };
    }

    // ========================================
    // EXPORT FUNCTIONS
    // ========================================
    function exportPDF() {
      showToast('Generating PDF...', 'info');
      buildReports();
      
      setTimeout(() => {
        const el = document.body.cloneNode(true);
        el.querySelectorAll('.toolbar, .sticky-actions, .voice-btn, #toastContainer, .modal, .photo-delete, .note-delete').forEach(b => b && (b.style.display='none'));
        
        const opt = {
          margin: 0.5,
          filename: `FieldBuddy_${sanitize($('#customerName').value || 'Report')}_${$('#inspectionDate').value || new Date().toISOString().slice(0,10)}.pdf`,
          image: { type:'jpeg', quality:0.98 },
          html2canvas: { scale:2, useCORS:true },
          jsPDF: { unit:'in', format:'letter', orientation:'portrait' }
        };
        
        html2pdf().set(opt).from(el).save().then(() => {
          showToast('PDF exported successfully', 'success');
        }).catch(() => {
          showToast('PDF export failed', 'error');
        });
      }, 500);
    }

    function exportHTML() {
      buildReports();
      
      const doc = `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Field Buddy Report - ${sanitize($('#customerName').value || 'Report')}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,sans-serif;max-width:900px;margin:0 auto;padding:16px;line-height:1.6}
    h2{border-bottom:2px solid #ddd;padding-bottom:8px;margin-top:24px}
    pre{white-space:pre-wrap;background:#f8fafc;padding:16px;border-radius:8px;font-size:13px;overflow-x:auto}
  </style>
</head>
<body>
  <h1>Field Buddy Pro — HVAC Inspection Report</h1>
  <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
  <h2>Customer Summary</h2>
  <pre>${escapeHtml($('#customerSummary').textContent)}</pre>
  <h2>Back Office Technical Summary</h2>
  <pre>${escapeHtml($('#officeSummary').textContent)}</pre>
</body>
</html>`;
      
      const blob = new Blob([doc], {type:'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `FieldBuddy_${sanitize($('#customerName').value || 'Report')}_${$('#inspectionDate').value || new Date().toISOString().slice(0,10)}.html`;
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('HTML exported successfully', 'success');
    }

    function exportJSON() {
      buildReports();
      
      const payload = {
        version: '2.0',
        generated: new Date().toISOString(),
        customer: $('#customerName')?.value || '',
        date: $('#inspectionDate')?.value || '',
        tech: $('#technicianName')?.value || '',
        address: $('#address')?.value || '',
        ambientF: $('#ambientF')?.value || '',
        ambientRH: $('#ambientRH')?.value || '',
        systems: []
      };
      
      $$('[data-system]').forEach(card => {
        const sysId = card.dataset.systemId;
        const data = collectCardData(card);
        const scores = scoreCard(card);
        const photos = AppState.photos.get(sysId) || [];
        const notes = AppState.notes.get(sysId) || [];
        
        payload.systems.push({
          data,
          scores,
          photos: photos.map(p => ({id: p.id, timestamp: p.timestamp, name: p.name, data: p.data})),
          notes: notes.map(n => ({id: n.id, text: n.text, timestamp: n.timestamp, isFlag: n.isFlag}))
        });
      });
      
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `FieldBuddy_${sanitize($('#customerName').value || 'Report')}_${$('#inspectionDate').value || new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      showToast('JSON exported successfully', 'success');
    }

    const escapeHtml = (str) => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // ========================================
    // CLIPBOARD
    // ========================================
    function copyToClipboard(text, label) {
      navigator.clipboard.writeText(text)
        .then(() => showToast(`${label} copied to clipboard`, 'success'))
        .catch(() => showToast('Copy failed - please select and copy manually', 'error'));
    }

    // ========================================
    // TOAST NOTIFICATIONS
    // ========================================
    function showToast(message, type = 'info') {
      const container = $('#toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '✓',
        error: '✗',
        info: 'ℹ️'
      };
      
      toast.innerHTML = `<span>${icons[type] || ''}</span><span>${sanitize(message)}</span>`;
      container.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 10);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // ========================================
    // STORAGE & PERSISTENCE
    // ========================================
    const STORAGE_KEY = 'fieldbuddy_draft_v2';

    function gatherDraft() {
      const draft = {
        version: '2.0',
        header: {
          customer: $('#customerName').value || '',
          date: $('#inspectionDate').value || '',
          tech: $('#technicianName').value || '',
          address: $('#address').value || '',
          ambientF: $('#ambientF').value || '',
          ambientRH: $('#ambientRH').value || ''
        },
        systems: []
      };
      
      $$('[data-system]').forEach(card => {
        const sysId = card.dataset.systemId;
        draft.systems.push({
          id: sysId,
          data: collectCardData(card),
          photos: AppState.photos.get(sysId) || [],
          notes: AppState.notes.get(sysId) || []
        });
      });
      
      return draft;
    }

    function markDirty() {
      dirty = true;
    }

    function saveDraft(showIndicator = false) {
      if(!dirty) return;
      
      try {
        const draft = gatherDraft();
        sessionStorage.setItem(STORAGE_KEY, JSON.stringify(draft));
        dirty = false;
        
        if(showIndicator) {
          showToast('Draft saved', 'success');
        }
      } catch(e) {
        console.error('Save failed:', e);
        showToast('Save failed - storage may be full', 'error');
      }
    }

    function debouncedSave() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        if(dirty) saveDraft(true);
      }, 2000);
    }

    function clearDraft() {
      if(confirm('⚠️ Clear all data and start fresh?\n\nThis will delete all systems, photos, and notes. This cannot be undone.')) {
        sessionStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem('technicianName');
        location.reload();
      }
    }

    // ========================================
    // GLOBAL EVENT WIRING
    // ========================================
    function wireGlobalEvents() {
      // Buttons
      $('#btnAddSystem').addEventListener('click', addSystem);
      $('#btnExpandAll').addEventListener('click', () => $$('[data-system] details').forEach(d => d.open = true));
      $('#btnCollapseAll').addEventListener('click', () => $$('[data-system] details').forEach(d => d.open = false));
      $('#btnGenerate').addEventListener('click', buildReports);
      $('#btnPDF2').addEventListener('click', exportPDF);
      $('#btnHTML2').addEventListener('click', exportHTML);
      $('#btnJSON2').addEventListener('click', exportJSON);
      $('#btnClear').addEventListener('click', clearDraft);
      $('#btnToday').addEventListener('click', () => $('#inspectionDate').valueAsDate = new Date());
      $('#btnCopyCustomer').addEventListener('click', () => copyToClipboard($('#customerSummary').textContent, 'Customer Summary'));
      $('#btnCopyOffice').addEventListener('click', () => copyToClipboard($('#officeSummary').textContent, 'Office Summary'));
      
      // Help modal
      $('#btnHelp').addEventListener('click', () => $('#helpModal').style.display = 'flex');
      $('#btnCloseHelp').addEventListener('click', () => $('#helpModal').style.display = 'none');
      $('#helpModal').addEventListener('click', (e) => {
        if(e.target.id === 'helpModal') $('#helpModal').style.display = 'none';
      });
      
      // Photo modal
      $('#btnClosePhoto').addEventListener('click', () => $('#photoModal').style.display = 'none');
      $('#photoModal').addEventListener('click', (e) => {
        if(e.target.id === 'photoModal') $('#photoModal').style.display = 'none';
      });
      
      // Voice buttons
      document.addEventListener('click', (e) => {
        if(e.target.classList.contains('voice-btn')) {
          startVoiceInput(e.target);
        }
      });
      
      // Auto-save on input
      $('#app').addEventListener('input', () => {
        markDirty();
        debouncedSave();
      });
      
      $('#app').addEventListener('change', () => {
        markDirty();
        debouncedSave();
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if(e.ctrlKey || e.metaKey) {
          if(e.key === 's') {
            e.preventDefault();
            saveDraft(true);
          }
          if(e.key === 'n') {
            e.preventDefault();
            addSystem();
            setTimeout(() => {
              const systems = $('#systems');
              systems.scrollTo({ top: systems.scrollHeight, behavior: 'smooth' });
            }, 100);
          }
          if(e.key === 'g') {
            e.preventDefault();
            buildReports();
          }
          if(e.key === 'p') {
            e.preventDefault();
            exportPDF();
          }
        }
      });
      
      // Prevent accidental navigation away
      window.addEventListener('beforeunload', (e) => {
        if(dirty) {
          e.preventDefault();
          e.returnValue = '';
        }
      });
    }

    // ========================================
    // ERROR HANDLING
    // ========================================
    window.addEventListener('error', (e) => {
      console.error('Global error:', e);
      showToast('An error occurred. Your data has been saved.', 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled promise rejection:', e);
      showToast('An error occurred. Your data has been saved.', 'error');
    });

    // ========================================
    // INITIALIZE APP
    // ========================================
    init();
    
    // Log version
    console.log('%cField Buddy Pro v2.0', 'color:#2563eb;font-size:16px;font-weight:bold');
    console.log('%cPhase 1 Complete: Photo capture, validation, refrigerant calcs, auto-save', 'color:#16a34a;font-size:12px');
  </script>
</body>
</html>
