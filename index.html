You're absolutely right - I stripped out the real-time validation feedback that makes this tool actually useful! Let me restore those critical features while keeping the clean design.

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>HVAC Pro Diagnostic</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --primary: #0f172a;
      --primary-light: #1e293b;
      --accent: #3b82f6;
      --accent-dark: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --neutral: #64748b;
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
    }
    
    body { 
      font: 16px -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 0;
      margin: 0;
      line-height: 1.6;
      padding-bottom: 100px;
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      padding: 24px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-lg);
    }
    
    .header-content {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 { 
      font-size: 22px; 
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .mode-selector {
      display: flex;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 4px;
      border-radius: 8px;
    }
    
    .mode-btn {
      padding: 6px 14px;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.7);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: white;
      color: var(--primary);
    }
    
    /* Progress */
    .progress {
      background: var(--card);
      padding: 20px;
      margin: 20px 20px 0;
      border-radius: 12px;
      box-shadow: var(--shadow);
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .progress-steps {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .step {
      text-align: center;
      padding: 10px 4px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--border);
      color: var(--text-muted);
      transition: all 0.3s;
    }
    
    .step.active { 
      background: var(--accent); 
      color: white;
      transform: scale(1.05);
    }
    
    .step.complete { 
      background: var(--success); 
      color: white; 
    }
    
    .progress-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--accent));
      border-radius: 2px;
      transition: width 0.4s ease;
      width: 0%;
    }
    
    .progress-text {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 12px;
      text-align: center;
    }
    
    /* Container */
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Cards */
    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.3s;
    }
    
    .card.collapsed .card-body {
      display: none;
    }
    
    .card.collapsed {
      padding: 16px 24px;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }
    
    .card.collapsed .card-header {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card-title .emoji {
      font-size: 20px;
    }
    
    .card-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .card-status.ready { background: #dbeafe; color: #1e40af; }
    .card-status.complete { background: #d1fae5; color: #065f46; }
    .card-status.active { background: #fef3c7; color: #92400e; }
    
    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }
    
    label.required::after {
      content: " *";
      color: var(--error);
    }
    
    input, select, textarea {
      font-size: 16px;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      width: 100%;
      font-family: inherit;
      transition: all 0.2s;
      background: white;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    input.error, select.error, textarea.error {
      border-color: var(--error);
      background: #fef2f2;
    }
    
    input.success, select.success, textarea.success {
      border-color: var(--success);
      background: #f0fdf4;
    }
    
    input.warning, select.warning {
      border-color: var(--warning);
      background: #fffbeb;
    }
    
    input[readonly] {
      background: var(--bg);
      color: var(--text-muted);
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .input-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* Grid Layouts */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }
    
    /* Buttons */
    button {
      font-size: 15px;
      font-weight: 600;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      min-height: 48px;
    }
    
    button.primary {
      background: var(--accent);
      color: white;
    }
    
    button.primary:hover:not(:disabled) {
      background: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    button.secondary {
      background: var(--neutral);
      color: white;
    }
    
    button.secondary:hover:not(:disabled) {
      background: var(--primary-light);
    }
    
    button.success {
      background: var(--success);
      color: white;
    }
    
    button.success:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    button.full-width {
      width: 100%;
      margin-top: 8px;
    }
    
    /* Status Messages */
    .status-message {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      margin: 16px 0;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      border-left: 4px solid;
    }
    
    .status-message.info { 
      background: #eff6ff; 
      border-left-color: #3b82f6;
      color: #1e40af;
    }
    
    .status-message.success { 
      background: #f0fdf4; 
      border-left-color: #10b981;
      color: #065f46;
    }
    
    .status-message.warning { 
      background: #fffbeb; 
      border-left-color: #f59e0b;
      color: #92400e;
    }
    
    .status-message.error { 
      background: #fef2f2; 
      border-left-color: #ef4444;
      color: #991b1b;
    }
    
    /* Photo System */
    .photo-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    
    .photo-toolbar button {
      flex: 1;
      font-size: 13px;
      padding: 10px;
      min-height: auto;
    }
    
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    
    .photo-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
      background: var(--border);
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .photo-item:hover {
      transform: scale(1.05);
    }
    
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 8px 6px 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .photo-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(239, 68, 68, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 16px;
      cursor: pointer;
      padding: 0;
      min-height: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .photo-item:hover .photo-delete {
      opacity: 1;
    }
    
    /* Floating Camera Button */
    .camera-fab {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);
      z-index: 90;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      min-height: auto;
    }
    
    .camera-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
    }
    
    /* Photo Modal */
    .photo-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 200;
      padding: 20px;
    }
    
    .photo-modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      color: var(--text);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 24px;
      cursor: pointer;
      min-height: auto;
    }
    
    .modal-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .modal-buttons button {
      min-width: 120px;
    }
    
    /* Action Bar */
    .action-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 16px 20px;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
      border-top: 1px solid var(--border);
      z-index: 80;
    }
    
    .action-bar-content {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
    }
    
    .action-bar button {
      flex: 1;
    }
    
    /* Checkbox Groups */
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    
    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      font-size: 14px;
    }
    
    .checkbox-label:hover {
      border-color: var(--accent);
    }
    
    .checkbox-label input {
      width: auto;
      cursor: pointer;
    }
    
    .checkbox-label input:checked + span {
      color: var(--accent);
    }
    
    /* Mode-specific visibility */
    .cooling-only, .heating-only { display: none; }
    body.mode-cooling .cooling-only { display: block; }
    body.mode-heating .heating-only { display: block; }
    .grid .cooling-only, .grid .heating-only { display: none; }
    body.mode-cooling .grid .cooling-only { display: block; }
    body.mode-heating .grid .heating-only { display: block; }
    
    /* Responsive */
    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .progress-steps { 
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }
      .step { font-size: 10px; padding: 8px 2px; }
      .header-content { flex-direction: column; gap: 12px; }
      .action-bar-content { flex-direction: column; }
    }
    
    /* Report Styling */
    .report-section {
      margin: 24px 0;
    }
    
    .report-section h3 {
      font-size: 16px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }
    
    .report-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .report-label {
      font-weight: 600;
      color: var(--text-muted);
    }
    
    .report-value {
      color: var(--text);
      font-weight: 500;
      text-align: right;
    }
  </style>
</head>
<body class="mode-cooling">

  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>HVAC Pro Diagnostic</h1>
      <div class="mode-selector">
        <button class="mode-btn active" onclick="setMode('cooling')" id="btn-cooling">
          ❄️ Cooling
        </button>
        <button class="mode-btn" onclick="setMode('heating')" id="btn-heating">
          🔥 Heating
        </button>
      </div>
    </div>
  </div>

  <!-- Progress Tracker -->
  <div class="progress">
    <div class="progress-steps">
      <div class="step" data-step="power">Power</div>
      <div class="step" data-step="airflow">Airflow</div>
      <div class="step" data-step="electrical">Electrical</div>
      <div class="step" data-step="refrigerant">Refrigerant</div>
      <div class="step" data-step="controls">Controls</div>
      <div class="step" data-step="environment">Environment</div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <div class="progress-text" id="progress-text">0 of 6 Steps Complete</div>
  </div>

  <div class="container">
    
    <!-- Job Information -->
    <div class="card" id="job-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">📋</span>
          Job Information
        </div>
        <div class="card-status ready">Required</div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label class="required">Customer Name</label>
          <input type="text" id="customer" placeholder="Enter customer name" required>
        </div>
        
        <div class="form-group">
          <label class="required">Service Address</label>
          <input type="text" id="address" placeholder="Enter service address" required>
        </div>
        
        <div class="form-group">
          <label>Customer Complaint</label>
          <textarea id="complaint" placeholder="Describe the customer's complaint in their own words"></textarea>
        </div>
      </div>
    </div>

    <!-- Equipment Information -->
    <div class="card" id="equipment-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">🔧</span>
          Equipment Information
        </div>
        <div class="card-status ready">Required</div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label>Unit Location</label>
          <input type="text" id="location" placeholder="Attic, Garage, Basement, Closet, etc.">
        </div>

        <div class="grid">
          <div class="form-group">
            <label class="required">Indoor Unit Brand</label>
            <input type="text" id="indoor-brand" placeholder="e.g., Carrier" required>
          </div>
          <div class="form-group">
            <label class="required">Indoor Model #</label>
            <input type="text" id="indoor-model" placeholder="e.g., 58MVC" required>
          </div>
        </div>

        <div class="form-group">
          <label class="required">Indoor Serial #</label>
          <input type="text" id="indoor-serial" placeholder="e.g., 1234567890" required>
        </div>

        <div class="grid">
          <div class="form-group">
            <label class="required">Outdoor Unit Brand</label>
            <input type="text" id="outdoor-brand" placeholder="e.g., Carrier" required>
          </div>
          <div class="form-group">
            <label class="required">Outdoor Model #</label>
            <input type="text" id="outdoor-model" placeholder="e.g., 24ABC6" required>
          </div>
        </div>

        <div class="form-group">
          <label class="required">Outdoor Serial #</label>
          <input type="text" id="outdoor-serial" placeholder="e.g., 0987654321" required>
        </div>

        <div class="grid">
          <div class="form-group">
            <label class="required">System Tonnage</label>
            <select id="tonnage" required>
              <option value="">Select tonnage...</option>
              <option value="1.5">1.5 Ton</option>
              <option value="2">2 Ton</option>
              <option value="2.5">2.5 Ton</option>
              <option value="3">3 Ton</option>
              <option value="3.5">3.5 Ton</option>
              <option value="4">4 Ton</option>
              <option value="5">5 Ton</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="required">Refrigerant Type</label>
            <select id="refrigerant" required>
              <option value="">Select refrigerant...</option>
              <option value="R-410A">R-410A</option>
              <option value="R-22">R-22 (Legacy)</option>
              <option value="R-32">R-32</option>
              <option value="R-454B">R-454B</option>
            </select>
          </div>
        </div>

        <div class="grid cooling-only">
          <div class="form-group">
            <label>Metering Device Type</label>
            <select id="metering-device">
              <option value="">Select type...</option>
              <option value="TXV">TXV (Thermostatic Expansion Valve)</option>
              <option value="Piston">Fixed Orifice / Piston</option>
              <option value="EEV">EEV (Electronic Expansion Valve)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Manufacture Date</label>
            <input type="date" id="mfg-date">
          </div>
        </div>
      </div>
    </div>

    <!-- STEP 1: POWER -->
    <div class="card" id="power-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">⚡</span>
          Step 1: Power Verification
        </div>
        <div class="card-status ready" id="power-status">Start</div>
      </div>
      <div class="card-body">
        <div class="status-message info">
          <span>💡</span>
          <span>Always verify power before proceeding. Never test unpowered systems.</span>
        </div>

        <div class="form-group">
          <label class="required">Disconnect Status</label>
          <select id="disconnect-status" required onchange="validatePowerStep()">
            <option value="">Check disconnect...</option>
            <option value="present">Present and Functional</option>
            <option value="missing">Missing or Non-functional</option>
            <option value="bypassed">Bypassed - SAFETY ISSUE</option>
          </select>
        </div>

        <div class="grid">
          <div class="form-group">
            <label class="required">Line Voltage (L1-L2)</label>
            <input type="number" id="voltage-line" placeholder="208-240" step="0.1" required oninput="validatePowerStep()">
            <div class="input-hint">Typical: 208-240V</div>
          </div>
          <div class="form-group">
            <label>Control Voltage (24V)</label>
            <input type="number" id="voltage-control" placeholder="18-30" step="0.1" oninput="validatePowerStep()">
            <div class="input-hint">Typical: 22-26V</div>
          </div>
        </div>

        <div class="grid">
          <div class="form-group">
            <label>Voltage L1-N</label>
            <input type="number" id="voltage-l1n" step="0.1" oninput="validatePowerStep()">
          </div>
          <div class="form-group">
            <label>Voltage L2-N</label>
            <input type="number" id="voltage-l2n" step="0.1" oninput="validatePowerStep()">
          </div>
        </div>

        <div id="power-validation"></div>

        <button class="success full-width" onclick="completeStep('power')" id="power-btn" disabled>
          ✓ Complete Power Verification
        </button>
      </div>
    </div>

    <!-- STEP 2: AIRFLOW -->
    <div class="card" id="airflow-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">💨</span>
          Step 2: Airflow Assessment
        </div>
        <div class="card-status ready" id="airflow-status">Start</div>
      </div>
      <div class="card-body">
        <div class="status-message info">
          <span>💡</span>
          <span>Verify adequate airflow before refrigerant testing. No gauges without airflow confirmation.</span>
        </div>

        <div class="form-group">
          <label class="required">Filter Condition</label>
          <select id="filter-condition" required onchange="validateAirflowStep()">
            <option value="">Inspect filter...</option>
            <option value="clean">Clean - Good Airflow</option>
            <option value="lightly-soiled">Lightly Soiled - Acceptable</option>
            <option value="dirty">Dirty - Restricting Airflow</option>
            <option value="severely-blocked">Severely Blocked</option>
            <option value="missing">Missing Filter</option>
          </select>
        </div>

        <div class="grid">
          <div class="form-group">
            <label>Return Static Pressure</label>
            <input type="number" id="return-static" placeholder="-0.10" step="0.01" oninput="validateAirflowStep()">
            <div class="input-hint">Typically negative (-0.1 to -0.3)</div>
          </div>
          <div class="form-group">
            <label>Supply Static Pressure</label>
            <input type="number" id="supply-static" placeholder="0.30" step="0.01" oninput="validateAirflowStep()">
            <div class="input-hint">Typically positive (0.2 to 0.5)</div>
          </div>
        </div>

        <div class="form-group">
          <label>Total Static Pressure (TESP)</label>
          <input type="text" id="total-static" readonly>
          <div class="input-hint">Auto-calculated when both values entered</div>
        </div>

        <div class="form-group">
          <label class="required">Blower Status</label>
          <select id="blower-operation" required onchange="validateAirflowStep()">
            <option value="">Check blower...</option>
            <option value="normal">Normal Operation</option>
            <option value="reduced">Reduced Airflow</option>
            <option value="noisy">Noisy Operation</option>
            <option value="inoperative">Inoperative</option>
          </select>
        </div>

        <div id="airflow-validation"></div>

        <button class="success full-width" onclick="completeStep('airflow')" id="airflow-btn" disabled>
          ✓ Complete Airflow Assessment
        </button>
      </div>
    </div>

    <!-- STEP 3: ELECTRICAL -->
    <div class="card" id="electrical-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">🔌</span>
          Step 3: Electrical Components
        </div>
        <div class="card-status ready" id="electrical-status">Start</div>
      </div>
      <div class="card-body">
        <div class="status-message info">
          <span>💡</span>
          <span>Test components under load when possible. Check amperage against nameplate ratings.</span>
        </div>

        <div class="grid">
          <div class="form-group">
            <label>Blower Motor Amps</label>
            <input type="text" id="blower-amps" placeholder="Format: 8.2/10.0 (actual/rated)" oninput="validateElectricalStep()">
          </div>
          <div class="form-group cooling-only">
            <label>Compressor Amps</label>
            <input type="text" id="comp-amps" placeholder="Format: 18.5/21.0" oninput="validateElectricalStep()">
          </div>
          <div class="form-group heating-only">
            <label>Inducer Motor Amps</label>
            <input type="number" id="inducer-amps" step="0.1" oninput="validateElectricalStep()">
          </div>
        </div>

        <div class="cooling-only">
          <div class="form-group">
            <label>Condenser Fan Motor Amps</label>
            <input type="number" id="cond-fan-amps" step="0.1" oninput="validateElectricalStep()">
          </div>
        </div>

        <div class="form-group">
          <label class="required">Run Capacitor Reading</label>
          <input type="text" id="capacitor-reading" placeholder="Format: 45/50 µF (measured/rated)" required oninput="validateElectricalStep()">
        </div>

        <div class="form-group cooling-only">
          <label>Start Capacitor (if equipped)</label>
          <input type="text" id="start-capacitor" placeholder="Format: 88/100 µF">
        </div>

        <div class="form-group cooling-only">
          <label class="required">Contactor Condition</label>
          <select id="contactor-condition" required onchange="validateElectricalStep()">
            <option value="">Inspect contactor...</option>
            <option value="good">Good - Minimal Wear</option>
            <option value="fair">Fair - Moderate Pitting</option>
            <option value="poor">Poor - Heavy Pitting, Recommend Replacement</option>
            <option value="failed">Failed - Burned or Welded Contacts</option>
          </select>
        </div>

        <div id="electrical-validation"></div>

        <button class="success full-width" onclick="completeStep('electrical')" id="electrical-btn" disabled>
          ✓ Complete Electrical Testing
        </button>
      </div>
    </div>

    <!-- STEP 4: REFRIGERANT -->
    <div class="card" id="refrigerant-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">❄️</span>
          Step 4: Refrigerant Circuit
        </div>
        <div class="card-status ready" id="refrigerant-status">Start</div>
      </div>
      <div class="card-body">
        <div class="status-message info">
          <span>💡</span>
          <span>Only test after airflow confirmation. Always measure both superheat AND subcool.</span>
        </div>

        <!-- Cooling Mode -->
        <div class="cooling-only">
          <div class="grid">
            <div class="form-group">
              <label class="required">Suction Pressure (psig)</label>
              <input type="number" id="suction-pressure" step="0.1" required oninput="validateRefrigerantStep()">
            </div>
            <div class="form-group">
              <label class="required">Liquid Pressure (psig)</label>
              <input type="number" id="liquid-pressure" step="0.1" required oninput="validateRefrigerantStep()">
            </div>
          </div>

          <div class="grid">
            <div class="form-group">
              <label class="required">Suction Line Temp (°F)</label>
              <input type="number" id="suction-temp" step="0.1" required oninput="validateRefrigerantStep()">
            </div>
            <div class="form-group">
              <label class="required">Liquid Line Temp (°F)</label>
              <input type="number" id="liquid-temp" step="0.1" required oninput="validateRefrigerantStep()">
            </div>
          </div>

          <div class="grid">
            <div class="form-group">
              <label>Outdoor Dry Bulb (°F)</label>
              <input type="number" id="outdoor-dry-bulb" step="0.1">
            </div>
            <div class="form-group">
              <label>Outdoor Wet Bulb (°F)</label>
              <input type="number" id="outdoor-wet-bulb" step="0.1">
              <div class="input-hint">Required for accurate charge verification</div>
            </div>
          </div>

          <div class="grid">
            <div class="form-group">
              <label>Indoor Dry Bulb (°F)</label>
              <input type="number" id="indoor-dry-bulb" step="0.1">
            </div>
            <div class="form-group">
              <label>Indoor Wet Bulb (°F)</label>
              <input type="number" id="indoor-wet-bulb" step="0.1">
              <div class="input-hint">For CFM calculations</div>
            </div>
          </div>

          <div class="grid">
            <div class="form-group">
              <label>Superheat (calculated)</label>
              <input type="text" id="superheat-calc" readonly>
            </div>
            <div class="form-group">
              <label>Subcool (calculated)</label>
              <input type="text" id="subcool-calc" readonly>
            </div>
          </div>

          <div id="superheat-status"></div>
          <div id="subcool-status"></div>
        </div>

        <!-- Heating Mode -->
        <div class="heating-only">
          <div class="grid">
            <div class="form-group">
              <label>Gas Input (BTU/hr)</label>
              <input type="number" id="gas-input" oninput="validateRefrigerantStep()">
            </div>
            <div class="form-group">
              <label>Manifold Pressure (in w.c.)</label>
              <input type="number" id="manifold-pressure" step="0.1" oninput="validateRefrigerantStep()">
            </div>
          </div>

          <div class="form-group">
            <label>Heat Exchanger Condition</label>
            <select id="heat-exchanger" onchange="validateRefrigerantStep()">
              <option value="">Inspect heat exchanger...</option>
              <option value="clean">Clean - No Restrictions</option>
              <option value="light-buildup">Light Buildup</option>
              <option value="restricted">Restricted - Needs Cleaning</option>
              <option value="cracked">Cracked - SAFETY ISSUE</option>
            </select>
          </div>

          <div class="form-group">
            <label>Flame Sensor Reading (µA)</label>
            <input type="number" id="flame-sensor" step="0.1">
            <div class="input-hint">Minimum 0.5 µA, typical 2-8 µA</div>
          </div>
        </div>

        <div id="refrigerant-validation"></div>

        <button class="success full-width" onclick="completeStep('refrigerant')" id="refrigerant-btn" disabled>
          ✓ Complete Refrigerant Testing
        </button>
      </div>
    </div>

    <!-- STEP 5: CONTROLS -->
    <div class="card" id="controls-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">🎛️</span>
          Step 5: Controls & System Response
        </div>
        <div class="card-status ready" id="controls-status">Start</div>
      </div>
      <div class="card-body">
        <div class="status-message info">
          <span>💡</span>
          <span>Verify actual system response matches expected behavior.</span>
        </div>

        <div class="form-group">
          <label class="required">Thermostat Communication</label>
          <select id="thermostat-comm" required onchange="validateControlsStep()">
            <option value="">Test thermostat...</option>
            <option value="normal">Normal - Responds to Calls</option>
            <option value="intermittent">Intermittent Response</option>
            <option value="no-comm">No Communication</option>
            <option value="wiring-issue">Wiring Issue Detected</option>
          </select>
        </div>

        <div class="grid">
          <div class="form-group">
            <label class="required">Return Air Temp (°F)</label>
            <input type="number" id="return-air-temp" step="0.1" required oninput="validateControlsStep()">
          </div>
          <div class="form-group">
            <label class="required">Supply Air Temp (°F)</label>
            <input type="number" id="supply-air-temp" step="0.1" required oninput="validateControlsStep()">
          </div>
        </div>

        <div class="form-group">
          <label>Delta T (calculated)</label>
          <input type="text" id="delta-t-calc" readonly>
          <div class="input-hint">Cooling: 16-22°F ideal | Heating: 40-70°F ideal</div>
        </div>

        <div id="delta-t-status"></div>

        <div class="form-group">
          <label>Safety Controls</label>
          <div class="checkbox-group cooling-only">
            <label class="checkbox-label">
              <input type="checkbox" id="high-pressure" onchange="validateControlsStep()">
              <span>High Pressure OK</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="low-pressure" onchange="validateControlsStep()">
              <span>Low Pressure OK</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="float-switch" onchange="validateControlsStep()">
              <span>Float Switch OK</span>
            </label>
          </div>

          <div class="checkbox-group heating-only">
            <label class="checkbox-label">
              <input type="checkbox" id="flame-sensor-ok" onchange="validateControlsStep()">
              <span>Flame Sensor OK</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="limit-switch" onchange="validateControlsStep()">
              <span>Limit Switch OK</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="pressure-switch" onchange="validateControlsStep()">
              <span>Pressure Switch OK</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="rollout-switch" onchange="validateControlsStep()">
              <span>Rollout Switch OK</span>
            </label>
          </div>
        </div>

        <div id="controls-validation"></div>

        <button class="success full-width" onclick="completeStep('controls')" id="controls-btn" disabled>
          ✓ Complete Controls Testing
        </button>
      </div>
    </div>

    <!-- STEP 6: ENVIRONMENT -->
    <div class="card" id="environment-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">🌡️</span>
          Step 6: Environmental Assessment
        </div>
        <div class="card-status ready" id="environment-status">Start</div>
      </div>
      <div class="card-body">
        <div class="status-message info">
          <span>💡</span>
          <span>Site conditions often reveal the root cause. Document everything.</span>
        </div>

        <div class="grid">
          <div class="form-group">
            <label>Outdoor Temperature (°F)</label>
            <input type="number" id="outdoor-temp" step="0.1">
          </div>
          <div class="form-group">
            <label>Outdoor Humidity (%)</label>
            <input type="number" id="outdoor-humidity" min="0" max="100">
          </div>
        </div>

        <div class="form-group">
          <label class="required">Evaporator Coil Condition</label>
          <select id="evap-coil-condition" required onchange="validateEnvironmentStep()">
            <option value="">Inspect evaporator coil...</option>
            <option value="clean">Clean - No Obstructions</option>
            <option value="dusty">Dusty - Light Cleaning Needed</option>
            <option value="dirty">Dirty - Significant Restriction</option>
            <option value="frozen">Frozen - Airflow/Charge Issue</option>
            <option value="corroded">Corroded - Replacement Needed</option>
          </select>
        </div>

        <div class="form-group cooling-only">
          <label class="required">Condenser Coil Condition</label>
          <select id="cond-coil-condition" required onchange="validateEnvironmentStep()">
            <option value="">Inspect condenser coil...</option>
            <option value="clean">Clean - Good Heat Transfer</option>
            <option value="dusty">Dusty - Light Cleaning Needed</option>
            <option value="dirty">Dirty - Reduced Efficiency</option>
            <option value="severely-blocked">Severely Blocked</option>
            <option value="damaged-fins">Damaged Fins</option>
          </select>
        </div>

        <div class="form-group">
          <label class="required">Drainage System</label>
          <select id="drainage-condition" required onchange="validateEnvironmentStep()">
            <option value="">Check drainage...</option>
            <option value="clear">Clear - Draining Properly</option>
            <option value="slow">Slow Drainage</option>
            <option value="blocked">Blocked - Standing Water</option>
            <option value="backup">Backup - Overflow Risk</option>
          </select>
        </div>

        <div class="form-group">
          <label>Condensate Trap Condition</label>
          <select id="trap-condition">
            <option value="">Inspect trap...</option>
            <option value="good">Good - Proper Seal</option>
            <option value="dry">Dry - Needs Priming</option>
            <option value="clogged">Clogged</option>
            <option value="missing">Missing or Damaged</option>
          </select>
        </div>

        <div class="form-group">
          <label>Ductwork Assessment</label>
          <select id="ductwork">
            <option value="">Assess ductwork...</option>
            <option value="good">Good - No Issues</option>
            <option value="minor-leaks">Minor Leaks Detected</option>
            <option value="major-leaks">Major Leaks - Significant Loss</option>
            <option value="disconnected">Disconnected Sections</option>
            <option value="undersized">Undersized for System</option>
          </select>
        </div>

        <div class="form-group">
          <label>Environmental Factors / Site Observations</label>
          <textarea id="site-issues" placeholder="Document any environmental factors affecting performance"></textarea>
        </div>

        <div id="environment-validation"></div>

        <button class="success full-width" onclick="completeStep('environment')" id="environment-btn" disabled>
          ✓ Complete Environmental Assessment
        </button>
      </div>
    </div>

    <!-- Diagnosis & Recommendations -->
    <div class="card" id="findings-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">📝</span>
          Diagnosis & Recommendations
        </div>
        <div class="card-status ready" id="findings-status">Final Step</div>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label class="required">Diagnosis</label>
          <textarea id="diagnosis" placeholder="What's wrong and why - be specific with technical details" rows="4" required></textarea>
          <div class="input-hint">Clearly state the problem and the evidence supporting your diagnosis</div>
        </div>

        <div class="form-group">
          <label class="required">Recommended Repairs</label>
          <textarea id="repairs" placeholder="Specific repair steps, parts needed, and estimated time" rows="4" required></textarea>
          <div class="input-hint">Include part numbers and specifications when applicable</div>
        </div>

        <div class="form-group">
          <label>Preventive Measures</label>
          <textarea id="preventive" placeholder="How to prevent this issue in the future" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label>Additional Notes</label>
          <textarea id="additional-notes" placeholder="Any other relevant information" rows="2"></textarea>
        </div>
      </div>
    </div>

    <!-- Photo Documentation -->
    <div class="card" id="photos-card">
      <div class="card-header">
        <div class="card-title">
          <span class="emoji">📸</span>
          Photo Documentation
        </div>
        <div class="card-status ready">Optional</div>
      </div>
      <div class="card-body">
        <div class="photo-toolbar">
          <button class="secondary" onclick="takePhoto('nameplate')">📷 Nameplate</button>
          <button class="secondary" onclick="takePhoto('problem')">📷 Problem Area</button>
          <button class="secondary" onclick="takePhoto('before')">📷 Before</button>
          <button class="secondary" onclick="takePhoto('after')">📷 After</button>
        </div>
        <div class="photo-grid" id="photo-preview"></div>
      </div>
    </div>

    <!-- Generated Report will appear here -->
    <div id="report-container"></div>

  </div>

  <!-- Floating Camera Button -->
  <button class="camera-fab" onclick="showPhotoModal()" title="Take Photo">
    📷
  </button>

  <!-- Photo Modal -->
  <div class="photo-modal" id="photo-modal">
    <button class="modal-close" onclick="hidePhotoModal()">×</button>
    <h2 style="color: white; margin-bottom: 20px;">Select Photo Purpose</h2>
    <div class="modal-buttons">
      <button class="primary" onclick="takePhotoAndClose('nameplate')">Nameplate</button>
      <button class="primary" onclick="takePhotoAndClose('problem')">Problem Area</button>
      <button class="primary" onclick="takePhotoAndClose('before')">Before Repair</button>
      <button class="primary" onclick="takePhotoAndClose('after')">After Repair</button>
    </div>
  </div>

  <!-- Action Bar -->
  <div class="action-bar">
    <div class="action-bar-content">
      <button class="success" onclick="generateReport()" id="generate-report-btn" disabled>
        Generate Report
      </button>
      <button class="secondary" onclick="exportReport()" id="export-btn" disabled>
        📄 Export
      </button>
    </div>
  </div>

  <script>
    // ==================== STATE MANAGEMENT ====================
    let currentMode = 'cooling';
    let stepCompleted = {
      power: false,
      airflow: false,
      electrical: false,
      refrigerant: false,
      controls: false,
      environment: false
    };
    let photos = [];

    // R-410A Pressure-Temperature Chart (expanded)
    const R410A_PT = {
      85: 41.4, 90: 44.7, 95: 47.1, 100: 49.6, 105: 52.2, 110: 54.9, 
      115: 57.7, 120: 60.6, 125: 63.6, 130: 66.7, 135: 69.9, 140: 73.2,
      145: 76.6, 150: 80.1, 155: 83.7, 160: 87.4, 165: 91.3, 170: 95.2,
      175: 99.3, 180: 103.5, 185: 107.8, 190: 112.2, 195: 116.7, 200: 121.4
    };

    // ==================== UTILITY FUNCTIONS ====================
    const $ = id => document.getElementById(id);
    const num = val => { const n = parseFloat(val); return isNaN(n) ? null : n; };

    function lookupSatTemp(pressure) {
      let closest = null;
      let minDiff = Infinity;
      for (let temp in R410A_PT) {
        const p = R410A_PT[temp];
        const diff = Math.abs(p - pressure);
        if (diff < minDiff) {
          minDiff = diff;
          closest = parseFloat(temp);
        }
      }
      return closest;
    }

    // ==================== MODE MANAGEMENT ====================
    function setMode(mode) {
      currentMode = mode;
      document.body.className = `mode-${mode}`;
      $('btn-cooling').classList.toggle('active', mode === 'cooling');
      $('btn-heating').classList.toggle('active', mode === 'heating');
      
      // Reset refrigerant step when mode changes
      if (stepCompleted.refrigerant) {
        stepCompleted.refrigerant = false;
        updateProgress();
      }
      
      // Revalidate refrigerant step for new mode
      validateRefrigerantStep();
      
      saveState();
    }

    // ==================== PROGRESS MANAGEMENT ====================
    function updateProgress() {
      const completed = Object.values(stepCompleted).filter(Boolean).length;
      const percentage = (completed / 6) * 100;
      
      $('progress-fill').style.width = percentage + '%';
      $('progress-text').textContent = `${completed} of 6 Steps Complete`;
      
      // Update step indicators
      Object.keys(stepCompleted).forEach(step => {
        const stepEl = document.querySelector(`[data-step="${step}"]`);
        if (stepCompleted[step]) {
          stepEl.className = 'step complete';
        } else {
          stepEl.className = 'step';
        }
      });
      
      // Enable report when all steps complete
      const allComplete = Object.values(stepCompleted).every(Boolean);
      const diagnosisComplete = $('diagnosis').value.trim() && $('repairs').value.trim();
      $('generate-report-btn').disabled = !(allComplete && diagnosisComplete);
    }

    // ==================== STEP VALIDATION ====================
    function validatePowerStep() {
      const disconnect = $('disconnect-status').value;
      const lineVoltage = num($('voltage-line').value);
      const controlVoltage = num($('voltage-control').value);
      const l1n = num($('voltage-l1n').value);
      const l2n = num($('voltage-l2n').value);
      const validation = $('power-validation');
      let isValid = false;
      let messages = [];

      // Disconnect validation
      if (disconnect === 'bypassed') {
        messages.push('<div class="status-message error"><span>⚠️</span><span><strong>SAFETY ISSUE:</strong> Bypassed disconnect must be corrected before proceeding</span></div>');
        $('disconnect-status').className = 'error';
      } else if (disconnect === 'missing') {
        messages.push('<div class="status-message error"><span>⚠️</span><span>Missing disconnect - code violation, must be installed</span></div>');
        $('disconnect-status').className = 'error';
      } else if (disconnect === 'present') {
        messages.push('<div class="status-message success"><span>✓</span><span>Disconnect verified</span></div>');
        $('disconnect-status').className = 'success';
      }

      // Line voltage validation
      if (lineVoltage) {
        if (lineVoltage < 200) {
          messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Low voltage:</strong> ' + lineVoltage + 'V - Check supply, possible utility issue</span></div>');
          $('voltage-line').className = 'error';
        } else if (lineVoltage > 250) {
          messages.push('<div class="status-message error"><span>⚠️</span><span><strong>High voltage:</strong> ' + lineVoltage + 'V - Check supply, possible overvoltage</span></div>');
          $('voltage-line').className = 'error';
        } else if (lineVoltage < 208) {
          messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Low-normal voltage:</strong> ' + lineVoltage + 'V - Acceptable but monitor performance</span></div>');
          $('voltage-line').className = 'warning';
          isValid = disconnect === 'present';
        } else {
          messages.push('<div class="status-message success"><span>✓</span><span><strong>Line voltage good:</strong> ' + lineVoltage + 'V</span></div>');
          $('voltage-line').className = 'success';
          isValid = disconnect === 'present';
        }
      }

      // Control voltage validation
      if (controlVoltage) {
        if (controlVoltage < 18) {
          messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Control voltage low:</strong> ' + controlVoltage + 'V - Check transformer</span></div>');
          $('voltage-control').className = 'error';
        } else if (controlVoltage > 30) {
          messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Control voltage high:</strong> ' + controlVoltage + 'V - Check transformer</span></div>');
          $('voltage-control').className = 'error';
        } else if (controlVoltage < 22 || controlVoltage > 28) {
          messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Control voltage marginal:</strong> ' + controlVoltage + 'V</span></div>');
          $('voltage-control').className = 'warning';
        } else {
          messages.push('<div class="status-message success"><span>✓</span><span><strong>Control voltage good:</strong> ' + controlVoltage + 'V</span></div>');
          $('voltage-control').className = 'success';
        }
      }

      // L1-N and L2-N balance check
      if (l1n && l2n) {
        const imbalance = Math.abs(l1n - l2n);
        if (imbalance > 10) {
          messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Voltage imbalance:</strong> ' + imbalance.toFixed(1) + 'V difference - Check service</span></div>');
        } else if (imbalance > 5) {
          messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Slight voltage imbalance:</strong> ' + imbalance.toFixed(1) + 'V difference</span></div>');
        } else {
          messages.push('<div class="status-message success"><span>✓</span><span><strong>Voltage balanced:</strong> L1-N: ' + l1n + 'V, L2-N: ' + l2n + 'V</span></div>');
        }
      }

      validation.innerHTML = messages.join('');
      $('power-btn').disabled = !isValid;
    }

    function validateAirflowStep() {
      const filter = $('filter-condition').value;
      const blower = $('blower-operation').value;
      const returnStatic = num($('return-static').value);
      const supplyStatic = num($('supply-static').value);
      const validation = $('airflow-validation');
      let isValid = false;
      let messages = [];

      // Calculate TESP
      if (returnStatic !== null && supplyStatic !== null) {
        const tesp = Math.abs(returnStatic) + Math.abs(supplyStatic);
        $('total-static').value = tesp.toFixed(2) + ' in w.c.';
        
        if (tesp <= 0.50) {
          messages.push('<div class="status-message success"><span>✓</span><span><strong>TESP excellent:</strong> ' + tesp.toFixed(2) + ' in w.c. - Good airflow</span></div>');
          $('total-static').className = 'success';
        } else if (tesp <= 0.70) {
          messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>TESP elevated:</strong> ' + tesp.toFixed(2) + ' in w.c. - Monitor ductwork</span></div>');
          $('total-static').className = 'warning';
        } else if (tesp <= 0.90) {
          messages.push('<div class="status-message error"><span>⚠️</span><span><strong>TESP high:</strong> ' + tesp.toFixed(2) + ' in w.c. - Significant restriction</span></div>');
          $('total-static').className = 'error';
        } else {
          messages.push('<div class="status-message error"><span>⚠️</span><span><strong>TESP excessive:</strong> ' + tesp.toFixed(2) + ' in w.c. - Major duct issues</span></div>');
          $('total-static').className = 'error';
        }
      }

      // Filter validation
      if (filter === 'severely-blocked' || filter === 'dirty') {
        messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Filter restricted:</strong> Replace before proceeding with diagnostic</span></div>');
        $('filter-condition').className = 'error';
      } else if (filter === 'lightly-soiled') {
        messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Filter lightly soiled:</strong> Acceptable for now, recommend replacement</span></div>');
        $('filter-condition').className = 'warning';
      } else if (filter === 'clean') {
        messages.push('<div class="status-message success"><span>✓</span><span>Filter clean - good airflow</span></div>');
        $('filter-condition').className = 'success';
      } else if (filter === 'missing') {
        messages.push('<div class="status-message error"><span>⚠️</span><span><strong>No filter:</strong> Install filter immediately</span></div>');
        $('filter-condition').className = 'error';
      }

      // Blower validation
      if (blower === 'normal') {
        messages.push('<div class="status-message success"><span>✓</span><span>Blower operation normal</span></div>');
        $('blower-operation').className = 'success';
        isValid = (filter === 'clean' || filter === 'lightly-soiled');
      } else if (blower === 'inoperative') {
        messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Blower inoperative:</strong> Address before continuing diagnostic</span></div>');
        $('blower-operation').className = 'error';
      } else if (blower === 'reduced') {
        messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Reduced airflow:</strong> Check blower, motor, or restrictions</span></div>');
        $('blower-operation').className = 'error';
      } else if (blower === 'noisy') {
        messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Noisy operation:</strong> Check bearings and wheel balance</span></div>');
        $('blower-operation').className = 'warning';
      }

      validation.innerHTML = messages.join('');
      $('airflow-btn').disabled = !isValid;
    }

    function validateElectricalStep() {
      const capacitor = $('capacitor-reading').value;
      const contactor = $('contactor-condition').value;
      const blowerAmps = $('blower-amps').value;
      const compAmps = $('comp-amps').value;
      const validation = $('electrical-validation');
      let isValid = false;
      let messages = [];

      // Capacitor validation
      if (capacitor) {
        const match = capacitor.match(/(\d+\.?\d*)\s*\/\s*(\d+\.?\d*)/);
        if (match) {
          const measured = parseFloat(match[1]);
          const rated = parseFloat(match[2]);
          const deviation = ((measured - rated) / rated) * 100;
          
          if (Math.abs(deviation) <= 6) {
            messages.push('<div class="status-message success"><span>✓</span><span><strong>Capacitor good:</strong> ' + measured + 'µF / ' + rated + 'µF rated (' + deviation.toFixed(1) + '% deviation)</span></div>');
            $('capacitor-reading').className = 'success';
          } else if (Math.abs(deviation) <= 10) {
            messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Capacitor marginal:</strong> ' + measured + 'µF / ' + rated + 'µF rated (' + deviation.toFixed(1) + '% deviation) - Monitor</span></div>');
            $('capacitor-reading').className = 'warning';
          } else {
            messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Capacitor failing:</strong> ' + measured + 'µF / ' + rated + 'µF rated (' + deviation.toFixed(1) + '% deviation) - Replace</span></div>');
            $('capacitor-reading').className = 'error';
          }
        } else {
          messages.push('<div class="status-message success"><span>✓</span><span>Capacitor reading documented</span></div>');
          $('capacitor-reading').className = 'success';
        }
      }

      // Amp draw analysis
      if (blowerAmps) {
        const match = blowerAmps.match(/(\d+\.?\d*)\s*\/\s*(\d+\.?\d*)/);
        if (match) {
          const actual = parseFloat(match[1]);
          const rated = parseFloat(match[2]);
          const percent = (actual / rated) * 100;
          
          if (percent > 110) {
            messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Blower overcurrent:</strong> ' + actual + 'A / ' + rated + 'A rated (' + percent.toFixed(0) + '%) - Check for restriction</span></div>');
            $('blower-amps').className = 'error';
          } else if (percent > 100) {
            messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Blower high amps:</strong> ' + actual + 'A / ' + rated + 'A rated (' + percent.toFixed(0) + '%)</span></div>');
            $('blower-amps').className = 'warning';
          } else if (percent < 70) {
            messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Blower low amps:</strong> ' + actual + 'A / ' + rated + 'A rated (' + percent.toFixed(0) + '%) - Check airflow</span></div>');
            $('blower-amps').className = 'warning';
          } else {
            messages.push('<div class="status-message success"><span>✓</span><span><strong>Blower amps normal:</strong> ' + actual + 'A / ' + rated + 'A rated (' + percent.toFixed(0) + '%)</span></div>');
            $('blower-amps').className = 'success';
          }
        }
      }

      if (compAmps && currentMode === 'cooling') {
        const match = compAmps.match(/(\d+\.?\d*)\s*\/\s*(\d+\.?\d*)/);
        if (match) {
          const actual = parseFloat(match[1]);
          const rated = parseFloat(match[2]);
          const percent = (actual / rated) * 100;
          
          if (percent > 115) {
            messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Compressor overcurrent:</strong> ' + actual + 'A / ' + rated + 'A rated (' + percent.toFixed(0) + '%) - Overcharge or restriction</span></div>');
            $('comp-amps').className = 'error';
          } else if (percent > 105) {
            messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Compressor high amps:</strong> ' + actual + 'A / ' + rated + 'A rated (' + percent.toFixed(0) + '%)</span></div>');
            $('comp-amps').className = 'warning';
          } else if (percent < 70) {
            messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Compressor low amps:</strong> ' + actual + 'A / ' + rated + 'A rated (' + percent.toFixed(0) + '%) - Undercharge or low load</span></div>');
            $('comp-amps').className = 'warning';
          } else {
            messages.push('<div class="status-message success"><span>✓</span><span><strong>Compressor amps normal:</strong> ' + actual + 'A / ' + rated + 'A rated (' + percent.toFixed(0) + '%)</span></div>');
            $('comp-amps').className = 'success';
          }
        }
      }

      // Contactor validation (cooling only)
      if (currentMode === 'cooling') {
        if (contactor === 'failed' || contactor === 'poor') {
          messages.push('<div class="status-message error"><span>⚠️</span><span><strong>Contactor replacement required:</strong> Safety and reliability concern</span></div>');
          $('contactor-condition').className = 'error';
        } else if (contactor === 'fair') {
          messages.push('<div class="status-message warning"><span>⚠️</span><span><strong>Contactor wear detected:</strong> Plan replacement soon</span></div>');
          $('contactor-condition').className = 'warning';
        } else if (contactor === 'good') {
          messages.push('<div class="status-message success"><span>✓</span><span>Contactor condition acceptable</span></div>');
          $('contactor-condition').className = 'success';
          isValid = !!capacitor;
        }
      } else {
        isValid = !!capacitor;
      }

      validation.innerHTML = messages.join('');
      $('electrical-btn').disabled = !isValid;
    }

    function validateRefrigerantStep() {
      let isValid = false;
      
      if (currentMode === 'cooling') {
        const suctionP = num($('suction-pressure').value);
        const liquidP = num($('liquid-pressure').value);
        const suctionT = num($('suction-temp').value);
        const liquidT = num($('liquid-temp').value);
        const refrigerant = $('refrigerant').value;

        // Calculate superheat
        if (suctionP && suctionT && refrigerant === 'R-410A') {
          const satTemp = lookupSatTemp(suctionP);
          if (satTemp) {
            const superheat = suctionT - satTemp;
            $('superheat-calc').value = superheat.toFixed(1) + '°F';
            updateSuperheatStatus(superheat);
          }
        }

        // Calculate subcool
        if (liquidP && liquidT && refrigerant === 'R-410A') {
          const satTemp = lookupSatTemp(liquidP);
          if (satTemp) {
            const subcool = satTemp - liquidT;
            $('subcool-calc').value = subcool.toFixed(1) + '°F';
            updateSubcoolStatus(subcool);
          }
        }

        isValid = suctionP && liquidP && suctionT && liquidT;
      } else {
        const gasInput = $('gas-input').value;
        const manifold = $('manifold-pressure').value;
        const heatExchanger = $('heat-exchanger').value;
        isValid = gasInput && manifold && heatExchanger;
      }

      $('refrigerant-btn').disabled = !isValid;
    }

    function updateSuperheatStatus(superheat) {
      const statusDiv = $('superheat-status');
      const calcField = $('superheat-calc');
      
      if (superheat < 5) {
        statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>Low superheat (' + superheat.toFixed(1) + '°F):</strong> Possible overcharge or TXV flooding</span></div>';
        calcField.className = 'error';
      } else if (superheat > 25) {
        statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>High superheat (' + superheat.toFixed(1) + '°F):</strong> Possible undercharge or restriction</span></div>';
        calcField.className = 'error';
      } else if (superheat >= 8 && superheat <= 18) {
        statusDiv.innerHTML = '<div class="status-message success"><span>✓</span><span><strong>Superheat optimal (' + superheat.toFixed(1) + '°F):</strong> Target range 8-18°F</span></div>';
        calcField.className = 'success';
      } else if (superheat >= 5 && superheat <= 22) {
        statusDiv.innerHTML = '<div class="status-message warning"><span>⚠️</span><span><strong>Superheat marginal (' + superheat.toFixed(1) + '°F):</strong> Monitor conditions</span></div>';
        calcField.className = 'warning';
      } else {
        statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>Superheat critical (' + superheat.toFixed(1) + '°F):</strong> Immediate attention required</span></div>';
        calcField.className = 'error';
      }
    }

    function updateSubcoolStatus(subcool) {
      const statusDiv = $('subcool-status');
      const calcField = $('subcool-calc');
      
      if (subcool < 5) {
        statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>Low subcool (' + subcool.toFixed(1) + '°F):</strong> Possible undercharge</span></div>';
        calcField.className = 'error';
      } else if (subcool > 20) {
        statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>High subcool (' + subcool.toFixed(1) + '°F):</strong> Possible overcharge or restriction</span></div>';
        calcField.className = 'error';
      } else if (subcool >= 8 && subcool <= 15) {
        statusDiv.innerHTML = '<div class="status-message success"><span>✓</span><span><strong>Subcool optimal (' + subcool.toFixed(1) + '°F):</strong> Target range 8-15°F</span></div>';
        calcField.className = 'success';
      } else if (subcool >= 5 && subcool <= 18) {
        statusDiv.innerHTML = '<div class="status-message warning"><span>⚠️</span><span><strong>Subcool marginal (' + subcool.toFixed(1) + '°F):</strong> Verify charge method</span></div>';
        calcField.className = 'warning';
      } else {
        statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>Subcool critical (' + subcool.toFixed(1) + '°F):</strong> Immediate attention required</span></div>';
        calcField.className = 'error';
      }
    }

    function validateControlsStep() {
      const thermostat = $('thermostat-comm').value;
      const returnTemp = num($('return-air-temp').value);
      const supplyTemp = num($('supply-air-temp').value);

      // Calculate Delta T
      if (returnTemp && supplyTemp) {
        const delta = currentMode === 'cooling' 
          ? returnTemp - supplyTemp 
          : supplyTemp - returnTemp;
        $('delta-t-calc').value = delta.toFixed(1) + '°F';

        const statusDiv = $('delta-t-status');
        const calcField = $('delta-t-calc');
        
        if (currentMode === 'cooling') {
          if (delta >= 16 && delta <= 22) {
            statusDiv.innerHTML = '<div class="status-message success"><span>✓</span><span><strong>Delta T optimal (' + delta.toFixed(1) + '°F):</strong> Cooling performance excellent</span></div>';
            calcField.className = 'success';
          } else if (delta < 14) {
            statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>Delta T low (' + delta.toFixed(1) + '°F):</strong> Possible overcharge, dirty coil, or excess airflow</span></div>';
            calcField.className = 'error';
          } else if (delta > 24) {
            statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>Delta T high (' + delta.toFixed(1) + '°F):</strong> Possible undercharge or restricted airflow</span></div>';
            calcField.className = 'error';
          } else {
            statusDiv.innerHTML = '<div class="status-message warning"><span>⚠️</span><span><strong>Delta T marginal (' + delta.toFixed(1) + '°F):</strong> Target range 16-22°F</span></div>';
            calcField.className = 'warning';
          }
        } else {
          if (delta >= 40 && delta <= 70) {
            statusDiv.innerHTML = '<div class="status-message success"><span>✓</span><span><strong>Delta T optimal (' + delta.toFixed(1) + '°F):</strong> Heating performance good</span></div>';
            calcField.className = 'success';
          } else if (delta < 35) {
            statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>Delta T low (' + delta.toFixed(1) + '°F):</strong> Check heat exchanger and gas input</span></div>';
            calcField.className = 'error';
          } else if (delta > 80) {
            statusDiv.innerHTML = '<div class="status-message error"><span>⚠️</span><span><strong>Delta T high (' + delta.toFixed(1) + '°F):</strong> Possible low airflow</span></div>';
            calcField.className = 'error';
          } else {
            statusDiv.innerHTML = '<div class="status-message warning"><span>⚠️</span><span><strong>Delta T marginal (' + delta.toFixed(1) + '°F):</strong> Monitor performance</span></div>';
            calcField.className = 'warning';
          }
        }
      }

      const isValid = thermostat && returnTemp && supplyTemp;
      $('controls-btn').disabled = !isValid;
    }

    function validateEnvironmentStep() {
      const evapCoil = $('evap-coil-condition').value;
      const condCoil = currentMode === 'cooling' ? $('cond-coil-condition').value : true;
      const drainage = $('drainage-condition').value;

      const isValid = evapCoil && condCoil && drainage;
      $('environment-btn').disabled = !isValid;
    }

    // ==================== STEP COMPLETION ====================
    function completeStep(step) {
      stepCompleted[step] = true;
      $(`${step}-status`).textContent = 'Complete';
      $(`${step}-status`).className = 'card-status complete';
      
      // Collapse the completed card
      $(`${step}-card`).classList.add('collapsed');
      
      updateProgress();
      saveState();

      // Scroll to next incomplete step
      const nextStep = Object.keys(stepCompleted).find(s => !stepCompleted[s]);
      if (nextStep) {
        setTimeout(() => {
          $(`${nextStep}-card`).scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      } else {
        // All steps complete, scroll to findings
        setTimeout(() => {
          $('findings-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 300);
      }
    }

    // ==================== PHOTO MANAGEMENT ====================
    function showPhotoModal() {
      $('photo-modal').classList.add('active');
    }

    function hidePhotoModal() {
      $('photo-modal').classList.remove('active');
    }

    function takePhotoAndClose(purpose) {
      hidePhotoModal();
      takePhoto(purpose);
    }

    function takePhoto(purpose) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          photos.push({
            purpose: purpose,
            data: event.target.result,
            timestamp: new Date().toISOString(),
            filename: file.name
          });
          updatePhotoPreview();
          saveState();
        };
        reader.readAsDataURL(file);
      };
      
      input.click();
    }

    function deletePhoto(index) {
      if (confirm('Delete this photo?')) {
        photos.splice(index, 1);
        updatePhotoPreview();
        saveState();
      }
    }

    function updatePhotoPreview() {
      const preview = $('photo-preview');
      if (photos.length === 0) {
        preview.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No photos yet</p>';
        return;
      }
      
      preview.innerHTML = photos.map((photo, index) => `
        <div class="photo-item" onclick="viewPhoto(${index})">
          <img src="${photo.data}" alt="${photo.purpose}">
          <div class="photo-label">${photo.purpose}</div>
          <button class="photo-delete" onclick="event.stopPropagation(); deletePhoto(${index})">×</button>
        </div>
      `).join('');
    }

    function viewPhoto(index) {
      const photo = photos[index];
      const win = window.open('', '_blank');
      win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${photo.purpose}</title>
          <style>
            body { margin: 0; display: flex; align-items: center; justify-content: center; background: #000; }
            img { max-width: 100%; max-height: 100vh; }
          </style>
        </head>
        <body>
          <img src="${photo.data}" alt="${photo.purpose}">
        </body>
        </html>
      `);
    }

    // ==================== REPORT GENERATION ====================
    function generateReport() {
      const report = gatherReportData();
      displayReport(report);
      $('export-btn').disabled = false;
      
      // Scroll to report
      setTimeout(() => {
        $('report-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
    }

    function gatherReportData() {
      return {
        timestamp: new Date().toLocaleString(),
        mode: currentMode,
        job: {
          customer: $('customer').value,
          address: $('address').value,
          complaint: $('complaint').value
        },
        equipment: {
          location: $('location').value,
          indoor: {
            brand: $('indoor-brand').value,
            model: $('indoor-model').value,
            serial: $('indoor-serial').value
          },
          outdoor: {
            brand: $('outdoor-brand').value,
            model: $('outdoor-model').value,
            serial: $('outdoor-serial').value
          },
          tonnage: $('tonnage').value,
          refrigerant: $('refrigerant').value,
          mfgDate: $('mfg-date').value,
          meteringDevice: $('metering-device').value
        },
        diagnostic: {
          power: {
            disconnect: $('disconnect-status').value,
            lineVoltage: $('voltage-line').value,
            controlVoltage: $('voltage-control').value,
            l1n: $('voltage-l1n').value,
            l2n: $('voltage-l2n').value
          },
          airflow: {
            filter: $('filter-condition').value,
            returnStatic: $('return-static').value,
            supplyStatic: $('supply-static').value,
            tesp: $('total-static').value,
            blower: $('blower-operation').value
          },
          electrical: {
            blowerAmps: $('blower-amps').value,
            compAmps: $('comp-amps').value,
            condFanAmps: $('cond-fan-amps').value,
            inducerAmps: $('inducer-amps').value,
            capacitor: $('capacitor-reading').value,
            startCapacitor: $('start-capacitor').value,
            contactor: $('contactor-condition').value
          },
          refrigerant: currentMode === 'cooling' ? {
            suctionPressure: $('suction-pressure').value,
            liquidPressure: $('liquid-pressure').value,
            suctionTemp: $('suction-temp').value,
            liquidTemp: $('liquid-temp').value,
            superheat: $('superheat-calc').value,
            subcool: $('subcool-calc').value,
            outdoorDB: $('outdoor-dry-bulb').value,
            outdoorWB: $('outdoor-wet-bulb').value,
            indoorDB: $('indoor-dry-bulb').value,
            indoorWB: $('indoor-wet-bulb').value
          } : {
            gasInput: $('gas-input').value,
            manifoldPressure: $('manifold-pressure').value,
            heatExchanger: $('heat-exchanger').value,
            flameSensor: $('flame-sensor').value
          },
          controls: {
            thermostat: $('thermostat-comm').value,
            returnAirTemp: $('return-air-temp').value,
            supplyAirTemp: $('supply-air-temp').value,
            deltaT: $('delta-t-calc').value
          },
          environment: {
            outdoorTemp: $('outdoor-temp').value,
            outdoorHumidity: $('outdoor-humidity').value,
            evapCoil: $('evap-coil-condition').value,
            condCoil: $('cond-coil-condition').value,
            drainage: $('drainage-condition').value,
            trap: $('trap-condition').value,
            ductwork: $('ductwork').value,
            siteIssues: $('site-issues').value
          }
        },
        findings: {
          diagnosis: $('diagnosis').value,
          repairs: $('repairs').value,
          preventive: $('preventive').value,
          notes: $('additional-notes').value
        },
        photos: photos,
        completedSteps: Object.values(stepCompleted).filter(Boolean).length
      };
    }

    function displayReport(report) {
      const reportHTML = `
        <div class="card" style="background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white;">
          <div style="text-align: center;">
            <h2 style="margin-bottom: 8px; font-size: 24px;">HVAC Diagnostic Report</h2>
            <div style="font-size: 14px; opacity: 0.9;">Professional Service Documentation</div>
            <div style="font-size: 13px; opacity: 0.8; margin-top: 12px;">Generated: ${report.timestamp}</div>
          </div>
        </div>

        <div class="card">
          <div class="report-section">
            <h3>Service Information</h3>
            <div class="report-row">
              <span class="report-label">Customer:</span>
              <span class="report-value">${report.job.customer}</span>
            </div>
            <div class="report-row">
              <span class="report-label">Address:</span>
              <span class="report-value">${report.job.address}</span>
            </div>
            <div class="report-row">
              <span class="report-label">Mode:</span>
              <span class="report-value">${report.mode.charAt(0).toUpperCase() + report.mode.slice(1)}</span>
            </div>
            ${report.job.complaint ? `
            <div class="report-row">
              <span class="report-label">Complaint:</span>
              <span class="report-value">${report.job.complaint}</span>
            </div>
            ` : ''}
          </div>
        </div>

        <div class="card">
          <div class="report-section">
            <h3>Equipment Information</h3>
            ${report.equipment.location ? `
            <div class="report-row">
              <span class="report-label">Location:</span>
              <span class="report-value">${report.equipment.location}</span>
            </div>
            ` : ''}
            <div class="report-row">
              <span class="report-label">Indoor Unit:</span>
              <span class="report-val<span class="report-value">${report.equipment.indoor.serial}</span>
            </div>
            <div class="report-row">
              <span class="report-label">Outdoor Unit:</span>
              <span class="report-value">${report.equipment.outdoor.brand} ${report.equipment.outdoor.model}</span>
            </div>
            <div class="report-row">
              <span class="report-label">Outdoor S/N:</span>
              <span class="report-value">${report.equipment.outdoor.serial}</span>
            </div>
            <div class="report-row">
              <span class="report-label">Tonnage:</span>
              <span class="report-value">${report.equipment.tonnage} Ton</span>
            </div>
            <div class="report-row">
              <span class="report-label">Refrigerant:</span>
              <span class="report-value">${report.equipment.refrigerant}</span>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="report-section">
            <h3>Diagnostic Results</h3>
            <div class="status-message ${report.completedSteps === 6 ? 'success' : 'warning'}">
              <span>${report.completedSteps === 6 ? '✓' : '⚠️'}</span>
              <span>Diagnostic Completion: ${report.completedSteps}/6 steps</span>
            </div>

            <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--text);">Power Verification</h4>
            <div class="report-row">
              <span class="report-label">Disconnect Status:</span>
              <span class="report-value">${report.diagnostic.power.disconnect || 'N/A'}</span>
            </div>
            <div class="report-row">
              <span class="report-label">Line Voltage:</span>
              <span class="report-value">${report.diagnostic.power.lineVoltage ? report.diagnostic.power.lineVoltage + 'V' : 'N/A'}</span>
            </div>
            ${report.diagnostic.power.controlVoltage ? `
            <div class="report-row">
              <span class="report-label">Control Voltage:</span>
              <span class="report-value">${report.diagnostic.power.controlVoltage}V</span>
            </div>
            ` : ''}

            <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--text);">Airflow Assessment</h4>
            <div class="report-row">
              <span class="report-label">Filter Condition:</span>
              <span class="report-value">${report.diagnostic.airflow.filter || 'N/A'}</span>
            </div>
            ${report.diagnostic.airflow.tesp ? `
            <div class="report-row">
              <span class="report-label">Total Static Pressure:</span>
              <span class="report-value">${report.diagnostic.airflow.tesp}</span>
            </div>
            ` : ''}
            <div class="report-row">
              <span class="report-label">Blower Status:</span>
              <span class="report-value">${report.diagnostic.airflow.blower || 'N/A'}</span>
            </div>

            <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--text);">Electrical Components</h4>
            ${report.diagnostic.electrical.capacitor ? `
            <div class="report-row">
              <span class="report-label">Run Capacitor:</span>
              <span class="report-value">${report.diagnostic.electrical.capacitor}</span>
            </div>
            ` : ''}
            ${report.diagnostic.electrical.contactor ? `
            <div class="report-row">
              <span class="report-label">Contactor:</span>
              <span class="report-value">${report.diagnostic.electrical.contactor}</span>
            </div>
            ` : ''}
            ${report.diagnostic.electrical.blowerAmps ? `
            <div class="report-row">
              <span class="report-label">Blower Amps:</span>
              <span class="report-value">${report.diagnostic.electrical.blowerAmps}</span>
            </div>
            ` : ''}
            ${report.diagnostic.electrical.compAmps ? `
            <div class="report-row">
              <span class="report-label">Compressor Amps:</span>
              <span class="report-value">${report.diagnostic.electrical.compAmps}</span>
            </div>
            ` : ''}

            <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--text);">${report.mode === 'cooling' ? 'Refrigerant Circuit' : 'Heating System'}</h4>
            ${report.mode === 'cooling' ? `
              ${report.diagnostic.refrigerant.suctionPressure ? `
              <div class="report-row">
                <span class="report-label">Suction Pressure:</span>
                <span class="report-value">${report.diagnostic.refrigerant.suctionPressure} psig</span>
              </div>
              ` : ''}
              ${report.diagnostic.refrigerant.liquidPressure ? `
              <div class="report-row">
                <span class="report-label">Liquid Pressure:</span>
                <span class="report-value">${report.diagnostic.refrigerant.liquidPressure} psig</span>
              </div>
              ` : ''}
              ${report.diagnostic.refrigerant.superheat ? `
              <div class="report-row">
                <span class="report-label">Superheat:</span>
                <span class="report-value">${report.diagnostic.refrigerant.superheat}</span>
              </div>
              ` : ''}
              ${report.diagnostic.refrigerant.subcool ? `
              <div class="report-row">
                <span class="report-label">Subcool:</span>
                <span class="report-value">${report.diagnostic.refrigerant.subcool}</span>
              </div>
              ` : ''}
            ` : `
              ${report.diagnostic.refrigerant.gasInput ? `
              <div class="report-row">
                <span class="report-label">Gas Input:</span>
                <span class="report-value">${report.diagnostic.refrigerant.gasInput} BTU/hr</span>
              </div>
              ` : ''}
              ${report.diagnostic.refrigerant.manifoldPressure ? `
              <div class="report-row">
                <span class="report-label">Manifold Pressure:</span>
                <span class="report-value">${report.diagnostic.refrigerant.manifoldPressure} in w.c.</span>
              </div>
              ` : ''}
              ${report.diagnostic.refrigerant.heatExchanger ? `
              <div class="report-row">
                <span class="report-label">Heat Exchanger:</span>
                <span class="report-value">${report.diagnostic.refrigerant.heatExchanger}</span>
              </div>
              ` : ''}
            `}

            <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--text);">Controls & System Response</h4>
            ${report.diagnostic.controls.thermostat ? `
            <div class="report-row">
              <span class="report-label">Thermostat:</span>
              <span class="report-value">${report.diagnostic.controls.thermostat}</span>
            </div>
            ` : ''}
            ${report.diagnostic.controls.deltaT ? `
            <div class="report-row">
              <span class="report-label">Delta T:</span>
              <span class="report-value">${report.diagnostic.controls.deltaT}</span>
            </div>
            ` : ''}

            <h4 style="margin-top: 20px; margin-bottom: 10px; color: var(--text);">Environmental Conditions</h4>
            ${report.diagnostic.environment.evapCoil ? `
            <div class="report-row">
              <span class="report-label">Evaporator Coil:</span>
              <span class="report-value">${report.diagnostic.environment.evapCoil}</span>
            </div>
            ` : ''}
            ${report.diagnostic.environment.condCoil ? `
            <div class="report-row">
              <span class="report-label">Condenser Coil:</span>
              <span class="report-value">${report.diagnostic.environment.condCoil}</span>
            </div>
            ` : ''}
            ${report.diagnostic.environment.drainage ? `
            <div class="report-row">
              <span class="report-label">Drainage System:</span>
              <span class="report-value">${report.diagnostic.environment.drainage}</span>
            </div>
            ` : ''}
          </div>
        </div>

        <div class="card">
          <div class="report-section">
            <h3>Diagnosis & Recommendations</h3>
            <h4 style="margin-bottom: 10px; color: var(--text);">Diagnosis:</h4>
            <p style="margin-bottom: 20px; line-height: 1.6;">${report.findings.diagnosis}</p>
            
            <h4 style="margin-bottom: 10px; color: var(--text);">Recommended Repairs:</h4>
            <p style="margin-bottom: 20px; line-height: 1.6;">${report.findings.repairs}</p>
            
            ${report.findings.preventive ? `
            <h4 style="margin-bottom: 10px; color: var(--text);">Preventive Measures:</h4>
            <p style="margin-bottom: 20px; line-height: 1.6;">${report.findings.preventive}</p>
            ` : ''}
            
            ${report.findings.notes ? `
            <h4 style="margin-bottom: 10px; color: var(--text);">Additional Notes:</h4>
            <p style="line-height: 1.6;">${report.findings.notes}</p>
            ` : ''}
          </div>
        </div>

        ${report.photos.length > 0 ? `
        <div class="card">
          <div class="report-section">
            <h3>Photo Documentation (${report.photos.length})</h3>
            <div class="photo-grid">
              ${report.photos.map((photo, i) => `
                <div class="photo-item" onclick="viewPhoto(${i})">
                  <img src="${photo.data}" alt="${photo.purpose}">
                  <div class="photo-label">${photo.purpose}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
        ` : ''}

        <div class="card" style="text-align: center; border: 2px solid var(--primary);">
          <h3 style="color: var(--primary); margin-bottom: 16px;">Technician Certification</h3>
          <p style="margin-bottom: 24px; color: var(--text-muted);">
            I certify that this diagnostic was performed following industry best practices
            and all findings are accurate to the best of my knowledge.
          </p>
          <div style="border-top: 2px solid var(--border); margin: 32px auto 12px; width: 250px;"></div>
          <div style="font-size: 13px; color: var(--text-muted);">Technician Signature & Date</div>
        </div>
      `;

      $('report-container').innerHTML = reportHTML;
      sessionStorage.setItem('hvacReport', JSON.stringify(report));
    }

    function exportReport() {
      const report = JSON.parse(sessionStorage.getItem('hvacReport'));
      if (!report) return;

      const text = generateTextReport(report);
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `HVAC_Report_${report.job.customer.replace(/\s/g, '_')}_${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function generateTextReport(report) {
      return `
HVAC DIAGNOSTIC REPORT
=====================
Generated: ${report.timestamp}
Mode: ${report.mode.toUpperCase()}

SERVICE INFORMATION
------------------
Customer: ${report.job.customer}
Address: ${report.job.address}
${report.job.complaint ? `Complaint: ${report.job.complaint}` : ''}

EQUIPMENT INFORMATION
--------------------
${report.equipment.location ? `Location: ${report.equipment.location}` : ''}
Indoor Unit: ${report.equipment.indoor.brand} ${report.equipment.indoor.model}
Indoor S/N: ${report.equipment.indoor.serial}
Outdoor Unit: ${report.equipment.outdoor.brand} ${report.equipment.outdoor.model}
Outdoor S/N: ${report.equipment.outdoor.serial}
Tonnage: ${report.equipment.tonnage} Ton
Refrigerant: ${report.equipment.refrigerant}

DIAGNOSTIC RESULTS
-----------------
Completion: ${report.completedSteps}/6 steps

Power Verification:
- Disconnect: ${report.diagnostic.power.disconnect || 'N/A'}
- Line Voltage: ${report.diagnostic.power.lineVoltage ? report.diagnostic.power.lineVoltage + 'V' : 'N/A'}

Airflow Assessment:
- Filter: ${report.diagnostic.airflow.filter || 'N/A'}
- TESP: ${report.diagnostic.airflow.tesp || 'N/A'}
- Blower: ${report.diagnostic.airflow.blower || 'N/A'}

Electrical Components:
- Capacitor: ${report.diagnostic.electrical.capacitor || 'N/A'}
- Contactor: ${report.diagnostic.electrical.contactor || 'N/A'}

${report.mode === 'cooling' ? `Refrigerant Circuit:
- Suction Pressure: ${report.diagnostic.refrigerant.suctionPressure || 'N/A'} psig
- Liquid Pressure: ${report.diagnostic.refrigerant.liquidPressure || 'N/A'} psig
- Superheat: ${report.diagnostic.refrigerant.superheat || 'N/A'}
- Subcool: ${report.diagnostic.refrigerant.subcool || 'N/A'}` : `Heating System:
- Gas Input: ${report.diagnostic.refrigerant.gasInput || 'N/A'} BTU/hr
- Manifold Pressure: ${report.diagnostic.refrigerant.manifoldPressure || 'N/A'} in w.c.
- Heat Exchanger: ${report.diagnostic.refrigerant.heatExchanger || 'N/A'}`}

Controls:
- Thermostat: ${report.diagnostic.controls.thermostat || 'N/A'}
- Delta T: ${report.diagnostic.controls.deltaT || 'N/A'}

Environment:
- Evaporator Coil: ${report.diagnostic.environment.evapCoil || 'N/A'}
- Condenser Coil: ${report.diagnostic.environment.condCoil || 'N/A'}
- Drainage: ${report.diagnostic.environment.drainage || 'N/A'}

DIAGNOSIS & RECOMMENDATIONS
--------------------------
Diagnosis:
${report.findings.diagnosis}

Recommended Repairs:
${report.findings.repairs}

${report.findings.preventive ? `Preventive Measures:
${report.findings.preventive}` : ''}

${report.findings.notes ? `Additional Notes:
${report.findings.notes}` : ''}

Photos: ${report.photos.length} attached

---
Technician Signature: _______________________  Date: __________
      `.trim();
    }

    // ==================== STATE PERSISTENCE ====================
    function saveState() {
      const state = {
        mode: currentMode,
        stepCompleted: stepCompleted,
        photos: photos,
        formData: {}
      };

      // Save all form values
      document.querySelectorAll('input, select, textarea').forEach(el => {
        if (el.id && el.type !== 'file' && el.type !== 'checkbox') {
          state.formData[el.id] = el.value;
        } else if (el.id && el.type === 'checkbox') {
          state.formData[el.id] = el.checked;
        }
      });

      localStorage.setItem('hvacDiagnosticState', JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem('hvacDiagnosticState');
      if (!saved) return;

      try {
        const state = JSON.parse(saved);
        
        // Restore mode
        if (state.mode) setMode(state.mode);
        
        // Restore step completion
        if (state.stepCompleted) {
          stepCompleted = state.stepCompleted;
          Object.keys(stepCompleted).forEach(step => {
            if (stepCompleted[step]) {
              $(`${step}-status`).textContent = 'Complete';
              $(`${step}-status`).className = 'card-status complete';
              $(`${step}-card`).classList.add('collapsed');
            }
          });
        }
        
        // Restore photos
        if (state.photos) {
          photos = state.photos;
          updatePhotoPreview();
        }
        
        // Restore form data
        if (state.formData) {
          Object.keys(state.formData).forEach(id => {
            const el = $(id);
            if (el) {
              if (el.type === 'checkbox') {
                el.checked = state.formData[id];
              } else {
                el.value = state.formData[id];
              }
            }
          });
        }
        
        updateProgress();
      } catch (e) {
        console.error('Error loading state:', e);
      }
    }

    function clearState() {
      if (confirm('Clear all diagnostic data and start fresh?')) {
        localStorage.removeItem('hvacDiagnosticState');
        sessionStorage.removeItem('hvacReport');
        location.reload();
      }
    }

    // ==================== INITIALIZATION ====================
    window.addEventListener('load', () => {
      // Load saved state
      loadState();
      
      // Initialize photo preview
      updatePhotoPreview();
      
      // Run initial validations
      validatePowerStep();
      validateAirflowStep();
      validateElectricalStep();
      validateRefrigerantStep();
      validateControlsStep();
      validateEnvironmentStep();
      
      console.log('HVAC Pro Diagnostic loaded successfully');
    });

    // Warn before leaving if there's unsaved work
    window.addEventListener('beforeunload', (e) => {
      const hasData = $('customer').value || $('address').value || photos.length > 0;
      if (hasData && !sessionStorage.getItem('hvacReport')) {
        e.preventDefault();
        e.returnValue = 'You have unsaved diagnostic data. Are you sure you want to leave?';
        return e.returnValue;
      }
    });

    // Card header click to toggle collapse/expand
    document.addEventListener('click', (e) => {
      const header = e.target.closest('.card-header');
      if (header && !e.target.classList.contains('card-status')) {
        const card = header.closest('.card');
        if (card && (card.id === 'job-card' || card.id === 'equipment-card' || 
            card.id === 'findings-card' || card.id === 'photos-card' ||
            stepCompleted[card.id.replace('-card', '')])) {
          card.classList.toggle('collapsed');
        }
      }
    });

    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + S to save/generate report
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (!$('generate-report-btn').disabled) {
          generateReport();
        }
      }
      
      // Ctrl/Cmd + P to take photo
      if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        showPhotoModal();
      }
    });

    // Auto-save on input changes
    document.addEventListener('input', saveState);
    document.addEventListener('change', saveState);

    // Expose functions for debugging
    window.hvacDebug = {
      clearState,
      saveState,
      loadState,
      getState: () => stepCompleted,
      getPhotos: () => photos
    };
  </script>
</body>
</html>
