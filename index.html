
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
  <title>FieldBuddy Advanced‚Ñ¢ - Fidelity Diagnostic Engine</title>
  <style>
    /* NOTE: All CSS is retained from your draft, as it was excellent. */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --fidelity-blue: #1e3a8a;
      --fidelity-light: #3b82f6;
      --success-green: #059669;
      --warning-amber: #d97706;
      --error-red: #dc2626;
      --neutral-gray: #6b7280;
      --bg-light: #f8fafc;
      --card-white: #ffffff;
      --text-dark: #1f2937;
      --border-light: #e5e7eb;
    }
    
    body { 
      font: 16px -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      padding: 8px;
      padding-bottom: 100px;
      line-height: 1.5;
    }
    
    /* Header with FMS branding */
    .header {
      background: linear-gradient(135deg, var(--fidelity-blue), var(--fidelity-light));
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      text-align: center;
      position: relative;
    }
    
    .header h1 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .header .tagline { font-size: 13px; opacity: 0.9; }
    .header .mode-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255,255,255,0.2);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    
    /* Diagnostic progress indicator */
    .progress-bar {
      background: var(--card-white);
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .step {
      flex: 1;
      text-align: center;
      padding: 8px 4px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      position: relative;
    }
    
    .step.active { background: var(--fidelity-light); color: white; }
    .step.complete { background: var(--success-green); color: white; }
    .step.pending { background: var(--border-light); color: var(--neutral-gray); }
    .step.warning { background: var(--warning-amber); color: white; }
    
    .progress-line {
      height: 3px;
      background: var(--border-light);
      border-radius: 2px;
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success-green), var(--fidelity-light));
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    /* Enhanced input styling */
    input, select, textarea, button {
      font-size: 16px;
      padding: 14px;
      border: 2px solid var(--border-light);
      border-radius: 8px;
      width: 100%;
      margin: 6px 0;
      font-family: inherit;
      transition: all 0.2s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--fidelity-light);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    button {
      background: var(--fidelity-blue);
      color: white;
      font-weight: 600;
      border: none;
      min-height: 48px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    button.secondary { background: var(--neutral-gray); }
    button.danger { background: var(--error-red); }
    button.success { background: var(--success-green); }
    button.warning { background: var(--warning-amber); }
    
    /* Enhanced card system */
    .card {
      background: var(--card-white);
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid var(--border-light);
      position: relative;
    }
    
    .card.locked {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .card.locked::before {
      content: "üîí Complete previous steps";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      z-index: 10;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--border-light);
    }
    
    .card-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: 600;
    }
    
    .card-status.complete { background: #dcfce7; color: #166534; }
    .card-status.warning { background: #fef3c7; color: #92400e; }
    .card-status.error { background: #fecaca; color: #991b1b; }
    
    /* Grid layouts */
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    
    /* Status indicators with enhanced styling */
    .status {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      margin: 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      border-left: 4px solid;
    }
    
    .status.good { 
      background: #f0fdf4; color: #166534; border-left-color: #22c55e;
    }
    .status.warn { 
      background: #fffbeb; color: #92400e; border-left-color: #f59e0b;
    }
    .status.bad { 
      background: #fef2f2; color: #991b1b; border-left-color: #ef4444;
    }
    .status.info { 
      background: #eff6ff; color: #1e40af; border-left-color: #3b82f6;
    }
    
    /* AI Coach integration */
    .ai-coach {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin: 16px 0;
      position: relative;
    }
    
    .ai-coach-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .ai-coach-content {
      font-size: 14px;
      line-height: 1.5;
    }
    
    .ai-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .ai-actions button {
      background: rgba(255,255,255,0.2);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      font-size: 12px;
      padding: 6px 12px;
      min-height: auto;
    }
    
    /* Voice interface enhancement */
    .voice-wrapper {
      position: relative;
    }
    
    .voice-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 36px;
      height: 36px;
      padding: 0;
      background: var(--fidelity-light);
      border-radius: 50%;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: auto;
      z-index: 5;
    }
    
    .voice-btn.listening { 
      background: var(--error-red);
      animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: translateY(-50%) scale(1); }
      50% { transform: translateY(-50%) scale(1.1); }
    }
    
    /* Enhanced photo system */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      margin: 12px 0;
    }
    
    .photo-item {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      aspect-ratio: 1;
      background: var(--border-light);
    }
    
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .photo-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 8px 6px 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    /* Sticky action bar enhancement */
    .actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 16px;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
    }
    
    .actions button {
      flex: 1;
    }
    
    /* Field validation styling */
    input.error, select.error, textarea.error {
      border-color: var(--error-red);
      background-color: #fef2f2;
    }
    
    input.success, select.success, textarea.success {
      border-color: var(--success-green);
      background-color: #f0fdf4;
    }
    
    .field-feedback {
      font-size: 12px;
      margin-top: 4px;
      font-weight: 500;
    }
    
    .field-feedback.error { color: var(--error-red); }
    .field-feedback.success { color: var(--success-green); }
    .field-feedback.warning { color: var(--warning-amber); }
    
    /* Label enhancements */
    label {
      display: block;
      font-size: 13px;
      color: var(--neutral-gray);
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    label.required::after {
      content: " *";
      color: var(--error-red);
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .grid { grid-template-columns: 1fr; }
      .progress-steps { flex-wrap: wrap; }
      .step { margin-bottom: 4px; }
    }
    
    /* Hide mode-specific sections */
    .cooling-only, .heating-only { display: none; }
    body.mode-cooling .cooling-only { display: block; }
    body.mode-heating .heating-only { display: block; }
    
    /* Loading states */
    .loading {
      position: relative;
      pointer-events: none;
    }
    
    .loading::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid var(--border-light);
      border-radius: 50%;
      border-top-color: var(--fidelity-light);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="mode-cooling">

  <div class="header">
    <div class="mode-badge" id="mode-indicator">COOLING MODE</div>
    <h1>FieldBuddy Advanced‚Ñ¢</h1>
    <div class="tagline">Fidelity Mechanical Solutions ‚Ä¢ Diagnostic Engine</div>
  </div>

  <div class="progress-bar">
    <div class="progress-steps">
      <div class="step active" data-step="setup">SETUP</div>
      <div class="step pending" data-step="equipment">EQUIPMENT</div>
      <div class="step pending" data-step="power">POWER</div>
      <div class="step pending" data-step="airflow">AIRFLOW</div>
      <div class="step pending" data-step="electrical">ELECTRICAL</div>
      <div class="step pending" data-step="refrigerant">REFRIGERANT</div>
      <div class="step pending" data-step="controls">CONTROLS</div>
      <div class="step pending" data-step="environment">ENVIRONMENT</div>
    </div>
    <div class="progress-line">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <div style="font-size: 12px; color: var(--neutral-gray); margin-top: 8px; text-align: center;">
      FMS Diagnostic Method Progress: <span id="progress-text">0/6 Complete</span>
    </div>
  </div>

  <div class="ai-coach" id="ai-coach" style="display: none;" role="alert">
    <div class="ai-coach-header">
      <span>ü§ñ</span>
      <span>FieldBuddy AI Coach</span>
    </div>
    <div class="ai-coach-content" id="ai-message">
      Welcome to your diagnostic session. Remember: Power before panic. Let's start with power verification.
    </div>
    <div class="ai-actions">
      <button onclick="dismissCoach()">Got it</button>
      <button onclick="askCoach()">Ask Question</button>
    </div>
  </div>

  <div class="card" id="setup-card" data-step="setup">
    <div class="card-header">
      Job Setup
      <div class="card-status" id="setup-status">Pending</div>
    </div>
    <label class="required">Customer Name</label>
    <input type="text" id="customer" placeholder="Customer name" required oninput="validateSetupStep()">
    <div class="field-feedback" id="customer-feedback"></div>
    
    <label class="required">Service Address</label>
    <input type="text" id="address" placeholder="Service address" required oninput="validateSetupStep()">
    <div class="field-feedback" id="address-feedback"></div>
    
    <label>Customer Complaint</label>
    <div class="voice-wrapper">
      <textarea id="complaint" placeholder="Customer complaint (in their words)" rows="2" oninput="validateSetupStep()"></textarea>
      <button class="voice-btn" data-voice="complaint" aria-label="Record customer complaint">üé§</button>
    </div>
    <div class="field-feedback" id="complaint-feedback"></div>
    
    <button onclick="completeSetupStep()" id="setup-complete-btn" class="success" disabled style="margin-top: 16px;">
      ‚úì Confirm Job Setup
    </button>
  </div>

  <div class="card locked" id="equipment-card" data-step="equipment">
    <div class="card-header">
      Equipment Identity
      <div class="card-status" id="equipment-status">Locked</div>
    </div>
    
    <label>Equipment Location</label>
    <input type="text" id="location" placeholder="e.g., Attic above master bedroom" oninput="validateEquipmentStep()">
    
    <label class="required">Indoor Unit Data</label>
    <div class="voice-wrapper">
      <input type="text" id="indoor-data" placeholder="Brand/Model/Serial - speak or scan nameplate" required oninput="validateEquipmentStep()">
      <button class="voice-btn" data-voice="indoor-data" aria-label="Record indoor unit data">üé§</button>
    </div>
    <div class="field-feedback" id="indoor-data-feedback"></div>
    
    <label class="required">Outdoor Unit Data</label>
    <div class="voice-wrapper">
      <input type="text" id="outdoor-data" placeholder="Brand/Model/Serial - speak or scan nameplate" required oninput="validateEquipmentStep()">
      <button class="voice-btn" data-voice="outdoor-data" aria-label="Record outdoor unit data">üé§</button>
    </div>
    <div class="field-feedback" id="outdoor-data-feedback"></div>
    
    <label>Manufacture Date</label>
    <input type="date" id="mfg-date" oninput="validateEquipmentStep()">
    
    <label class="required">Refrigerant Type</label>
    <select id="refrigerant" required onchange="validateEquipmentStep()">
      <option value="">Select refrigerant type...</option>
      <option value="R-410A">R-410A</option>
      <option value="R-22">R-22 (Legacy)</option>
      <option value="R-32">R-32</option>
      <option value="R-134A">R-134A</option>
    </select>
    <div class="field-feedback" id="refrigerant-feedback"></div>
    
    <div style="margin-top: 16px;">
      <label>Operating Mode</label>
      <div class="grid">
        <button onclick="setMode('cooling')" id="btn-cooling">‚ùÑÔ∏è Cooling Mode</button>
        <button onclick="setMode('heating')" id="btn-heating" class="secondary">üî• Heating Mode</button>
      </div>
    </div>
    
    <button onclick="completeEquipmentStep()" id="equipment-complete-btn" class="success" disabled style="margin-top: 16px;">
      ‚úì Confirm Equipment Data - Start Diagnostics
    </button>
  </div>

  <div class="card locked" data-step="power" id="power-card">
    <div class="card-header">
      Step 1: Power Verification
      <div class="card-status" id="power-status">Locked</div>
    </div>
    
    <div class="status info">
      <span>‚ö°</span>
      FMS Method: Always verify power before proceeding. No testing on unpowered systems.
    </div>
    
    <label>Disconnect Present & Functional</label>
    <select id="disconnect-status" onchange="validatePowerStep()">
      <option value="">Check disconnect...</option>
      <option value="present">Present and functional</option>
      <option value="missing">Missing or non-functional</option>
      <option value="bypassed">Bypassed - SAFETY CONCERN</option>
    </select>
    
    <div class="grid">
      <div>
        <label class="required">Line Voltage (L1-L2)</label>
        <input type="number" id="voltage-line" placeholder="208-240V typical" step="0.1" required onchange="validatePowerStep()">
      </div>
      <div>
        <label>Control Voltage (24V)</label>
        <input type="number" id="voltage-control" placeholder="18-30V range" step="0.1" onchange="validatePowerStep()">
      </div>
    </div>
    
    <div class="grid">
      <div>
        <label>Voltage L1-N</label>
        <input type="number" id="voltage-l1n" step="0.1" onchange="validatePowerStep()">
      </div>
      <div>
        <label>Voltage L2-N</label>
        <input type="number" id="voltage-l2n" step="0.1" onchange="validatePowerStep()">
      </div>
    </div>
    
    <div id="power-validation" role="alert"></div>
    
    <button onclick="completePowerStep()" id="power-complete-btn" class="success" disabled>
      ‚úì Power Verified - Proceed to Airflow
    </button>
  </div>

  <div class="card locked" data-step="airflow" id="airflow-card">
    <div class="card-header">
      Step 2: Airflow Verification
      <div class="card-status" id="airflow-status">Locked</div>
    </div>
    
    <div class="status info">
      <span>üí®</span>
      FMS Method: Never skip airflow verification. No refrigerant testing until airflow is confirmed.
    </div>
    
    <label class="required">Filter Condition</label>
    <select id="filter-condition" onchange="validateAirflowStep()" required>
      <option value="">Assess filter...</option>
      <option value="clean">Clean - good airflow</option>
      <option value="light-dust">Light dust - acceptable</option>
      <option value="dirty">Dirty - restricting airflow</option>
      <option value="blocked">Severely blocked - major restriction</option>
      <option value="missing">Missing filter</option>
    </select>
    
    <div class="grid">
      <div>
        <label>Return Static Pressure</label>
        <input type="number" id="return-static" placeholder="-0.1 to -0.3 typical" step="0.01" onchange="validateAirflowStep()">
      </div>
      <div>
        <label>Supply Static Pressure</label>
        <input type="number" id="supply-static" placeholder="0.2 to 0.5 typical" step="0.01" onchange="validateAirflowStep()">
      </div>
    </div>
    
    <label>Total External Static Pressure</label>
    <input type="text" id="total-static" readonly>
    
    <label>Blower Operation</label>
    <select id="blower-operation" onchange="validateAirflowStep()">
      <option value="">Check blower...</option>
      <option value="normal">Normal operation - good airflow</option>
      <option value="reduced">Reduced airflow - possible restriction</option>
      <option value="noisy">Noisy operation</option>
      <option value="failed">Not operating</option>
    </select>
    
    <div id="airflow-validation" role="alert"></div>
    
    <button onclick="completeAirflowStep()" id="airflow-complete-btn" class="success" disabled>
      ‚úì Airflow Verified - Proceed to Electrical
    </button>
  </div>

  <div class="card locked" data-step="electrical" id="electrical-card">
    <div class="card-header">
      Step 3: Electrical Components
      <div class="card-status" id="electrical-status">Locked</div>
    </div>
    
    <div class="status info">
      <span>‚ö°</span>
      FMS Method: Verify electrical components under load when possible.
    </div>
    
    <div class="grid">
      <div>
        <label>Blower Motor Amps</label>
        <input type="text" id="blower-amps" placeholder="Actual/Rated (e.g., 8.2/10.0)" onchange="validateElectricalStep()">
      </div>
      <div class="cooling-only">
        <label>Compressor Amps</label>
        <input type="text" id="comp-amps" placeholder="Actual/Rated" onchange="validateElectricalStep()">
      </div>
      <div class="heating-only">
        <label>Inducer Motor Amps</label>
        <input type="number" id="inducer-amps" step="0.1" onchange="validateElectricalStep()">
      </div>
    </div>
    
    <div class="cooling-only">
      <label>Condenser Fan Motor Amps</label>
      <input type="number" id="cond-fan-amps" step="0.1" onchange="validateElectricalStep()">
    </div>
    
    <label class="required">Capacitor Condition</label>
    <div class="voice-wrapper">
      <input type="text" id="capacitor-reading" placeholder="Measured ¬µF vs rated ¬µF" required onchange="validateElectricalStep()">
      <button class="voice-btn" data-voice="capacitor-reading" aria-label="Record capacitor reading">üé§</button>
    </div>
    
    <label>Contactor Condition</label>
    <select id="contactor-condition" onchange="validateElectricalStep()">
      <option value="">Inspect contactor...</option>
      <option value="excellent">Excellent - clean contacts</option>
      <option value="good">Good - light wear</option>
      <option value="fair">Fair - moderate pitting</option>
      <option value="poor">Poor - heavy pitting, recommend replacement</option>
      <option value="failed">Failed - burned/welded contacts</option>
    </select>
    
    <div id="electrical-validation" role="alert"></div>
    
    <button onclick="completeElectricalStep()" id="electrical-complete-btn" class="success" disabled>
      ‚úì Electrical Verified - Proceed to Refrigerant
    </button>
  </div>

  <div class="card locked" data-step="refrigerant" id="refrigerant-card">
    <div class="card-header">
      Step 4: Refrigerant Circuit
      <div class="card-status" id="refrigerant-status">Locked</div>
    </div>
    
    <div class="status info">
      <span>‚ùÑÔ∏è</span>
      FMS Method: Only after airflow is confirmed. Always measure superheat AND subcool.
    </div>
    
    <div id="refrigerant-validation" role="alert"></div>
    
    <div class="cooling-only">
      <div class="grid">
        <div>
          <label class="required">Suction Pressure (psig)</label>
          <input type="number" id="suction-pressure" step="0.1" required onchange="validateRefrigerantStep()">
        </div>
        <div>
          <label class="required">Liquid Pressure (psig)</label>
          <input type="number" id="liquid-pressure" step="0.1" required onchange="validateRefrigerantStep()">
        </div>
      </div>
      
      <div class="grid">
        <div>
          <label class="required">Suction Line Temperature</label>
          <input type="number" id="suction-temp" step="0.1" required onchange="validateRefrigerantStep()">
        </div>
        <div>
          <label class="required">Liquid Line Temperature</label>
          <input type="number" id="liquid-temp" step="0.1" required onchange="validateRefrigerantStep()">
        </div>
      </div>
      
      <div class="grid">
        <div>
          <label>Superheat (calculated)</label>
          <input type="text" id="superheat-calc" readonly>
        </div>
        <div>
          <label>Subcool (calculated)</label>
          <input type="text" id="subcool-calc" readonly>
        </div>
      </div>
      
      <div id="superheat-status"></div>
      <div id="subcool-status"></div>
    </div>
    
    <div class="heating-only">
      <div class="grid">
        <div>
          <label class="required">Gas Input (BTU/hr)</label>
          <input type="number" id="gas-input" required onchange="validateRefrigerantStep()">
        </div>
        <div>
          <label class="required">Manifold Pressure (in w.c.)</label>
          <input type="number" id="manifold-pressure" step="0.1" required onchange="validateRefrigerantStep()">
        </div>
      </div>
      
      <label class="required">Heat Exchanger Condition</label>
      <select id="heat-exchanger" required onchange="validateRefrigerantStep()">
        <option value="">Inspect heat exchanger...</option>
        <option value="clean">Clean - no restrictions</option>
        <option value="light-buildup">Light buildup</option>
        <option value="restricted">Restricted - needs cleaning</option>
        <option value="cracked">Cracked - safety concern</option>
      </select>
    </div>
    
    <button onclick="completeRefrigerantStep()" id="refrigerant-complete-btn" class="success" disabled>
      ‚úì Refrigerant Verified - Proceed to Controls
    </button>
  </div>

  <div class="card locked" data-step="controls" id="controls-card">
    <div class="card-header">
      Step 5: Controls & Sensors
      <div class="card-status" id="controls-status">Locked</div>
    </div>
    
    <div class="status info">
      <span>üéõÔ∏è</span>
      FMS Method: Verify system response matches expected behavior.
    </div>
    
    <label class="required">Thermostat Communication</label>
    <select id="thermostat-comm" required onchange="validateControlsStep()">
      <option value="">Test thermostat...</option>
      <option value="normal">Normal - responds to calls</option>
      <option value="intermittent">Intermittent response</option>
      <option value="no-comm">No communication</option>
      <option value="wiring-issue">Wiring issue detected</option>
    </select>
    
    <div class="grid">
      <div>
        <label class="required">Return Air Temperature</label>
        <input type="number" id="return-air-temp" step="0.1" required onchange="validateControlsStep()">
      </div>
      <div>
        <label class="required">Supply Air Temperature</label>
        <input type="number" id="supply-air-temp" step="0.1" required onchange="validateControlsStep()">
      </div>
    </div>
    
    <label>Delta T (calculated)</label>
    <input type="text" id="delta-t-calc" readonly>
    <div id="delta-t-status"></div>
    
    <label>Safety Controls (Cooling)</label>
    <div class="grid-3 cooling-only">
      <label><input type="checkbox" id="high-pressure" onchange="validateControlsStep()"> High Pressure OK</label>
      <label><input type="checkbox" id="low-pressure" onchange="validateControlsStep()"> Low Pressure OK</label>
      <label><input type="checkbox" id="float-switch" onchange="validateControlsStep()"> Float Switch OK</label>
    </div>
    
    <label>Safety Controls (Heating)</label>
    <div class="grid-3 heating-only">
      <label><input type="checkbox" id="flame-sensor" onchange="validateControlsStep()"> Flame Sensor OK</label>
      <label><input type="checkbox" id="limit-switch" onchange="validateControlsStep()"> Limit Switch OK</label>
      <label><input type="checkbox" id="pressure-switch" onchange="validateControlsStep()"> Pressure Switch OK</label>
    </div>
    
    <div id="controls-validation" role="alert"></div>
    
    <button onclick="completeControlsStep()" id="controls-complete-btn" class="success" disabled>
      ‚úì Controls Verified - Proceed to Environment
    </button>
  </div>

  <div class="card locked" data-step="environment" id="environment-card">
    <div class="card-header">
      Step 6: Environmental Factors
      <div class="card-status" id="environment-status">Locked</div>
    </div>
    
    <div class="status info">
      <span>üå°Ô∏è</span>
      FMS Method: Site conditions often reveal the true problem.
    </div>
    
    <div class="grid">
      <div>
        <label>Outdoor Temperature</label>
        <input type="number" id="outdoor-temp" step="0.1" onchange="validateEnvironmentStep()">
      </div>
      <div>
        <label>Outdoor Humidity (%)</label>
        <input type="number" id="outdoor-humidity" onchange="validateEnvironmentStep()">
      </div>
    </div>
    
    <label class="required">Evaporator Coil Condition</label>
    <select id="evap-coil-condition" required onchange="validateEnvironmentStep()">
      <option value="">Inspect evaporator coil...</option>
      <option value="clean">Clean - no obstructions</option>
      <option value="dusty">Dusty - light cleaning needed</option>
      <option value="dirty">Dirty - significant restriction</option>
      <option value="frozen">Frozen - airflow/charge issue</option>
      <option value="corroded">Corroded - replacement needed</option>
    </select>
    
    <label class="required">Condenser Coil Condition</label>
    <select id="cond-coil-condition" required onchange="validateEnvironmentStep()">
      <option value="">Inspect condenser coil...</option>
      <option value="clean">Clean - good heat transfer</option>
      <option value="dusty">Dusty - light cleaning needed</option>
      <option value="dirty">Dirty - reduced efficiency</option>
      <option value="blocked">Severely blocked</option>
      <option value="damaged">Damaged fins</option>
    </select>
    
    <label class="required">Drainage</label>
    <select id="drainage-condition" required onchange="validateEnvironmentStep()">
      <option value="">Check drainage...</option>
      <option value="clear">Clear - draining properly</option>
      <option value="slow">Slow drainage</option>
      <option value="blocked">Blocked - standing water</option>
      <option value="backup">Backup - overflow risk</option>
    </select>
    
    <label>Site-Specific Issues</label>
    <div class="voice-wrapper">
      <textarea id="site-issues" placeholder="Note any environmental factors affecting performance" rows="2" onchange="validateEnvironmentStep()"></textarea>
      <button class="voice-btn" data-voice="site-issues" aria-label="Record site-specific issues">üé§</button>
    </div>
    
    <div id="environment-validation" role="alert"></div>
    
    <button onclick="completeEnvironmentStep()" id="environment-complete-btn" class="success" disabled>
      ‚úì Environment Assessed - Complete Diagnostic
    </button>
  </div>

  <div class="card locked" id="findings-card">
    <div class="card-header">
      Diagnostic Summary
      <div class="card-status" id="findings-status">Locked</div>
    </div>
    
    <label class="required">Primary Findings</label>
    <div class="voice-wrapper">
      <textarea id="primary-findings" placeholder="What's wrong and why - be specific" rows="3" required></textarea>
      <button class="voice-btn" data-voice="primary-findings" aria-label="Record primary findings">üé§</button>
    </div>
    
    <label>Root Cause Analysis</label>
    <div class="voice-wrapper">
      <textarea id="root-cause" placeholder="Why this failure occurred" rows="2"></textarea>
      <button class="voice-btn" data-voice="root-cause" aria-label="Record root cause analysis">üé§</button>
    </div>
    
    <label class="required">Repair Recommendations</label>
    <div class="voice-wrapper">
      <textarea id="repair-recommendations" placeholder="Specific repair steps and options" rows="3" required></textarea>
      <button class="voice-btn" data-voice="repair-recommendations" aria-label="Record repair recommendations">üé§</button>
    </div>
    
    <label>Preventive Measures</label>
    <div class="voice-wrapper">
      <textarea id="preventive-measures" placeholder="How to prevent future issues" rows="2"></textarea>
      <button class="voice-btn" data-voice="preventive-measures" aria-label="Record preventive measures">üé§</button>
    </div>
  </div>

  <div class="card" id="photos-card">
    <div class="card-header">
      Photo Documentation
      <div class="card-status">Optional</div>
    </div>
    
    <div class="grid">
      <button onclick="takePhoto('nameplate')" class="secondary">üì∑ Nameplate</button>
      <button onclick="takePhoto('problem')" class="secondary">üì∑ Problem Area</button>
      <button onclick="takePhoto('before')" class="secondary">üì∑ Before Repair</button>
      <button onclick="takePhoto('after')" class="secondary">üì∑ After Repair</button>
    </div>
    
    <div class="photo-grid" id="photo-preview"></div>
  </div>

  <div class="actions">
    <button onclick="generateFMSReport()" class="success" id="generate-report-btn" disabled>Generate FMS Report</button>
    <button onclick="exportPDF()" class="secondary" disabled>üìÑ Export PDF</button>
    <button onclick="shareReport()" class="secondary" disabled>üì§ Share</button>
  </div>

  <script>
    // ==================== GLOBAL STATE ====================
    let currentStepIndex = 0;
    const steps = ['setup', 'equipment', 'power', 'airflow', 'electrical', 'refrigerant', 'controls', 'environment'];
    const diagnosticSteps = ['power', 'airflow', 'electrical', 'refrigerant', 'controls', 'environment'];
    let stepCompleted = [false, false, false, false, false, false, false, false]; // setup, equipment, power, airflow...
    let photos = [];
    let aiCoachVisible = false;
    
    // Enhanced R-410A PT chart for accurate calculations
    const R410A_PT = {
      90: 44.7, 95: 47.1, 100: 49.6, 105: 52.2, 110: 54.9, 115: 57.7,
      120: 60.6, 125: 63.6, 130: 66.7, 135: 69.9, 140: 73.2, 145: 76.6,
      150: 80.1, 155: 83.7, 160: 87.4, 165: 91.3, 170: 95.2, 175: 99.3,
      180: 103.5, 185: 107.8, 190: 112.2, 195: 116.7, 200: 121.4
    };
    
    // ==================== UTILITY FUNCTIONS ====================
    const $ = id => document.getElementById(id);
    const num = val => { const n = parseFloat(val); return isNaN(n) ? null : n; };
    
    function showAICoach(message) {
      $('ai-message').textContent = message;
      $('ai-coach').style.display = 'block';
      aiCoachVisible = true;
    }
    
    function dismissCoach() {
      $('ai-coach').style.display = 'none';
      aiCoachVisible = false;
    }
    
    function askCoach() {
      const question = prompt("What would you like help with?");
      if (question) {
        // Simulate AI response based on current step
        const responses = {
          setup: "Start by filling in the Customer Name and Service Address (required fields).",
          equipment: "Enter the Brand, Model, and Serial for both indoor and outdoor units, and select the Refrigerant Type.",
          power: "Remember: Power before panic. Check disconnects, verify voltage at source and load. Don't test unpowered systems.",
          airflow: "Airflow first, refrigerant second. Check filters, static pressure, and blower operation before touching gauges.",
          electrical: "Test under load when possible. Check amp draw against nameplate ratings. Look for signs of wear.",
          refrigerant: "Only after airflow is confirmed. Measure both superheat AND subcool - don't just look at pressure.",
          controls: "Verify actual system response matches expected behavior. Test safety controls under normal operation.",
          environment: "Site conditions often reveal the true problem. Check coil conditions, drainage, and ambient factors."
        };
        showAICoach(responses[steps[currentStepIndex]] || "Stay focused on the FMS Method. Each step builds on the last.");
      }
    }
    
    // ==================== MODE SWITCHING ====================
    function setMode(mode) {
      document.body.className = `mode-${mode}`;
      $('btn-cooling').className = mode === 'cooling' ? '' : 'secondary';
      $('btn-heating').className = mode === 'heating' ? '' : 'secondary';
      $('mode-indicator').textContent = mode.toUpperCase() + ' MODE';
      
      // Reset refrigerant/controls step validation when mode changes
      if (stepCompleted[5] || stepCompleted[6]) {
        stepCompleted[5] = false; // Refrigerant
        stepCompleted[6] = false; // Controls
        updateProgress();
        updateStepAccess();
      }
      
      // Re-validate current step if it is refrigerant or controls
      if (currentStepIndex === 5) validateRefrigerantStep();
      if (currentStepIndex === 6) validateControlsStep();
    }
    
    // ==================== PROGRESS MANAGEMENT ====================
    function updateProgress() {
      const completed = stepCompleted.slice(2).filter(Boolean).length; // Only count the 6 diagnostic steps
      const percentage = (completed / diagnosticSteps.length) * 100;
      
      $('progress-fill').style.width = percentage + '%';
      $('progress-text').textContent = `${completed}/${diagnosticSteps.length} Complete`;
      
      // Update step indicators
      steps.forEach((step, index) => {
        const stepEl = document.querySelector(`[data-step="${step}"]`);
        if (!stepEl) return;
        
        if (stepCompleted[index]) {
          stepEl.className = 'step complete';
        } else if (index === currentStepIndex) {
          stepEl.className = 'step active';
        } else {
          stepEl.className = 'step pending';
        }
      });
      
      // Enable report generation when all diagnostic steps complete
      const allDiagnosticComplete = stepCompleted.slice(2).every(Boolean);
      $('generate-report-btn').disabled = !allDiagnosticComplete;
      
      if (allDiagnosticComplete) {
        unlockCard('findings-card');
        showAICoach("Excellent work! All diagnostic steps completed using the FMS Method. Ready to generate your report.");
      }
    }
    
    function updateStepAccess() {
      // Setup Validation
      const setupValid = $('customer').value.trim() && $('address').value.trim();
      $('setup-complete-btn').disabled = !setupValid;
      
      if (stepCompleted[0]) {
        $('setup-status').textContent = 'Complete';
        $('setup-status').className = 'card-status complete';
        unlockCard('equipment-card');
      } else {
        $('setup-status').textContent = setupValid ? 'Ready' : 'Pending';
        $('setup-status').className = setupValid ? 'card-status' : 'card-status';
      }
      
      // Equipment Validation
      const equipmentValid = $('indoor-data').value.trim() && $('outdoor-data').value.trim() && $('refrigerant').value;
      $('equipment-complete-btn').disabled = !equipmentValid;

      if (stepCompleted[1]) {
        $('equipment-status').textContent = 'Complete';
        $('equipment-status').className = 'card-status complete';
      } else if (stepCompleted[0]) {
        $('equipment-status').textContent = equipmentValid ? 'Ready' : 'Pending';
        $('equipment-status').className = equipmentValid ? 'card-status' : 'card-status';
      }
      
      // Unlock subsequent diagnostic steps based on completion
      diagnosticSteps.forEach((step, index) => {
        const stepIndex = index + 2; // Map 0-5 to stepCompleted index 2-7
        const prevStepCompleted = stepCompleted[stepIndex - 1];
        
        if (prevStepCompleted) {
          unlockCard(`${step}-card`);
          if (stepCompleted[stepIndex]) {
            $(`${step}-status`).textContent = 'Complete';
            $(`${step}-status`).className = 'card-status complete';
          } else {
            $(`${step}-status`).textContent = 'Ready';
            $(`${step}-status`).className = 'card-status';
          }
          if (currentStepIndex < stepIndex) currentStepIndex = stepIndex; // Advance active step indicator
        }
      });
      updateProgress();
    }
    
    function unlockCard(cardId) {
      const card = $(cardId);
      if (card) card.classList.remove('locked');
    }
    
    // ==================== FIELD VALIDATION (GENERAL) ====================
    function validateField(field) {
      const value = field.value.trim();
      
      // Clear previous styling
      field.classList.remove('error', 'success');
      
      if (field.hasAttribute('required') && !value) {
        field.classList.add('error');
      } else if (value) {
        field.classList.add('success');
      }
      
      // Re-run step-specific validation when a field changes
      const card = field.closest('.card');
      if (!card) return;
      
      const step = card.dataset.step;
      if (step === 'setup') validateSetupStep();
      if (step === 'equipment') validateEquipmentStep();
    }
    
    // ==================== STEP VALIDATION FUNCTIONS (SPECIFIC) ====================
    
    function validateSetupStep() {
      const customerValid = $('customer').value.trim();
      const addressValid = $('address').value.trim();
      const isValid = customerValid && addressValid;
      $('setup-complete-btn').disabled = !isValid;
      updateStepAccess();
    }
    
    function validateEquipmentStep() {
      const indoorValid = $('indoor-data').value.trim();
      const outdoorValid = $('outdoor-data').value.trim();
      const refrigerantValid = $('refrigerant').value;
      const isValid = indoorValid && outdoorValid && refrigerantValid;
      $('equipment-complete-btn').disabled = !isValid;
      updateStepAccess();
    }
    
    function validatePowerStep() {
      const disconnect = $('disconnect-status').value;
      const lineVoltage = num($('voltage-line').value);
      const validation = $('power-validation');
      
      let isValid = false;
      let messages = [];
      
      if ($('voltage-line').value.trim() === '') {
        messages.push('<div class="status warn">‚ö†Ô∏è Line Voltage is Required to proceed.</div>');
      } else if (disconnect === 'bypassed') {
        messages.push('<div class="status bad">‚ö†Ô∏è SAFETY CONCERN: Bypassed disconnect must be corrected</div>');
      } else if (disconnect === 'missing') {
        messages.push('<div class="status bad">‚ö†Ô∏è Missing disconnect - code violation</div>');
      } else if (disconnect === 'present') {
        messages.push('<div class="status good">‚úì Disconnect verified</div>');
      }
      
      if (lineVoltage) {
        if (lineVoltage < 200) {
          messages.push('<div class="status bad">‚ö†Ô∏è Low voltage - potential supply issue</div>');
        } else if (lineVoltage > 250) {
          messages.push('<div class="status bad">‚ö†Ô∏è High voltage - potential supply issue</div>');
        } else {
          messages.push('<div class="status good">‚úì Line voltage within acceptable range</div>');
          isValid = disconnect === 'present' && lineVoltage;
        }
      }
      
      validation.innerHTML = messages.join('');
      $('power-complete-btn').disabled = !isValid;
    }
    
    function validateAirflowStep() {
      const filter = $('filter-condition').value;
      const blower = $('blower-operation').value;
      const returnStatic = num($('return-static').value);
      const supplyStatic = num($('supply-static').value);
      const validation = $('airflow-validation');
      
      let isValid = filter === 'clean' || filter === 'light-dust'; // Minimum for "verified"
      let messages = [];
      
      // Calculate total static if both values present
      if (returnStatic !== null && supplyStatic !== null) {
        const total = Math.abs(returnStatic) + Math.abs(supplyStatic);
        $('total-static').value = total.toFixed(2) + ' in w.c.';
        
        if (total <= 0.50) {
          messages.push('<div class="status good">‚úì Static pressure acceptable</div>');
        } else if (total <= 0.80) {
          messages.push('<div class="status warn">‚ö†Ô∏è Elevated static - monitor ductwork</div>');
        } else {
          messages.push('<div class="status bad">‚ö†Ô∏è Excessive static - duct issues likely</div>');
        }
      }
      
      if (filter === 'blocked' || filter === 'dirty') {
        messages.push('<div class="status bad">‚ö†Ô∏è Filter restriction affecting airflow</div>');
        isValid = false;
      } else if (filter === 'clean' || filter === 'light-dust') {
        messages.push('<div class="status good">‚úì Filter condition acceptable</div>');
      } else if (!filter) {
         messages.push('<div class="status warn">‚ö†Ô∏è Filter condition must be assessed.</div>');
         isValid = false;
      }
      
      if (blower === 'normal') {
        messages.push('<div class="status good">‚úì Blower operation normal</div>');
      } else if (blower === 'failed') {
        messages.push('<div class="status bad">‚ö†Ô∏è Blower not operating - major issue</div>');
        isValid = false;
      } else if (!blower) {
        messages.push('<div class="status warn">‚ö†Ô∏è Blower operation must be checked.</div>');
        isValid = false;
      }
      
      validation.innerHTML = messages.join('');
      $('airflow-complete-btn').disabled = !isValid;
    }
    
    function validateElectricalStep() {
      const capacitor = $('capacitor-reading').value;
      const contactor = $('contactor-condition').value;
      const validation = $('electrical-validation');
      
      let isValid = false;
      let messages = [];
      
      if (capacitor) {
        messages.push('<div class="status good">‚úì Capacitor reading documented</div>');
      } else {
        messages.push('<div class="status warn">‚ö†Ô∏è Capacitor reading is required to proceed.</div>');
      }
      
      if (contactor === 'failed' || contactor === 'poor') {
        messages.push('<div class="status bad">‚ö†Ô∏è Contactor requires immediate replacement</div>');
      } else if (contactor === 'excellent' || contactor === 'good') {
        messages.push('<div class="status good">‚úì Contactor condition acceptable</div>');
        isValid = !!capacitor;
      }
      
      validation.innerHTML = messages.join('');
      $('electrical-complete-btn').disabled = !isValid;
    }
    
    // NEW: Heating-specific validation logic
    function validateHeatingStep() {
      const gasInput = $('gas-input').value;
      const manifold = $('manifold-pressure').value;
      const heatExchanger = $('heat-exchanger').value;
      const validation = $('refrigerant-validation');
      
      let messages = [];
      let isValid = !!gasInput && !!manifold && !!heatExchanger;

      if (heatExchanger === 'cracked') {
          messages.push('<div class="status bad">‚ö†Ô∏è Cracked Heat Exchanger - **IMMEDIATE SHUTDOWN REQUIRED**</div>');
          isValid = false;
      } else if (heatExchanger === 'restricted') {
          messages.push('<div class="status warn">‚ö†Ô∏è Restricted Heat Exchanger - performance issue</div>');
      } else if (heatExchanger === 'clean') {
          messages.push('<div class="status good">‚úì Heat Exchanger condition acceptable</div>');
      } else if (!heatExchanger) {
          messages.push('<div class="status warn">‚ö†Ô∏è Heat Exchanger inspection is required.</div>');
          isValid = false;
      }

      if (!gasInput || !manifold) {
          messages.push('<div class="status warn">‚ö†Ô∏è Gas Input and Manifold Pressure are required.</div>');
          isValid = false;
      }
      
      validation.innerHTML = messages.join('');
      return isValid;
    }
    
    function validateRefrigerantStep() {
      const mode = document.body.classList.contains('mode-cooling') ? 'cooling' : 'heating';
      
      if (mode === 'heating') {
          $('refrigerant-validation').innerHTML = ''; // Clear cooling statuses
          return validateHeatingStep();
      }
      
      // COOLING MODE LOGIC
      const suctionP = num($('suction-pressure').value);
      const liquidP = num($('liquid-pressure').value);
      const suctionT = num($('suction-temp').value);
      const liquidT = num($('liquid-temp').value);
      const refrigerant = $('refrigerant').value;
      const validation = $('refrigerant-validation');

      let isValid = !!suctionP && !!liquidP && !!suctionT && !!liquidT;
      let messages = [];
      
      if (!isValid) {
          messages.push('<div class="status warn">‚ö†Ô∏è All 4 pressure/temperature readings are required to proceed.</div>');
      }
      
      if (suctionP && suctionT && refrigerant === 'R-410A') {
        // Simple linear interpolation to estimate saturation temp for demonstration
        const keys = Object.keys(R410A_PT).map(Number).sort((a,b) => a - b);
        let satTemp = null;
        for (let i = 0; i < keys.length - 1; i++) {
            if (suctionP >= keys[i] && suctionP <= keys[i+1]) {
                const p1 = keys[i];
                const p2 = keys[i+1];
                const t1 = R410A_PT[p1];
                const t2 = R410A_PT[p2];
                // Linear interpolation: T = T1 + (P - P1) * (T2 - T1) / (P2 - P1)
                satTemp = t1 + (suctionP - p1) * (t2 - t1) / (p2 - p1);
                break;
            }
        }
        
        if (satTemp) {
          const superheat = suctionT - satTemp;
          $('superheat-calc').value = superheat.toFixed(1) + '¬∞F';
          updateSuperheatStatus(superheat);
        } else {
            $('superheat-calc').value = 'N/A';
        }
      }
      
      if (liquidP && liquidT && refrigerant === 'R-410A') {
        const keys = Object.keys(R410A_PT).map(Number).sort((a,b) => a - b);
        let satTemp = null;
        for (let i = 0; i < keys.length - 1; i++) {
            if (liquidP >= keys[i] && liquidP <= keys[i+1]) {
                const p1 = keys[i];
                const p2 = keys[i+1];
                const t1 = R410A_PT[p1];
                const t2 = R410A_PT[p2];
                satTemp = t1 + (liquidP - p1) * (t2 - t1) / (p2 - p1);
                break;
            }
        }
        
        if (satTemp) {
          const subcool = satTemp - liquidT;
          $('subcool-calc').value = subcool.toFixed(1) + '¬∞F';
          updateSubcoolStatus(subcool);
        } else {
            $('subcool-calc').value = 'N/A';
        }
      }
      
      validation.innerHTML = messages.join('');
      $('refrigerant-complete-btn').disabled = !isValid;
      return isValid;
    }
    
    function updateSuperheatStatus(superheat) {
      const statusDiv = $('superheat-status');
      if (superheat < 5) {
        statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low superheat - possible overcharge</div>';
      } else if (superheat > 25) {
        statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è High superheat - possible undercharge</div>';
      } else if (superheat >= 8 && superheat <= 18) {
        statusDiv.innerHTML = '<div class="status good">‚úì Superheat in target range</div>';
      } else {
        statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Superheat marginal</div>';
      }
    }
    
    function updateSubcoolStatus(subcool) {
      const statusDiv = $('subcool-status');
      if (subcool < 5) {
        statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Low subcool - possible undercharge</div>';
      } else if (subcool > 20) {
        statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è High subcool - possible overcharge</div>';
      } else if (subcool >= 8 && subcool <= 15) {
        statusDiv.innerHTML = '<div class="status good">‚úì Subcool in target range</div>';
      } else {
        statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Subcool marginal</div>';
      }
    }
    
    function validateControlsStep() {
      const thermostat = $('thermostat-comm').value;
      const returnTemp = num($('return-air-temp').value);
      const supplyTemp = num($('supply-air-temp').value);
      const mode = document.body.classList.contains('mode-cooling') ? 'cooling' : 'heating';
      const validation = $('controls-validation');
      
      let isValid = !!thermostat && !!returnTemp && !!supplyTemp;
      let messages = [];

      // Check required fields
      if (!thermostat || !returnTemp || !supplyTemp) {
          messages.push('<div class="status warn">‚ö†Ô∏è Thermostat and both air temperatures are required.</div>');
          isValid = false;
      }
      
      let allSafetyOK = false;
      if (mode === 'cooling') {
        const safetyChecks = ['high-pressure', 'low-pressure', 'float-switch'];
        allSafetyOK = safetyChecks.every(id => $(id).checked);
        if (!allSafetyOK) messages.push('<div class="status warn">‚ö†Ô∏è All Cooling Safety Checks must be confirmed.</div>');
      } else { // heating
        const safetyChecks = ['flame-sensor', 'limit-switch', 'pressure-switch'];
        allSafetyOK = safetyChecks.every(id => $(id).checked);
        if (!allSafetyOK) messages.push('<div class="status warn">‚ö†Ô∏è All Heating Safety Checks must be confirmed.</div>');
      }
      
      // Calculate Delta T
      if (returnTemp && supplyTemp) {
        const delta = mode === 'cooling' ? returnTemp - supplyTemp : supplyTemp - returnTemp;
        $('delta-t-calc').value = delta.toFixed(1) + '¬∞F';
        
        const statusDiv = $('delta-t-status');
        if (mode === 'cooling') {
          if (delta >= 16 && delta <= 22) {
            statusDiv.innerHTML = '<div class="status good">‚úì Delta T optimal (Cooling)</div>';
          } else if (delta < 14 || delta > 24) {
            statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Delta T out of range (Cooling)</div>';
          } else {
            statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Delta T marginal (Cooling)</div>';
          }
        } else { // Heating
            if (delta >= 35 && delta <= 65) {
                statusDiv.innerHTML = '<div class="status good">‚úì Delta T optimal (Heating)</div>';
            } else if (delta < 30 || delta > 70) {
                statusDiv.innerHTML = '<div class="status bad">‚ö†Ô∏è Delta T out of range (Heating)</div>';
            } else {
                statusDiv.innerHTML = '<div class="status warn">‚ö†Ô∏è Delta T marginal (Heating)</div>';
            }
        }
      }

      isValid = isValid && allSafetyOK;
      validation.innerHTML = messages.join('');
      $('controls-complete-btn').disabled = !isValid;
    }
    
    function validateEnvironmentStep() {
      const evapCoil = $('evap-coil-condition').value;
      const condCoil = $('cond-coil-condition').value;
      const drainage = $('drainage-condition').value;
      
      const isValid = evapCoil && condCoil && drainage;
      $('environment-complete-btn').disabled = !isValid;
    }
    
    // ==================== STEP COMPLETION FUNCTIONS ====================
    
    function completeSetupStep() {
      stepCompleted[0] = true;
      currentStepIndex = 1;
      updateStepAccess();
      showAICoach("Job setup complete! Now, accurately document the Equipment Identity.");
    }

    function completeEquipmentStep() {
      stepCompleted[1] = true;
      currentStepIndex = 2;
      updateStepAccess();
      showAICoach("Equipment data confirmed! Starting the FMS Diagnostic Method. Step 1: Power Verification.");
      // Scroll to Power Card
      $('power-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function completePowerStep() {
      stepCompleted[2] = true;
      currentStepIndex = 3;
      updateStepAccess();
      showAICoach("Power verified! Now let's check airflow. Remember: never skip to refrigerant without confirming airflow first.");
      $('airflow-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function completeAirflowStep() {
      stepCompleted[3] = true;
      currentStepIndex = 4;
      updateStepAccess();
      showAICoach("Airflow confirmed! Moving to electrical components. Test under load when possible.");
      $('electrical-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function completeElectricalStep() {
      stepCompleted[4] = true;
      currentStepIndex = 5;
      updateStepAccess();
      showAICoach("Electrical verified! Now we can safely check the refrigerant circuit. Measure both superheat AND subcool.");
      $('refrigerant-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function completeRefrigerantStep() {
      stepCompleted[5] = true;
      currentStepIndex = 6;
      updateStepAccess();
      showAICoach("Refrigerant circuit analyzed! Let's verify controls and system response.");
      $('controls-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function completeControlsStep() {
      stepCompleted[6] = true;
      currentStepIndex = 7;
      updateStepAccess();
      showAICoach("Controls verified! Final step: environmental factors often reveal the true problem.");
      $('environment-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function completeEnvironmentStep() {
      stepCompleted[7] = true;
      currentStepIndex = 7; // Final step index
      updateProgress();
      updateStepAccess();
      showAICoach("Outstanding! You've completed the full FMS Diagnostic Method. Ready to document your findings.");
      $('findings-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // ==================== VOICE INPUT ====================
    let recognition = null;
    let currentTarget = null;
    
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = (e) => {
        if (currentTarget && e.results[0]) {
          const transcript = e.results[0][0].transcript;
          currentTarget.value = transcript;
          currentTarget.dispatchEvent(new Event('input'));
          currentTarget.dispatchEvent(new Event('change'));
        }
      };
      
      // FIXED: Added logic for onend and onerror to clear listening state
      recognition.onend = () => {
        document.querySelectorAll('.voice-btn.listening').forEach(btn => {
          btn.classList.remove('listening');
        });
      };
      
      recognition.onerror = (e) => {
        console.error('Speech recognition error:', e);
        document.querySelectorAll('.voice-btn.listening').forEach(btn => {
          btn.classList.remove('listening');
        });
        alert('Voice recognition failed. Please ensure microphone permissions are granted.');
      };
    }
    
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('voice-btn')) {
        const targetId = e.target.dataset.voice;
        currentTarget = $(targetId);
        
        if (recognition && currentTarget) {
          try {
            // Stop any currently listening instance
            recognition.stop();
          } catch (e) {
            // Ignore if recognition wasn't active
          }
          
          // Clear all other listening states
          document.querySelectorAll('.voice-btn').forEach(btn => {
             btn.classList.remove('listening');
          });

          // Start new recognition
          e.target.classList.add('listening');
          recognition.start();

        } else if (!recognition) {
          alert('Voice input not supported on this device');
        }
      }
    });
    
    // ==================== PHOTO SYSTEM & REPORTING (Unchanged - they were complete) ====================

    function takePhoto(purpose) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.capture = 'environment';
      
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
          photos.push({
            purpose: purpose,
            data: event.target.result,
            timestamp: new Date().toISOString(),
            filename: file.name
          });
          updatePhotoPreview();
        };
        reader.readAsDataURL(file);
      };
      
      input.click();
    }
    
    function updatePhotoPreview() {
      const preview = $('photo-preview');
      preview.innerHTML = photos.map((photo, index) => `
        <div class="photo-item">
          <img src="${photo.data}" alt="${photo.purpose}">
          <div class="photo-label">${photo.purpose}</div>
        </div>
      `).join('');
    }
    
    function generateFMSReport() {
      const mode = document.body.classList.contains('mode-cooling') ? 'Cooling' : 'Heating';
      const timestamp = new Date();
      
      const report = {
        // Header Information
        header: {
          title: "FIDELITY MECHANICAL SOLUTIONS‚Ñ¢",
          subtitle: "Technical Service Report",
          generated: timestamp.toLocaleString(),
          technician: "[Technician Signature Required]",
          mode: mode
        },
        
        // Job Information
        job: {
          customer: $('customer').value,
          address: $('address').value,
          complaint: $('complaint').value,
          equipment: {
            location: $('location').value,
            indoor: $('indoor-data').value,
            outdoor: $('outdoor-data').value,
            mfgDate: $('mfg-date').value,
            refrigerant: $('refrigerant').value
          }
        },
        
        // FMS Diagnostic Results
        diagnostic: {
          power: {
            disconnect: $('disconnect-status').value,
            lineVoltage: $('voltage-line').value,
            controlVoltage: $('voltage-control').value,
            l1n: $('voltage-l1n').value,
            l2n: $('voltage-l2n').value
          },
          airflow: {
            filterCondition: $('filter-condition').value,
            returnStatic: $('return-static').value,
            supplyStatic: $('supply-static').value,
            totalStatic: $('total-static').value,
            blowerOperation: $('blower-operation').value
          },
          electrical: {
            blowerAmps: $('blower-amps').value,
            compAmps: $('comp-amps').value,
            condFanAmps: $('cond-fan-amps').value,
            inducerAmps: $('inducer-amps').value,
            capacitor: $('capacitor-reading').value,
            contactor: $('contactor-condition').value
          },
          refrigerant: mode === 'Cooling' ? {
            suctionPressure: $('suction-pressure').value,
            liquidPressure: $('liquid-pressure').value,
            suctionTemp: $('suction-temp').value,
            liquidTemp: $('liquid-temp').value,
            superheat: $('superheat-calc').value,
            subcool: $('subcool-calc').value
          } : {
            gasInput: $('gas-input').value,
            manifoldPressure: $('manifold-pressure').value,
            heatExchanger: $('heat-exchanger').value
          },
          controls: {
            thermostatComm: $('thermostat-comm').value,
            returnAirTemp: $('return-air-temp').value,
            supplyAirTemp: $('supply-air-temp').value,
            deltaT: $('delta-t-calc').value,
            safetyControls: {
              highPressure: $('high-pressure').checked,
              lowPressure: $('low-pressure').checked,
              floatSwitch: $('float-switch').checked,
              flameSensor: $('flame-sensor') ? $('flame-sensor').checked : false,
              limitSwitch: $('limit-switch') ? $('limit-switch').checked : false,
              pressureSwitch: $('pressure-switch') ? $('pressure-switch').checked : false
            }
          },
          environment: {
            outdoorTemp: $('outdoor-temp').value,
            outdoorHumidity: $('outdoor-humidity').value,
            evapCoil: $('evap-coil-condition').value,
            condCoil: $('cond-coil-condition').value,
            drainage: $('drainage-condition').value,
            siteIssues: $('site-issues').value
          }
        },
        
        // Findings and Recommendations
        findings: {
          primary: $('primary-findings').value,
          rootCause: $('root-cause').value,
          repairs: $('repair-recommendations').value,
          preventive: $('preventive-measures').value
        },
        
        // Documentation
        photos: photos,
        completedSteps: stepCompleted.slice(2).filter(Boolean).length,
        fmsMethodFollowed: stepCompleted.slice(2).every(Boolean)
      };
      
      // Store report data
      sessionStorage.setItem('fmsReport', JSON.stringify(report));
      
      // Generate formatted report display
      displayFMSReport(report);
      
      // Enable export buttons
      document.querySelectorAll('.actions button').forEach(btn => btn.disabled = false);
    }
    
    function displayFMSReport(report) {
      const reportHTML = `
        <div class="card" style="background: linear-gradient(135deg, var(--fidelity-blue), var(--fidelity-light)); color: white;">
          <div style="text-align: center;">
            <h2 style="margin-bottom: 8px;">${report.header.title}</h2>
            <div style="font-size: 16px; opacity: 0.9;">${report.header.subtitle}</div>
            <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Generated: ${report.header.generated}</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">Service Summary</div>
          <div class="grid">
            <div><strong>Customer:</strong> ${report.job.customer}</div>
            <div><strong>Mode:</strong> ${report.header.mode}</div>
          </div>
          <div><strong>Address:</strong> ${report.job.address}</div>
          <div><strong>Complaint:</strong> ${report.job.complaint}</div>
          <div><strong>Equipment Location:</strong> ${report.job.equipment.location}</div>
        </div>
        
        <div class="card">
          <div class="card-header">Equipment Identity</div>
          <div><strong>Indoor Unit:</strong> ${report.job.equipment.indoor}</div>
          <div><strong>Outdoor Unit:</strong> ${report.job.equipment.outdoor}</div>
          <div><strong>Refrigerant:</strong> ${report.job.equipment.refrigerant}</div>
          ${report.job.equipment.mfgDate ? `<div><strong>Manufacture Date:</strong> ${report.job.equipment.mfgDate}</div>` : ''}
        </div>
        
        <div class="card">
          <div class="card-header">FMS Diagnostic Method Results</div>
          <div class="status ${report.fmsMethodFollowed ? 'good' : 'warn'}">
            ${report.fmsMethodFollowed ? '‚úì' : '‚ö†Ô∏è'} 
            FMS Method Compliance: ${report.completedSteps}/6 diagnostic steps completed
          </div>
          
          <h4 style="margin: 16px 0 8px 0;">Power Verification</h4>
          <div>Disconnect: ${report.diagnostic.power.disconnect}</div>
          <div>Line Voltage: ${report.diagnostic.power.lineVoltage}V</div>
          ${report.diagnostic.power.controlVoltage ? `<div>Control Voltage: ${report.diagnostic.power.controlVoltage}V</div>` : ''}
          
          <h4 style="margin: 16px 0 8px 0;">Airflow Assessment</h4>
          <div>Filter Condition: ${report.diagnostic.airflow.filterCondition}</div>
          <div>Total Static Pressure: ${report.diagnostic.airflow.totalStatic}</div>
          <div>Blower Operation: ${report.diagnostic.airflow.blowerOperation}</div>
          
          <h4 style="margin: 16px 0 8px 0;">Electrical Components</h4>
          <div>Capacitor Reading: ${report.diagnostic.electrical.capacitor}</div>
          <div>Contactor Condition: ${report.diagnostic.electrical.contactor}</div>
          ${report.diagnostic.electrical.blowerAmps ? `<div>Blower Amps: ${report.diagnostic.electrical.blowerAmps}</div>` : ''}
          
          <h4 style="margin: 16px 0 8px 0;">${report.header.mode} Circuit</h4>
          ${report.header.mode === 'Cooling' ? `
            <div>Suction Pressure: ${report.diagnostic.refrigerant.suctionPressure} psig</div>
            <div>Liquid Pressure: ${report.diagnostic.refrigerant.liquidPressure} psig</div>
            <div>Superheat: ${report.diagnostic.refrigerant.superheat}</div>
            <div>Subcool: ${report.diagnostic.refrigerant.subcool}</div>
          ` : `
            <div>Gas Input: ${report.diagnostic.refrigerant.gasInput} BTU/hr</div>
            <div>Manifold Pressure: ${report.diagnostic.refrigerant.manifoldPressure} in w.c.</div>
            <div>Heat Exchanger: ${report.diagnostic.refrigerant.heatExchanger}</div>
          `}
          
          <h4 style="margin: 16px 0 8px 0;">Controls & Environment</h4>
          <div>Thermostat Communication: ${report.diagnostic.controls.thermostatComm}</div>
          <div>Delta T: ${report.diagnostic.controls.deltaT}</div>
          <div>Evaporator Coil: ${report.diagnostic.environment.evapCoil}</div>
          <div>Condenser Coil: ${report.diagnostic.environment.condCoil}</div>
          <div>Drainage: ${report.diagnostic.environment.drainage}</div>
        </div>
        
        <div class="card">
          <div class="card-header">Findings & Recommendations</div>
          <h4>Primary Findings:</h4>
          <p style="margin-bottom: 12px;">${report.findings.primary}</p>
          
          ${report.findings.rootCause ? `
            <h4>Root Cause Analysis:</h4>
            <p style="margin-bottom: 12px;">${report.findings.rootCause}</p>
          ` : ''}
          
          <h4>Repair Recommendations:</h4>
          <p style="margin-bottom: 12px;">${report.findings.repairs}</p>
          
          ${report.findings.preventive ? `
            <h4>Preventive Measures:</h4>
            <p style="margin-bottom: 12px;">${report.findings.preventive}</p>
          ` : ''}
        </div>
        
        ${report.photos.length > 0 ? `
          <div class="card">
            <div class="card-header">Photo Documentation (${report.photos.length})</div>
            <div class="photo-grid">
              ${report.photos.map(photo => `
                <div class="photo-item">
                  <img src="${photo.data}" alt="${photo.purpose}">
                  <div class="photo-label">${photo.purpose}</div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        
        <div class="card" style="text-align: center; border: 2px solid var(--fidelity-blue);">
          <div style="color: var(--fidelity-blue); font-weight: 700; margin-bottom: 16px;">
            TECHNICIAN CERTIFICATION
          </div>
          <div style="margin-bottom: 16px;">
            I certify that this diagnostic was performed using the Fidelity Mechanical Solutions method,
            following the complete Power ‚Üí Airflow ‚Üí Electrical ‚Üí Refrigerant ‚Üí Controls ‚Üí Environment sequence.
          </div>
          <div style="border-top: 2px solid var(--neutral-gray); margin: 24px auto; width: 200px;"></div>
          <div style="font-size: 12px; color: var(--neutral-gray);">Technician Signature & Date</div>
        </div>
      `;
      
      // Insert report before actions
      const reportDiv = document.createElement('div');
      reportDiv.innerHTML = reportHTML;
      reportDiv.id = 'generated-report';
      
      // Remove any existing report
      const existingReport = $('generated-report');
      if (existingReport) existingReport.remove();
      
      document.querySelector('.actions').before(reportDiv);
      reportDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function exportPDF() {
      const report = sessionStorage.getItem('fmsReport');
      if (!report) return;
      
      const data = JSON.parse(report);
      const textReport = generateTextReport(data);
      
      const blob = new Blob([textReport], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `FMS_Report_${data.job.customer.replace(/\s/g, '_')}_${new Date().toISOString().slice(0,10)}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }
    
    function shareReport() {
      const report = sessionStorage.getItem('fmsReport');
      if (!report) return;
      
      const data = JSON.parse(report);
      const shareText = `FMS Diagnostic Report - ${data.job.customer}\nCompleted: ${data.header.generated}\nMethod Compliance: ${data.completedSteps}/6 steps`;
      
      if (navigator.share) {
        navigator.share({
          title: 'FMS Diagnostic Report',
          text: shareText,
          url: window.location.href
        });
      } else {
        navigator.clipboard.writeText(shareText).then(() => {
          alert('Report summary copied to clipboard');
        });
      }
    }
    
    function generateTextReport(data) {
      return `
FIDELITY MECHANICAL SOLUTIONS‚Ñ¢
TECHNICAL SERVICE REPORT
${data.header.generated}

CUSTOMER: ${data.job.customer}
ADDRESS: ${data.job.address}
COMPLAINT: ${data.job.complaint}
MODE: ${data.header.mode}

EQUIPMENT IDENTITY
------------------
Location: ${data.job.equipment.location}
Indoor Unit: ${data.job.equipment.indoor}
Outdoor Unit: ${data.job.equipment.outdoor}
Refrigerant: ${data.job.equipment.refrigerant}

FMS DIAGNOSTIC METHOD RESULTS
-----------------------------
Method Compliance: ${data.completedSteps}/6 steps completed

POWER VERIFICATION
- Disconnect: ${data.diagnostic.power.disconnect}
- Line Voltage: ${data.diagnostic.power.lineVoltage}V

AIRFLOW ASSESSMENT  
- Filter: ${data.diagnostic.airflow.filterCondition}
- Total Static: ${data.diagnostic.airflow.totalStatic}
- Blower: ${data.diagnostic.airflow.blowerOperation}

ELECTRICAL COMPONENTS
- Capacitor: ${data.diagnostic.electrical.capacitor}
- Contactor: ${data.diagnostic.electrical.contactor}

${data.header.mode.toUpperCase()} CIRCUIT
${data.header.mode === 'Cooling' ? `
- Suction Pressure: ${data.diagnostic.refrigerant.suctionPressure} psig
- Liquid Pressure: ${data.diagnostic.refrigerant.liquidPressure} psig  
- Superheat: ${data.diagnostic.refrigerant.superheat}
- Subcool: ${data.diagnostic.refrigerant.subcool}` : `
- Gas Input: ${data.diagnostic.refrigerant.gasInput} BTU/hr
- Manifold Pressure: ${data.diagnostic.refrigerant.manifoldPressure} in w.c.`}

CONTROLS & ENVIRONMENT
- Thermostat: ${data.diagnostic.controls.thermostatComm}
- Delta T: ${data.diagnostic.controls.deltaT}
- Evap Coil: ${data.diagnostic.environment.evapCoil}
- Cond Coil: ${data.diagnostic.environment.condCoil}
- Drainage: ${data.diagnostic.environment.drainage}

FINDINGS & RECOMMENDATIONS
--------------------------
Primary Findings: ${data.findings.primary}
Repair Recommendations: ${data.findings.repairs}

---
Technician: ${data.header.technician}
Report generated by FieldBuddy Advanced‚Ñ¢
      `.trim();
    }
    
    // ==================== INITIALIZATION ====================
    window.addEventListener('load', () => {
      // Show initial AI coach message
      setTimeout(() => {
        showAICoach("Welcome to FieldBuddy Advanced! Let's start with job setup, then follow the complete FMS Diagnostic Method: Power ‚Üí Airflow ‚Üí Electrical ‚Üí Refrigerant ‚Üí Controls ‚Üí Environment.");
      }, 1000);
      
      // Auto-save load logic (simplified for this example)
      const draft = sessionStorage.getItem('fmsDraft');
      if (draft && confirm('Resume previous diagnostic session?')) {
        // In a real app, this would load field values
      }
      
      updateStepAccess();
    });
    
    // Auto-save functionality
    setInterval(() => {
      const draft = {
        customer: $('customer').value,
        address: $('address').value,
        complaint: $('complaint').value,
        timestamp: Date.now()
      };
      sessionStorage.setItem('fmsDraft', JSON.stringify(draft));
    }, 30000);
  </script>
</body>
</html>
